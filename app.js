// ===== 0) Firebase Ï¥àÍ∏∞Ìôî =====
const firebaseConfig = {
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "196036694705",
  appId: "1:196036694705:web:8988d12919420130464890",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db   = firebase.firestore();

// ===== 1) Í≥†Ï†ïÍ∞í (ÎÑ§ Í∞íÏúºÎ°ú ÍµêÏ≤¥!) =====
const ADMIN_UID  = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // Í¥ÄÎ¶¨Ïûê
const PUBLIC_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // Í≥µÍ∞ú Ï°∞ÌöåÏö©

// ===== 2) DOM Ìó¨Ìçº =====
const $  = (q, r=document)=>r.querySelector(q);
const $$ = (q, r=document)=>Array.from(r.querySelectorAll(q));

// ===== 3) Ï†ÑÏó≠ =====
let currentUser = null;
let listeners = []; // onSnapshot Ìï¥Ï†úÏö©
let noticeUnsub = null;
let settingsUnsub = null;

// ===== 4) UI helpers =====
function toggleSection(id){ $("#"+id).classList.toggle("open"); }

function escapeHTML(s){
  return (s||"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));
}
function getWeekday(iso){
  if(!iso) return "";
  const d = new Date(iso+'T00:00:00');
  return ["Ïùº","Ïõî","Ìôî","Ïàò","Î™©","Í∏à","ÌÜ†"][d.getDay()];
}
function dateSpanText(start, end){
  if(!start && !end) return "";
  const s = start || end;
  const e = end || start;
  const sW = getWeekday(s);
  const eW = getWeekday(e);
  if(s === e) return `${s} (${sW})`;
  return `${s} (${sW}) ~ ${e} (${eW})`;
}
function periodText(pStart, pEnd){
  if(!pStart && !pEnd) return "";
  if(pStart && !pEnd)  return `${pStart}ÍµêÏãú`;
  if(!pStart && pEnd)  return `${pEnd}ÍµêÏãú`;
  if(pStart === pEnd)  return `${pStart}ÍµêÏãú`;
  return `${pStart}~${pEnd}ÍµêÏãú`;
}

// D-Day (ÏãúÏûëÏùº Í∏∞Ï§Ä, ÏßÑÌñâÏ§ëÏùÄ D-day ÎÖ∏Îûë, ÏãúÏûë Ï†Ñ Îπ®/Ï£º/ÎÖ∏/Ï¥à, ÏßÄÎÇ® ÌöåÏÉâ)
function renderDday(start, end){
  if(!start) return "";
  const today = new Date(); today.setHours(0,0,0,0);
  const s = new Date(start+'T00:00:00');
  const e = new Date((end||start)+'T00:00:00');
  const diff = Math.floor((s - today) / 86400000);

  let label="", cls="";
  if(today >= s && today <= e){
    label = "D-day"; cls = "yellow";
  }else if(diff > 0){
    label = `D-${diff}`;
    if(diff === 1) cls = "red";
    else if(diff <= 3) cls = "orange";
    else if(diff <= 5) cls = "yellow";
    else cls = "green";
  }else if(diff === 0){
    label = "D-0"; cls = "red";
  }else{
    label = "ÎÅù"; cls = "gray";
  }
  return `<span class="dday ${cls}">${label}</span>`;
}

// ===== 5) Í≤ΩÎ°ú Ìó¨Ìçº =====
function taskCol(cat){
  const uid = (currentUser && currentUser.uid === ADMIN_UID) ? ADMIN_UID : PUBLIC_UID;
  return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
}
// Ï†ÑÎã¨ ÏÇ¨Ìï≠: Îã®Ïùº Ïª¨Î†âÏÖò(users/{PUBLIC_UID}/notices)
function noticesCol(){
  return db.collection("users").doc(PUBLIC_UID).collection("notices");
}
// ON/OFF ÏÑ§Ï†ï Î¨∏ÏÑú(users/{PUBLIC_UID}/settings/app)
function appSettingsDoc(){
  return db.collection("users").doc(PUBLIC_UID).collection("settings").doc("app");
}

// ===== 6) Î†åÎçîÎßÅ =====
const lists = {
  exam: $("#list_exam"),
  perf: $("#list_perf"),
  home: $("#list_home"),
};

function taskItemHTML(cat, id, it){
  const dates = dateSpanText(it.start, it.end);
  const pTxt  = periodText(it.pStart, it.pEnd);
  return `
  <li class="task">
    <div class="task__main">
      <div><b>${escapeHTML(it.subj||"")}</b> ${renderDday(it.start, it.end)}</div>
      ${it.text ? `<div>${escapeHTML(it.text)}</div>` : ""}
      <div class="meta">üìÖ ${dates}${pTxt?` ¬∑ ${pTxt}`:""}</div>
      ${it.detail ? `<pre>${escapeHTML(it.detail)}</pre>` : ""}
      ${currentUser?.uid===ADMIN_UID ? `
        <div class="card-actions">
          <button class="btn" onclick="openEdit('${cat}','${id}')">ÏàòÏ†ï</button>
          <button class="btn" onclick="doDelete('${cat}','${id}')">ÏÇ≠Ï†ú</button>
        </div>` : ``}
    </div>
  </li>`;
}
function renderList(cat, docs){
  const ul = lists[cat];
  ul.innerHTML = docs.map(d => taskItemHTML(cat, d.id, d.data())).join("");
}

// Ï†ÑÎã¨ÏÇ¨Ìï≠ Î†åÎçî
function noticeItemHTML(n){
  const kindCls = n.kind === 'notice' ? 'kind-notice'
                : n.kind === 'info'   ? 'kind-info'
                : 'kind-alert';
  const title = escapeHTML(n.title||"");
  const body  = escapeHTML(n.body||"");
  const created = n.createdAt?.toDate ? n.createdAt.toDate() : null;
  const meta = created ? created.toLocaleString() : "";

  return `
  <li class="notice-card ${kindCls}">
    <div class="notice-title">[${n.kind==='notice'?'Í≥µÏßÄ':n.kind==='info'?'ÏïàÎÇ¥':'ÏïåÎ¶º'}] ${title}</div>
    <pre style="margin:8px 0 0">${body}</pre>
    <div class="notice-meta">${meta}</div>
    ${currentUser?.uid===ADMIN_UID ? `
      <div class="card-actions">
        <button class="btn" onclick="openNoticeEdit('${n.id}')">ÏàòÏ†ï</button>
        <button class="btn" onclick="deleteNotice('${n.id}')">ÏÇ≠Ï†ú</button>
      </div>` : ``}
  </li>`;
}
function renderNotices(arr){
  $("#notice_list").innerHTML = arr.map(noticeItemHTML).join("");
}

// ===== 7) Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ =====
function startTaskListeners(){
  stopTaskListeners();
  ["exam","perf","home"].forEach(cat=>{
    const un = taskCol(cat).orderBy("start","asc").onSnapshot(snap=>{
      const arr = []; snap.forEach(d=>arr.push(d));
      renderList(cat, arr);
    }, err=>{
      console.error(err);
      alert("Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§: " + err.message);
    });
    listeners.push(un);
  });
}
function stopTaskListeners(){
  listeners.forEach(u=>u&&u()); listeners = [];
}

function startNoticeListener(){
  if(noticeUnsub) { noticeUnsub(); noticeUnsub=null; }
  noticeUnsub = noticesCol()
    .orderBy("createdAt", "desc")
    .onSnapshot((snap)=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      renderNotices(arr);
    }, (err)=>{
      console.error(err);
      alert("Ï†ÑÎã¨ ÏÇ¨Ìï≠ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§: "+err.message);
    });
}
function startSettingsListener(){
  if(settingsUnsub) { settingsUnsub(); settingsUnsub=null; }
  settingsUnsub = appSettingsDoc().onSnapshot((doc)=>{
    const data = doc.data() || { noticesOn: true };
    $("#noticeToggle").checked = !!data.noticesOn;
    $("#sec_notice").style.display = data.noticesOn ? "" : "none";
  }, (err)=>{
    console.error(err);
  });
}

// ===== 8) Î°úÍ∑∏Ïù∏ =====
const loginBtn  = $("#loginBtn");
const logoutBtn = $("#logoutBtn");
loginBtn.onclick  = ()=> auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick = ()=> auth.signOut();

auth.onAuthStateChanged(u=>{
  currentUser = u || null;
  loginBtn.style.display  = u ? "none" : "";
  logoutBtn.style.display = u ? "" : "none";

  const isAdmin = !!u && u.uid===ADMIN_UID;
  $$(".add-row").forEach(r=> r.style.display = isAdmin ? "" : "none");

  bindAddRows();              // Ï∂îÍ∞Ä Î≤ÑÌäº Î∞îÏù∏Îî©
  startTaskListeners();       // Í≥ºÏ†ú/ÏãúÌóò/ÏàòÌñâ
  startNoticeListener();      // Ï†ÑÎã¨ ÏÇ¨Ìï≠
  startSettingsListener();    // ON/OFF
});

// ===== 9) Ï∂îÍ∞Ä Ìèº Î∞îÏù∏Îî© & Ï†ÄÏû• =====
function bindAddRows(){
  $$(".add-row").forEach(row=>{
    const btn = $(".add", row);
    if(!btn) return;
    btn.onclick = async ()=>{
      if(currentUser?.uid !== ADMIN_UID) { alert("Í¥ÄÎ¶¨ÏûêÎßå Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }

      const cat   = row.dataset.cat;
      if(!cat){ return; } // Ï†ÑÎã¨ÏÇ¨Ìï≠ ÌèºÎèÑ add-rowÎùºÏÑú Íµ¨Î∂Ñ

      const subj  = $(".subj", row).value.trim();
      const text  = $(".text", row).value.trim();
      const start = $(".date", row).value || "";
      const end   = $(".date2",row).value || start;
      const pStart= $(".pStart",row).value || "";
      const pEnd  = $(".pEnd", row).value || "";
      const detail= $(".detail",row).value;

      if(!subj || !start){ alert("Í≥ºÎ™©/ÎÇ†ÏßúÎäî ÌïÑÏàòÏûÖÎãàÎã§."); return; }

      try{
        await taskCol(cat).add({
          subj, text, start, end, pStart, pEnd, detail,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // reset
        $(".subj", row).value = "";
        $(".text", row).value = "";
        $(".date", row).value = "";
        $(".date2",row).value = "";
        $(".pStart",row).value = "";
        $(".pEnd", row).value = "";
        $(".detail",row).value = "";
      }catch(e){
        alert("Ï†ÄÏû• Ïã§Ìå®: "+e.message);
        console.error(e);
      }
    };
  });

  // Ï†ÑÎã¨ ÏÇ¨Ìï≠ Ï∂îÍ∞Ä Î≤ÑÌäº
  const addBtn = $("#nAddBtn");
  if(addBtn){
    addBtn.onclick = async ()=>{
      if(currentUser?.uid !== ADMIN_UID){ alert("Í¥ÄÎ¶¨ÏûêÎßå Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
      const title = $("#nTitle").value.trim();
      const kind  = $("#nKind").value || "notice";
      const body  = $("#nBody").value;

      if(!title){ alert("Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî."); return; }
      try{
        await noticesCol().add({
          title, kind, body,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        $("#nTitle").value = "";
        $("#nKind").value = "notice";
        $("#nBody").value = "";
      }catch(e){
        alert("Ï†ÑÎã¨ ÏÇ¨Ìï≠ Ï†ÄÏû• Ïã§Ìå®: " + e.message);
        console.error(e);
      }
    };
  }
}

// ===== 10) ÏàòÏ†ï/ÏÇ≠Ï†ú (ÏùºÎ∞ò Ìï≠Î™©) =====
let editCtx = {cat:null, id:null};
const modal   = $("#editModal");
const mSubj   = $("#mSubj");
const mText   = $("#mText");
const mStart  = $("#mStart");
const mEnd    = $("#mEnd");
const mPStart = $("#mPStart");
const mPEnd   = $("#mPEnd");
const mDetail = $("#mDetail");
const mSave   = $("#mSave");

function openEdit(cat, id){
  if(currentUser?.uid !== ADMIN_UID){ alert("Í¥ÄÎ¶¨ÏûêÎßå ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
  editCtx = {cat, id};
  taskCol(cat).doc(id).get().then(snap=>{
    const it = snap.data();
    mSubj.value   = it.subj || "";
    mText.value   = it.text || "";
    mStart.value  = it.start || "";
    mEnd.value    = it.end   || it.start || "";
    mPStart.value = it.pStart || "";
    mPEnd.value   = it.pEnd   || "";
    mDetail.value = it.detail || "";
    modal.classList.remove("hidden");
  });
}
function closeEdit(){
  modal.classList.add("hidden");
  editCtx = {cat:null, id:null};
}
mSave.onclick = async ()=>{
  if(currentUser?.uid !== ADMIN_UID){ alert("Í¥ÄÎ¶¨ÏûêÎßå ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
  const {cat,id} = editCtx; if(!cat||!id) return;
  const payload = {
    subj:mSubj.value.trim(),
    text:mText.value.trim(),
    start:mStart.value||"",
    end:mEnd.value||mStart.value||"",
    pStart: mPStart.value || "",
    pEnd:   mPEnd.value   || "",
    detail:mDetail.value
  };
  try{
    await taskCol(cat).doc(id).update(payload);
    closeEdit();
  }catch(e){
    alert("ÏàòÏ†ï Ïã§Ìå®: "+e.message);
  }
};
async function doDelete(cat, id){
  if(currentUser?.uid !== ADMIN_UID){ alert("Í¥ÄÎ¶¨ÏûêÎßå ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
  if(!confirm("Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
  try{
    await taskCol(cat).doc(id).delete();
  }catch(e){
    alert("ÏÇ≠Ï†ú Ïã§Ìå®: "+e.message);
  }
}

// ===== 11) Ï†ÑÎã¨ ÏÇ¨Ìï≠ ON/OFF =====
$("#noticeToggle").addEventListener("change", async (e)=>{
  const on = e.target.checked;
  if(currentUser?.uid !== ADMIN_UID){
    // ÏùΩÍ∏∞ Ï†ÑÏö©: Îã§Ïãú ÏõêÎûòÎåÄÎ°ú ÎèåÎ†§ÎÜìÍ≥† ÏïåÎ¶º
    e.target.checked = !on;
    alert("Í¥ÄÎ¶¨ÏûêÎßå ÏÑ§Ï†ïÏùÑ Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§.");
    return;
  }
  try{
    await appSettingsDoc().set({ noticesOn: on }, { merge:true });
  }catch(err){
    alert("ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®: "+err.message);
  }
});

// ===== 12) Ï†ÑÎã¨ ÏÇ¨Ìï≠ ÏàòÏ†ï/ÏÇ≠Ï†ú =====
let nEditId = null;
const nModal = $("#noticeModal");
const nmTitle = $("#nmTitle");
const nmKind  = $("#nmKind");
const nmBody  = $("#nmBody");
const nmSave  = $("#nmSave");

function openNoticeEdit(id){
  if(currentUser?.uid !== ADMIN_UID){ alert("Í¥ÄÎ¶¨ÏûêÎßå ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
  nEditId = id;
  noticesCol().doc(id).get().then(snap=>{
    const n = snap.data();
    nmTitle.value = n.title || "";
    nmKind.value  = n.kind  || "notice";
    nmBody.value  = n.body  || "";
    nModal.classList.remove("hidden");
  });
}
function closeNoticeEdit(){
  nModal.classList.add("hidden");
  nEditId = null;
}
$("#nmClose").onclick = closeNoticeEdit;
nmSave.onclick = async ()=>{
  if(currentUser?.uid !== ADMIN_UID){ alert("Í¥ÄÎ¶¨ÏûêÎßå ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
  if(!nEditId) return;
  try{
    await noticesCol().doc(nEditId).update({
      title: nmTitle.value.trim(),
      kind:  nmKind.value,
      body:  nmBody.value
    });
    closeNoticeEdit();
  }catch(e){
    alert("Ï†ÑÎã¨ ÏÇ¨Ìï≠ ÏàòÏ†ï Ïã§Ìå®: " + e.message);
  }
};
async function deleteNotice(id){
  if(currentUser?.uid !== ADMIN_UID){ alert("Í¥ÄÎ¶¨ÏûêÎßå ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
  if(!confirm("Ï†ÑÎã¨ ÏÇ¨Ìï≠ÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
  try{
    await noticesCol().doc(id).delete();
  }catch(e){
    alert("Ï†ÑÎã¨ ÏÇ¨Ìï≠ ÏÇ≠Ï†ú Ïã§Ìå®: " + e.message);
  }
}
