<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가</title>

  <!-- 파비콘(404 방지) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='48'>📝</text></svg>">

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- 상단 바 -->
  <header class="admin-bar" style="display:flex;gap:12px;align-items:center;justify-content:flex-start;">
    <h1 style="margin-right:auto">📒 숙제 & 수행평가 </h1>
    <button id="loginBtn"  class="btn">🔑 Google 로그인</button>
    <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
  </header>

  <!-- 본문 -->
  <main class="container">
    <!-- 수행평가 -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">📄 수행평가 ▾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>
        <div class="add-row" data-cat="perf" style="display:none">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date" type="date" />
          <button class="add btn">+ 추가</button>
        </div>
      </div>
    </section>

    <!-- 시험 -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">🧪 시험 ▾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date" type="date" />
          <button class="add btn">+ 추가</button>
        </div>
      </div>
    </section>

    <!-- 숙제 -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">📌 숙제 ▾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>
        <div class="add-row" data-cat="home" style="display:none">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date" type="date" />
          <button class="add btn">+ 추가</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 🔧 Firebase 기본 설정을 SDK에 미리 주입( init.json 요청 방지 ) -->
  <script>
    window.__FIREBASE_DEFAULTS__ = {
      config: {
        apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
        authDomain: "my-memo-site.firebaseapp.com",
        projectId: "my-memo-site",
        storageBucket: "my-memo-site.appspot.com",   // 반드시 appspot.com
        messagingSenderId: "196036694705",
        appId: "1:196036694705:web:8988d12919420130464890"
      }
    };
  </script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase 초기화 (가드) -->
  <script>
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FIREBASE_DEFAULTS__.config);
    }
  </script>

  <!-- ===== 공용 유틸/상태 ===== -->
  <script>
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";   // 로그아웃 상태에서 읽기용
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const el = {
      loginBtn:  $("#loginBtn"),
      logoutBtn: $("#logoutBtn"),
      lists:     { perf: $("#list_perf"), exam: $("#list_exam"), home: $("#list_home") }
    };

    let currentUser = null;
    let unsubscribers = [];

    function toggleSection(id){
      const box = document.getElementById(id);
      if(!box) return;
      box.classList.toggle("open");
      saveOpenState();
    }

    function setEditVisible(v){
      $$(".add-row").forEach(r => r.style.display = v ? "" : "none");
      $$(".btn-ghost").forEach(b => b.style.display = v ? "" : "none");
    }

    const DRAFT_KEY = "memo:draft-v1";
    const OPEN_KEY  = "memo:open-v1";

    function gatherDraft(){
      const data = {};
      $$(".add-row").forEach(row=>{
        const cat  = row.dataset.cat;
        data[cat] = {
          subj: $(".subj", row).value,
          text: $(".text", row).value,
          date: $(".date", row).value
        };
      });
      return data;
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        $$(".add-row").forEach(row=>{
          const d = data?.[row.dataset.cat];
          if(!d) return;
          $(".subj", row).value = d.subj || "";
          $(".text", row).value = d.text || "";
          $(".date", row).value = d.date || "";
        });
      }catch{}
    }
    function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft())); }
    function clearDraft(){ localStorage.removeItem(DRAFT_KEY); }
    document.addEventListener("input", e=>{
      if(e.target.closest(".add-row")) saveDraft();
    });
    function afterAdded(row){
      $(".subj", row).value = "";
      $(".text", row).value = "";
      $(".date", row).value = "";
      saveDraft();
    }

    function saveOpenState(){
      const state = {
        perf: $("#sec_perf")?.classList.contains("open"),
        exam: $("#sec_exam")?.classList.contains("open"),
        home: $("#sec_home")?.classList.contains("open"),
      };
      localStorage.setItem(OPEN_KEY, JSON.stringify(state));
    }
    function loadOpenState(){
      try{
        const s = JSON.parse(localStorage.getItem(OPEN_KEY) || "{}");
        if(s.perf === false) $("#sec_perf")?.classList.remove("open");
        if(s.exam === false) $("#sec_exam")?.classList.remove("open");
        if(s.home === false) $("#sec_home")?.classList.remove("open");
      }catch{}
    }

    const col = (cat) => {
      const uid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;
      return db.collection("users").doc(uid)
               .collection("tasks").doc(cat).collection("items");
    };

    function startListeners(){
      unsubscribers.forEach(u => u && u());
      unsubscribers = [];

      ["perf","exam","home"].forEach(cat => {
        const u = col(cat).orderBy("due","asc").onSnapshot(
          snap => {
            const arr = [];
            snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
            renderList(cat, arr);
          },
          err => {
            console.error("listener error:", err);
            alert("목록을 불러오지 못했습니다: " + err.message);
          }
        );
        unsubscribers.push(u);
      });

      loadDraft();
      loadOpenState();
    }

    function renderList(cat, items){
      const ul = el.lists[cat];
      ul.innerHTML = "";
      for(const it of items){
        const li = document.createElement("li");
        li.className = "task" + (it.done ? " done" : "");
        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""}
                   data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>
          <div class="task__main">
            <div class="task__line">
              <b>${esc(it.subj||"")}</b><span class="sep">–</span>
              <span>${esc(it.text||"")}</span>
            </div>
            <div class="task__meta">${it.due ? `📅 ${it.due}` : ""}</div>
          </div>
          <button class="btn-ghost" data-act="del" data-cat="${cat}" data-id="${it.id}"
                  style="display:${currentUser?'':'none'}">삭제</button>
        `;
        ul.appendChild(li);
      }

      ul.onclick = async (e)=>{
        const t = e.target;
        const act = t.getAttribute("data-act");
        if(!act) return;

        if(!currentUser){
          alert("수정/삭제는 로그인 후 가능합니다.");
          if(act === "toggle") t.checked = !t.checked;
          return;
        }

        const cat2 = t.getAttribute("data-cat");
        const id   = t.getAttribute("data-id");
        try{
          if(act === "toggle"){
            await col(cat2).doc(id).update({ done: t.checked });
          }else if(act === "del"){
            await col(cat2).doc(id).delete();
          }
        }catch(e){
          alert("변경 실패: " + e.message);
          console.error(e);
        }
      };
    }

    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn = $(".add", row);
        const cat = row.dataset.cat;
        btn.onclick = async ()=>{
          if(!currentUser){ alert("로그인 후 추가할 수 있어요."); return; }
          const subj = $(".subj", row).value.trim();
          const text = $(".text", row).value.trim();
          const date = $(".date", row).value || "";
          if(!subj || !text){ alert("과목/내용을 입력해 주세요."); return; }

          try{
            await col(cat).add({
              subj, text, due: date || "", done: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            afterAdded(row);
          }catch(e){
            alert("저장 실패: " + e.message);
            console.error(e);
          }
        };
      });
    }

    function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  </script>

  <!-- ===== 로그인: 리다이렉트 기본 + 팝업 백업 ===== -->
  <script>
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });

  // 한국어 UI (선택)
  auth.useDeviceLanguage?.();

  // 세션 LOCAL 강제
  async function ensureLocal() {
    try {
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    } catch (e) {
      console.error('setPersistence 실패:', e);
      alert('세션 저장 실패: ' + (e.code || e.message));
    }
  }

  // 화면에 모든 에러를 띄우는 헬퍼
  function showAuthError(e, where) {
    const code = e?.code || 'unknown';
    const msg  = e?.message || String(e);
    console.error(`[AUTH][${where}] ${code} ${msg}`, e);
    alert(`로그인 오류(${where}): ${code}\n${msg}`);
  }

  // ✅ 팝업만 강제 (리다이렉트 사용 안 함)
  el.loginBtn.addEventListener('click', async () => {
    try {
      await ensureLocal();
      const res = await auth.signInWithPopup(provider);
      console.log('✅ 팝업 로그인 성공:', res.user?.uid);
      alert('로그인 성공! uid: ' + res.user?.uid);
    } catch (e) {
      showAuthError(e, 'popup');
    }
  });

  el.logoutBtn.addEventListener('click', async () => {
    try {
      await auth.signOut();
      alert('로그아웃 완료');
    } catch (e) {
      showAuthError(e, 'signOut');
    }
  });

  // 리다이렉트 결과는 이번 테스트에선 사용 안 함
  // auth.getRedirectResult() ... <-- 주석 처리하거나 제거

  // 상태 변화 로그
  auth.onAuthStateChanged(user => {
    console.log('[onAuthStateChanged]', user?.uid || null);
    el.loginBtn.style.display  = user ? 'none' : '';
    el.logoutBtn.style.display = user ? '' : 'none';
    setEditVisible(!!user);
    bindAddRows();
    startListeners();
  });
</script>

</body>
</html>
