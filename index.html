<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="spacer"></div>
    <button id="loginBtn"  class="btn">ğŸ”‘ ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <main class="container">

    <!-- === ìˆœì„œ 1 : ì‹œí—˜ === -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">ğŸ§ª ì‹œí—˜ â–¾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>

        <!-- ì¶”ê°€ í¼ -->
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <div class="row">
            <input class="date date-start" type="date" />
            <span class="tilde">~</span>
            <input class="date date-end" type="date" />
          </div>
          <div class="row">
            <select class="p-start">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>0êµì‹œ</option>
            </select>
            <select class="p-end">
              <option value="">ë êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>0êµì‹œ</option>
            </select>
          </div>
          <button class="add btn primary">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- === ìˆœì„œ 2 : ìˆ˜í–‰í‰ê°€ === -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">ğŸ“„ ìˆ˜í–‰í‰ê°€ â–¾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>

        <div class="add-row" data-cat="perf" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <div class="row">
            <input class="date date-start" type="date" />
            <span class="tilde">~</span>
            <input class="date date-end" type="date" />
          </div>
          <div class="row">
            <select class="p-start">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>0êµì‹œ</option>
            </select>
            <select class="p-end">
              <option value="">ë êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>0êµì‹œ</option>
            </select>
          </div>
          <button class="add btn primary">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- === ìˆœì„œ 3 : ìˆ™ì œ === -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>

        <div class="add-row" data-cat="home" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <div class="row">
            <input class="date date-start" type="date" />
            <span class="tilde">~</span>
            <input class="date date-end" type="date" />
          </div>
          <div class="row">
            <select class="p-start">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>0êµì‹œ</option>
            </select>
            <select class="p-end">
              <option value="">ë êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>0êµì‹œ</option>
            </select>
          </div>
          <button class="add btn primary">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” (ë„¤ ê°’ ìœ ì§€) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    /* ===== ê¸°ë³¸ ===== */
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";  // ë¹„ë¡œê·¸ì¸ ì½ê¸°ìš©
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

    const el = {
      loginBtn:  $("#loginBtn"),
      logoutBtn: $("#logoutBtn"),
      lists: { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") }
    };

    let currentUser = null;
    let unsubscribers = [];

    function toggleSection(id){
      const box = document.getElementById(id);
      if(!box) return;
      box.classList.toggle("open");
    }

    function setEditVisible(v){
      $$(".add-row").forEach(r => r.style.display = v ? "" : "none");
      $$(".btn-ghost").forEach(b => b.style.display = v ? "" : "none");
    }

    // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ
    const col = (cat) => {
      const uid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;
      return db.collection("users").doc(uid)
               .collection("tasks").doc(cat).collection("items");
    };

    /* ===== D-day ===== */
    const weekday = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    function toDate(s){ if(!s) return null; const d = new Date(s); return isNaN(d)? null : d; }
    function dateLabel(d){
      if(!d) return "";
      const D = toDate(d);
      return `${D.getFullYear()}-${String(D.getMonth()+1).padStart(2,"0")}-${String(D.getDate()).padStart(2,"0")} (${weekday[D.getDay()]})`;
    }
    function renderDdayLabel(endDate, dueDate, startDate){
      const target = toDate(endDate) || toDate(dueDate) || toDate(startDate);
      if(!target) return "";
      const today = new Date(); today.setHours(0,0,0,0);
      target.setHours(0,0,0,0);
      const diff = Math.floor((target - today) / (1000*60*60*24));

      let label = "", cls = "";
      if (diff === 0) {
        label = "D-Day"; cls = "red";
      } else if (diff > 0) {
        label = `D-${diff}`;
        if (diff === 1) cls = "red";
        else if (diff <= 3) cls = "orange";
        else if (diff <= 5) cls = "yellow";
        else cls = "green";
      } else {
        // ì§€ë‚œ ì¼ì • â†’ A+N (ëŒ€ë¬¸ì ë³´ì¥)
        label = `A+${Math.abs(diff)}`.toUpperCase();
        cls = "past";
      }
      return `<span class="dday ${cls}">${label}</span>`;
    }

    /* ===== ë Œë”ë§ ===== */
    function renderList(cat, items){
      const ul = el.lists[cat];
      ul.innerHTML = "";
      for(const it of items){
        const li = document.createElement("li");
        li.className = "task" + (it.done ? " done" : "");
        // êµì‹œ ë¼ë²¨
        const period = (it.pStart && it.pEnd)
          ? ` ${it.pStart.replace("êµì‹œ","")}~${it.pEnd.replace("êµì‹œ","")}êµì‹œ`
          : (it.pStart ? ` ${it.pStart}` : (it.pEnd ? ` ${it.pEnd}` : ""));
        const dateText = (it.startDate || it.endDate)
          ? `${dateLabel(it.startDate)}${it.endDate ? " ~ " + dateLabel(it.endDate) : ""}${period}`
          : "";

        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""}
                   data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>

          <div class="task__content">
            <div class="line1">
              <b class="subj">${esc(it.subj||"")}</b>
              <span class="dday-wrap">${renderDdayLabel(it.endDate, it.dueDate, it.startDate)}</span>
            </div>

            <div class="line2">${esc(it.text||"")}</div>
            ${it.detail ? `<div class="line3">${esc(it.detail)}</div>` : ""}

            <div class="line4">${dateText ? `ğŸ“… ${dateText}` : ""}</div>
          </div>

          <div class="actions">
            <button class="btn-ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
            <button class="btn-ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);
      }

      // ì•¡ì…˜
      ul.onclick = async (e)=>{
        const t = e.target;
        const act = t.getAttribute("data-act");
        if(!act) return;

        const cat2 = t.getAttribute("data-cat");
        const id   = t.getAttribute("data-id");

        if(act === "toggle"){
          if(!currentUser){ t.checked = !t.checked; alert("ë¡œê·¸ì¸ í›„ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”."); return; }
          try{ await col(cat2).doc(id).update({ done: t.checked }); }
          catch(e){ alert("ë³€ê²½ ì‹¤íŒ¨: "+e.message); t.checked=!t.checked; }
        }
        if(act === "del"){
          if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”."); return; }
          if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
          try{ await col(cat2).doc(id).delete(); }catch(e){ alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
        }
        if(act === "edit"){
          if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”."); return; }
          openEditDialog(cat2, id);
        }
      };
    }

    function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    /* ===== ì‹¤ì‹œê°„ êµ¬ë… ===== */
    function startListeners(){
      unsubscribers.forEach(u => u && u());
      unsubscribers = [];
      ["exam","perf","home"].forEach(cat=>{
        const u = col(cat).orderBy("due","asc").onSnapshot(
          snap=>{
            const arr = [];
            snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
            renderList(cat, arr);
          },
          err => console.error(err)
        );
        unsubscribers.push(u);
      });
    }

    /* ===== ì¶”ê°€ í¼ ===== */
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn = $(".add", row);
        const cat = row.dataset.cat;
        btn.onclick = async ()=>{
          if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }
          const subj = $(".subj", row).value.trim();
          const text = $(".text", row).value.trim();
          const detail = $(".detail", row).value.trim();
          const sDate = $(".date-start", row).value;
          const eDate = $(".date-end", row).value;
          const pStart= $(".p-start", row).value;
          const pEnd  = $(".p-end", row).value;

          if(!subj || !text){ alert("ê³¼ëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

          try{
            await col(cat).add({
              subj, text, detail,
              startDate: sDate || "",
              endDate:   eDate || "",
              due: eDate || sDate || "",
              pStart, pEnd,
              done:false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            $(".subj",row).value = ""; $(".text",row).value=""; $(".detail",row).value="";
            $(".date-start",row).value=""; $(".date-end",row).value="";
            $(".p-start",row).value=""; $(".p-end",row).value="";
          }catch(e){ alert("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
        };
      });
    }

    /* ===== ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸ (ê°„ë‹¨) ===== */
    function openEditDialog(cat,id){
      // ê°„ë‹¨íˆ prompt ë°©ì‹ (í•„ìš”í•˜ë©´ ì¶”í›„ ëª¨ë‹¬ë¡œ ê°œì„  ê°€ëŠ¥)
      col(cat).doc(id).get().then(doc=>{
        if(!doc.exists) return;
        const it = doc.data();
        const subj = prompt("ê³¼ëª©", it.subj || "");
        if(subj===null) return;
        const text = prompt("ë‚´ìš©", it.text || "");
        if(text===null) return;
        const detail = prompt("ìƒì„¸ë‚´ìš©", it.detail || "");
        if(detail===null) return;
        const startDate = prompt("ì‹œì‘ì¼(YYYY-MM-DD)", it.startDate || "");
        if(startDate===null) return;
        const endDate = prompt("ì¢…ë£Œì¼(YYYY-MM-DD)", it.endDate || "");
        if(endDate===null) return;
        const pStart = prompt("ì‹œì‘êµì‹œ (ì˜ˆ: 1êµì‹œ)", it.pStart || "");
        if(pStart===null) return;
        const pEnd = prompt("ëêµì‹œ (ì˜ˆ: 2êµì‹œ)", it.pEnd || "");
        if(pEnd===null) return;

        col(cat).doc(id).update({
          subj, text, detail,
          startDate, endDate,
          due: endDate || startDate || "",
          pStart, pEnd
        });
      });
    }

    /* ===== ë¡œê·¸ì¸ ===== */
    el.loginBtn.addEventListener("click", async ()=>{
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      }catch(e){
        alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.code}\n${e.message}`);
      }
    });
    el.logoutBtn.addEventListener("click", ()=> auth.signOut());

    auth.onAuthStateChanged(user=>{
      currentUser = user;
      el.loginBtn.style.display  = user? "none": "";
      el.logoutBtn.style.display = user? "": "none";
      setEditVisible(!!user);
      bindAddRows();
      startListeners();
    });
  </script>
</body>
</html>
