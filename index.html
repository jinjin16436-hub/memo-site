<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1í•™ë…„ 1ë°˜ ìˆ˜í–‰í‰ê°€ & ìˆ™ì œ</title>

  <!-- íŒŒë¹„ì½˜(404 ë°©ì§€) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='48'>ğŸ“</text></svg>">

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="admin-bar" style="display:flex;gap:12px;align-items:center;justify-content:flex-start;">
    <h1 style="margin-right:auto">ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€ </h1>
    <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <!-- ë³¸ë¬¸ -->
  <main class="container">
    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">ğŸ“„ ìˆ˜í–‰í‰ê°€ â–¾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>
        <div class="add-row" data-cat="perf" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <!-- ì‹œì‘/ë êµì‹œ -->
          <select class="periodFrom">
            <option value="">ì‹œì‘êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="periodTo">
            <option value="">ëêµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">ğŸ§ª ì‹œí—˜ â–¾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <select class="periodFrom">
            <option value="">ì‹œì‘êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="periodTo">
            <option value="">ëêµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>
        <div class="add-row" data-cat="home" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <select class="periodFrom">
            <option value="">ì‹œì‘êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="periodTo">
            <option value="">ëêµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase ê¸°ë³¸ ì„¤ì • -->
  <script>
    window.__FIREBASE_DEFAULTS__ = {
      config: {
        apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
        authDomain: "my-memo-site.firebaseapp.com",
        projectId: "my-memo-site",
        storageBucket: "my-memo-site.appspot.com",
        messagingSenderId: "196036694705",
        appId: "1:196036694705:web:8988d12919420130464890"
      }
    };
  </script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” -->
  <script>
    if (!firebase.apps.length) {
      firebase.initializeApp(window.__FIREBASE_DEFAULTS__.config);
    }
  </script>

  <!-- ===== ì•± ì½”ë“œ ===== -->
  <script>
    /* ---------- ìƒìˆ˜/í•¸ë“¤ ---------- */
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";   // ë„¤ UID
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const el = {
      loginBtn:  $("#loginBtn"),
      logoutBtn: $("#logoutBtn"),
      lists:     { perf: $("#list_perf"), exam: $("#list_exam"), home: $("#list_home") }
    };

    /* ---------- ê¶Œí•œ/ê²½ë¡œ ---------- */
    const isOwner = () => auth.currentUser?.uid === OWNER_UID;
    const col = (cat) =>
      db.collection("users").doc(OWNER_UID)
        .collection("tasks").doc(cat).collection("items");

    /* ---------- UI í† ê¸€/ìƒíƒœ ---------- */
    function toggleSection(id){
      const box = document.getElementById(id);
      if(!box) return;
      box.classList.toggle("open");
      saveOpenState();
    }
    function setEditVisible(v){
      $$(".add-row").forEach(r => r.style.display = v ? "" : "none");
      $$(".btn-ghost").forEach(b => b.style.display = v ? "" : "none");
    }

    /* ---------- ì„ì‹œì €ì¥(ì…ë ¥/í¼ì¹¨) ---------- */
    const DRAFT_KEY = "memo:draft-v2"; // (êµì‹œ í¬í•¨)
    const OPEN_KEY  = "memo:open-v1";

    function gatherDraft(){
      const data = {};
      $$(".add-row").forEach(row=>{
        const cat = row.dataset.cat;
        data[cat] = {
          subj: $(".subj", row).value,
          text: $(".text", row).value,
          date: $(".date", row).value,
          periodFrom: $(".periodFrom", row)?.value || "",
          periodTo:   $(".periodTo", row)?.value   || ""
        };
      });
      return data;
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        $$(".add-row").forEach(row=>{
          const d = data?.[row.dataset.cat];
          if(!d) return;
          $(".subj", row).value = d.subj || "";
          $(".text", row).value = d.text || "";
          $(".date", row).value = d.date || "";
          const pf = $(".periodFrom", row); if (pf) pf.value = d.periodFrom || "";
          const pt = $(".periodTo", row);   if (pt) pt.value = d.periodTo   || "";
        });
      }catch{}
    }
    function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft())); }
    function clearDraft(){ localStorage.removeItem(DRAFT_KEY); }
    document.addEventListener("input",  e => { if(e.target.closest(".add-row")) saveDraft(); });
    document.addEventListener("change", e => { if(e.target.closest(".add-row")) saveDraft(); });

    function saveOpenState(){
      const state = {
        perf: $("#sec_perf")?.classList.contains("open"),
        exam: $("#sec_exam")?.classList.contains("open"),
        home: $("#sec_home")?.classList.contains("open"),
      };
      localStorage.setItem(OPEN_KEY, JSON.stringify(state));
    }
    function loadOpenState(){
      try{
        const s = JSON.parse(localStorage.getItem(OPEN_KEY) || "{}");
        if(s.perf === false) $("#sec_perf")?.classList.remove("open");
        if(s.exam === false) $("#sec_exam")?.classList.remove("open");
        if(s.home === false) $("#sec_home")?.classList.remove("open");
      }catch{}
    }

    /* ---------- ì‹¤ì‹œê°„ êµ¬ë… ---------- */
    let unsubscribers = [];
    function startListeners(){
      unsubscribers.forEach(u => u && u());
      unsubscribers = [];

      ["perf","exam","home"].forEach(cat => {
        const u = col(cat).orderBy("due","asc").onSnapshot(
          snap => {
            const arr = [];
            snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
            renderList(cat, arr);
          },
          err => {
            console.error("listener error:", err);
            alert("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + err.message);
          }
        );
        unsubscribers.push(u);
      });

      loadDraft();
      loadOpenState();
    }

    /* ---------- ë‚ ì§œ/ìš”ì¼/êµì‹œ/D-day í¬ë§· ---------- */
    function formatMeta(it){
      let meta = "";
      let ddayHtml = "";

      if (it.due) {
        const d = new Date(it.due);
        if (!isNaN(d)) {
          const wd = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
          meta = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} (${wd})`;

          // D-day (ì„¸ë¶„í™” ìƒ‰ìƒ)
          const today = new Date(); today.setHours(0,0,0,0);
          const dueDay = new Date(d); dueDay.setHours(0,0,0,0);
          const diff = Math.floor((dueDay - today) / (1000*60*60*24));

          if (diff === 0) {
            ddayHtml = `<span class="dday red">D-day</span>`;
          } else if (diff === 1) {
            ddayHtml = `<span class="dday red">D-1</span>`;
          } else if (diff >= 2 && diff <= 3) {
            ddayHtml = `<span class="dday orange">D-${diff}</span>`;
          } else if (diff >= 4 && diff <= 5) {
            ddayHtml = `<span class="dday yellow">D-${diff}</span>`;
          } else if (diff >= 6) {
            ddayHtml = `<span class="dday green">D-${diff}</span>`;
          } else {
            ddayHtml = `<span class="dday past">D+${Math.abs(diff)}</span>`;
          }
        } else {
          meta = it.due;
        }
      }

      const pf = it.periodFrom, pt = it.periodTo;
      if (Number.isFinite(pf) && Number.isFinite(pt)) {
        meta += ` ${pf===pt ? `${pf}êµì‹œ` : `${pf}~${pt}êµì‹œ`}`;
      }

      return (meta || ddayHtml) ? `ğŸ“… ${meta} ${ddayHtml}`.trim() : "";
    }

    /* ---------- ëª©ë¡ ë Œë”ë§ ---------- */
    function renderList(cat, items){
      const ul = el.lists[cat];
      ul.innerHTML = "";
      for(const it of items){
        const li = document.createElement("li");
        li.className = "task" + (it.done ? " done" : "");
        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""}
                   data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>
          <div class="task__main">
            <div class="task__line">
              <b>${esc(it.subj||"")}</b><span class="sep">â€“</span>
              <span>${esc(it.text||"")}</span>
            </div>
            <div class="task__meta">${formatMeta(it)}</div>
          </div>
          <button class="btn-ghost" data-act="del" data-cat="${cat}" data-id="${it.id}"
                  style="display:${isOwner()?'':'none'}">ì‚­ì œ</button>
        `;
        ul.appendChild(li);
      }

      // ì²´í¬ë°•ìŠ¤(change)
      ul.onchange = async (e) => {
        const t = e.target;
        if (!(t instanceof HTMLInputElement) || t.type !== "checkbox") return;
        if (t.getAttribute("data-act") !== "toggle") return;
        const cat2 = t.getAttribute("data-cat");
        const id   = t.getAttribute("data-id");
        if (!isOwner()) {
          alert("ì™„ë£Œ ì²´í¬ëŠ” ì†Œìœ ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          t.checked = !t.checked;
          return;
        }
        try {
          await col(cat2).doc(id).update({ done: t.checked });
        } catch (e) {
          console.error(e);
          alert("ë³€ê²½ ì‹¤íŒ¨: " + e.message);
          t.checked = !t.checked;
        }
      };

      // ì‚­ì œ(click)
      ul.onclick = async (e) => {
        const btn = e.target.closest('[data-act="del"]');
        if (!btn) return;
        if (!isOwner()) {
          alert("ì‚­ì œëŠ” ì†Œìœ ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return;
        }
        const cat2 = btn.getAttribute("data-cat");
        const id   = btn.getAttribute("data-id");
        try {
          await col(cat2).doc(id).delete();
        } catch (e) {
          console.error(e);
          alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
        }
      };
    }

    /* ---------- +ì¶”ê°€ (ì „ì—­ ìœ„ì„) ---------- */
    function bindAddRows(){
      if (bindAddRows._installed) return;
      bindAddRows._installed = true;

      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.add-row .add');
        if (!btn) return;

        const row = btn.closest('.add-row');
        const cat = row?.dataset?.cat;
        if (!cat) return;

        if(!isOwner()){
          alert("ì¶”ê°€ëŠ” ì†Œìœ ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return;
        }

        const subj = $(".subj", row).value.trim();
        const text = $(".text", row).value.trim();
        const date = $(".date", row).value || "";
        const pf = parseInt($(".periodFrom", row)?.value || "", 10);
        const pt = parseInt($(".periodTo", row)?.value   || "", 10);

        const pfOk = Number.isFinite(pf), ptOk = Number.isFinite(pt);
        if ((pfOk && !ptOk) || (!pfOk && ptOk)) {
          alert("êµì‹œëŠ” ì‹œì‘/ëì„ ë‘˜ ë‹¤ ì„ íƒí•˜ê±°ë‚˜ ë‘˜ ë‹¤ ë¹„ì›Œë‘ì„¸ìš”.");
          return;
        }
        if (pfOk && ptOk && pf > pt) {
          alert("ì‹œì‘ êµì‹œê°€ ë êµì‹œë³´ë‹¤ í´ ìˆ˜ ì—†ì–´ìš”.");
          return;
        }
        if(!subj || !text){
          alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }

        try{
          await col(cat).add({
            subj, text, due: date || "",
            periodFrom: pfOk ? pf : null,
            periodTo:   ptOk ? pt : null,
            done: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          afterAdded(row);
          console.log('[ADD ok]');
        }catch(e){
          console.error("ADD ERR:", e.code, e.message, e);
          alert(`ì¶”ê°€ ì‹¤íŒ¨: ${e.code}\n${e.message}`);
        }
      });
    }

    /* ---------- ë„ìš°ë¯¸ ---------- */
    function afterAdded(row){
      $(".subj", row).value = "";
      $(".text", row).value = "";
      $(".date", row).value = "";
      const pf = $(".periodFrom", row); if (pf) pf.value = "";
      const pt = $(".periodTo", row);   if (pt) pt.value = "";
      saveDraft();
    }
    function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    /* ---------- ë¡œê·¸ì¸: íŒì—… ì „ìš© ---------- */
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    auth.useDeviceLanguage?.();

    async function ensureLocal() {
      try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); }
      catch (e) { console.error('setPersistence ì‹¤íŒ¨:', e); }
    }

    el.loginBtn.addEventListener("click", async () => {
      saveDraft(); saveOpenState();
      await ensureLocal();
      try {
        const r = await auth.signInWithPopup(provider);
        console.log('âœ… íŒì—… ë¡œê·¸ì¸ ì„±ê³µ:', r.user?.uid);
      } catch (e) {
        console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', e);
        alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.code}\n${e.message}`);
      }
    });

    el.logoutBtn.addEventListener("click", async () => {
      try { await auth.signOut(); }
      catch(e){ console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', e); }
    });

    /* ---------- ì„¸ì…˜ ë³€í™” ---------- */
    auth.onAuthStateChanged(user => {
      console.log('[onAuthStateChanged]', user?.uid || null);
      el.loginBtn.style.display  = user ? "none" : "";
      el.logoutBtn.style.display = user ? "" : "none";
      setEditVisible(isOwner());
      bindAddRows();
      startListeners();
    });
  </script>
</body>
</html>
