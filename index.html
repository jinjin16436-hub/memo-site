<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="topbar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="right">
      <!-- ê´€ë¦¬ì ì „ìš©: ì¤‘ìš” ì „ë‹¬ì‚¬í•­ ON/OFF -->
      <div id="impSwitchWrap" class="imp-switch" style="display:none">
        <label>
          <input id="toggleImportant" type="checkbox">
          ì¤‘ìš” ì „ë‹¬ì‚¬í•­ í‘œì‹œ
        </label>
      </div>
      <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <main class="container">
    <!-- ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ (ê´€ë¦¬ìê°€ ONì¼ ë•Œë§Œ ë³´ì„) -->
    <section id="sec_important" class="board">
      <div class="board__head">
        <h2>ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</h2>
      </div>
      <ul id="list_important" class="task-list"></ul>

      <!-- ê´€ë¦¬ì ì „ìš© ì…ë ¥ -->
      <div class="add-row" data-cat="important" style="display:none">
        <div class="row-1">
          <input class="subj" type="text" placeholder="ì œëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date from" type="date" />
          <input class="date to"   type="date" />
          <select class="startp">
            <option value="0">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="endp">
            <option value="0">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
        <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section class="board">
      <div class="board__head">
        <h2>ğŸ§ª ì‹œí—˜</h2>
      </div>
      <ul id="list_exam" class="task-list"></ul>

      <!-- ê´€ë¦¬ì ì „ìš© ì…ë ¥ -->
      <div class="add-row" data-cat="exam" style="display:none">
        <div class="row-1">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date from" type="date" />
          <input class="date to"   type="date" />
          <select class="startp">
            <option value="0">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="endp">
            <option value="0">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
        <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
      </div>
    </section>

    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section class="board">
      <div class="board__head">
        <h2>ğŸ“„ ìˆ˜í–‰í‰ê°€</h2>
      </div>
      <ul id="list_perf" class="task-list"></ul>

      <!-- ê´€ë¦¬ì ì „ìš© ì…ë ¥ -->
      <div class="add-row" data-cat="perf" style="display:none">
        <div class="row-1">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date from" type="date" />
          <input class="date to"   type="date" />
          <select class="startp">
            <option value="0">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="endp">
            <option value="0">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
        <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section class="board">
      <div class="board__head">
        <h2>ğŸ“Œ ìˆ™ì œ</h2>
      </div>
      <ul id="list_home" class="task-list"></ul>

      <!-- ê´€ë¦¬ì ì „ìš© ì…ë ¥ -->
      <div class="add-row" data-cat="home" style="display:none">
        <div class="row-1">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date from" type="date" />
          <input class="date to"   type="date" />
          <select class="startp">
            <option value="0">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="endp">
            <option value="0">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
        <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
      </div>
    </section>
  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” (ë„¤ ê°’ìœ¼ë¡œ êµì²´) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ì•± ì½”ë“œ -->
  <script>
    /* ---------- ê¸°ë³¸ í•¸ë“¤ ---------- */
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ğŸ” ì†Œìœ ì UID (ê´€ë¦¬ì ê³„ì •)
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

    const $  = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

    const lists = {
      important: $("#list_important"),
      exam:      $("#list_exam"),
      perf:      $("#list_perf"),
      home:      $("#list_home"),
    };
    const addRows = $$(".add-row");

    // ë§ˆì§€ë§‰ ìŠ¤ëƒ…ìƒ· ìºì‹œ â†’ 1ë¶„ë§ˆë‹¤ â€œì¡°ìš©íˆâ€ ì¬ë Œë”
    const lastData = { important:[], exam:[], perf:[], home:[] };

    let currentUser = null;

    function isOwner() {
      return currentUser && currentUser.uid === OWNER_UID;
    }

    /* ---------- Firestore ì°¸ì¡° ---------- */
    // ì½ê¸°: í•­ìƒ OWNERì˜ ë°ì´í„° (ê³µê°œìš©)
    function colRO(cat) {
      return db.collection("users").doc(OWNER_UID).collection("tasks").doc(cat).collection("items");
    }
    // ì“°ê¸°: ë°˜ë“œì‹œ ê´€ë¦¬ìë§Œ (ë³´ì•ˆê·œì¹™+í´ë¼ì´ì–¸íŠ¸ ì´ì¤‘ì°¨ë‹¨)
    function colRW(cat) {
      if (!isOwner()) throw new Error("ê´€ë¦¬ìë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return colRO(cat);
    }

    /* ---------- ë‚ ì§œ/ìš”ì¼/êµì‹œ ---------- */
    const wd = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    function fmtDate(dStr){
      if(!dStr) return "";
      const d = new Date(dStr+"T00:00:00");
      return `${dStr} (${wd[d.getDay()]})`;
    }
    function periods(s,e){
      s = (s||"").replace("êµì‹œ","");
      e = (e||"").replace("êµì‹œ","");
      if(!s || s==='0' || !e || e==='0') return "";
      if(s===e) return `${s}êµì‹œ`;
      return `${s}~${e}êµì‹œ`;
    }
    function formatRange(a,b){
      if(!a && !b) return "";
      if(!a && b) return fmtDate(b);
      if(a && !b) return fmtDate(a);
      return `${fmtDate(a)} ~ ${fmtDate(b)}`;
    }

    /* ---------- D-Day ë°°ì§€ ---------- */
    function dayDiff(dStr){
      if(!dStr) return null;
      const tz = new Date().toISOString().slice(0,10);
      const a = new Date(tz+"T00:00:00");
      const b = new Date(dStr+"T00:00:00");
      return Math.round((b - a) / 86400000);
    }
    function ddayBadge(dStr){
      const diff = dayDiff(dStr);
      if(diff===null) return "";
      let label, cls;
      if(diff > 0){
        label = `D-${diff}`;
        if(diff===1) cls="dd-red";
        else if(diff<=3) cls="dd-orange";
        else if(diff<=5) cls="dd-yellow";
        else cls="dd-green";
      }else if(diff === 0){
        label = "D-DAY"; cls="dd-red";
      }else{
        label = `D+${Math.abs(diff)}`;
        cls="dd-gray";
      }
      return `<span class="dd-badge ${cls}">${label}</span>`;
    }

    /* ---------- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ---------- */
    $("#loginBtn").onclick  = ()=> auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    $("#logoutBtn").onclick = ()=> auth.signOut();

    auth.onAuthStateChanged(u=>{
      currentUser = u || null;
      $("#loginBtn").style.display  = currentUser ? "none" : "";
      $("#logoutBtn").style.display = currentUser ? "" : "none";

      // ê´€ë¦¬ìë§Œ ì…ë ¥/í¸ì§‘ UI ë…¸ì¶œ
      setEditVisible(isOwner());
      // ê´€ë¦¬ìë§Œ ì¤‘ìš” ì „ë‹¬ ìŠ¤ìœ„ì¹˜ ë³´ì´ê¸°
      $("#impSwitchWrap").style.display = isOwner() ? "" : "none";

      startListeners();
      watchSettings();
    });

    function setEditVisible(v){
      addRows.forEach(r => r.style.display = v ? "" : "none");
    }

    /* ---------- ì¤‘ìš” ì „ë‹¬ì‚¬í•­ ON/OFF (ì„¤ì • ì €ì¥) ---------- */
    const settingsDoc = db.collection("users").doc(OWNER_UID).collection("config").doc("ui");

    function applyImportantVisibility(show){
      $("#sec_important").style.display = show ? "" : "none";
      const sw = $("#toggleImportant");
      if(sw) sw.checked = !!show;
    }

    function watchSettings(){
      // í•­ìƒ OWNER ì„¤ì • ì½ê¸°
      settingsDoc.onSnapshot(snap=>{
        const data = snap.exists ? snap.data() : {};
        const show = (data.showImportant !== false);
        applyImportantVisibility(show);
      });

      const sw = $("#toggleImportant");
      if(sw){
        sw.onchange = async (e)=>{
          if(!isOwner()){       // ë¹„ê´€ë¦¬ì ì°¨ë‹¨ + ì¦‰ì‹œ ë³µì›
            sw.checked = !sw.checked;
            alert("ê´€ë¦¬ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          try{
            await settingsDoc.set({ showImportant: e.target.checked }, { merge:true });
          }catch(err){
            sw.checked = !sw.checked;
            alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: " + (err?.message || err));
          }
        };
      }
    }

    /* ---------- ì‹¤ì‹œê°„ êµ¬ë… ---------- */
    let unsubscribers = [];
    function startListeners(){
      unsubscribers.forEach(u=>u&&u()); unsubscribers=[];
      ["important","exam","perf","home"].forEach(cat=>{
        const ref = colRO(cat);
        const q = (cat === "important")
          ? ref.orderBy("createdAt","desc")
          : ref.orderBy("dateFrom","asc");
        const un = q.onSnapshot(snap=>{
          const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
          lastData[cat] = arr;           // âœ… ìºì‹œ
          renderList(cat, arr);
        },err=>console.error(err));
        unsubscribers.push(un);
      });
    }

    // ğŸ”„ 1ë¶„ë§ˆë‹¤ â€œì¡°ìš©í•œ ê°±ì‹ â€ (ì„œë²„í˜¸ì¶œ ì—†ì´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°)
    setInterval(()=>{
      ["important","exam","perf","home"].forEach(cat=>{
        if(lastData[cat]) renderList(cat, lastData[cat]);
      });
    }, 60_000);

    /* ---------- ë Œë” ---------- */
    function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function renderList(cat, items){
      const ul = lists[cat];
      ul.innerHTML = "";
      items.forEach(it=>{
        const li = document.createElement("li");
        li.className = "task";

        // ë‚ ì§œ/êµì‹œ
        const range = formatRange(it.dateFrom, it.dateTo);
        const pr = periods(it.startP || "", it.endP || "");

        // D-dayëŠ” ì‹œì‘ì¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
        const badge = ddayBadge(it.dateFrom || it.dateTo);

        // í¸ì§‘/ì‚­ì œ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ
        const ownerBtns = isOwner() ? `
          <div class="owner-btns">
            <button class="btn btn-ghost" data-act="edit" data-id="${it.id}" data-cat="${cat}">ìˆ˜ì •</button>
            <button class="btn btn-ghost" data-act="del"  data-id="${it.id}" data-cat="${cat}">ì‚­ì œ</button>
          </div>` : "";

        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" disabled ${it.done?"checked":""}>
            <span></span>
          </label>

          <div class="task__content">
            <div class="line-1">
              <div class="subject">
                <b>${esc(it.subj||"")}</b>
                ${badge}
              </div>
              <div class="text">${esc(it.text||"")}</div>
              ${it.detail ? `<div class="detail">${esc(it.detail)}</div>` : ``}
            </div>

            <div class="meta">
              ${range ? `ğŸ“… ${range}` : ``}
              ${pr ? ` &nbsp;â€¢&nbsp; ${pr}` : ``}
            </div>
          </div>

          ${ownerBtns}
        `;

        ul.appendChild(li);
      });

      // ê´€ë¦¬ìë§Œ í¸ì§‘/ì‚­ì œ ë™ì‘
      if(isOwner()){
        ul.onclick = async (e)=>{
          const t = e.target.closest("button[data-act]");
          if(!t) return;
          const act = t.dataset.act;
          const id  = t.dataset.id;
          const c   = t.dataset.cat;
          if(act === "del"){
            if(confirm("ì‚­ì œí• ê¹Œìš”?")){
              try{ await colRW(c).doc(id).delete(); }catch(err){ alert(err.message); }
            }
          }else if(act === "edit"){
            openEditModal(c, id, items.find(x=>x.id===id));
          }
        };
      }
    }

    /* ---------- ì¶”ê°€ ---------- */
    function bindAddRows(){
      addRows.forEach(row=>{
        const btn = $(".add",row);
        const cat = row.dataset.cat;
        btn.onclick = async ()=>{
          if(!isOwner()){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
          const subj = $(".subj",row).value.trim();
          const text = $(".text",row).value.trim();
          const dateFrom = $(".date.from",row).value;
          const dateTo   = $(".date.to",row).value;
          const startp   = $(".startp",row).value;
          const endp     = $(".endp",row).value;
          const detail   = $(".detail",row).value.trim();

          if(!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

          try{
            await colRW(cat).add({
              subj, text, detail,
              dateFrom: dateFrom || "",
              dateTo:   dateTo   || "",
              startP: startp || "0",
              endP:   endp   || "0",
              done:false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // ì…ë ¥ê°’ ì´ˆê¸°í™”
            $(".subj",row).value="";
            $(".text",row).value="";
            $(".date.from",row).value="";
            $(".date.to",row).value="";
            $(".startp",row).value="0";
            $(".endp",row).value="0";
            $(".detail",row).value="";
          }catch(err){
            alert("ì €ì¥ ì‹¤íŒ¨: " + (err?.message || err));
          }
        };
      });
    }
    bindAddRows();

    /* ---------- ê°„ë‹¨ ìˆ˜ì • ëª¨ë‹¬ ---------- */
    function openEditModal(cat, id, item){
      const html = `
        <div class="modal__inner">
          <h3>í•­ëª© ìˆ˜ì •</h3>
          <div class="grid">
            <input id="e_subj"  type="text" value="${esc(item.subj||"")}" />
            <input id="e_text"  type="text" value="${esc(item.text||"")}" />
            <input id="e_from"  type="date" value="${item.dateFrom || ""}" />
            <input id="e_to"    type="date" value="${item.dateTo || ""}" />
            <select id="e_sp">
              <option value="0">ì‹œì‘ êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
            </select>
            <select id="e_ep">
              <option value="0">ë êµì‹œ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
            </select>
          </div>
          <textarea id="e_detail" rows="4" placeholder="ìƒì„¸ ë‚´ìš©">${esc(item.detail||"")}</textarea>
          <div class="modal__actions">
            <button id="e_ok" class="btn">ì €ì¥</button>
            <button id="e_cancel" class="btn btn-ghost">ì·¨ì†Œ</button>
          </div>
        </div>
      `;
      const wrap = document.createElement("div");
      wrap.className = "modal";
      wrap.innerHTML = html;
      document.body.appendChild(wrap);

      $("#e_sp",wrap).value = item.startP||"0";
      $("#e_ep",wrap).value = item.endP||"0";

      $("#e_cancel",wrap).onclick = ()=> wrap.remove();
      $("#e_ok",wrap).onclick = async ()=>{
        try{
          await colRW(cat).doc(id).set({
            subj:   $("#e_subj",wrap).value.trim(),
            text:   $("#e_text",wrap).value.trim(),
            detail: $("#e_detail",wrap).value.trim(),
            dateFrom: $("#e_from",wrap).value || "",
            dateTo:   $("#e_to",wrap).value   || "",
            startP:   $("#e_sp",wrap).value   || "0",
            endP:     $("#e_ep",wrap).value   || "0",
          }, { merge:true });
          wrap.remove();
        }catch(err){
          alert(err.message||err);
        }
      };
    }
  </script>
</body>
</html>
