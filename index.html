<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가 </title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- 상단바 -->
  <header class="admin-bar">
    <h1>📒 숙제 & 수행평가</h1>
    <button id="loginBtn" class="btn">🔑 Google 로그인</button>
    <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
  </header>

  <!-- 본문 -->
  <main class="container">
    <!-- 수행평가 -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">📄 수행평가 ▾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>
        <div class="add-row" data-cat="perf" style="display:none">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">
            <option value="">시작 교시</option>
            <option value="1">1교시</option><option value="2">2교시</option>
            <option value="3">3교시</option><option value="4">4교시</option>
            <option value="5">5교시</option><option value="6">6교시</option>
            <option value="7">7교시</option>
          </select>
          <select class="endPeriod">
            <option value="">끝 교시</option>
            <option value="1">1교시</option><option value="2">2교시</option>
            <option value="3">3교시</option><option value="4">4교시</option>
            <option value="5">5교시</option><option value="6">6교시</option>
            <option value="7">7교시</option>
          </select>
          <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
          <button class="add btn">+ 추가</button>
        </div>
      </div>
    </section>

    <!-- 시험 -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">🧪 시험 ▾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">…(같음)…</select>
          <select class="endPeriod">…(같음)…</select>
          <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
          <button class="add btn">+ 추가</button>
        </div>
      </div>
    </section>

    <!-- 숙제 -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">📌 숙제 ▾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>
        <div class="add-row" data-cat="home" style="display:none">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">…</select>
          <select class="endPeriod">…</select>
          <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
          <button class="add btn">+ 추가</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.appspot.com",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);

    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    let currentUser = null;

    function toggleSection(id){ $("#"+id).classList.toggle("open"); }

    const col = (cat) => {
      const uid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;
      return db.collection("users").doc(uid)
               .collection("tasks").doc(cat).collection("items");
    };

    function renderList(cat, items){
      const ul = $("#list_"+cat); ul.innerHTML="";
      items.forEach(it=>{
        const d1 = it.due||"", d2 = it.due2||"", dayStr = d1?(d2?`${d1} ~ ${d2}`:d1):"";
        const week = d1?`(${["일","월","화","수","목","금","토"][new Date(d1).getDay()]})`:"";
        const period = it.startP? `${it.startP}${it.endP?`~${it.endP}`:""}교시` : "";
        const detail = it.detail? `<div class="detail">${esc(it.detail)}</div>`:"";
        const dday = getDday(d1);

        const li = document.createElement("li");
        li.className="task"+(it.done?" done":"");
        li.innerHTML=`
          <label class="chk-wrap"><input type="checkbox" ${it.done?"checked":""} data-act="toggle" data-id="${it.id}" data-cat="${cat}"><span></span></label>
          <div class="task__main">
            <div class="task__line"><b>${esc(it.subj)}</b></div>
            <div>${esc(it.text)}</div>
            <div class="task__meta">📅 ${dayStr} ${week} ${period} ${dday}</div>
            ${detail}
          </div>
          <button class="btn-ghost" data-act="edit" data-id="${it.id}" data-cat="${cat}">수정</button>
          <button class="btn-ghost" data-act="del" data-id="${it.id}" data-cat="${cat}">삭제</button>
        `;
        ul.appendChild(li);
      });
    }

    function getDday(dateStr){
      if(!dateStr) return "";
      const diff = Math.floor((new Date(dateStr)-new Date())/86400000);
      let color="green";
      if(diff<=1) color="red"; else if(diff<=3) color="orange"; else if(diff<=5) color="gold"; else color="limegreen";
      return `<span style="background:${color};padding:2px 6px;border-radius:6px;font-weight:bold">D-${diff}</span>`;
    }

    function esc(s){return (s||"").replaceAll("<","&lt;").replaceAll(">","&gt;");}

    // Firestore 리스너
    function startListeners(){
      ["perf","exam","home"].forEach(cat=>{
        col(cat).orderBy("due","asc").onSnapshot(snap=>{
          const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
          renderList(cat,arr);
        });
      });
    }

    // 추가
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        $(".add",row).onclick=async()=>{
          if(!currentUser) return alert("로그인 후 추가 가능");
          const subj=$(".subj",row).value.trim(),
                text=$(".text",row).value.trim(),
                due=$(".date",row).value,
                due2=$(".date2",row).value,
                startP=$(".startPeriod",row).value,
                endP=$(".endPeriod",row).value,
                detail=$(".detail",row).value;
          if(!subj||!text) return alert("과목/내용 입력");
          await col(row.dataset.cat).add({subj,text,due,due2,startP,endP,detail,done:false,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
        };
      });
    }

    // 체크/삭제/수정
    document.body.addEventListener("click",async e=>{
      const t=e.target, act=t.dataset.act;
      if(!act) return;
      const cat=t.dataset.cat, id=t.dataset.id;
      if(act==="toggle"){
        if(!currentUser){alert("로그인 필요"); t.checked=!t.checked; return;}
        await col(cat).doc(id).update({done:t.checked});
      }else if(act==="del"){
        if(!currentUser) return alert("로그인 필요");
        await col(cat).doc(id).delete();
      }else if(act==="edit"){
        alert("✏ 수정 기능은 여기서 이어서 구현할 수 있어요 (폼 채우기/저장).");
      }
    });

    // 로그인 처리
    $("#loginBtn").onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    $("#logoutBtn").onclick=()=>auth.signOut();
    auth.onAuthStateChanged(u=>{
      currentUser=u;
      $("#loginBtn").style.display=u?"none":"";
      $("#logoutBtn").style.display=u?"":"none";
    });

    bindAddRows();
    startListeners();
  </script>
</body>
</html>
