<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- 상단 바 -->
  <header class="admin-bar">
    <h1>📒 숙제 & 수행평가</h1>
    <div class="auth-area">
      <button id="loginBtn"  class="btn">🔑 Google 로그인</button>
      <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
    </div>
  </header>

  <main class="container">

    <!-- ⚠️ 섹션 순서: 시험 → 수행평가 → 숙제 -->

    <!-- 시험 -->
    <section>
      <div class="section-head-row">
        <h2 class="section-head">🧪 시험</h2>
      </div>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>

        <!-- 추가 입력: 관리자 전용 -->
        <div class="add-row owner-only" data-cat="exam" style="display:none;">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date-from" type="date" />
          <input class="date-to"   type="date" />
          <select class="start">
            <option value="">시작 교시</option>
            <option>1교시</option><option>2교시</option><option>3교시</option>
            <option>4교시</option><option>5교시</option><option>6교시</option>
            <option>7교시</option>
          </select>
          <select class="end">
            <option value="">끝 교시</option>
            <option>1교시</option><option>2교시</option><option>3교시</option>
            <option>4교시</option><option>5교시</option><option>6교시</option>
            <option>7교시</option>
          </select>
          <button class="add btn">+ 추가</button>

          <!-- 두 번째 줄: 상세내용 크게 -->
          <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
        </div>
      </div>
    </section>

    <!-- 수행평가 -->
    <section>
      <div class="section-head-row">
        <h2 class="section-head">📄 수행평가</h2>
      </div>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>

        <div class="add-row owner-only" data-cat="perf" style="display:none;">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date-from" type="date" />
          <input class="date-to"   type="date" />
          <select class="start">
            <option value="">시작 교시</option>
            <option>1교시</option><option>2교시</option><option>3교시</option>
            <option>4교시</option><option>5교시</option><option>6교시</option>
            <option>7교시</option>
          </select>
          <select class="end">
            <option value="">끝 교시</option>
            <option>1교시</option><option>2교시</option><option>3교시</option>
            <option>4교시</option><option>5교시</option><option>6교시</option>
            <option>7교시</option>
          </select>
          <button class="add btn">+ 추가</button>
          <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
        </div>
      </div>
    </section>

    <!-- 숙제 -->
    <section>
      <div class="section-head-row">
        <h2 class="section-head">📌 숙제</h2>
      </div>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>

        <div class="add-row owner-only" data-cat="home" style="display:none;">
          <input class="subj" type="text" placeholder="과목" />
          <input class="text" type="text" placeholder="내용" />
          <input class="date-from" type="date" />
          <input class="date-to"   type="date" />
          <select class="start">
            <option value="">시작 교시</option>
            <option>1교시</option><option>2교시</option><option>3교시</option>
            <option>4교시</option><option>5교시</option><option>6교시</option>
            <option>7교시</option>
          </select>
          <select class="end">
            <option value="">끝 교시</option>
            <option>1교시</option><option>2교시</option><option>3교시</option>
            <option>4교시</option><option>5교시</option><option>6교시</option>
            <option>7교시</option>
          </select>
          <button class="add btn">+ 추가</button>
          <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
        </div>
      </div>
    </section>

  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase 초기화 : 너의 콘솔 값 그대로 넣기 -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- 앱 코드 -->
  <script>
    // 👑 관리자 UID (오너 UID)
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

    const auth = firebase.auth();
    const db   = firebase.firestore();

    // UI helpers
    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const lists = { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") };

    let currentUser = null;
    let unsubscribers = [];

    const isOwner = () => currentUser && currentUser.uid === OWNER_UID;

    // 로그인/로그아웃
    const provider = new firebase.auth.GoogleAuthProvider();
    $("#loginBtn").onclick  = () => auth.signInWithPopup(provider);
    $("#logoutBtn").onclick = () => auth.signOut();

    auth.onAuthStateChanged(u => {
      currentUser = u;
      $("#loginBtn").style.display  = u ? "none" : "";
      $("#logoutBtn").style.display = u ? "" : "none";
      // 관리자 전용 요소 표시/숨김
      $$(".owner-only").forEach(el => el.style.display = isOwner() ? "" : "none");
      // 카드 내 수정/삭제 버튼
      $$(".owner-only-inline").forEach(el => el.style.display = isOwner() ? "" : "none");

      startListeners();
      bindAddRows();
    });

    // 경로 유틸 (읽기는 고정 OWNER, 쓰기는 현재 사용자(=OWNER)만)
    const colRO = (cat) => db.collection("users").doc(OWNER_UID).collection("tasks").doc(cat).collection("items");
    const colRW = (cat) => db.collection("users").doc(currentUser.uid).collection("tasks").doc(cat).collection("items");

    // 리스너 재시작
    function startListeners(){
      unsubscribers.forEach(u => u && u());
      unsubscribers = [];
      ["exam","perf","home"].forEach(cat => {
        const u = colRO(cat).orderBy("dateFrom","asc").onSnapshot(snap =>{
          const arr = [];
          snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
          renderList(cat, arr);
        });
        unsubscribers.push(u);
      });
    }

    // 요일
    const WEEKS = ["일","월","화","수","목","금","토"];
    const z2 = n => String(n).padStart(2,"0");
    function fmtDay(dateStr){
      if(!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())} (${WEEKS[d.getDay()]})`;
    }

    // 교시 텍스트
    function lessonText(start, end){
      if(!start && !end) return "";
      if(start && end){
        if(start === end) return `${start}`;
        return `${start}~${end}`;
      }
      return (start || end) || "";
    }

    // D-day 표시
    function ddayBadge(dateStr){
      if(!dateStr) return "";
      const today = new Date();
      today.setHours(0,0,0,0);
      const d = new Date(dateStr + "T00:00:00");
      const diff = Math.floor((d - today)/(1000*60*60*24));

      let label="", cls="";
      if(diff > 0){
        label = `D-${diff}`;
        if(diff <= 1) cls = "urgent";
        else if(diff <= 3) cls = "soon";
        else if(diff <= 5) cls = "mid";
        else cls = "safe";
      }else if(diff === 0){
        label = "D-DAY";
        cls = "urgent";
      }else{
        // 지난 일정 → A+N
        label = `A+${Math.abs(diff)}`;
        cls = "past";
      }
      return `<span class="dday ${cls}">${label}</span>`;
    }

    // 카드 렌더
    function renderList(cat, items){
      const ul = lists[cat];
      ul.innerHTML = "";
      items.forEach(it => {
        const li = document.createElement("li");
        li.className = "task";

        const rangeText = (it.dateTo && it.dateTo!==it.dateFrom)
          ? `${fmtDay(it.dateFrom)} ~ ${fmtDay(it.dateTo)}`
          : fmtDay(it.dateFrom);

        const period = lessonText(it.start, it.end);
        const periodLine = period ? ` ${period}` : "";

        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""} data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>

          <div class="task__body">
            <!-- 과목 + D-day -->
            <div class="task__title">
              <b>${esc(it.subj || "")}</b>
              ${ddayBadge(it.dateFrom)}
            </div>
            <!-- 내용 (줄바꿈) -->
            <div class="task__content">${esc(it.text || "")}</div>
            <!-- 상세내용 (더 작게) -->
            ${it.detail ? `<div class="task__detail">${esc(it.detail)}</div>` : ""}
            <!-- 날짜 라인 -->
            <div class="task__date">📅 ${rangeText}${periodLine ? ` ${periodLine}` : ""}</div>
          </div>

          <div class="task__actions owner-only-inline" style="display:${isOwner()?"":"none"}">
            <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">수정</button>
            <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">삭제</button>
          </div>
        `;
        ul.appendChild(li);

        // 이벤트 바인딩
        li.addEventListener("click", async (e)=>{
          const t = e.target;
          const act = t.getAttribute("data-act");
          if(!act) return;

          if(act === "toggle"){
            // 누구나 체크 가능? → 요구: 관리자만 수정/삭제, 체크는 그대로 두고 싶으면 아래 조건 제거
            if(!isOwner()){
              e.preventDefault();
              t.checked = !t.checked;
              return;
            }
            try{
              await colRW(cat).doc(t.getAttribute("data-id"))
                .set({ done:t.checked }, { merge:true });
            }catch(err){ alert(err.message); }
          }

          if(!isOwner()){
            alert("관리자만 가능합니다.");
            return;
          }

          const id = t.getAttribute("data-id");
          if(act === "del"){
            if(confirm("삭제할까요?")){
              await colRW(cat).doc(id).delete();
            }
          }else if(act === "edit"){
            openEditDialog(cat, id, it);
          }
        });
      });
    }

    // 추가 핸들러
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn = $(".add", row);
        const cat = row.dataset.cat;
        btn.onclick = async ()=>{
          if(!isOwner()){ alert("관리자만 추가할 수 있어요."); return; }

          const subj = $(".subj", row).value.trim();
          const text = $(".text", row).value.trim();
          const dateFrom = $(".date-from", row).value;
          const dateTo   = $(".date-to", row).value || dateFrom;
          const start = $(".start", row).value;
          const end   = $(".end", row).value;
          const detail= $(".detail", row).value.trim();

          if(!subj || !text || !dateFrom){ alert("과목/내용/시작일을 입력해 주세요."); return; }

          await colRW(cat).add({
            subj, text, detail,
            dateFrom, dateTo,
            start, end,
            done:false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // clear
          $(".subj", row).value = "";
          $(".text", row).value = "";
          $(".date-from", row).value = "";
          $(".date-to", row).value = "";
          $(".start", row).value = "";
          $(".end", row).value = "";
          $(".detail", row).value = "";
        };
      });
    }

    // 간단 수정 다이얼로그
    function openEditDialog(cat, id, it){
      const subj = prompt("과목", it.subj || "");
      if(subj === null) return;
      const text = prompt("내용", it.text || "");
      if(text === null) return;
      const detail = prompt("상세 내용(선택)", it.detail || "");
      if(detail === null) return;

      const from = prompt("시작일(YYYY-MM-DD)", it.dateFrom || "");
      if(from === null) return;
      const to = prompt("종료일(YYYY-MM-DD, 비우면 시작일과 동일)", it.dateTo || it.dateFrom || "");
      if(to === null) return;
      const start = prompt("시작 교시(예: 1교시, 비우기 가능)", it.start || "");
      if(start === null) return;
      const end = prompt("끝 교시(예: 3교시, 비우기 가능)", it.end || "");
      if(end === null) return;

      colRW(cat).doc(id).set({
        subj, text, detail,
        dateFrom: from, dateTo: to || from,
        start, end
      }, { merge:true });
    }

    // escape
    function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  </script>
</body>
</html>
