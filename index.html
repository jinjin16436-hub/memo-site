<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="topbar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="right">
      <!-- ê´€ë¦¬ìë§Œ ë³´ì´ëŠ” ì¤‘ìš” ì „ë‹¬ì‚¬í•­ ON/OFF -->
      <div id="impSwitchWrap" class="imp-switch" style="display:none">
        <label>
          <input id="toggleImportant" type="checkbox" />
          ì¤‘ìš” ì „ë‹¬ì‚¬í•­ í‘œì‹œ
        </label>
      </div>
      <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <main class="container">

    <!-- ===========================
         ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ (ìƒ‰ìƒë³„ 3ë³´ë“œ)
         =========================== -->
    <section id="group_important">
      <!-- ğŸ”´ ê¸´ê¸‰(ë¹¨ê°•) -->
      <section class="board board--notice board--red">
        <div class="board__head">
          <h2>ğŸ”´ ê¸´ê¸‰ ê³µì§€</h2>
        </div>
        <ul id="list_notice_red" class="task-list"></ul>
        <div class="add-row add-row--notice" data-cat="important" data-color="notice-red" style="display:none">
          <div class="row-1">
            <input class="subj" type="text" placeholder="ì œëª©" />
            <input class="text" type="text" placeholder="ë‚´ìš©" />
            <button class="add btn">+ ì¶”ê°€</button>
          </div>
          <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        </div>
      </section>

      <!-- ğŸ”µ ì¼ë°˜(íŒŒë‘) -->
      <section class="board board--notice board--blue">
        <div class="board__head">
          <h2>ğŸ”µ ê³µì§€</h2>
        </div>
        <ul id="list_notice_blue" class="task-list"></ul>
        <div class="add-row add-row--notice" data-cat="important" data-color="notice-blue" style="display:none">
          <div class="row-1">
            <input class="subj" type="text" placeholder="ì œëª©" />
            <input class="text" type="text" placeholder="ë‚´ìš©" />
            <button class="add btn">+ ì¶”ê°€</button>
          </div>
          <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        </div>
      </section>

      <!-- ğŸŸ¡ ì•Œë¦¼(ë…¸ë‘) -->
      <section class="board board--notice board--yellow">
        <div class="board__head">
          <h2>ğŸŸ¡ ì „ë‹¬ ì‚¬í•­</h2>
        </div>
        <ul id="list_notice_yellow" class="task-list"></ul>
        <div class="add-row add-row--notice" data-cat="important" data-color="notice-yellow" style="display:none">
          <div class="row-1">
            <input class="subj" type="text" placeholder="ì œëª©" />
            <input class="text" type="text" placeholder="ë‚´ìš©" />
            <button class="add btn">+ ì¶”ê°€</button>
          </div>
          <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        </div>
      </section>
    </section>

    <!-- ğŸ§ª ì‹œí—˜ -->
    <section class="board">
      <div class="board__head"><h2>ğŸ§ª ì‹œí—˜</h2></div>
      <ul id="list_exam" class="task-list"></ul>

      <div class="add-row" data-cat="exam" style="display:none">
        <div class="row-1">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date from" type="date" />
          <input class="date to"   type="date" />
          <select class="startp">
            <option value="0">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="endp">
            <option value="0">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
        <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
      </div>
    </section>

    <!-- ğŸ“„ ìˆ˜í–‰í‰ê°€ -->
    <section class="board">
      <div class="board__head"><h2>ğŸ“„ ìˆ˜í–‰í‰ê°€</h2></div>
      <ul id="list_perf" class="task-list"></ul>

      <div class="add-row" data-cat="perf" style="display:none">
        <div class="row-1">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date from" type="date" />
          <input class="date to"   type="date" />
          <select class="startp">
            <option value="0">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="endp">
            <option value="0">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
        <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
      </div>
    </section>

    <!-- ğŸ“Œ ìˆ™ì œ -->
    <section class="board">
      <div class="board__head"><h2>ğŸ“Œ ìˆ™ì œ</h2></div>
      <ul id="list_home" class="task-list"></ul>

      <div class="add-row" data-cat="home" style="display:none">
        <div class="row-1">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date from" type="date" />
          <input class="date to"   type="date" />
          <select class="startp">
            <option value="0">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="endp">
            <option value="0">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
        <textarea class="detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
      </div>
    </section>

  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” (ì´ë¯¸ ì‚¬ìš©ê°’) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ì•± ì½”ë“œ -->
  <script>
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";
    const isOwner = ()=> auth.currentUser && auth.currentUser.uid === OWNER_UID;

    const $  = (q,r=document)=>r.querySelector(q);
    const $$ = (q,r=document)=>Array.from(r.querySelectorAll(q));

    // ëª©ë¡ ì°¸ì¡°
    const lists = {
      notice_red:   $("#list_notice_red"),
      notice_blue:  $("#list_notice_blue"),
      notice_yellow:$("#list_notice_yellow"),
      exam: $("#list_exam"),
      perf: $("#list_perf"),
      home: $("#list_home"),
    };

    // ë‚ ì§œ/ìš”ì¼/D-day
    const wd = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const fmtDate = (dStr)=> dStr? (()=>{const d=new Date(dStr+"T00:00:00");return `${dStr} (${wd[d.getDay()]})`;})() : "";
    const periods=(s,e)=>{s=(s||"").replace("êµì‹œ","");e=(e||"").replace("êµì‹œ","");if(!s||s==='0'||!e||e==='0')return"";return s===e?`${s}êµì‹œ`:`${s}~${e}êµì‹œ`;}
    const formatRange=(a,b)=>!a&&!b?"":(!a?fmtDate(b):(!b?fmtDate(a):`${fmtDate(a)} ~ ${fmtDate(b)}`));
    const dayDiff=dStr=>{if(!dStr)return null;const t=new Date();t.setHours(0,0,0,0);const d=new Date(dStr+"T00:00:00");d.setHours(0,0,0,0);return Math.round((d-t)/86400000);}
    const ddayBadge=dStr=>{
      const diff=dayDiff(dStr); if(diff===null) return "";
      if(diff>0){
        if(diff===1) return `<span class="dd-badge dd-red">D-${diff}</span>`;
        if(diff<=3)  return `<span class="dd-badge dd-orange">D-${diff}</span>`;
        if(diff<=5)  return `<span class="dd-badge dd-yellow">D-${diff}</span>`;
        return `<span class="dd-badge dd-green">D-${diff}</span>`;
      }else if(diff===0){
        return `<span class="dd-badge dd-red">D-DAY</span>`;
      }else{
        return `<span class="dd-badge dd-gray">D+${Math.abs(diff)}</span>`;
      }
    };
    const esc=s=>(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    // ì½ê¸° ì „ìš©/ì“°ê¸° ì°¸ì¡°
    const colRO=(cat)=>db.collection("users").doc(OWNER_UID).collection("tasks").doc(cat).collection("items");
    const colRW=(cat)=>{ if(!isOwner()) throw new Error("ê´€ë¦¬ìë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return colRO(cat); };

    // ë¡œê·¸ì¸
    $("#loginBtn").onclick = ()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    $("#logoutBtn").onclick= ()=>auth.signOut();

    auth.onAuthStateChanged(u=>{
      $("#loginBtn").style.display  = u? "none": "";
      $("#logoutBtn").style.display = u? "": "none";
      setEditVisible(isOwner());
      $("#impSwitchWrap").style.display = isOwner()? "": "none";
      startListeners();
      watchSettings();
    });

    // ì„¤ì •(ON/OFF)
    const settingsDoc = db.collection("users").doc(OWNER_UID).collection("config").doc("ui");
    function applyImportantVisibility(show){
      $("#group_important").style.display = show? "": "none";
      const sw=$("#toggleImportant"); if(sw) sw.checked = !!show;
    }
    function watchSettings(){
      settingsDoc.onSnapshot(s=>{
        const data = s.exists? s.data(): {};
        applyImportantVisibility(data.showImportant !== false);
      });
      const sw=$("#toggleImportant");
      if(sw){
        sw.onchange = async e=>{
          if(!isOwner()){ sw.checked=!sw.checked; alert("ê´€ë¦¬ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
          try{ await settingsDoc.set({showImportant:e.target.checked},{merge:true}); }
          catch(err){ sw.checked=!sw.checked; alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: "+(err?.message||err)); }
        };
      }
    }

    // êµ¬ë…
    let unsubscribers=[];
    const lastData={important:[], exam:[], perf:[], home:[]};

    function startListeners(){
      unsubscribers.forEach(u=>u&&u()); unsubscribers=[];
      // ì¤‘ìš”
      unsubscribers.push(
        colRO("important").orderBy("createdAt","desc").onSnapshot(s=>{
          const arr=[]; s.forEach(d=>arr.push({id:d.id, ...d.data()}));
          lastData.important=arr; renderImportant(arr);
        })
      );
      // ì¼ë°˜ 3ê°œ
      ["exam","perf","home"].forEach(cat=>{
        const un = colRO(cat).orderBy("dateFrom","asc").onSnapshot(s=>{
          const arr=[]; s.forEach(d=>arr.push({id:d.id, ...d.data()}));
          lastData[cat]=arr; renderList(cat,arr);
        });
        unsubscribers.push(un);
      });
    }

    // 1ë¶„ë§ˆë‹¤ ì¡°ìš©íˆ ì¬ë Œë”
    setInterval(()=>{
      renderImportant(lastData.important||[]);
      ["exam","perf","home"].forEach(cat=>renderList(cat,lastData[cat]||[]));
    }, 60000);

    // ì¤‘ìš” ì „ë‹¬ì‚¬í•­ ë Œë”(ìƒ‰ìƒë³„ ë¶„ë¦¬)
    function renderImportant(items){
      const reds  = items.filter(x=> (x.color||"notice-yellow")==="notice-red");
      const blues = items.filter(x=> (x.color||"notice-yellow")==="notice-blue");
      const yellows=items.filter(x=> (x.color||"notice-yellow")==="notice-yellow");

      buildNoticeList(lists.notice_red, reds,  "notice-red");
      buildNoticeList(lists.notice_blue,blues,"notice-blue");
      buildNoticeList(lists.notice_yellow,yellows,"notice-yellow");
    }

    function buildNoticeList(ul, arr, color){
      ul.innerHTML="";
      arr.forEach(it=>{
        const li=document.createElement("li");
        li.className=`task task--notice ${color}`;
        li.innerHTML=`
          <div class="task__content">
            <div class="subject"><b>${esc(it.subj||"")}</b></div>
            <div class="text">${esc(it.text||"")}</div>
            ${it.detail? `<div class="detail">${esc(it.detail)}</div>`:``}
          </div>
          ${isOwner()?`
            <div class="owner-btns">
              <button class="btn-ghost" data-act="edit" data-id="${it.id}" data-cat="important">ìˆ˜ì •</button>
              <button class="btn-ghost" data-act="del"  data-id="${it.id}" data-cat="important">ì‚­ì œ</button>
            </div>`:``}
        `;
        ul.appendChild(li);
      });

      if(isOwner()){
        ul.onclick = async e=>{
          const t=e.target.closest("button[data-act]"); if(!t) return;
          const act=t.dataset.act, id=t.dataset.id, cat=t.dataset.cat;
          const item=(lastData.important||[]).find(x=>x.id===id); if(!item) return;

          if(act==="del"){
            if(confirm("ì‚­ì œí• ê¹Œìš”?")){ try{await colRW(cat).doc(id).delete();}catch(err){alert(err.message)} }
          }else if(act==="edit"){
            openEditModal(cat,id,item);
          }
        };
      }
    }

    // ì¼ë°˜ ë¦¬ìŠ¤íŠ¸ ë Œë”
    function renderList(cat, items){
      const ul = lists[cat]; ul.innerHTML="";
      items.forEach(it=>{
        const li=document.createElement("li");
        li.className="task";
        const range = formatRange(it.dateFrom, it.dateTo);
        const pr    = periods(it.startP||"", it.endP||"");
        const badge = ddayBadge(it.dateFrom || it.dateTo);
        li.innerHTML=`
          <label class="chk-wrap"><input type="checkbox" disabled ${it.done?"checked":""}></label>
          <div class="task__content">
            <div class="subject"><b>${esc(it.subj||"")}</b> ${badge}</div>
            <div class="text">${esc(it.text||"")}</div>
            ${it.detail? `<div class="detail">${esc(it.detail)}</div>`:""}
            <div class="meta">${range?`ğŸ“… ${range}`:""} ${pr?` &nbsp;â€¢&nbsp; ${pr}`:""}</div>
          </div>
          ${isOwner()?`
            <div class="owner-btns">
              <button class="btn-ghost" data-act="edit" data-id="${it.id}" data-cat="${cat}">ìˆ˜ì •</button>
              <button class="btn-ghost" data-act="del"  data-id="${it.id}" data-cat="${cat}">ì‚­ì œ</button>
            </div>`:""}
        `;
        ul.appendChild(li);
      });

      if(isOwner()){
        ul.onclick = async e=>{
          const t=e.target.closest("button[data-act]"); if(!t) return;
          const act=t.dataset.act, id=t.dataset.id, c=t.dataset.cat;
          const item=(lastData[c]||[]).find(x=>x.id===id); if(!item) return;
          if(act==="del"){
            if(confirm("ì‚­ì œí• ê¹Œìš”?")){ try{await colRW(c).doc(id).delete();}catch(err){alert(err.message)} }
          }else if(act==="edit"){
            openEditModal(c,id,item);
          }
        };
      }
    }

    // ì¶”ê°€ ë°”ì¸ë”©
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn=$(".add",row), cat=row.dataset.cat, fixedColor=row.dataset.color||"";
        btn.onclick=async ()=>{
          if(!isOwner()){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }

          if(cat==="important"){
            const subj=$(".subj",row).value.trim();
            const text=$(".text",row).value.trim();
            const detail=$(".detail",row).value.trim();
            const color=fixedColor; // ë³´ë“œ ìƒ‰ìƒ ê³ ì •
            if(!subj||!text){ alert("ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
            try{
              await colRW(cat).add({
                subj,text,detail,color,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              $(".subj",row).value="";
              $(".text",row).value="";
              $(".detail",row).value="";
            }catch(err){ alert("ì €ì¥ ì‹¤íŒ¨: "+(err?.message||err)); }
            return;
          }

          const subj=$(".subj",row).value.trim();
          const text=$(".text",row).value.trim();
          const from=$(".date.from",row).value;
          const to  =$(".date.to",row).value;
          const sp  =$(".startp",row).value;
          const ep  =$(".endp",row).value;
          const detail=$(".detail",row).value.trim();
          if(!subj||!text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
          try{
            await colRW(cat).add({
              subj,text,detail,
              dateFrom:from||"", dateTo:to||"",
              startP:sp||"0", endP:ep||"0",
              done:false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            $(".subj",row).value=""; $(".text",row).value="";
            $(".date.from",row).value=""; $(".date.to",row).value="";
            $(".startp",row).value="0"; $(".endp",row).value="0";
            $(".detail",row).value="";
          }catch(err){ alert("ì €ì¥ ì‹¤íŒ¨: "+(err?.message||err)); }
        };
      });
    }
    bindAddRows();

    // ìˆ˜ì • ëª¨ë‹¬ (ì¤‘ìš”/ì¼ë°˜ ê³µí†µ)
    function openEditModal(cat,id,item){
      const isNotice=(cat==="important");
      const html=`
        <div class="modal__inner">
          <h3>${isNotice?"ì¤‘ìš” ì „ë‹¬ì‚¬í•­ ìˆ˜ì •":"í•­ëª© ìˆ˜ì •"}</h3>
          <div class="grid ${isNotice?"grid--notice":""}">
            <input id="e_subj" type="text" value="${esc(item.subj||"")}" placeholder="${isNotice?"ì œëª©":"ê³¼ëª©"}" />
            <input id="e_text" type="text" value="${esc(item.text||"")}" placeholder="ë‚´ìš©" />
            ${isNotice?``:`
              <input id="e_from" type="date" value="${item.dateFrom||""}" />
              <input id="e_to"   type="date" value="${item.dateTo||""}" />
              <select id="e_sp">
                <option value="0">ì‹œì‘ êµì‹œ</option>
                <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
                <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
              </select>
              <select id="e_ep">
                <option value="0">ë êµì‹œ</option>
                <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
                <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
              </select>`}
          </div>
          <textarea id="e_detail" rows="4" placeholder="ìƒì„¸ ë‚´ìš©(ì„ íƒ)">${esc(item.detail||"")}</textarea>
          <div class="modal__actions">
            <button id="e_ok" class="btn">ì €ì¥</button>
            <button id="e_cancel" class="btn btn-ghost">ì·¨ì†Œ</button>
          </div>
        </div>`;
      const wrap=document.createElement("div"); wrap.className="modal"; wrap.innerHTML=html; document.body.appendChild(wrap);
      if(!isNotice){ $("#e_sp",wrap).value=item.startP||"0"; $("#e_ep",wrap).value=item.endP||"0"; }
      $("#e_cancel",wrap).onclick=()=>wrap.remove();
      $("#e_ok",wrap).onclick=async ()=>{
        try{
          if(isNotice){
            await colRW(cat).doc(id).set({
              subj:$("#e_subj",wrap).value.trim(),
              text:$("#e_text",wrap).value.trim(),
              detail:$("#e_detail",wrap).value.trim()
            },{merge:true});
          }else{
            await colRW(cat).doc(id).set({
              subj:$("#e_subj",wrap).value.trim(),
              text:$("#e_text",wrap).value.trim(),
              detail:$("#e_detail",wrap).value.trim(),
              dateFrom:$("#e_from",wrap).value||"",
              dateTo:$("#e_to",wrap).value||"",
              startP:$("#e_sp",wrap).value||"0",
              endP:$("#e_ep",wrap).value||"0"
            },{merge:true});
          }
          wrap.remove();
        }catch(err){ alert(err.message||err); }
      };
    }

    // í¸ì§‘ UI ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
    function setEditVisible(v){
      $$(".add-row").forEach(r=> r.style.display = v? "" : "none");
      $$(".owner-btns").forEach(b=> b.style.display = v? "" : "none");
    }
  </script>
</body>
</html>
