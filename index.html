<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>숙제 메모 (Firebase)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>📒 숙제 & 수행평가 메모</h1>
    <div class="admin-bar">
      <button id="loginBtn"  class="btn-sm">🔑 Google 로그인</button>
      <button id="logoutBtn" class="btn-sm" style="display:none">🔓 로그아웃</button>
    </div>
  </header>

  <main>
    <!-- 수행평가 -->
    <section>
      <button class="toggle-btn" onclick="toggleSection('sec_perf')">📑 수행평가 ▼</button>
      <div id="sec_perf" class="toggle-content open">
        <ul id="list_perf" class="task-list"></ul>
        <div class="add-row" data-cat="perf" style="display:none">
          <input class="in subj" placeholder="과목 (예: 국어)">
          <input class="in text" placeholder="내용 (예: 발표 준비)">
          <input class="in date" type="date" placeholder="기한">
          <button class="btn-sm add">+ 추가</button>
        </div>
      </div>
    </section>

    <!-- 시험 -->
    <section>
      <button class="toggle-btn" onclick="toggleSection('sec_exam')">📝 시험 ▼</button>
      <div id="sec_exam" class="toggle-content open">
        <ul id="list_exam" class="task-list"></ul>
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="in subj" placeholder="과목 (예: 수학)">
          <input class="in text" placeholder="내용 (예: 단원평가)">
          <input class="in date" type="date" placeholder="일자">
          <button class="btn-sm add">+ 추가</button>
        </div>
      </div>
    </section>

    <!-- 숙제 -->
    <section>
      <button class="toggle-btn" onclick="toggleSection('sec_home')">📌 숙제 ▼</button>
      <div id="sec_home" class="toggle-content open">
        <ul id="list_home" class="task-list"></ul>
        <div class="add-row" data-cat="home" style="display:none">
          <input class="in subj" placeholder="과목 (예: 과학)">
          <input class="in text" placeholder="내용 (예: 리포트)">
          <input class="in date" type="date" placeholder="기한">
          <button class="btn-sm add">+ 추가</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>🔒 로그인하면 “추가/삭제/완료체크” 가능 (본인만 쓰기)</p>
  </footer>

  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // 1) 🔧 firebaseConfig: 콘솔에서 복사한 값으로 교체하세요
    const firebaseConfig = {
       apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "196036694705",
  appId: "1:196036694705:web:8988d12919420130464890"
};
    firebase.initializeApp(firebaseConfig);

    // 2) Firebase 핸들
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // 3) DOM 유틸
    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

    const el = {
      loginBtn:  $("#loginBtn"),
      logoutBtn: $("#logoutBtn"),
      lists:     { perf: $("#list_perf"), exam: $("#list_exam"), home: $("#list_home") }
    };

    let currentUser = null;
    let unsub = []; // 실시간 리스너 해제용

    // 4) 토글
    function toggleSection(id){ $("#"+id).classList.toggle("open"); }
    function setEditVisible(v){
      $$(".add-row").forEach(r => r.style.display = v ? "" : "none");
      $$(".btn-ghost").forEach(b => b.style.display = v ? "" : "none");
    }

    // 5) 로그인/로그아웃
    el.loginBtn.onclick  = async () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    el.logoutBtn.onclick = async () => auth.signOut();

    auth.onAuthStateChanged(user => {
      currentUser = user;
      el.loginBtn.style.display  = user ? "none" : "";
      el.logoutBtn.style.display = user ? "" : "none";
      setEditVisible(!!user);
      bindAddRows();
      startListeners();
    });

    // 6) Firestore 경로: users/{uid}/tasks/{cat}/items/{doc}
    const col = (cat) => db
      .collection("users").doc(currentUser.uid)
      .collection("tasks").doc(cat).collection("items");

    function startListeners(){
      // 해제
      unsub.forEach(u => u && u());
      unsub = [];

      if(!currentUser){
        ["perf","exam","home"].forEach(cat => renderList(cat, []));
        return;
      }
      ["perf","exam","home"].forEach(cat => {
        const u = col(cat).orderBy("due","asc").onSnapshot(s => {
          const arr = [];
          s.forEach(d => arr.push({ id:d.id, ...d.data() }));
          renderList(cat, arr);
        });
        unsub.push(u);
      });
    }

    // 7) 렌더 + 이벤트
    function renderList(cat, items){
      const ul = el.lists[cat];
      ul.innerHTML = "";
      for(const it of items){
        const li = document.createElement("li");
        li.className = "task" + (it.done ? " done" : "");
        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""} data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>
          <div class="task__main">
            <div class="task__line">
              <b>${esc(it.subj||"")}</b><span class="sep">–</span>
              <span>${esc(it.text||"")}</span>
            </div>
            <div class="task__meta">${it.due ? `📅 ${it.due}` : ""}</div>
          </div>
          <button class="btn-ghost" data-act="del" data-cat="${cat}" data-id="${it.id}" style="display:${currentUser?'':'none'}">삭제</button>
        `;
        ul.appendChild(li);
      }

      ul.onclick = async (e)=>{
        const t = e.target;
        const act = t.getAttribute("data-act");
        if(!act) return;
        if(!currentUser){ alert("로그인 후 수정 가능합니다."); return; }

        const cat2 = t.getAttribute("data-cat");
        const id   = t.getAttribute("data-id");
        if(act === "toggle"){
          await col(cat2).doc(id).update({ done: t.checked });
        }else if(act === "del"){
          await col(cat2).doc(id).delete();
        }
      };
    }

    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn = $(".add", row);
        const cat = row.dataset.cat;
        btn.onclick = async ()=>{
          if(!currentUser){ alert("로그인 후 추가 가능"); return; }
          const subj = $(".subj", row).value.trim();
          const text = $(".text", row).value.trim();
          const date = $(".date", row).value || "";
          if(!subj || !text){ alert("과목/내용을 입력해 주세요."); return; }
          await col(cat).add({
            subj, text, due: date, done: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          $(".subj", row).value = "";
          $(".text", row).value = "";
          $(".date", row).value = "";
        };
      });
    }

    // 8) 유틸
    const esc = s => s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    // 초기 편집 비노출
    setEditVisible(false);
  </script>
</body>
</html>
