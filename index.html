<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìˆ™ì œ & ìˆ˜í–‰í‰ê°€ ë©”ëª¨</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="admin-bar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="admin-right">
      <button id="loginBtn" class="btn">ğŸ”‘ ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
      <button id="adminBadge" class="chip" style="display:none">ê´€ë¦¬ì</button>
    </div>
  </header>

  <!-- ================= ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ ================= -->
  <section class="notice-wrap">
    <div class="notice-head">
      <h2>ğŸ“£ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</h2>
      <label class="switch" id="noticeSwitchWrap" style="display:none">
        <input type="checkbox" id="noticeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <div id="noticeEmpty" class="notice-empty">ë“±ë¡ëœ ì „ë‹¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    <ul id="noticeList" class="notice-list"></ul>

    <!-- ê´€ë¦¬ìë§Œ ë³´ì´ëŠ” ì…ë ¥ í¼ -->
    <div id="noticeForm" class="notice-form" style="display:none">
      <div class="grid-notice">
        <input id="nf_title" class="inp" placeholder="ì œëª©" />
        <select id="nf_level" class="sel">
          <option value="info">ì•ˆë‚´</option>
          <option value="warn">ì£¼ì˜</option>
          <option value="alert">ê¸´ê¸‰</option>
        </select>
      </div>
      <textarea id="nf_body" class="txt" rows="3" placeholder="ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
      <button id="nf_add" class="btn primary">+ ì¶”ê°€</button>
    </div>
  </section>

  <!-- ================= ì‹œí—˜ / ìˆ˜í–‰í‰ê°€ / ìˆ™ì œ ================= -->
  <main class="container">
    <!-- ì‹œí—˜ -->
    <section>
      <div class="section-title">ğŸ§ª ì‹œí—˜</div>
      <ul id="list_exam" class="task-list"></ul>
      <div class="add-row" data-cat="exam" style="display:none">
        <input class="subj" type="text" placeholder="ê³¼ëª©" />
        <input class="text" type="text" placeholder="ë‚´ìš©" />
        <input class="date" type="date" />
        <input class="date" type="date" placeholder="ë ë‚ ì§œ(ì„ íƒ)" />
        <select class="period-start">
          <option value="">ì‹œì‘ êµì‹œ</option><option>1êµì‹œ</option><option>2êµì‹œ</option>
          <option>3êµì‹œ</option><option>4êµì‹œ</option><option>5êµì‹œ</option>
          <option>6êµì‹œ</option><option>7êµì‹œ</option>
        </select>
        <select class="period-end">
          <option value="">ë êµì‹œ</option><option>1êµì‹œ</option><option>2êµì‹œ</option>
          <option>3êµì‹œ</option><option>4êµì‹œ</option><option>5êµì‹œ</option>
          <option>6êµì‹œ</option><option>7êµì‹œ</option>
        </select>
        <textarea class="memo" rows="2" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <div class="section-title">ğŸ“ ìˆ˜í–‰í‰ê°€</div>
      <ul id="list_perf" class="task-list"></ul>
      <div class="add-row" data-cat="perf" style="display:none">
        <input class="subj" type="text" placeholder="ê³¼ëª©" />
        <input class="text" type="text" placeholder="ë‚´ìš©" />
        <input class="date" type="date" />
        <input class="date" type="date" placeholder="ë ë‚ ì§œ(ì„ íƒ)" />
        <select class="period-start">
          <option value="">ì‹œì‘ êµì‹œ</option><option>1êµì‹œ</option><option>2êµì‹œ</option>
          <option>3êµì‹œ</option><option>4êµì‹œ</option><option>5êµì‹œ</option>
          <option>6êµì‹œ</option><option>7êµì‹œ</option>
        </select>
        <select class="period-end">
          <option value="">ë êµì‹œ</option><option>1êµì‹œ</option><option>2êµì‹œ</option>
          <option>3êµì‹œ</option><option>4êµì‹œ</option><option>5êµì‹œ</option>
          <option>6êµì‹œ</option><option>7êµì‹œ</option>
        </select>
        <textarea class="memo" rows="2" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <div class="section-title">ğŸ“Œ ìˆ™ì œ</div>
      <ul id="list_home" class="task-list"></ul>
      <div class="add-row" data-cat="home" style="display:none">
        <input class="subj" type="text" placeholder="ê³¼ëª©" />
        <input class="text" type="text" placeholder="ë‚´ìš©" />
        <input class="date" type="date" />
        <input class="date" type="date" placeholder="ë ë‚ ì§œ(ì„ íƒ)" />
        <select class="period-start">
          <option value="">ì‹œì‘ êµì‹œ</option><option>1êµì‹œ</option><option>2êµì‹œ</option>
          <option>3êµì‹œ</option><option>4êµì‹œ</option><option>5êµì‹œ</option>
          <option>6êµì‹œ</option><option>7êµì‹œ</option>
        </select>
        <select class="period-end">
          <option value="">ë êµì‹œ</option><option>1êµì‹œ</option><option>2êµì‹œ</option>
          <option>3êµì‹œ</option><option>4êµì‹œ</option><option>5êµì‹œ</option>
          <option>6êµì‹œ</option><option>7êµì‹œ</option>
        </select>
        <textarea class="memo" rows="2" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ====== ê´€ë¦¬ì UID (ë°˜ë“œì‹œ ê´€ë¦¬ì UIDë¡œ êµì²´) ======
  const ADMIN_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

  // ====== Firebase Config (ì§€ê¸ˆ ì“°ëŠ” ê°’ ê·¸ëŒ€ë¡œ) ======
  const firebaseConfig = {
    apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
    authDomain: "my-memo-site.firebaseapp.com",
    projectId: "my-memo-site",
    storageBucket: "my-memo-site.firebasestorage.app",
    messagingSenderId: "196036694705",
    appId: "1:196036694705:web:8988d12919420130464890"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db   = firebase.firestore();

  const $  = (q, root=document) => root.querySelector(q);
  const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

  const el = {
    loginBtn:  $("#loginBtn"),
    logoutBtn: $("#logoutBtn"),
    adminBadge: $("#adminBadge"),
    // notice
    noticeSwitchWrap: $("#noticeSwitchWrap"),
    noticeToggle: $("#noticeToggle"),
    noticeList: $("#noticeList"),
    noticeEmpty: $("#noticeEmpty"),
    noticeForm: $("#noticeForm"),
    nf_title: $("#nf_title"),
    nf_level: $("#nf_level"),
    nf_body:  $("#nf_body"),
    nf_add:   $("#nf_add"),
    // lists
    lists: { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") },
  };

  let currentUser = null;
  let isAdmin = false;
  let unsubscribers = [];

  // ===== LocalStorage í‚¤ =====
  const DRAFT_TASK = "memo:draft-task-v2";
  const DRAFT_NOTICE = "memo:draft-notice-v1";

  // ===== ê²½ë¡œ ìœ í‹¸ =====
  const colTasks = (cat) => {
    const uid = isAdmin ? ADMIN_UID : (currentUser?.uid || ADMIN_UID);
    // ë¡œê·¸ì•„ì›ƒë„ ì½ê¸°ëŠ” ADMIN_UIDë¡œ
    return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
  };
  const colAnnounces = () => db.collection("users").doc(ADMIN_UID).collection("announces");
  const docSettings = () => db.collection("users").doc(ADMIN_UID).collection("settings").doc("app");

  // ===== ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ =====
  el.loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  el.logoutBtn.onclick = () => auth.signOut();

  auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    isAdmin = !!(user && user.uid === ADMIN_UID);
    el.loginBtn.style.display  = user ? "none" : "";
    el.logoutBtn.style.display = user ? "" : "none";
    el.adminBadge.style.display = isAdmin ? "" : "none";

    // ê´€ë¦¬ìë§Œ ì…ë ¥/í† ê¸€ ë…¸ì¶œ
    setEditVisible(isAdmin);

    // ë¦¬ìŠ¤ë„ˆ ì¬ì‹œì‘
    startListeners();
  });

  function setEditVisible(v){
    $$(".add-row").forEach(r => r.style.display = v ? "" : "none");
    el.noticeForm.style.display = v ? "" : "none";
    el.noticeSwitchWrap.style.display = v ? "" : "none";
  }

  // ===== D-Day ë±ƒì§€ =====
  function ddayLabel(start, end){
    const today = new Date(); today.setHours(0,0,0,0);
    const s = start ? new Date(start) : null;
    const e = end   ? new Date(end)   : null;
    const target = e || s;
    if(!target) return "";

    const diff = Math.floor((target - today) / 86400000);
    let label, cls="future";
    if(diff > 0){ label = `D-${diff}`; cls="future"; }
    else if(diff === 0){ label = "D-0"; cls="today"; }
    else { label = `D+${Math.abs(diff)}`; cls="past"; }
    return `<span class="dday ${cls}">${label}</span>`;
  }

  function ymd(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr+"T00:00:00");
    const week = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} (${week})`;
  }

  // ===== ëª©ë¡ ë Œë” =====
  function renderTasks(cat, items){
    const ul = el.lists[cat];
    ul.innerHTML = "";
    if(!items.length){
      ul.innerHTML = `<li class="empty">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
      return;
    }
    for(const it of items){
      const line1 = `
        <div class="task-head">
          <b class="task-subj">${it.subj||""}</b>
          ${ddayLabel(it.dueStart, it.dueEnd)}
        </div>`;
      const line2 = `<div class="task-text">${it.text||""}</div>`;
      const line3 = `<div class="task-meta">ğŸ“… ${ymd(it.dueStart)}${it.dueEnd?` ~ ${ymd(it.dueEnd)}`:""}${(it.periodStart||it.periodEnd)?` Â· ${it.periodStart||""}${it.periodEnd?`~${it.periodEnd}`:""}`:""}</div>`;
      const memo = it.memo ? `<div class="task-memo">${it.memo}</div>` : "";
      const adminBtns = isAdmin ? `
        <div class="task-btns">
          <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
          <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
        </div>` : "";

      const li = document.createElement("li");
      li.className = "task";
      li.innerHTML = `
        <label class="chk-wrap">
          <input type="checkbox" ${it.done?"checked":""} data-act="toggle" data-cat="${cat}" data-id="${it.id}">
          <span></span>
        </label>
        <div class="task-body">
          ${line1}${line2}${memo}${line3}
        </div>
        ${adminBtns}
      `;
      ul.appendChild(li);
    }

    ul.onclick = async (e)=>{
      const t = e.target;
      const act = t.getAttribute("data-act");
      if(!act) return;
      const cat2 = t.getAttribute("data-cat");
      const id   = t.getAttribute("data-id");
      if(act==="toggle"){
        if(!isAdmin){ t.checked = !t.checked; return; }
        await colTasks(cat2).doc(id).update({ done: t.checked });
      }else if(act==="del"){
        if(!isAdmin) return;
        if(confirm("ì‚­ì œí• ê¹Œìš”?")) await colTasks(cat2).doc(id).delete();
      }else if(act==="edit"){
        if(!isAdmin) return;
        openEditDialog(cat2, id);
      }
    };
  }

  // ê°„ë‹¨ í¸ì§‘(ëª¨ë‹¬ ì—†ì´ prompt) â€“ í•„ìš”ì‹œ ëª¨ë‹¬ë¡œ í™•ì¥ ê°€ëŠ¥
  async function openEditDialog(cat, id){
    const ref = await colTasks(cat).doc(id).get();
    if(!ref.exists) return;
    const it = ref.data();
    const subj = prompt("ê³¼ëª©", it.subj||""); if(subj===null) return;
    const text = prompt("ë‚´ìš©", it.text||""); if(text===null) return;
    const memo = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", it.memo||""); if(memo===null) return;
    await colTasks(cat).doc(id).update({ subj, text, memo });
  }

  // ===== ëª©ë¡ êµ¬ë… =====
  function startListeners(){
    unsubscribers.forEach(u => u && u());
    unsubscribers = [];

    // ì „ë‹¬ ì‚¬í•­ í‘œì‹œ ì—¬ë¶€
    const uS = docSettings().onSnapshot(snap=>{
      const show = !!snap.data()?.showNotice;
      el.noticeToggle.checked = show;
      // í‘œì‹œ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ ëª©ë¡ì€ ë³´ì—¬ì£¼ë˜, ë¹ˆ ë¬¸êµ¬ëŠ” showì¼ ë•Œë§Œ ê°ì¶°ë„ OK
      // ì—¬ê¸°ì„œëŠ” show=false ì—¬ë„ ëª©ë¡ì€ í‘œì‹œ(ìš”ì²­ì‚¬í•­ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥)
    });
    unsubscribers.push(uS);

    // ì „ë‹¬ ì‚¬í•­ ëª©ë¡
    const uN = colAnnounces().orderBy("createdAt","desc").onSnapshot(snap=>{
      const arr = [];
      snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
      renderNotices(arr);
    });
    unsubscribers.push(uN);

    // ê° ì¹´í…Œê³ ë¦¬
    ["exam","perf","home"].forEach(cat=>{
      const u = colTasks(cat).orderBy("dueStart","asc").onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
        renderTasks(cat, arr);
      });
      unsubscribers.push(u);
    });
  }

  // ===== ì „ë‹¬ ì‚¬í•­ ë Œë” =====
  function renderNotices(list){
    el.noticeList.innerHTML = "";
    if(!list.length){
      el.noticeEmpty.style.display = "";
      return;
    }
    el.noticeEmpty.style.display = "none";
    for(const n of list){
      const li = document.createElement("li");
      li.className = `notice-item notice-${n.level||"info"}`;
      li.innerHTML = `
        <div class="notice-title">
          <span class="tag ${n.level||"info"}">${(n.level==="alert"?"ê¸´ê¸‰":(n.level==="warn"?"ì£¼ì˜":"ì•ˆë‚´"))}</span>
          <b>${escapeHtml(n.title||"")}</b>
        </div>
        <div class="notice-body">${(n.body||"").replaceAll("\n","<br>")}</div>
        ${isAdmin?`<div class="task-btns"><button class="btn ghost" data-act="ndel" data-id="${n.id}">ì‚­ì œ</button></div>`:""}
      `;
      el.noticeList.appendChild(li);
    }
    if(isAdmin){
      el.noticeList.onclick = async (e)=>{
        const t = e.target;
        const act = t.getAttribute("data-act");
        if(act==="ndel"){
          const id = t.getAttribute("data-id");
          if(confirm("ì „ë‹¬ ì‚¬í•­ì„ ì‚­ì œí• ê¹Œìš”?")){
            await colAnnounces().doc(id).delete();
          }
        }
      }
    }
  }

  function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  // ===== ì „ë‹¬ ì‚¬í•­ ON/OFF (ê´€ë¦¬ì) =====
  el.noticeToggle.onchange = async ()=>{
    if(!isAdmin){ el.noticeToggle.checked = !el.noticeToggle.checked; return; }
    try{
      await docSettings().set({ showNotice: el.noticeToggle.checked }, { merge:true });
    }catch(e){
      alert(`ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
    }
  };

  // ===== ì „ë‹¬ ì‚¬í•­ ì¶”ê°€ (ê´€ë¦¬ì) + ì´ˆì•ˆ ì €ì¥ =====
  function loadNoticeDraft(){
    try{
      const d = JSON.parse(localStorage.getItem(DRAFT_NOTICE)||"{}");
      el.nf_title.value = d.title || "";
      el.nf_level.value = d.level || "info";
      el.nf_body.value  = d.body  || "";
    }catch(_){}
  }
  function saveNoticeDraft(){
    const data = { title: el.nf_title.value, level: el.nf_level.value, body: el.nf_body.value };
    localStorage.setItem(DRAFT_NOTICE, JSON.stringify(data));
  }
  ["input","change"].forEach(ev=>{
    el.nf_title.addEventListener(ev, saveNoticeDraft);
    el.nf_level.addEventListener(ev, saveNoticeDraft);
    el.nf_body.addEventListener(ev,  saveNoticeDraft);
  });

  el.nf_add.onclick = async ()=>{
    if(!isAdmin) return;
    const title = el.nf_title.value.trim();
    const body  = el.nf_body.value.trim();
    const level = el.nf_level.value;
    if(!title || !body){ alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
    await colAnnounces().add({
      title, body, level,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // ì„±ê³µ â†’ í¼ ë¹„ìš°ê³  ì´ˆì•ˆ ì‚­ì œ
    el.nf_title.value = ""; el.nf_body.value = ""; el.nf_level.value = "info";
    localStorage.removeItem(DRAFT_NOTICE);
  };

  // ===== ê³¼ëª©/ë‚´ìš©/ë‚ ì§œ/êµì‹œ/ë©”ëª¨ ì´ˆì•ˆ ì €ì¥ =====
  function gatherTaskDraft(){
    const data = {};
    $$(".add-row").forEach(row=>{
      const cat = row.dataset.cat;
      data[cat] = {
        subj:  $(".subj", row).value,
        text:  $(".text", row).value,
        date1: $(".date:nth-of-type(1)", row).value,
        date2: $(".date:nth-of-type(2)", row).value,
        ps:    $(".period-start", row).value,
        pe:    $(".period-end", row).value,
        memo:  $(".memo", row).value
      };
    });
    return data;
  }
  function loadTaskDraft(){
    try{
      const raw = localStorage.getItem(DRAFT_TASK);
      if(!raw) return;
      const d = JSON.parse(raw);
      $$(".add-row").forEach(row=>{
        const cat = row.dataset.cat;
        const x = d?.[cat]; if(!x) return;
        $(".subj", row).value = x.subj||"";
        $(".text", row).value = x.text||"";
        $(".date:nth-of-type(1)", row).value = x.date1||"";
        $(".date:nth-of-type(2)", row).value = x.date2||"";
        $(".period-start", row).value = x.ps||"";
        $(".period-end", row).value = x.pe||"";
        $(".memo", row).value = x.memo||"";
      });
    }catch(_){}
  }
  function persistTaskDraft(){ localStorage.setItem(DRAFT_TASK, JSON.stringify(gatherTaskDraft())); }
  document.addEventListener("input",(e)=>{ if(e.target.closest(".add-row")) persistTaskDraft(); });

  function clearTaskRow(row){
    $(".subj", row).value = "";
    $(".text", row).value = "";
    $(".date:nth-of-type(1)", row).value = "";
    $(".date:nth-of-type(2)", row).value = "";
    $(".period-start", row).value = "";
    $(".period-end", row).value = "";
    $(".memo", row).value = "";
    persistTaskDraft();
  }

  // ===== ì¶”ê°€ ë²„íŠ¼ ë°”ì¸ë”© =====
  function bindAddRows(){
    $$(".add-row").forEach(row=>{
      const btn = $(".add", row);
      const cat = row.dataset.cat;
      btn.onclick = async ()=>{
        if(!isAdmin){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
        const subj = $(".subj", row).value.trim();
        const text = $(".text", row).value.trim();
        const date1= $(".date:nth-of-type(1)", row).value || "";
        const date2= $(".date:nth-of-type(2)", row).value || "";
        const ps   = $(".period-start", row).value || "";
        const pe   = $(".period-end", row).value || "";
        const memo = $(".memo", row).value.trim();

        if(!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
        await colTasks(cat).add({
          subj, text, memo,
          dueStart: date1 || null,
          dueEnd:   date2 || null,
          periodStart: ps || null,
          periodEnd:   pe || null,
          done:false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        clearTaskRow(row);
      };
    });
  }

  // ===== ìµœì´ˆ ë¡œë“œ ì‹œ ì´ˆì•ˆ ë³µì› =====
  loadNoticeDraft();
  loadTaskDraft();

  // ===== ë°”ì¸ë”© & ë¦¬ìŠ¤ë„ˆ ì‹œì‘ =====
  bindAddRows();
  startListeners();

  // ===== 1ë¶„ë§ˆë‹¤ ì¡°ìš©í•œ ê°±ì‹  =====
  setInterval(()=>{ startListeners(); }, 60*1000);

  </script>
</body>
</html>
