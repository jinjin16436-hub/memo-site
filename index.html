<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ™ì œ & ìˆ˜í–‰í‰ê°€ ë©”ëª¨</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ë°” -->
  <header class="admin-bar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <button id="loginBtn" class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <!-- ë³¸ë¬¸ -->
  <main class="container">
    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">ğŸ“„ ìˆ˜í–‰í‰ê°€ â–¾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>
        <!-- ê¸°ë³¸ì€ ìˆ¨ê¹€: ë¡œê·¸ì¸ ì‹œ í‘œì‹œ -->
        <div class="add-row" data-cat="perf" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="endPeriod">
            <option value="">ë êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">ğŸ§ª ì‹œí—˜ â–¾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="endPeriod">
            <option value="">ë êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>
        <div class="add-row" data-cat="home" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="endPeriod">
            <option value="">ë êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* ================= Firebase ================= */
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.appspot.com",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);

    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* ================= Utils ================= */
    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const yoil = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const pad2 = n => String(n).padStart(2,"0");
    const fmtDate = d => {
      if(!d) return "";
      const x = new Date(d);
      return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    };
    function esc(s){return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}
    function toggleSection(id){ $("#"+id).classList.toggle("open"); }

    // ì¶”ê°€ í¼ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    function setAddRowsVisible(isOn) {
      document.querySelectorAll(".add-row").forEach(r => {
        r.style.display = isOn ? "" : "none";
      });
    }

    let currentUser = null;
    let unsub = { perf:null, exam:null, home:null };
    let openEditorEl = null;   // í˜„ì¬ ì—´ë¦° ì—ë””í„° DOM
    let openEditorKey = null;  // "cat:id"

    const col = (cat) => {
      const uid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;
      return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
    };

    /* ================= D-day ================= */
    function getDdayBadge(dateStr){
  if(!dateStr) return "";
  const MS_DAY = 24 * 60 * 60 * 1000;

  const today = new Date();  
  today.setHours(0,0,0,0);

  const target = new Date(dateStr); 
  target.setHours(0,0,0,0);

  const diff = Math.floor((target - today) / MS_DAY);

  let label;
  if (diff === 0) label = "D-DAY";
  else if (diff > 0) label = `D-${diff}`;
  else label = `D+${Math.abs(diff)}`;

  // ë¯¸ë˜ ë‚ ì§œ ìƒ‰ìƒ
  let color = "var(--green)";
  if (diff === 0 || diff === 1) color = "var(--red)";
  else if (diff === 2 || diff === 3) color = "var(--orange)";
  else if (diff === 4 || diff === 5) color = "var(--yellow)";
  else if (diff >= 6) color = "var(--green)";

  // ì§€ë‚œ ì¼ì •ì€ ë³„ë„ í´ë˜ìŠ¤
  const pastClass = diff < 0 ? " past" : "";
  const styleAttr = diff >= 0 ? ` style="background:${color}"` : "";

  return `<span class="dday${pastClass}"${styleAttr}>${label}</span>`;
}



    /* ================= Render ================= */
    function renderList(cat, items){
      const ul = $("#list_"+cat);
      ul.innerHTML = "";

      for(const it of items){
        const li = document.createElement("li");
        li.className = "task" + (it.done ? " done" : "");
        li.dataset.id = it.id;
        li.dataset.cat = cat;

        const due1 = it.due || "";
        const due2 = it.due2 || "";
        const yo = due1 ? `(${yoil[new Date(due1).getDay()]})` : "";
        const dayStr = due1 ? (due2 ? `${due1} ~ ${due2}` : `${due1}`) : "";
        const period = it.startP ? `${it.startP}${it.endP?`~${it.endP}`:""}êµì‹œ` : "";
        const detail = it.detail ? `<div class="detail">${esc(it.detail)}</div>` : "";
        const dday   = getDdayBadge(due1);

        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""}
                   data-act="toggle" data-id="${it.id}" data-cat="${cat}">
            <span></span>
          </label>

          <div class="task__main">
            <div class="task__line"><b>${esc(it.subj||"")}</b></div>
            <div>${esc(it.text||"")}</div>
            <div class="task__meta">ğŸ“… ${dayStr} ${yo} ${period} ${dday}</div>
            ${detail}
          </div>

          <div class="task__btns">
            <button class="btn-ghost" data-act="edit" data-id="${it.id}" data-cat="${cat}">ìˆ˜ì •</button>
            <button class="btn-ghost" data-act="del" data-id="${it.id}" data-cat="${cat}">ì‚­ì œ</button>
          </div>
        `;

        ul.appendChild(li);
      }
    }

    /* ================= Listeners ================= */
    function startListenerFor(cat){
      if(unsub[cat]) { unsub[cat](); unsub[cat] = null; }
      unsub[cat] = col(cat).orderBy("due","asc").onSnapshot(snap=>{
        const arr = []; snap.forEach(d => arr.push({id:d.id,...d.data()}));
        renderList(cat, arr);
      });
    }
    function startListeners(){
      ["perf","exam","home"].forEach(startListenerFor);
    }

    /* ================= Add ================= */
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        $(".add",row).onclick = async ()=>{
          if(!currentUser) return alert("ë¡œê·¸ì¸ í›„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.");
          const subj   = $(".subj",row).value.trim();
          const text   = $(".text",row).value.trim();
          const due    = $(".date",row).value;
          const due2   = $(".date2",row).value;
          const startP = $(".startPeriod",row).value;
          const endP   = $(".endPeriod",row).value;
          const detail = $(".detail",row).value.trim();

          if(!subj || !text) return alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

          await col(row.dataset.cat).add({
            subj, text, due, due2, startP, endP, detail,
            done:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // í¼ ë¹„ìš°ê¸°
          $(".subj",row).value = "";
          $(".text",row).value = "";
          $(".date",row).value = "";
          $(".date2",row).value = "";
          $(".startPeriod",row).value = "";
          $(".endPeriod",row).value = "";
          $(".detail",row).value = "";
        };
      });
    }

    /* ================= Edit (Inline) ================= */
    function closeEditor(){
      if(openEditorEl){
        openEditorEl.remove();
        openEditorEl = null;
        openEditorKey = null;
      }
    }

    async function openEditor(cat, id, li){
      if(!currentUser) return alert("ë¡œê·¸ì¸ í›„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.");

      // ê¸°ì¡´ ì—ë””í„° ì—´ë ¤ ìˆìœ¼ë©´ ë‹«ê¸°
      if(openEditorEl){
        if(openEditorKey === `${cat}:${id}`){ closeEditor(); return; }
        closeEditor();
      }

      // í˜„ì¬ ë°ì´í„° ì½ê¸°
      const snap = await col(cat).doc(id).get();
      if(!snap.exists) return alert("ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      const it = { id, ...snap.data() };

      // ì—ë””í„° DOM
      const panel = document.createElement("div");
      panel.className = "edit-panel open";
      panel.innerHTML = `
        <div class="edit-grid">
          <input class="e-subj" type="text" placeholder="ê³¼ëª©" />
          <input class="e-text" type="text" placeholder="ë‚´ìš©" />
          <input class="e-date" type="date" />
          <span class="tilde">~</span>
          <input class="e-date2" type="date" />
          <select class="e-startP">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="e-endP">
            <option value="">ë êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>

          <textarea class="e-detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>

          <div class="edit-actions">
            <button class="btn save">ì €ì¥</button>
            <button class="btn-ghost cancel">ì·¨ì†Œ</button>
          </div>
        </div>
      `;

      // ê°’ ì±„ìš°ê¸°
      $(".e-subj",panel).value   = it.subj || "";
      $(".e-text",panel).value   = it.text || "";
      $(".e-date",panel).value   = it.due  || "";
      $(".e-date2",panel).value  = it.due2 || "";
      $(".e-startP",panel).value = it.startP || "";
      $(".e-endP",panel).value   = it.endP   || "";
      $(".e-detail",panel).value = it.detail || "";

      // li ì•„ë˜ì— ì‚½ì…
      li.after(panel);
      openEditorEl  = panel;
      openEditorKey = `${cat}:${id}`;

      // ESCë¡œ ë‹«ê¸°
      const escHandler = (ev)=>{ if(ev.key === "Escape") closeEditor(); };
      document.addEventListener("keydown", escHandler, { once:true });

      // ì €ì¥
      $(".save",panel).onclick = async ()=>{
        const subj   = $(".e-subj",panel).value.trim();
        const text   = $(".e-text",panel).value.trim();
        const due    = $(".e-date",panel).value;
        const due2   = $(".e-date2",panel).value;
        const startP = $(".e-startP",panel).value;
        const endP   = $(".e-endP",panel).value;
        const detail = $(".e-detail",panel).value.trim();

        if(!subj || !text) return alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

        try{
          await col(cat).doc(id).update({ subj, text, due, due2, startP, endP, detail });
          closeEditor();
        }catch(e){
          alert("ìˆ˜ì • ì‹¤íŒ¨: "+e.message);
          console.error(e);
        }
      };

      // ì·¨ì†Œ
      $(".cancel",panel).onclick = closeEditor;
    }

    /* ================= Card clicks ================= */
    document.body.addEventListener("click", async (e)=>{
      const t = e.target;
      const act = t.dataset.act;
      if(!act) return;

      const cat = t.dataset.cat;
      const id  = t.dataset.id;

      if(act === "toggle"){
        if(!currentUser){ alert("ìˆ˜ì •/ì‚­ì œëŠ” ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤."); t.checked = !t.checked; return; }
        try{ await col(cat).doc(id).update({ done: t.checked }); }
        catch(err){ alert("ë³€ê²½ ì‹¤íŒ¨: "+err.message); t.checked = !t.checked; }
        return;
      }

      if(act === "del"){
        if(!currentUser) return alert("ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        try { await col(cat).doc(id).delete(); closeEditor(); }
        catch(err){ alert("ì‚­ì œ ì‹¤íŒ¨: "+err.message); }
        return;
      }

      if(act === "edit"){
        const li = t.closest(".task");
        openEditor(cat, id, li);
        return;
      }
    });

    /* ================= Auth ================= */
    $("#loginBtn").onclick  = ()=> auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    $("#logoutBtn").onclick = ()=> auth.signOut();

    auth.onAuthStateChanged(u=>{
      currentUser = u;
      $("#loginBtn").style.display  = u ? "none" : "";
      $("#logoutBtn").style.display = u ? "" : "none";
      closeEditor();

      // âœ… ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì¶”ê°€ í¼ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
      setAddRowsVisible(!!u);
    });

    /* ================= Init ================= */
    bindAddRows();
    startListeners();
  </script>
</body>
</html>
