<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

<header class="topbar">
  <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
  <div class="spacer"></div>
  <button id="loginBtn" class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
  <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</header>

<!-- ===================== ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ ===================== -->
<section class="notice-block">
  <div class="notice-head">
    <div class="title">
      <span class="ico">ğŸ“¢</span>
      <span>ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</span>
    </div>

    <div class="notice-controls">
      <!-- í‘œì‹œ í† ê¸€ (ëª¨ë‘ì—ê²Œ ë³´ì´ëŠ” ìƒíƒœë¥¼ ê´€ë¦¬ìë§Œ ë³€ê²½) -->
      <label class="switch">
        <input id="toggleNotice" type="checkbox">
        <span class="slider"></span>
      </label>
      <span class="toggle-label">í‘œì‹œ</span>
    </div>
  </div>

  <!-- ê³µì§€ ëª©ë¡ -->
  <div id="noticeList" class="notice-list"></div>

  <!-- ê´€ë¦¬ì ì „ìš© ì…ë ¥ -->
  <div id="noticeForm" class="notice-form" style="display:none">
    <div class="row">
      <input id="noticeTitle"   class="inp" placeholder="ì œëª©"/>
      <select id="noticeType"   class="inp">
        <option value="yellow">ì „ë‹¬ ì‚¬í•­(ë…¸ë‘)</option>
        <option value="red">ê¸´ê¸‰(ë¹¨ê°•)</option>
        <option value="blue">ì•ˆë‚´(íŒŒë‘)</option>
        <option value="green">ì°¸ê³ (ì´ˆë¡)</option>
        <option value="purple">ì¤‘ìš”(ë³´ë¼)</option>
      </select>
      <button id="addNotice" class="btn primary">+ ì¶”ê°€</button>
    </div>
    <textarea id="noticeBody" class="inp" rows="4" placeholder="ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
  </div>
</section>

<!-- ===================== ì„¹ì…˜: ì‹œí—˜ / ìˆ˜í–‰í‰ê°€ / ìˆ™ì œ ===================== -->
<main class="container">

  <!-- ì‹œí—˜ -->
  <section>
    <div class="section-head" onclick="toggleSection('sec_exam')">
      <span>ğŸ§ª ì‹œí—˜</span>
      <span class="arrow">â–¾</span>
    </div>
    <div id="sec_exam" class="section-body open">
      <ul id="list_exam" class="task-list"></ul>
      <div class="add-row" data-cat="exam" style="display:none">
        <input class="subj inp" type="text" placeholder="ê³¼ëª©"/>
        <input class="text inp" type="text" placeholder="ë‚´ìš©"/>
        <input class="date inp" type="date"/>
        <input class="date inp" type="date"/>
        <select class="startPd inp">
          <option value="">êµì‹œ ì—†ìŒ</option>
          <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <select class="endPd inp">
          <option value="">êµì‹œ ì—†ìŒ</option>
          <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <button class="add btn primary">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail inp add-detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ˜í–‰í‰ê°€ -->
  <section>
    <div class="section-head" onclick="toggleSection('sec_perf')">
      <span>ğŸ“„ ìˆ˜í–‰í‰ê°€</span>
      <span class="arrow">â–¾</span>
    </div>
    <div id="sec_perf" class="section-body open">
      <ul id="list_perf" class="task-list"></ul>
      <div class="add-row" data-cat="perf" style="display:none">
        <input class="subj inp" type="text" placeholder="ê³¼ëª©"/>
        <input class="text inp" type="text" placeholder="ë‚´ìš©"/>
        <input class="date inp" type="date"/>
        <input class="date inp" type="date"/>
        <select class="startPd inp">
          <option value="">êµì‹œ ì—†ìŒ</option>
          <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <select class="endPd inp">
          <option value="">êµì‹œ ì—†ìŒ</option>
          <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <button class="add btn primary">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail inp add-detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ™ì œ -->
  <section>
    <div class="section-head" onclick="toggleSection('sec_home')">
      <span>ğŸ“Œ ìˆ™ì œ</span>
      <span class="arrow">â–¾</span>
    </div>
    <div id="sec_home" class="section-body open">
      <ul id="list_home" class="task-list"></ul>
      <div class="add-row" data-cat="home" style="display:none">
        <input class="subj inp" type="text" placeholder="ê³¼ëª©"/>
        <input class="text inp" type="text" placeholder="ë‚´ìš©"/>
        <input class="date inp" type="date"/>
        <input class="date inp" type="date"/>
        <select class="startPd inp">
          <option value="">êµì‹œ ì—†ìŒ</option>
          <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <select class="endPd inp">
          <option value="">êµì‹œ ì—†ìŒ</option>
          <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <button class="add btn primary">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail inp add-detail" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

</main>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // ===== Firebase ì„¤ì • (ê·¸ëŒ€ë¡œ ì‚¬ìš©) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
    authDomain: "my-memo-site.firebaseapp.com",
    projectId: "my-memo-site",
    storageBucket: "my-memo-site.firebasestorage.app",
    messagingSenderId: "196036694705",
    appId: "1:196036694705:web:8988d12919420130464890"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ===== ê´€ë¦¬ì UID =====
  const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

  // ===== ìœ í‹¸ =====
  const $  = (q, r=document)=>r.querySelector(q);
  const $$ = (q, r=document)=>Array.from(r.querySelectorAll(q));
  const weekday = (d)=>["(ì¼)","(ì›”)","(í™”)","(ìˆ˜)","(ëª©)","(ê¸ˆ)","(í† )"][new Date(d+"T00:00:00").getDay()];

  function periodLabel(v){
    if (v===undefined || v===null) return "";
    const s = String(v).trim();
    if (!s) return "";
    if (/^\d+$/.test(s)) return `${s}êµì‹œ`;
    return "";
  }

  function ddayLabel(start){
    if(!start) return "";
    const base=new Date(); base.setHours(0,0,0,0);
    const s = new Date(start+"T00:00:00");
    if(isNaN(s.getTime())) return "";
    const diff = Math.round((s-base)/86400000);
    if (diff<0) return `<span class="dday past">A+${Math.abs(diff)}</span>`;
    if (diff===0) return `<span class="dday warn">D-DAY</span>`;
    let cls="far"; if(diff<=2) cls="urgent"; else if(diff<=3) cls="soon"; else if(diff<=5) cls="near";
    return `<span class="dday ${cls}">D-${diff}</span>`;
  }

  // ===== ì „ì—­ ìƒíƒœ =====
  let currentUser=null;
  let unsubTasks = [];
  let unsubNotice = null;
  let unsubSettings = null;

  // ===== ì„¹ì…˜ í† ê¸€ ì €ì¥ =====
  function toggleSection(id){
    const b = document.getElementById(id);
    b.classList.toggle("open");
    const st = {
      exam: $("#sec_exam")?.classList.contains("open"),
      perf: $("#sec_perf")?.classList.contains("open"),
      home: $("#sec_home")?.classList.contains("open"),
    };
    localStorage.setItem("open:v1", JSON.stringify(st));
  }
  (function restoreOpen(){
    try{
      const s = JSON.parse(localStorage.getItem("open:v1")||"{}");
      if(s.exam===false) $("#sec_exam")?.classList.remove("open");
      if(s.perf===false) $("#sec_perf")?.classList.remove("open");
      if(s.home===false) $("#sec_home")?.classList.remove("open");
    }catch{}
  })();

  // ===== Firestore refs =====
  const tasksCol = (cat, uid)=> db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
  const settingsDoc = db.collection("settings").doc("global");
  const noticeCol = db.collection("notice");

  // ===== ë¡œê·¸ì¸ ì œì–´ =====
  $("#loginBtn").onclick = async ()=>{
    try{
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
    }catch(e){ alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message); }
  };
  $("#logoutBtn").onclick = ()=> auth.signOut();

  auth.onAuthStateChanged(user=>{
    currentUser=user;
    $("#loginBtn").style.display = user? "none":"";
    $("#logoutBtn").style.display= user? "":"none";
    const isAdmin = !!(user && user.uid===OWNER_UID);
    setEditVisible(isAdmin);
    startListeners(isAdmin);
  });

  // ===== í¸ì§‘ UI ë…¸ì¶œ (ê´€ë¦¬ìë§Œ) =====
  function setEditVisible(isAdmin){
    $$(".add-row").forEach(r=> r.style.display = isAdmin? "" : "none");
    $$(".add-detail").forEach(t=> t.style.display = isAdmin? "" : "none");
    $("#noticeForm").style.display = isAdmin? "" : "none";
  }

  // ===== ì„¹ì…˜ë³„ ì‹¤ì‹œê°„ êµ¬ë… =====
  function startListeners(isAdmin){
    // ê¸°ì¡´ í•´ì œ
    unsubTasks.forEach(u=>u&&u()); unsubTasks=[];
    unsubNotice && unsubNotice(); unsubNotice=null;
    unsubSettings && unsubSettings(); unsubSettings=null;

    const readUid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;

    ["exam","perf","home"].forEach(cat=>{
      const u = tasksCol(cat, readUid).orderBy("start","asc").onSnapshot(snap=>{
        const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        renderList(cat, arr, isAdmin);
      });
      unsubTasks.push(u);
    });

    // ê³µì§€ ëª©ë¡
    unsubNotice = noticeCol.orderBy("createdAt","desc").onSnapshot(snap=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      renderNotices(arr, isAdmin);
    });

    // í‘œì‹œ ON/OFF
    unsubSettings = settingsDoc.onSnapshot(doc=>{
      const v = doc.exists? !!doc.data().showNotice : false;
      $("#toggleNotice").checked = v;
      $(".notice-block").classList.toggle("hidden", !v);
    });
  }

  // ===== ëª©ë¡ ë Œë” =====
  function renderList(cat, items, isAdmin){
    const ul = document.getElementById("list_"+cat);
    ul.innerHTML = "";
    for(const it of items){
      ul.appendChild(renderOne(cat, it, isAdmin));
    }
    bindAdd(cat);
  }

  function renderOne(cat, it, isAdmin){
    const li = document.createElement("li");
    li.className = "task";
    const hasS = !!(it.start && !isNaN(new Date(it.start+"T00:00:00")));
    const hasE = !!(it.end   && !isNaN(new Date(it.end  +"T00:00:00")));
    const sStr = hasS? `${it.start} ${weekday(it.start)}` : "";
    const eStr = hasE? `${it.end} ${weekday(it.end)}` : "";
    const sp = periodLabel(it.startPd);
    const ep = periodLabel(it.endPd);

    const parts=[];
    if(sStr) parts.push(sStr);
    if(eStr) parts.push(eStr);
    if(sp && ep) parts.push(`${sp} ~ ${ep}`);
    else if(sp) parts.push(sp);
    else if(ep) parts.push(ep);
    const dateLine = parts.length ? `ğŸ“… ${parts.join("  ~  ")}` : "";

    li.innerHTML = `
      <label class="chk"><input type="checkbox"><span></span></label>
      <div class="main">
        <div class="line1">
          <b class="subject">${(it.subj||"")}</b>
          ${ddayLabel(it.start)}
        </div>
        <div class="line2">${(it.text||"").replace(/\n/g,"<br>")}</div>
        ${it.detail ? `<div class="line3 small">${it.detail.replace(/\n/g,"<br>")}</div>` : ""}
        ${dateLine ? `<div class="meta">${dateLine}</div>` : ""}
      </div>
      <div class="ops" style="${isAdmin?'':'display:none'}">
        <button class="btn ghost edit">ìˆ˜ì •</button>
        <button class="btn ghost del">ì‚­ì œ</button>
      </div>
    `;

    $(".edit", li)?.addEventListener("click", ()=> openEdit(cat, it));
    $(".del", li)?.addEventListener("click", async ()=>{
      if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      try{ await tasksCol(cat, OWNER_UID).doc(it.id).delete(); }
      catch(e){ alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message); }
    });
    return li;
  }

  // ===== í•­ëª© ì¶”ê°€ =====
  function bindAdd(cat){
    const wrap = $(`.add-row[data-cat="${cat}"]`);
    if(!wrap) return;
    wrap.querySelector(".add").onclick = async ()=>{
      if(!(currentUser && currentUser.uid===OWNER_UID)) { alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }
      const subj = $(".subj", wrap).value.trim();
      const text = $(".text", wrap).value.trim();
      const dates = $$(".date", wrap).map(i=>i.value.trim());
      const start = dates[0] || "";
      const end   = dates[1] || "";
      const startPd = $(".startPd", wrap).value;
      const endPd   = $(".endPd", wrap).value;
      const detail  = wrap.parentElement.querySelector(".add-detail").value.trim();

      if(!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

      try{
        await tasksCol(cat, OWNER_UID).add({
          subj, text, detail, start, end, startPd, endPd,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // ì…ë ¥ ì´ˆê¸°í™”
        $$(".inp", wrap).forEach(i=> i.value="");
        wrap.parentElement.querySelector(".add-detail").value = "";
      }catch(e){ alert("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
    };
  }

  // ===== í¸ì§‘ ë‹¤ì´ì–¼ë¡œê·¸ (ê°„ë‹¨) =====
  function openEdit(cat, it){
    const subj=prompt("ê³¼ëª©", it.subj||""); if(subj===null) return;
    const text=prompt("ë‚´ìš©", it.text||""); if(text===null) return;
    const start=prompt("ì‹œì‘ ë‚ ì§œ(YYYY-MM-DD)", it.start||"")||"";
    const end  =prompt("ë ë‚ ì§œ(YYYY-MM-DD)", it.end||"")||"";
    const startPd=prompt("ì‹œì‘ êµì‹œ(ìˆ«ì ë˜ëŠ” ë¹ˆì¹¸)", it.startPd||"")||"";
    const endPd  =prompt("ë êµì‹œ(ìˆ«ì ë˜ëŠ” ë¹ˆì¹¸)", it.endPd||"")||"";
    const detail =prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ, \\n ì¤„ë°”ê¿ˆ)", it.detail||"")||"";
    tasksCol(cat, OWNER_UID).doc(it.id).update({subj,text,start,end,startPd,endPd,detail})
      .catch(e=>alert("ìˆ˜ì • ì‹¤íŒ¨: "+e.message));
  }

  // ===== ê³µì§€ ë Œë” =====
  function renderNotices(items, isAdmin){
    const box = $("#noticeList");
    box.innerHTML = "";
    for(const n of items){
      const card = document.createElement("div");
      card.className = `note ${n.type||"yellow"}`;
      card.innerHTML = `
        <div class="note-title">${(n.title||"")}</div>
        <div class="note-body">${(n.body||"").replace(/\n/g,"<br>")}</div>
        ${isAdmin ? `<div class="note-ops">
          <button class="btn ghost" data-act="edit">ìˆ˜ì •</button>
          <button class="btn ghost" data-act="del">ì‚­ì œ</button>
        </div>` : ""}
      `;
      if(isAdmin){
        $("[data-act='edit']", card).onclick = async ()=>{
          const title = prompt("ì œëª©", n.title||""); if(title===null) return;
          const body  = prompt("ë‚´ìš© (\\n ì¤„ë°”ê¿ˆ)", n.body||""); if(body===null) return;
          const type  = prompt("ìƒ‰(yellow/red/blue/green/purple)", n.type||"yellow")||"yellow";
          try{ await noticeCol.doc(n.id).update({title, body, type}); }
          catch(e){ alert("ìˆ˜ì • ì‹¤íŒ¨: "+e.message); }
        };
        $("[data-act='del']", card).onclick = async ()=>{
          if(!confirm("ê³µì§€ ì‚­ì œí• ê¹Œìš”?")) return;
          try{ await noticeCol.doc(n.id).delete(); }
          catch(e){ alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message); }
        };
      }
      box.appendChild(card);
    }
  }

  // ê³µì§€ ì¶”ê°€
  $("#addNotice").onclick = async ()=>{
    if(!(currentUser && currentUser.uid===OWNER_UID)){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
    const title = $("#noticeTitle").value.trim();
    const body  = $("#noticeBody").value.trim();
    const type  = $("#noticeType").value;
    if(!title || !body){ alert("ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
    try{
      await noticeCol.add({title, body, type, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
      $("#noticeTitle").value=""; $("#noticeBody").value="";
    }catch(e){ alert("ê³µì§€ ì €ì¥ ì‹¤íŒ¨: "+e.message); }
  };

  // í‘œì‹œ ON/OFF í† ê¸€
  $("#toggleNotice").addEventListener("change", async (e)=>{
    const on = e.target.checked;
    if(!(currentUser && currentUser.uid===OWNER_UID)){
      // ì½ê¸°ìš© ìƒíƒœëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ì‹œí‚¤ê³  í† ê¸€ì€ ë˜ëŒë¦¼
      e.target.checked = !on;
      alert("ê´€ë¦¬ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    try{
      await settingsDoc.set({showNotice: on}, {merge:true});
    }catch(err){
      alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: "+err.message);
      e.target.checked = !on; // ë˜ëŒë¦¬ê¸°
    }
  });

  // 1ë¶„ë§ˆë‹¤ ì¡°ìš©íˆ ê°±ì‹ 
  setInterval(()=> {
    // Firestore onSnapshotì´ ì‹¤ì‹œê°„ì´ì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ ìºì‹œ ë˜ëŠ” ë Œë” ê¼¬ì„ ëŒ€ë¹„
    // í‘œì‹œ ìƒíƒœëŠ” onSnapshotìœ¼ë¡œ ìë™ ë°˜ì˜ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì„¹ì…˜ ì ‘í˜ ìƒíƒœë§Œ ê°±ì‹ 
    // (í•„ìš”ì‹œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì•„ë˜ ì£¼ì„ í•´ì œ)
    // location.reload();
  }, 60000);
</script>

</body>
</html>
