<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ìˆ™ì œ ë©”ëª¨ (Firebase)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€ ë©”ëª¨</h1>
    <div class="admin-bar">
      <button id="loginBtn"  class="btn-sm">ğŸ”‘ Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn-sm" style="display:none">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <main>
    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <button class="toggle-btn" onclick="toggleSection('sec_perf')">ğŸ“‘ ìˆ˜í–‰í‰ê°€ â–¼</button>
      <div id="sec_perf" class="toggle-content open">
        <ul id="list_perf" class="task-list"></ul>
        <div class="add-row" data-cat="perf" style="display:none">
          <input class="in subj" placeholder="ê³¼ëª© (ì˜ˆ: êµ­ì–´)">
          <input class="in text" placeholder="ë‚´ìš© (ì˜ˆ: ë°œí‘œ ì¤€ë¹„)">
          <input class="in date" type="date" placeholder="ê¸°í•œ">
          <button class="btn-sm add">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section>
      <button class="toggle-btn" onclick="toggleSection('sec_exam')">ğŸ“ ì‹œí—˜ â–¼</button>
      <div id="sec_exam" class="toggle-content open">
        <ul id="list_exam" class="task-list"></ul>
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="in subj" placeholder="ê³¼ëª© (ì˜ˆ: ìˆ˜í•™)">
          <input class="in text" placeholder="ë‚´ìš© (ì˜ˆ: ë‹¨ì›í‰ê°€)">
          <input class="in date" type="date" placeholder="ì¼ì">
          <button class="btn-sm add">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <button class="toggle-btn" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¼</button>
      <div id="sec_home" class="toggle-content open">
        <ul id="list_home" class="task-list"></ul>
        <div class="add-row" data-cat="home" style="display:none">
          <input class="in subj" placeholder="ê³¼ëª© (ì˜ˆ: ê³¼í•™)">
          <input class="in text" placeholder="ë‚´ìš© (ì˜ˆ: ë¦¬í¬íŠ¸)">
          <input class="in date" type="date" placeholder="ê¸°í•œ">
          <button class="btn-sm add">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>ğŸ”’ ë¡œê·¸ì¸í•˜ë©´ â€œì¶”ê°€/ì‚­ì œ/ì™„ë£Œì²´í¬â€ ê°€ëŠ¥ (ë³¸ì¸ë§Œ ì“°ê¸°)</p>
  </footer>

  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

 <script>
  // ===== Firebase ì´ˆê¸°í™” (ë„¤ firebaseConfigëŠ” ì´ë¯¸ ìœ„ì— ìˆìŒ) =====
  // ì˜ˆ: const firebaseConfig = { ... }; firebase.initializeApp(firebaseConfig);

  // âœ… ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œ ë³´ì—¬ì¤„ ì£¼ì¸ UID
  const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

  // ===== Firebase handles =====
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ===== DOM helpers =====
  const $  = (q, root=document) => root.querySelector(q);
  const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

  const el = {
    loginBtn:  $("#loginBtn"),
    logoutBtn: $("#logoutBtn"),
    lists:     { perf: $("#list_perf"), exam: $("#list_exam"), home: $("#list_home") }
  };

  let currentUser = null;
  let unsubscribers = [];

  // ===== ì„¹ì…˜ í† ê¸€ (ì—†ì–´ì„œ ì—ëŸ¬ë‚¬ë˜ í•¨ìˆ˜) =====
  function toggleSection(id){
    const box = document.getElementById(id);
    if(!box) return;
    box.classList.toggle("open");
  }

  // ===== í¸ì§‘ UI ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° =====
  function setEditVisible(v){
    $$(".add-row").forEach(r => r.style.display = v ? "" : "none");
    $$(".btn-ghost").forEach(b => b.style.display = v ? "" : "none");
  }
  setEditVisible(false);

  // ===== ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ =====
  el.loginBtn?.addEventListener("click", () =>
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
  );
  el.logoutBtn?.addEventListener("click", () => auth.signOut());

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(el.loginBtn)  el.loginBtn.style.display  = user ? "none" : "";
    if(el.logoutBtn) el.logoutBtn.style.display = user ? "" : "none";
    setEditVisible(!!user);
    bindAddRows();
    startListeners();   // ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ êµ¬ë…
  });

  // ===== Firestore ê²½ë¡œ ìœ í‹¸ (ë¡œê·¸ì•„ì›ƒì´ë©´ OWNER_UIDë¡œ ì½ê¸°) =====
  // users/{uid}/tasks/{cat}/items
  const col = (cat) => {
    const uid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;
    return db.collection("users").doc(uid)
             .collection("tasks").doc(cat).collection("items");
  };

  // ===== ì‹¤ì‹œê°„ êµ¬ë… =====
  function startListeners(){
    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
    unsubscribers.forEach(u => u && u());
    unsubscribers = [];

    ["perf","exam","home"].forEach(cat => {
      const u = col(cat).orderBy("due","asc").onSnapshot(
        snap => {
          const arr = [];
          snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
          renderList(cat, arr);
        },
        err => {
          console.error("listener error:", err);
          alert("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + err.message);
        }
      );
      unsubscribers.push(u);
    });
  }

  // ===== ë Œë”ë§ & í•­ëª© ì´ë²¤íŠ¸ =====
  function renderList(cat, items){
    const ul = el.lists[cat];
    if(!ul) return;
    ul.innerHTML = "";
    for(const it of items){
      const li = document.createElement("li");
      li.className = "task" + (it.done ? " done" : "");
      li.innerHTML = `
        <label class="chk-wrap">
          <input type="checkbox" ${it.done?"checked":""}
                 data-act="toggle" data-cat="${cat}" data-id="${it.id}">
          <span></span>
        </label>
        <div class="task__main">
          <div class="task__line">
            <b>${esc(it.subj||"")}</b><span class="sep">â€“</span>
            <span>${esc(it.text||"")}</span>
          </div>
          <div class="task__meta">${it.due ? `ğŸ“… ${it.due}` : ""}</div>
        </div>
        <button class="btn-ghost" data-act="del" data-cat="${cat}" data-id="${it.id}"
                style="display:${currentUser?'':'none'}">ì‚­ì œ</button>
      `;
      ul.appendChild(li);
    }

    ul.onclick = async (e)=>{
      const t = e.target;
      const act = t.getAttribute("data-act");
      if(!act) return;

      if(!currentUser){
        alert("ìˆ˜ì •/ì‚­ì œëŠ” ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        if(act === "toggle") t.checked = !t.checked; // ì›ìƒë³µêµ¬
        return;
      }

      const cat2 = t.getAttribute("data-cat");
      const id   = t.getAttribute("data-id");
      try{
        if(act === "toggle"){
          await col(cat2).doc(id).update({ done: t.checked });
        }else if(act === "del"){
          await col(cat2).doc(id).delete();
        }
      }catch(e){
        alert("ë³€ê²½ ì‹¤íŒ¨: " + e.message);
        console.error(e);
      }
    };
  }

  // ===== ì¶”ê°€ í¼ ë°”ì¸ë”© =====
  function bindAddRows(){
    $$(".add-row").forEach(row=>{
      const btn = $(".add", row);
      const cat = row.dataset.cat;
      if(!btn) return;

      btn.onclick = async ()=>{
        if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }
        const subj = $(".subj", row).value.trim();
        const text = $(".text", row).value.trim();
        const date = $(".date", row).value || "";
        if(!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

        try{
          await col(cat).add({
            subj, text, due: date || "", done: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          $(".subj", row).value = "";
          $(".text", row).value = "";
          $(".date", row).value = "";
        }catch(e){
          alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
          console.error(e);
        }
      };
    });
  }

  // ===== HTML escape =====
  function esc(s){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
</script>


</body>
</html>
