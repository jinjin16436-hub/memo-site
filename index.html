<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="admin-bar" style="display:flex;gap:12px;align-items:center;justify-content:flex-start;">
    <h1 style="margin-right:auto">ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <!-- ë³¸ë¬¸ -->
  <main class="container">
    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">ğŸ“„ ìˆ˜í–‰í‰ê°€ â–¾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>

        <!-- ì¶”ê°€ ì…ë ¥ -->
        <div class="add-row" data-cat="perf">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ì œëª©/ê°„ë‹¨ ì„¤ëª…" />
          <input class="date-start" type="date" />
          <span>~</span>
          <input class="date-end" type="date" />
          <select class="start-p">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="end-p">
            <option value="">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">ğŸ§ª ì‹œí—˜ â–¾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>

        <div class="add-row" data-cat="exam">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ì œëª©/ê°„ë‹¨ ì„¤ëª…" />
          <input class="date-start" type="date" />
          <span>~</span>
          <input class="date-end" type="date" />
          <select class="start-p">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="end-p">
            <option value="">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>

        <div class="add-row" data-cat="home">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ì œëª©/ê°„ë‹¨ ì„¤ëª…" />
          <input class="date-start" type="date" />
          <span>~</span>
          <input class="date-end" type="date" />
          <select class="start-p">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <select class="end-p">
            <option value="">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option><option>7êµì‹œ</option>
          </select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” (ë„¤ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ) -->
  <script>
    const firebaseConfig = {
      // ğŸ”½ ì—¬ê¸°ì— ë„¤ Firebase ì½˜ì†”ì˜ êµ¬ì„± ê°’ì„ ë„£ì–´
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ì•± ì½”ë“œ -->
  <script>
    /* ===== ê¸€ë¡œë²Œ ===== */
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

    const el = {
      loginBtn:  $("#loginBtn"),
      logoutBtn: $("#logoutBtn"),
      lists: { perf: $("#list_perf"), exam: $("#list_exam"), home: $("#list_home") }
    };

    // ë¹„ë¡œê·¸ì¸ ê³µê°œì—´ëŒìš© UID (ë„¤ ì†Œìœ ì UID)
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

    let currentUser = null;
    let unsub = [];

    /* ===== ì„¹ì…˜ í† ê¸€ ì €ì¥ ===== */
    function toggleSection(id){
      const box = document.getElementById(id);
      box.classList.toggle("open");
    }

    /* ===== ìœ í‹¸ ===== */
    const wday = (d) => ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];

    function formatRange(startStr, endStr){
      if(!startStr && !endStr) return "";
      const s = startStr ? new Date(startStr) : null;
      const e = endStr   ? new Date(endStr)   : null;

      const left  = s ? `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")} (${wday(s)})` : "";
      const right = e ? `${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} (${wday(e)})` : "";
      return left && right ? `${left} ~ ${right}` : (left || right);
    }

    function formatPeriods(sp, ep){
      if(!sp && !ep) return "";
      if(sp && ep){
        if(sp === ep) return `${sp}`;
        // ì˜ˆ: 1êµì‹œ, 7êµì‹œ -> "1~7êµì‹œ" ë¡œ ë³´ì´ê²Œ
        const a = Number(sp.replace("êµì‹œ",""));
        const b = Number(ep.replace("êµì‹œ",""));
        if(!Number.isNaN(a) && !Number.isNaN(b)) return `${a}~${b}êµì‹œ`;
        return `${sp} ~ ${ep}`;
      }
      return sp || ep;
    }

    /* ===== D-Day ë°°ì§€ ===== */
    function renderDdayLabel(endDate){
      if(!endDate) return "";
      const today = new Date(); today.setHours(0,0,0,0);
      const target = new Date(endDate); target.setHours(0,0,0,0);

      const diff = Math.floor((target - today) / (1000*60*60*24));

      let label = "", cls = "";
      if (diff === 0) { label = "D-Day"; cls = "red"; }
      else if (diff > 0) {
        label = `D-${diff}`;
        if (diff === 1) cls = "red";
        else if (diff <= 3) cls = "orange";
        else if (diff <= 5) cls = "yellow";
        else cls = "green";
      } else {
        label = `D+${Math.abs(diff)}`;
        cls = "past"; // ì§€ë‚œ ì¼ì •: í…Œë‘ë¦¬ íšŒìƒ‰
      }
      return `<span class="dday ${cls}">${label}</span>`;
    }

    /* ===== Firestore ê²½ë¡œ ===== */
    const col = (cat) => {
      const uid = currentUser?.uid || OWNER_UID;
      return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
    };

    /* ===== ë Œë”ë§ ===== */
    function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function renderList(cat, arr){
      const ul = el.lists[cat];
      ul.innerHTML = "";

      arr.forEach(it=>{
        const periods = formatPeriods(it.startPeriod, it.endPeriod);
        const range   = formatRange(it.startDate, it.endDate);
        const meta = [
          range ? `ğŸ“… ${range}` : "",
          periods ? ` ${periods}` : ""
        ].join("");

        const li = document.createElement("li");
        li.className = "task" + (it.done ? " done" : "");
        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" data-act="toggle" data-cat="${cat}" data-id="${it.id}" ${it.done?"checked":""}/>
          </label>
          <div class="task__main">
            <div class="task__line">
              <b>${esc(it.subj||"")}</b>
              ${renderDdayLabel(it.endDate)}
              <div style="margin-top:6px;color:#cbd5e1">${esc(it.text||"")}</div>
            </div>
            <div class="task__meta">${meta}</div>
            ${it.detail ? `<div class="task__meta" style="margin-top:6px;white-space:pre-wrap;">${esc(it.detail)}</div>` : ""}
          </div>
          <div>
            <button class="btn-ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}" style="${currentUser?'':'display:none'}">ìˆ˜ì •</button>
            <button class="btn-ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}" style="${currentUser?'':'display:none'}">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);
      });

      ul.onclick = async (e)=>{
        const t   = e.target;
        const act = t.getAttribute("data-act");
        if(!act) return;

        const id  = t.getAttribute("data-id");
        const c   = t.getAttribute("data-cat");

        if(act === "toggle"){
          if(!currentUser){ t.checked = !t.checked; alert("ë¡œê·¸ì¸ í›„ ì™„ë£Œ ì²´í¬ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”."); return; }
          try{
            await col(c).doc(id).update({ done: t.checked });
          }catch(err){ console.error(err); alert("ë³€ê²½ ì‹¤íŒ¨"); }
        }
        if(act === "del"){
          if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”."); return; }
          if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
          try{ await col(c).doc(id).delete(); }catch(err){ console.error(err); alert("ì‚­ì œ ì‹¤íŒ¨"); }
        }
        if(act === "edit"){
          if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”."); return; }
          openEditDialog(c, id);
        }
      };
    }

    /* ===== ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸(ê°„ë‹¨ í”„ë¡¬í”„íŠ¸) =====
       * ì‹¤ì œë¡œëŠ” ëª¨ë‹¬/ì¸ë¼ì¸ í¼ì„ ì“°ë©´ ì˜ˆìœë°, ì—¬ê¸°ì„  ê°„ë‹¨í•˜ê²Œ êµ¬í˜„
    */
    async function openEditDialog(cat, id){
      try{
        const snap = await col(cat).doc(id).get();
        if(!snap.exists) return;
        const it = snap.data();

        const subj = prompt("ê³¼ëª©", it.subj || "");
        if(subj === null) return;
        const text = prompt("ì œëª©/ê°„ë‹¨ ì„¤ëª…", it.text || "");
        if(text === null) return;
        const detail = prompt("ìƒì„¸ ë‚´ìš©(ì¤„ë°”ê¿ˆ ê°€ëŠ¥)", it.detail || "");
        if(detail === null) return;

        await col(cat).doc(id).update({ subj, text, detail });
      }catch(e){ console.error(e); alert("ìˆ˜ì • ì‹¤íŒ¨"); }
    }

    /* ===== ì‹¤ì‹œê°„ êµ¬ë… ===== */
    function startListeners(){
      unsub.forEach(u=>u && u());
      unsub = [];

      ["perf","exam","home"].forEach(cat=>{
        const u = col(cat).orderBy("endDate","asc").onSnapshot(snap=>{
          const arr = [];
          snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
          renderList(cat, arr);
        }, err=>{
          console.error(err);
          alert("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
        unsub.push(u);
      });
    }

    /* ===== ì¶”ê°€ í¼ ===== */
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn = $(".add", row);
        btn.onclick = async ()=>{
          if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }

          const cat   = row.dataset.cat;
          const subj  = $(".subj", row).value.trim();
          const text  = $(".text", row).value.trim();
          const sDate = $(".date-start", row).value || "";
          const eDate = $(".date-end", row).value || "";
          const sP    = $(".start-p", row).value || "";
          const eP    = $(".end-p", row).value || "";
          const detail= $(".detail", row).value;

          if(!subj || !text){ alert("ê³¼ëª©/ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

          try{
            await col(cat).add({
              subj, text, detail,
              startDate: sDate,
              endDate:   eDate,
              startPeriod: sP,
              endPeriod:   eP,
              done: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // ì…ë ¥ ì´ˆê¸°í™”
            $(".subj", row).value = "";
            $(".text", row).value = "";
            $(".date-start", row).value = "";
            $(".date-end", row).value = "";
            $(".start-p", row).value = "";
            $(".end-p", row).value = "";
            $(".detail", row).value = "";
          }catch(e){ console.error(e); alert("ì €ì¥ ì‹¤íŒ¨"); }
        };
      });
    }

    /* ===== ë¡œê·¸ì¸ ===== */
    const provider = new firebase.auth.GoogleAuthProvider();

    el.loginBtn.addEventListener("click", async ()=>{
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithPopup(provider);
      }catch(e){
        alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.code}\n${e.message}`);
        console.error(e);
      }
    });

    el.logoutBtn.addEventListener("click", ()=> auth.signOut());

    auth.onAuthStateChanged(user=>{
      currentUser = user;
      el.loginBtn.style.display  = user ? "none" : "";
      el.logoutBtn.style.display = user ? "" : "none";
      bindAddRows();
      startListeners();
    });
  </script>
</body>
</html>
