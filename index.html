<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="topbar">
  <h1>📒 숙제 & 수행평가</h1>
  <div class="auth-area">
    <button id="adminBadge" class="badge admin" style="display:none">관리자</button>
    <button id="loginBtn"  class="btn">🔑 로그인</button>
    <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
  </div>
</header>

<main class="container">

  <!-- 중요 전달 사항 -->
  <section class="panel">
    <div class="panel-head">
      <h2>📣 중요 전달 사항</h2>
      <label class="switch" title="표시/숨김(관리자만)">
        <input type="checkbox" id="noticeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <div id="noticeWrap" class="notice-wrap">
      <p class="muted">등록된 전달 사항이 없습니다.</p>
    </div>

    <div id="noticeEditor" class="notice-editor" style="display:none">
      <div class="row">
        <input id="noticeTitle" class="input" placeholder="제목" />
        <select id="noticeTone" class="select">
          <option value="yellow">전달 사항</option>
          <option value="orange">주의</option>
          <option value="red">긴급</option>
          <option value="green">안내</option>
          <option value="blue">정보</option>
        </select>
        <button id="noticeAdd" class="btn add">+ 추가</button>
      </div>
      <textarea id="noticeBody" class="textarea" placeholder="내용 (줄바꿈 가능)"></textarea>
    </div>
  </section>

  <!-- 시험 -->
  <section class="panel">
    <div class="panel-head"><h2>🧪 시험</h2></div>
    <ul id="list_exam" class="task-list"></ul>
    <div class="add-row" data-cat="exam">
      <div class="grid">
        <input class="subj input" placeholder="과목" />
        <input class="text input" placeholder="내용" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="endPeriod select">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <button class="add btn">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 수행평가 -->
  <section class="panel">
    <div class="panel-head"><h2>🧾 수행평가</h2></div>
    <ul id="list_perf" class="task-list"></ul>
    <div class="add-row" data-cat="perf">
      <div class="grid">
        <input class="subj input" placeholder="과목" />
        <input class="text input" placeholder="내용" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="endPeriod select">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <button class="add btn">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 숙제 -->
  <section class="panel">
    <div class="panel-head"><h2>📌 숙제</h2></div>
    <ul id="list_home" class="task-list"></ul>
    <div class="add-row" data-cat="home">
      <div class="grid">
        <input class="subj input" placeholder="과목" />
        <input class="text input" placeholder="내용" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="endPeriod select">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <button class="add btn">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

</main>

<!-- 수정 모달 -->
<div id="editModal" class="modal" style="display:none">
  <div class="modal-body">
    <h3>항목 수정</h3>
    <div class="grid">
      <input id="editSubj"  class="input" />
      <input id="editText"  class="input" />
      <input id="editStart" class="input" type="date" />
      <input id="editEnd"   class="input" type="date" />
      <select id="editStartPeriod" class="select">
        <option value="">시작 교시</option>
        <option>1교시</option><option>2교시</option><option>3교시</option>
        <option>4교시</option><option>5교시</option><option>6교시</option>
        <option>7교시</option><option>8교시</option>
      </select>
      <select id="editEndPeriod" class="select">
        <option value="">끝 교시</option>
        <option>1교시</option><option>2교시</option><option>3교시</option>
        <option>4교시</option><option>5교시</option><option>6교시</option>
        <option>7교시</option><option>8교시</option>
      </select>
    </div>
    <textarea id="editDetail" class="textarea" placeholder="상세 내용 (선택)"></textarea>

    <div class="right">
      <button id="editCancel" class="btn light">취소</button>
      <button id="editSave"   class="btn">저장</button>
    </div>
  </div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ========= Firebase 설정 (교체 필요) ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "196036694705",
  appId: "1:196036694705:web:8988d12919420130464890"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ========= UID (교체 필요) ========= */
const ADMIN_UID  = "vv0bADtWdqQUnqFMy8k01dhO13t2";
const PUBLIC_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

/* ========= 상태 ========= */
let currentUser=null, isAdmin=false;
const lists = {
  exam: document.getElementById('list_exam'),
  perf: document.getElementById('list_perf'),
  home: document.getElementById('list_home'),
};
let unsubs = [];

/* ========= 로그인 ========= */
const $ = (q,r=document)=>r.querySelector(q);
document.getElementById('loginBtn').onclick = async ()=>{
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }catch(e){ alert("로그인 실패: "+e.message); }
};
document.getElementById('logoutBtn').onclick = ()=>auth.signOut();

auth.onAuthStateChanged(u=>{
  currentUser = u;
  isAdmin = !!(u && u.uid === ADMIN_UID);

  document.getElementById('loginBtn').style.display  = u? "none":"";
  document.getElementById('logoutBtn').style.display = u? "":"none";
  document.getElementById('adminBadge').style.display= isAdmin? "":"none";
  document.querySelectorAll('.add-row').forEach(r=>r.style.display = isAdmin? "":"none");
  document.getElementById('noticeEditor').style.display = isAdmin? "":"none";

  bindDraft();
  startListeners();
  loadNoticeToggle();
});

/* ========= Firestore 경로 ========= */
const readUid  = ()=> (isAdmin ? ADMIN_UID : PUBLIC_UID);
const writeUid = ()=> {
  if(!isAdmin) throw new Error("권한 없음");
  return ADMIN_UID;
};
function taskCol(cat, forWrite=false){
  return db.collection("users").doc(forWrite? writeUid(): readUid())
           .collection("tasks").doc(cat).collection("items");
}

/* ========= 날짜 파서 & D-day ========= */
function parseDateLocal(s){
  if(!s) return null;
  const [y,m,d] = s.split('-').map(Number);
  const dt = new Date(y, m-1, d);
  dt.setHours(0,0,0,0);
  return dt;
}
function renderDday(startStr, endStr){
  if(!startStr) return '';
  const msDay = 86400000;
  const today = new Date(); today.setHours(0,0,0,0);
  const start = parseDateLocal(startStr);
  const end   = endStr ? parseDateLocal(endStr) : parseDateLocal(startStr);
  if(!start || !end) return '';

  if (today < start) {
    const diff = Math.ceil((start - today)/msDay);
    const cls = (diff<=1)?'red':(diff<=3)?'orange':(diff<=5)?'yellow':'green';
    return `<span class="dday pill ${cls}">D-${diff}</span>`;
  } else if (today >= start && today <= end) {
    return `<span class="dday pill red">D-DAY</span>`;
  } else {
    const diff = Math.ceil((today - end)/msDay);
    return `<span class="dday pill past">D+${diff}</span>`;
  }
}

/* ========= 렌더 ========= */
function periodRange(s,e){
  if(!s && !e) return "";
  if(s && !e) return ` ${s}`;
  if(!s && e) return ` ${e}`;
  return ` ${s} ~ ${e}`;
}
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function renderItem(cat,it){
  const dday = renderDday(it.startDate, it.endDate);
  const pr   = periodRange(it.startPeriod||"", it.endPeriod||"");
  return `
  <li class="task" data-cat="${cat}" data-id="${it.id}">
    <label class="chk-wrap">
      <input type="checkbox" ${it.done?"checked":""} disabled />
      <span></span>
    </label>
    <div class="task__main">
      <div class="task__line">
        <div class="topline">
          <b class="subject">${escapeHtml(it.subj||"")}</b>
          ${dday}
        </div>
        <div class="content">${escapeHtml(it.text||"")}</div>
      </div>
      <div class="task__meta">
        <span>📅 ${it.startDate||""}${it.endDate?` ~ ${it.endDate}`:""}${pr?` ·${pr}`:""}</span>
      </div>
      ${it.detail? `<pre class="detail">${escapeHtml(it.detail||"")}</pre>`:""}
    </div>
    <div class="task__ops" style="display:${isAdmin?'flex':'none'}">
      <button class="op btn light" data-act="edit">수정</button>
      <button class="op btn light" data-act="del">삭제</button>
    </div>
  </li>`;
}
function renderList(cat, items){
  const ul = lists[cat];
  ul.innerHTML = items.map(it=>renderItem(cat,it)).join("");
  ul.querySelectorAll("[data-act]").forEach(btn=>{
    btn.onclick = async (e)=>{
      const li = e.target.closest("li.task");
      const id = li.dataset.id;
      const act= e.target.dataset.act;
      if(act==="del"){
        if(!confirm("삭제할까요?")) return;
        try{ await taskCol(cat,true).doc(id).delete(); }catch(err){ alert("삭제 실패: "+err.message); }
      }else if(act==="edit"){
        openEdit(cat,id);
      }
    };
  });
}

/* ========= 스냅샷 ========= */
function startListeners(){
  unsubs.forEach(u=>u&&u()); unsubs=[];
  ["exam","perf","home"].forEach(cat=>{
    const u = taskCol(cat).orderBy("startDate","asc").onSnapshot(snap=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      renderList(cat,arr);
    }, err=>console.error("listener:",err));
    unsubs.push(u);
  });
  loadNotices();
}
setInterval(()=>startListeners(), 60000); // 조용한 갱신

/* ========= 추가 폼 + 임시 저장 ========= */
const DRAFT_KEY="memo:draft-v2";
function gatherDraft(){
  const data={};
  document.querySelectorAll(".add-row").forEach(row=>{
    const cat=row.dataset.cat;
    data[cat]={
      subj: $(".subj",row).value,
      text: $(".text",row).value,
      start:$(".dateStart",row).value,
      end:  $(".dateEnd",row).value,
      sp:   $(".startPeriod",row).value,
      ep:   $(".endPeriod",row).value,
      det:  $(".detail",row).value
    };
  });
  return data;
}
function applyDraft(d){
  if(!d) return;
  document.querySelectorAll(".add-row").forEach(row=>{
    const cat=row.dataset.cat, v=d[cat]||{};
    $(".subj",row).value = v.subj||"";
    $(".text",row).value = v.text||"";
    $(".dateStart",row).value = v.start||"";
    $(".dateEnd",row).value   = v.end||"";
    $(".startPeriod",row).value = v.sp||"";
    $(".endPeriod",row).value   = v.ep||"";
    $(".detail",row).value = v.det||"";
  });
}
function bindDraft(){
  try{ applyDraft(JSON.parse(localStorage.getItem(DRAFT_KEY))); }catch{}
  document.addEventListener("input", e=>{
    if(e.target.closest(".add-row")){
      localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft()));
    }
  });
}
function clearRow(row){
  $(".subj",row).value=""; $(".text",row).value="";
  $(".dateStart",row).value=""; $(".dateEnd",row).value="";
  $(".startPeriod",row).value=""; $(".endPeriod",row).value="";
  $(".detail",row).value="";
  localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft()));
}
document.querySelectorAll(".add-row .add").forEach(btn=>{
  btn.onclick = async ()=>{
    if(!isAdmin){ alert("관리자만 추가할 수 있습니다."); return; }
    const row=btn.closest(".add-row");
    const cat=row.dataset.cat;
    const subj=$(".subj",row).value.trim();
    const text=$(".text",row).value.trim();
    const start=$(".dateStart",row).value;
    const end=$(".dateEnd",row).value || start;
    const sp=$(".startPeriod",row).value||"";
    const ep=$(".endPeriod",row).value||"";
    const detail=$(".detail",row).value||"";
    if(!subj || !text || !start){ alert("과목/내용/시작일은 필수입니다."); return; }
    try{
      await taskCol(cat,true).add({
        subj, text, startDate:start, endDate:end,
        startPeriod:sp, endPeriod:ep, detail,
        done:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      clearRow(row);
    }catch(e){ alert("저장 실패: "+e.message); }
  };
});

/* ========= 수정 모달 ========= */
const modal = document.getElementById("editModal");
const editSubj=$("#editSubj"), editText=$("#editText"), editStart=$("#editStart"),
      editEnd=$("#editEnd"), editStartPeriod=$("#editStartPeriod"),
      editEndPeriod=$("#editEndPeriod"), editDetail=$("#editDetail");
let editing={cat:null,id:null};

function openEdit(cat,id){
  editing={cat,id};
  taskCol(cat).doc(id).get().then(doc=>{
    const d=doc.data();
    editSubj.value=d.subj||"";
    editText.value=d.text||"";
    editStart.value=d.startDate||"";
    editEnd.value=d.endDate||"";
    editStartPeriod.value=d.startPeriod||"";
    editEndPeriod.value=d.endPeriod||"";
    editDetail.value=d.detail||"";
    modal.style.display="flex";
  });
}
document.getElementById("editCancel").onclick=()=> modal.style.display="none";
document.getElementById("editSave").onclick=async ()=>{
  if(!isAdmin){ alert("관리자만 수정할 수 있습니다."); return; }
  try{
    await taskCol(editing.cat,true).doc(editing.id).update({
      subj: editSubj.value.trim(),
      text: editText.value.trim(),
      startDate: editStart.value,
      endDate:   editEnd.value || editStart.value,
      startPeriod: editStartPeriod.value || "",
      endPeriod:   editEndPeriod.value   || "",
      detail: editDetail.value || ""    // ✅ 상세 내용 저장
    });
    modal.style.display="none";
  }catch(e){ alert("수정 실패: "+e.message); }
};

/* ========= 전달 사항 ========= */
const uiDoc = db.collection("settings").doc(ADMIN_UID).collection("ui").doc("global");
async function loadNoticeToggle(){
  const tgl = document.getElementById("noticeToggle");
  try{
    const s = await uiDoc.get();
    tgl.checked = !!(s.exists && s.data().showNotices);
  }catch{}
  tgl.disabled = !isAdmin;
  tgl.onchange = async ()=>{
    if(!isAdmin) return;
    try{ await uiDoc.set({showNotices: tgl.checked},{merge:true}); }catch(e){ alert("표시 설정 실패: "+e.message); }
  };
}
function loadNotices(){
  uiDoc.get().then(s=>{
    const show = !!(s.exists && s.data().showNotices);
    document.getElementById("noticeWrap").style.opacity = show? "1":".45";
  });
  db.collection("users").doc(readUid()).collection("notices").orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      const wrap=document.getElementById("noticeWrap");
      if(snap.empty){ wrap.innerHTML='<p class="muted">등록된 전달 사항이 없습니다.</p>'; return; }
      const html=[];
      snap.forEach(d=>{
        const n=d.data(), tone=n.tone||"yellow";
        html.push(`
          <article class="notice ${tone}">
            <div class="notice-title">${escapeHtml(n.title||"")}</div>
            <pre class="notice-body">${escapeHtml(n.body||"")}</pre>
          </article>
        `);
      });
      wrap.innerHTML=html.join("");
    }, err=>console.error(err));
}
document.getElementById("noticeAdd").onclick = async ()=>{
  if(!isAdmin){ alert("관리자만 추가할 수 있습니다."); return; }
  const title=$("#noticeTitle").value.trim();
  const body =$("#noticeBody").value.trim();
  const tone =$("#noticeTone").value;
  if(!title){ alert("제목을 입력하세요."); return; }
  try{
    await db.collection("users").doc(writeUid()).collection("notices").add({
      title, body, tone, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $("#noticeTitle").value=""; $("#noticeBody").value="";
  }catch(e){ alert("추가 실패: "+e.message); }
};
</script>
</body>
</html>
