<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="topbar">
  <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
  <div class="auth-area">
    <button id="adminBadge" class="badge admin" style="display:none">ê´€ë¦¬ì</button>
    <button id="loginBtn"  class="btn">ğŸ”‘ ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<main class="container">

  <!-- ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ -->
  <section class="panel">
    <div class="panel-head">
      <h2>ğŸ“£ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</h2>
      <label class="switch" title="í‘œì‹œ/ìˆ¨ê¹€(ê´€ë¦¬ìë§Œ)">
        <input type="checkbox" id="noticeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <div id="noticeWrap" class="notice-wrap">
      <p class="muted">ë“±ë¡ëœ ì „ë‹¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <div id="noticeEditor" class="notice-editor" style="display:none">
      <div class="row">
        <input id="noticeTitle" class="input" placeholder="ì œëª©" />
        <select id="noticeTone" class="select">
          <option value="yellow">ì „ë‹¬ ì‚¬í•­</option>
          <option value="orange">ì£¼ì˜</option>
          <option value="red">ê¸´ê¸‰</option>
          <option value="green">ì•ˆë‚´</option>
          <option value="blue">ì •ë³´</option>
        </select>
        <button id="noticeAdd" class="btn add">+ ì¶”ê°€</button>
      </div>
      <textarea id="noticeBody" class="textarea" placeholder="ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
    </div>
  </section>

  <!-- ì‹œí—˜ -->
  <section class="panel">
    <div class="panel-head"><h2>ğŸ§ª ì‹œí—˜</h2></div>
    <ul id="list_exam" class="task-list"></ul>
    <div class="add-row" data-cat="exam">
      <div class="grid">
        <input class="subj input" placeholder="ê³¼ëª©" />
        <input class="text input" placeholder="ë‚´ìš©" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <select class="endPeriod select">
          <option value="">ë êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ˜í–‰í‰ê°€ -->
  <section class="panel">
    <div class="panel-head"><h2>ğŸ§¾ ìˆ˜í–‰í‰ê°€</h2></div>
    <ul id="list_perf" class="task-list"></ul>
    <div class="add-row" data-cat="perf">
      <div class="grid">
        <input class="subj input" placeholder="ê³¼ëª©" />
        <input class="text input" placeholder="ë‚´ìš©" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <select class="endPeriod select">
          <option value="">ë êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ™ì œ -->
  <section class="panel">
    <div class="panel-head"><h2>ğŸ“Œ ìˆ™ì œ</h2></div>
    <ul id="list_home" class="task-list"></ul>
    <div class="add-row" data-cat="home">
      <div class="grid">
        <input class="subj input" placeholder="ê³¼ëª©" />
        <input class="text input" placeholder="ë‚´ìš©" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <select class="endPeriod select">
          <option value="">ë êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

</main>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="modal" style="display:none">
  <div class="modal-body">
    <h3>í•­ëª© ìˆ˜ì •</h3>
    <div class="grid">
      <input id="editSubj"  class="input" />
      <input id="editText"  class="input" />
      <input id="editStart" class="input" type="date" />
      <input id="editEnd"   class="input" type="date" />
      <select id="editStartPeriod" class="select">
        <option value="">ì‹œì‘ êµì‹œ</option>
        <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
        <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
        <option>7êµì‹œ</option><option>8êµì‹œ</option>
      </select>
      <select id="editEndPeriod" class="select">
        <option value="">ë êµì‹œ</option>
        <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
        <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
        <option>7êµì‹œ</option><option>8êµì‹œ</option>
      </select>
    </div>
    <textarea id="editDetail" class="textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>

    <div class="right">
      <button id="editCancel" class="btn light">ì·¨ì†Œ</button>
      <button id="editSave"   class="btn">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ========= Firebase ì„¤ì • (êµì²´ í•„ìš”) ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "196036694705",
  appId: "1:196036694705:web:8988d12919420130464890"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ========= UID (êµì²´ í•„ìš”) ========= */
const ADMIN_UID  = "vv0bADtWdqQUnqFMy8k01dhO13t2";
const PUBLIC_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

/* ========= ìƒíƒœ ========= */
let currentUser=null, isAdmin=false;
const lists = {
  exam: document.getElementById('list_exam'),
  perf: document.getElementById('list_perf'),
  home: document.getElementById('list_home'),
};
let unsubs = [];

/* ========= ë¡œê·¸ì¸ ========= */
const $ = (q,r=document)=>r.querySelector(q);
document.getElementById('loginBtn').onclick = async ()=>{
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }catch(e){ alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message); }
};
document.getElementById('logoutBtn').onclick = ()=>auth.signOut();

auth.onAuthStateChanged(u=>{
  currentUser = u;
  isAdmin = !!(u && u.uid === ADMIN_UID);

  document.getElementById('loginBtn').style.display  = u? "none":"";
  document.getElementById('logoutBtn').style.display = u? "":"none";
  document.getElementById('adminBadge').style.display= isAdmin? "":"none";
  document.querySelectorAll('.add-row').forEach(r=>r.style.display = isAdmin? "":"none");
  document.getElementById('noticeEditor').style.display = isAdmin? "":"none";

  bindDraft();
  startListeners();
  loadNoticeToggle();
});

/* ========= Firestore ê²½ë¡œ ========= */
const readUid  = ()=> (isAdmin ? ADMIN_UID : PUBLIC_UID);
const writeUid = ()=> {
  if(!isAdmin) throw new Error("ê¶Œí•œ ì—†ìŒ");
  return ADMIN_UID;
};
function taskCol(cat, forWrite=false){
  return db.collection("users").doc(forWrite? writeUid(): readUid())
           .collection("tasks").doc(cat).collection("items");
}

/* ========= ë‚ ì§œ íŒŒì„œ & D-day ========= */
function parseDateLocal(s){
  if(!s) return null;
  const [y,m,d] = s.split('-').map(Number);
  const dt = new Date(y, m-1, d);
  dt.setHours(0,0,0,0);
  return dt;
}
function renderDday(startStr, endStr){
  if(!startStr) return '';
  const msDay = 86400000;
  const today = new Date(); today.setHours(0,0,0,0);
  const start = parseDateLocal(startStr);
  const end   = endStr ? parseDateLocal(endStr) : parseDateLocal(startStr);
  if(!start || !end) return '';

  if (today < start) {
    const diff = Math.ceil((start - today)/msDay);
    const cls = (diff<=1)?'red':(diff<=3)?'orange':(diff<=5)?'yellow':'green';
    return `<span class="dday pill ${cls}">D-${diff}</span>`;
  } else if (today >= start && today <= end) {
    return `<span class="dday pill red">D-DAY</span>`;
  } else {
    const diff = Math.ceil((today - end)/msDay);
    return `<span class="dday pill past">D+${diff}</span>`;
  }
}

/* ========= ë Œë” ========= */
function periodRange(s,e){
  if(!s && !e) return "";
  if(s && !e) return ` ${s}`;
  if(!s && e) return ` ${e}`;
  return ` ${s} ~ ${e}`;
}
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function renderItem(cat,it){
  const dday = renderDday(it.startDate, it.endDate);
  const pr   = periodRange(it.startPeriod||"", it.endPeriod||"");
  return `
  <li class="task" data-cat="${cat}" data-id="${it.id}">
    <label class="chk-wrap">
      <input type="checkbox" ${it.done?"checked":""} disabled />
      <span></span>
    </label>
    <div class="task__main">
      <div class="task__line">
        <div class="topline">
          <b class="subject">${escapeHtml(it.subj||"")}</b>
          ${dday}
        </div>
        <div class="content">${escapeHtml(it.text||"")}</div>
      </div>
      <div class="task__meta">
        <span>ğŸ“… ${it.startDate||""}${it.endDate?` ~ ${it.endDate}`:""}${pr?` Â·${pr}`:""}</span>
      </div>
      ${it.detail? `<pre class="detail">${escapeHtml(it.detail||"")}</pre>`:""}
    </div>
    <div class="task__ops" style="display:${isAdmin?'flex':'none'}">
      <button class="op btn light" data-act="edit">ìˆ˜ì •</button>
      <button class="op btn light" data-act="del">ì‚­ì œ</button>
    </div>
  </li>`;
}
function renderList(cat, items){
  const ul = lists[cat];
  ul.innerHTML = items.map(it=>renderItem(cat,it)).join("");
  ul.querySelectorAll("[data-act]").forEach(btn=>{
    btn.onclick = async (e)=>{
      const li = e.target.closest("li.task");
      const id = li.dataset.id;
      const act= e.target.dataset.act;
      if(act==="del"){
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        try{ await taskCol(cat,true).doc(id).delete(); }catch(err){ alert("ì‚­ì œ ì‹¤íŒ¨: "+err.message); }
      }else if(act==="edit"){
        openEdit(cat,id);
      }
    };
  });
}

/* ========= ìŠ¤ëƒ…ìƒ· ========= */
function startListeners(){
  unsubs.forEach(u=>u&&u()); unsubs=[];
  ["exam","perf","home"].forEach(cat=>{
    const u = taskCol(cat).orderBy("startDate","asc").onSnapshot(snap=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      renderList(cat,arr);
    }, err=>console.error("listener:",err));
    unsubs.push(u);
  });
  loadNotices();
}
setInterval(()=>startListeners(), 60000); // ì¡°ìš©í•œ ê°±ì‹ 

/* ========= ì¶”ê°€ í¼ + ì„ì‹œ ì €ì¥ ========= */
const DRAFT_KEY="memo:draft-v2";
function gatherDraft(){
  const data={};
  document.querySelectorAll(".add-row").forEach(row=>{
    const cat=row.dataset.cat;
    data[cat]={
      subj: $(".subj",row).value,
      text: $(".text",row).value,
      start:$(".dateStart",row).value,
      end:  $(".dateEnd",row).value,
      sp:   $(".startPeriod",row).value,
      ep:   $(".endPeriod",row).value,
      det:  $(".detail",row).value
    };
  });
  return data;
}
function applyDraft(d){
  if(!d) return;
  document.querySelectorAll(".add-row").forEach(row=>{
    const cat=row.dataset.cat, v=d[cat]||{};
    $(".subj",row).value = v.subj||"";
    $(".text",row).value = v.text||"";
    $(".dateStart",row).value = v.start||"";
    $(".dateEnd",row).value   = v.end||"";
    $(".startPeriod",row).value = v.sp||"";
    $(".endPeriod",row).value   = v.ep||"";
    $(".detail",row).value = v.det||"";
  });
}
function bindDraft(){
  try{ applyDraft(JSON.parse(localStorage.getItem(DRAFT_KEY))); }catch{}
  document.addEventListener("input", e=>{
    if(e.target.closest(".add-row")){
      localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft()));
    }
  });
}
function clearRow(row){
  $(".subj",row).value=""; $(".text",row).value="";
  $(".dateStart",row).value=""; $(".dateEnd",row).value="";
  $(".startPeriod",row).value=""; $(".endPeriod",row).value="";
  $(".detail",row).value="";
  localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft()));
}
document.querySelectorAll(".add-row .add").forEach(btn=>{
  btn.onclick = async ()=>{
    if(!isAdmin){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
    const row=btn.closest(".add-row");
    const cat=row.dataset.cat;
    const subj=$(".subj",row).value.trim();
    const text=$(".text",row).value.trim();
    const start=$(".dateStart",row).value;
    const end=$(".dateEnd",row).value || start;
    const sp=$(".startPeriod",row).value||"";
    const ep=$(".endPeriod",row).value||"";
    const detail=$(".detail",row).value||"";
    if(!subj || !text || !start){ alert("ê³¼ëª©/ë‚´ìš©/ì‹œì‘ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
    try{
      await taskCol(cat,true).add({
        subj, text, startDate:start, endDate:end,
        startPeriod:sp, endPeriod:ep, detail,
        done:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      clearRow(row);
    }catch(e){ alert("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
  };
});

/* ========= ìˆ˜ì • ëª¨ë‹¬ ========= */
const modal = document.getElementById("editModal");
const editSubj=$("#editSubj"), editText=$("#editText"), editStart=$("#editStart"),
      editEnd=$("#editEnd"), editStartPeriod=$("#editStartPeriod"),
      editEndPeriod=$("#editEndPeriod"), editDetail=$("#editDetail");
let editing={cat:null,id:null};

function openEdit(cat,id){
  editing={cat,id};
  taskCol(cat).doc(id).get().then(doc=>{
    const d=doc.data();
    editSubj.value=d.subj||"";
    editText.value=d.text||"";
    editStart.value=d.startDate||"";
    editEnd.value=d.endDate||"";
    editStartPeriod.value=d.startPeriod||"";
    editEndPeriod.value=d.endPeriod||"";
    editDetail.value=d.detail||"";
    modal.style.display="flex";
  });
}
document.getElementById("editCancel").onclick=()=> modal.style.display="none";
document.getElementById("editSave").onclick=async ()=>{
  if(!isAdmin){ alert("ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
  try{
    await taskCol(editing.cat,true).doc(editing.id).update({
      subj: editSubj.value.trim(),
      text: editText.value.trim(),
      startDate: editStart.value,
      endDate:   editEnd.value || editStart.value,
      startPeriod: editStartPeriod.value || "",
      endPeriod:   editEndPeriod.value   || "",
      detail: editDetail.value || ""    // âœ… ìƒì„¸ ë‚´ìš© ì €ì¥
    });
    modal.style.display="none";
  }catch(e){ alert("ìˆ˜ì • ì‹¤íŒ¨: "+e.message); }
};

/* ========= ì „ë‹¬ ì‚¬í•­ ========= */
const uiDoc = db.collection("settings").doc(ADMIN_UID).collection("ui").doc("global");
async function loadNoticeToggle(){
  const tgl = document.getElementById("noticeToggle");
  try{
    const s = await uiDoc.get();
    tgl.checked = !!(s.exists && s.data().showNotices);
  }catch{}
  tgl.disabled = !isAdmin;
  tgl.onchange = async ()=>{
    if(!isAdmin) return;
    try{ await uiDoc.set({showNotices: tgl.checked},{merge:true}); }catch(e){ alert("í‘œì‹œ ì„¤ì • ì‹¤íŒ¨: "+e.message); }
  };
}
function loadNotices(){
  uiDoc.get().then(s=>{
    const show = !!(s.exists && s.data().showNotices);
    document.getElementById("noticeWrap").style.opacity = show? "1":".45";
  });
  db.collection("users").doc(readUid()).collection("notices").orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      const wrap=document.getElementById("noticeWrap");
      if(snap.empty){ wrap.innerHTML='<p class="muted">ë“±ë¡ëœ ì „ë‹¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
      const html=[];
      snap.forEach(d=>{
        const n=d.data(), tone=n.tone||"yellow";
        html.push(`
          <article class="notice ${tone}">
            <div class="notice-title">${escapeHtml(n.title||"")}</div>
            <pre class="notice-body">${escapeHtml(n.body||"")}</pre>
          </article>
        `);
      });
      wrap.innerHTML=html.join("");
    }, err=>console.error(err));
}
document.getElementById("noticeAdd").onclick = async ()=>{
  if(!isAdmin){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
  const title=$("#noticeTitle").value.trim();
  const body =$("#noticeBody").value.trim();
  const tone =$("#noticeTone").value;
  if(!title){ alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
  try{
    await db.collection("users").doc(writeUid()).collection("notices").add({
      title, body, tone, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $("#noticeTitle").value=""; $("#noticeBody").value="";
  }catch(e){ alert("ì¶”ê°€ ì‹¤íŒ¨: "+e.message); }
};
</script>
</body>
</html>
