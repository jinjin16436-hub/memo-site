<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="admin-bar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="auth-area">
      <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <main class="container">

    <!-- ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ (ë§¨ ìœ„) -->
    <section class="important-section">
      <h2 class="important-head">ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</h2>
      <ul id="list_important" class="task-list important-list"></ul>

      <!-- ê´€ë¦¬ì ì „ìš© ì¶”ê°€ -->
      <div class="add-row owner-only add-important" data-cat="important" style="display:none;">
        <input class="subj" type="text" placeholder="ì œëª©" />
        <button class="add btn">+ ì¶”ê°€</button>
        <textarea class="text" placeholder="ì¤‘ìš” ë‚´ìš©"></textarea>
      </div>
    </section>

    <!-- âš ï¸ ì„¹ì…˜ ìˆœì„œ: ì‹œí—˜ â†’ ìˆ˜í–‰í‰ê°€ â†’ ìˆ™ì œ -->

    <!-- ì‹œí—˜ -->
    <section>
      <div class="section-head-row">
        <h2 class="section-head">ğŸ§ª ì‹œí—˜</h2>
      </div>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>

        <!-- ê´€ë¦¬ì ì „ìš© ì¶”ê°€ -->
        <div class="add-row owner-only" data-cat="exam" style="display:none;">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date-from" type="date" />
          <input class="date-to"   type="date" />
          <select class="start">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option>
          </select>
          <select class="end">
            <option value="">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>

          <!-- 2ì¤„: ìƒì„¸ë‚´ìš© í¬ê²Œ -->
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        </div>
      </div>
    </section>

    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <div class="section-head-row">
        <h2 class="section-head">ğŸ“„ ìˆ˜í–‰í‰ê°€</h2>
      </div>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>

        <div class="add-row owner-only" data-cat="perf" style="display:none;">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date-from" type="date" />
          <input class="date-to"   type="date" />
          <select class="start">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option>
          </select>
          <select class="end">
            <option value="">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <div class="section-head-row">
        <h2 class="section-head">ğŸ“Œ ìˆ™ì œ</h2>
      </div>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>

        <div class="add-row owner-only" data-cat="home" style="display:none;">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date-from" type="date" />
          <input class="date-to"   type="date" />
          <select class="start">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option>
          </select>
          <select class="end">
            <option value="">ë êµì‹œ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option>
          </select>
          <button class="add btn">+ ì¶”ê°€</button>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        </div>
      </div>
    </section>

  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” : ë„¤ ì½˜ì†” ê°’ìœ¼ë¡œ ìœ ì§€ -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ì•± ì½”ë“œ -->
  <script>
    // ğŸ‘‘ ê´€ë¦¬ì UID
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, r=document) => r.querySelector(q);
    const $$ = (q, r=document) => Array.from(r.querySelectorAll(q));

    const lists = {
      important: $("#list_important"),
      exam: $("#list_exam"),
      perf: $("#list_perf"),
      home: $("#list_home")
    };

    let currentUser = null;
    let unsubscribers = [];
    const isOwner = () => currentUser && currentUser.uid === OWNER_UID;

    // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
    const provider = new firebase.auth.GoogleAuthProvider();
    $("#loginBtn").onclick  = async () => {
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithPopup(provider);
      }catch(e){ alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }
    };
    $("#logoutBtn").onclick = () => auth.signOut();

    auth.onAuthStateChanged(u => {
      currentUser = u;
      $("#loginBtn").style.display  = u ? "none" : "";
      $("#logoutBtn").style.display = u ? "" : "none";

      // ê´€ë¦¬ì ì „ìš© ìš”ì†Œ í‘œì‹œ/ìˆ¨ê¹€
      $$(".owner-only").forEach(el => el.style.display = isOwner() ? "" : "none");
      $$(".owner-only-inline").forEach(el => el.style.display = isOwner() ? "" : "none");

      startListeners();
      bindAddRows();
    });

    // ì½ê¸°(í•­ìƒ OWNER), ì“°ê¸°(í˜„ì¬ ì‚¬ìš©ì=ê´€ë¦¬ìë§Œ ì˜ë¯¸ ìˆìŒ)
    const colRO = (cat) => db.collection("users").doc(OWNER_UID).collection("tasks").doc(cat).collection("items");
    const colRW = (cat) => db.collection("users").doc(currentUser.uid).collection("tasks").doc(cat).collection("items");

    function startListeners(){
      unsubscribers.forEach(u=>u&&u()); unsubscribers = [];
      ["important","exam","perf","home"].forEach(cat => {
        const ref = colRO(cat);
        const q = (cat === "important")
          ? ref.orderBy("createdAt","desc")
          : ref.orderBy("dateFrom","asc");
        const un = q.onSnapshot(snap=>{
          const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
          renderList(cat, arr);
        }, err=>console.error(err));
        unsubscribers.push(un);
      });
    }

    // ìœ í‹¸
    const WEEKS = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const z2 = n => String(n).padStart(2,"0");
    function fmtDay(s){
      if(!s) return "";
      const d = new Date(s + "T00:00:00");
      if(isNaN(+d)) return "";
      return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())} (${WEEKS[d.getDay()]})`;
    }
    function lessonText(start, end){
      if(!start && !end) return "";
      if(start && end){
        if(start === end) return `${start}`;
        return `${start}~${end}`;
      }
      return (start || end) || "";
    }
    function ddayBadge(dateStr){
      if(!dateStr) return "";
      const today = new Date(); today.setHours(0,0,0,0);
      const d = new Date(dateStr + "T00:00:00"); d.setHours(0,0,0,0);
      const diff = Math.floor((d - today)/86400000);

      let label="", cls="";
      if(diff > 0){
        label = `D-${diff}`;
        if(diff <= 1) cls = "urgent";
        else if(diff <= 3) cls = "soon";
        else if(diff <= 5) cls = "mid";
        else cls = "safe";
      }else if(diff === 0){
        label = "D-DAY"; cls = "urgent";
      }else{
        label = `D+${Math.abs(diff)}`; cls = "past";
      }
      return `<span class="dday ${cls}">${label}</span>`;
    }
    function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // ë Œë”
    function renderList(cat, items){
      const ul = lists[cat];
      ul.innerHTML = "";

      items.forEach(it=>{
        // ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ì€ ê°„ë‹¨ ë Œë”
        if(cat === "important"){
          const li = document.createElement("li");
          li.className = "task task--important";
          li.innerHTML = `
            <div class="task__body">
              <div class="task__title task__title--important">
                <b>${esc(it.subj || "")}</b>
              </div>
              <div class="task__content">${esc(it.text || "")}</div>
            </div>
            <div class="task__actions owner-only-inline" style="display:${isOwner()?"":"none"}">
              <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
              <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
            </div>
          `;
          ul.appendChild(li);

          li.addEventListener("click", async (e)=>{
            const t = e.target, act = t.getAttribute("data-act");
            if(!act) return;
            if(!isOwner()){ alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            const id = t.getAttribute("data-id");
            if(act === "del"){
              if(confirm("ì‚­ì œí• ê¹Œìš”?")) await colRW(cat).doc(id).delete();
            }else if(act === "edit"){
              const subj = prompt("ì œëª©", it.subj || ""); if(subj===null) return;
              const text = prompt("ë‚´ìš©", it.text || ""); if(text===null) return;
              await colRW(cat).doc(id).set({ subj, text }, { merge:true });
            }
          });

          return;
        }

        // ì¼ë°˜(ì‹œí—˜/ìˆ˜í–‰/ìˆ™ì œ)
        const dateFrom = it.dateFrom || it.due || "";
        const dateTo   = it.dateTo   || dateFrom;
        const rangeText = (dateTo && dateTo!==dateFrom)
          ? `${fmtDay(dateFrom)} ~ ${fmtDay(dateTo)}`
          : fmtDay(dateFrom);
        const period = lessonText(it.start, it.end);
        const periodLine = period ? ` ${period}` : "";

        const li = document.createElement("li");
        li.className = "task";
        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""} ${isOwner()?"":"disabled"}
                   data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>

          <div class="task__body">
            <div class="task__title">
              <b>${esc(it.subj || "")}</b>
              ${ddayBadge(dateFrom)}
            </div>
            <div class="task__content">${esc(it.text || "")}</div>
            ${it.detail ? `<div class="task__detail">${esc(it.detail)}</div>` : ""}
            <div class="task__date">ğŸ“… ${rangeText}${periodLine ? ` ${periodLine}` : ""}</div>
          </div>

          <div class="task__actions owner-only-inline" style="display:${isOwner()?"":"none"}">
            <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
            <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);

        li.addEventListener("click", async (e)=>{
          const t = e.target, act = t.getAttribute("data-act");
          if(!act) return;

          if(!isOwner()){
            if(act === "toggle" && t.tagName === "INPUT"){
              t.checked = !t.checked;
            }
            alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return;
          }

          const id = t.getAttribute("data-id");
          if(act === "toggle"){
            await colRW(cat).doc(id).set({ done: t.checked }, { merge:true });
          }else if(act === "del"){
            if(confirm("ì‚­ì œí• ê¹Œìš”?")) await colRW(cat).doc(id).delete();
          }else if(act === "edit"){
            const subj = prompt("ê³¼ëª©", it.subj || ""); if(subj===null) return;
            const text = prompt("ë‚´ìš©", it.text || ""); if(text===null) return;
            const detail = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", it.detail || ""); if(detail===null) return;
            const from = prompt("ì‹œì‘ì¼(YYYY-MM-DD)", it.dateFrom || ""); if(from===null) return;
            const to   = prompt("ì¢…ë£Œì¼(YYYY-MM-DD, ë¹„ìš°ë©´ ì‹œì‘ì¼ê³¼ ë™ì¼)", it.dateTo || it.dateFrom || ""); if(to===null) return;
            const start= prompt("ì‹œì‘ êµì‹œ(ì˜ˆ: 1êµì‹œ, ë¹„ìš°ê¸° ê°€ëŠ¥)", it.start || ""); if(start===null) return;
            const end  = prompt("ë êµì‹œ(ì˜ˆ: 3êµì‹œ, ë¹„ìš°ê¸° ê°€ëŠ¥)", it.end || ""); if(end===null) return;

            await colRW(cat).doc(id).set({
              subj, text, detail,
              dateFrom: from, dateTo: to || from,
              start, end
            }, { merge:true });
          }
        });
      });
    }

    // ì¶”ê°€ í¼
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn = $(".add", row);
        const cat = row.dataset.cat;
        btn.onclick = async ()=>{
          if(!isOwner()){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }

          if(cat === "important"){
            const subj = $(".subj", row).value.trim();
            const text = $(".text", row).value.trim();
            if(!subj || !text){ alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
            await colRW(cat).add({
              subj, text,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            $(".subj", row).value = "";
            $(".text", row).value = "";
            return;
          }

          // ì¼ë°˜ ì¹´í…Œê³ ë¦¬(ì‹œí—˜/ìˆ˜í–‰/ìˆ™ì œ)
          const subj = $(".subj", row).value.trim();
          const text = $(".text", row).value.trim();
          const dateFrom = $(".date-from", row).value;
          const dateTo   = $(".date-to", row).value || dateFrom;
          const start = $(".start", row).value;
          const end   = $(".end", row).value;
          const detail= $(".detail", row).value.trim();

          if(!subj || !text || !dateFrom){
            alert("ê³¼ëª© / ë‚´ìš© / ì‹œì‘ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
          }

          await colRW(cat).add({
            subj, text, detail,
            dateFrom, dateTo,
            start, end,
            done:false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          $(".subj", row).value = "";
          $(".text", row).value = "";
          $(".date-from", row).value = "";
          $(".date-to", row).value = "";
          $(".start", row).value = "";
          $(".end", row).value = "";
          $(".detail", row).value = "";
        };
      });
    }
  </script>
</body>
</html>
