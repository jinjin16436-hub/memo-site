<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<header class="topbar">
  <div class="brand">ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</div>
  <div class="actions">
    <button id="adminBadge" class="chip" style="display:none">ê´€ë¦¬ì</button>
    <button id="loginBtn"  class="btn">ğŸ”‘ ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸ“œ ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<main class="container">

  <!-- ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ -->
  <section class="card notice">
    <div class="card-head">
      <div class="title">ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</div>
      <label class="switch">
        <input type="checkbox" id="noticeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <!-- ê´€ë¦¬ìë§Œ ë³´ì´ëŠ” ì…ë ¥ í¼ -->
    <div id="noticeFormWrap" class="notice-form">
      <input id="noticeTitle" class="input" placeholder="ì œëª©" />
      <select id="noticeLevel" class="select">
        <option value="info">ì „ë‹¬ ì‚¬í•­</option>
        <option value="warn">ì£¼ì˜</option>
        <option value="danger">ì¤‘ìš”</option>
      </select>
      <button id="noticeAddBtn" class="btn primary">+ ì¶”ê°€</button>
      <textarea id="noticeBody" class="textarea" placeholder="ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
    </div>

    <div id="noticeListWrap" class="notice-list"></div>
    <div id="noticeEmpty" class="empty">ë“±ë¡ëœ ì „ë‹¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
  </section>

  <!-- ì‹œí—˜ -->
  <section class="card">
    <div class="card-head">
      <div class="title">ğŸ§ª ì‹œí—˜</div>
    </div>
    <ul id="list_exam" class="task-list"></ul>

    <!-- ê´€ë¦¬ìë§Œ ë³´ì´ëŠ” ì¶”ê°€ í¼ -->
    <div class="add-row admin-only">
      <input class="subj input" placeholder="ê³¼ëª©" />
      <input class="text input" placeholder="ë‚´ìš©" />
      <input class="date input" type="date" />
      <input class="date input" type="date" />
      <select class="start select"></select>
      <select class="end select"></select>
      <button class="add btn primary" data-cat="exam">+ ì¶”ê°€</button>
      <textarea class="desc textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ˜í–‰í‰ê°€ -->
  <section class="card">
    <div class="card-head">
      <div class="title">ğŸ§¾ ìˆ˜í–‰í‰ê°€</div>
    </div>
    <ul id="list_perf" class="task-list"></ul>

    <div class="add-row admin-only">
      <input class="subj input" placeholder="ê³¼ëª©" />
      <input class="text input" placeholder="ë‚´ìš©" />
      <input class="date input" type="date" />
      <input class="date input" type="date" />
      <select class="start select"></select>
      <select class="end select"></select>
      <button class="add btn primary" data-cat="perf">+ ì¶”ê°€</button>
      <textarea class="desc textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ™ì œ -->
  <section class="card">
    <div class="card-head">
      <div class="title">ğŸ“Œ ìˆ™ì œ</div>
    </div>
    <ul id="list_home" class="task-list"></ul>

    <div class="add-row admin-only">
      <input class="subj input" placeholder="ê³¼ëª©" />
      <input class="text input" placeholder="ë‚´ìš©" />
      <input class="date input" type="date" />
      <input class="date input" type="date" />
      <select class="start select"></select>
      <select class="end select"></select>
      <button class="add btn primary" data-cat="home">+ ì¶”ê°€</button>
      <textarea class="desc textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>
</main>

<script>
/* ====== 0) ì„¤ì • ====== */
const ADMIN_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // â† ê´€ë¦¬ì UIDë¡œ êµì²´
const firebaseConfig = {
  // â† ë‚´ Firebase config ê°’ìœ¼ë¡œ êµì²´
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "1:196036694705:web:8988d12919420130464890"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ====== 1) ìƒíƒœ ====== */
let currentUser = null;
let isAdmin = false;
const $  = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

function applyAdminUIFlag(){
  document.body.classList.toggle('is-admin', isAdmin);
  $("#adminBadge").style.display = isAdmin ? "" : "none";
  // admin-only í¼
  $$(".admin-only").forEach(el => el.style.display = isAdmin ? "" : "none");
  // ì „ë‹¬ì‚¬í•­ ì…ë ¥í¼
  const wrap = $("#noticeFormWrap");
  if (wrap) wrap.style.display = isAdmin ? "" : "none";
}

/* ====== 2) ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ ====== */
$("#loginBtn").addEventListener("click", async ()=>{
  try {
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  } catch {}
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
});
$("#logoutBtn").addEventListener("click", ()=> auth.signOut());

auth.onAuthStateChanged(async (user)=>{
  currentUser = user;
  isAdmin = !!user && user.uid === ADMIN_UID;
  $("#loginBtn").style.display  = user ? "none" : "";
  $("#logoutBtn").style.display = user ? "" : "none";
  applyAdminUIFlag();
  await loadNoticeSettings();
  await renderNoticeList();
  startTaskListeners(); // ì‹œí—˜/ìˆ˜í–‰/ìˆ™ì œ ì‹¤ì‹œê°„
});

/* ====== 3) ì „ë‹¬ ì‚¬í•­ ====== */

// í‘œì‹œ on/off ë¶ˆëŸ¬ì˜¤ê¸°
async function loadNoticeSettings(){
  try{
    const snap = await db.doc("settings/global").get();
    const showNotice = snap.exists ? (snap.data().showNotice !== false) : true;
    const toggle = $("#noticeToggle");
    toggle.checked = showNotice;
    $("#noticeListWrap").classList.toggle("hidden", !showNotice);
  }catch(e){ console.error(e); }
}

// í‘œì‹œ on/off ì €ì¥ (ê´€ë¦¬ìë§Œ)
$("#noticeToggle").addEventListener("change", async (e)=>{
  if (!isAdmin){
    e.preventDefault();
    e.target.checked = !e.target.checked;
    return;
  }
  try{
    await db.doc("settings/global").set({ showNotice: e.target.checked }, { merge: true });
    $("#noticeListWrap").classList.toggle("hidden", !e.target.checked);
  }catch(err){
    alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: " + err.message);
  }
});

// ì „ë‹¬ì‚¬í•­ ì¶”ê°€ (ê´€ë¦¬ìë§Œ)
$("#noticeAddBtn").addEventListener("click", async ()=>{
  if (!isAdmin) return;
  const title = $("#noticeTitle").value.trim();
  const level = $("#noticeLevel").value;
  const body  = $("#noticeBody").value.trim();
  if (!title){ alert("ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
  try{
    await db.collection("notice").add({
      title, level, body,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $("#noticeTitle").value = "";
    $("#noticeBody").value  = "";
  }catch(e){ alert("ì¶”ê°€ ì‹¤íŒ¨: "+e.message); }
});

// ì „ë‹¬ì‚¬í•­ ëª©ë¡ ë Œë”
async function renderNoticeList(){
  const list = $("#noticeListWrap");
  list.innerHTML = "";
  const snap = await db.collection("notice").orderBy("createdAt","desc").get();
  if (snap.empty){ $("#noticeEmpty").style.display = ""; return; }
  $("#noticeEmpty").style.display = "none";
  snap.forEach(doc=>{
    const d = doc.data();
    const wrap = document.createElement("div");
    wrap.className = `notice-item ${d.level||"info"}`;
    wrap.innerHTML = `
      <div class="notice-title">${esc(d.title)}</div>
      ${d.body ? `<div class="notice-body">${esc(d.body).replace(/\n/g,"<br/>")}</div>`:""}
    `;
    list.appendChild(wrap);
  });
}

/* ====== 4) ê³¼ì œ(ì‹œí—˜/ìˆ˜í–‰/ìˆ™ì œ) ====== */

const lists = { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") };

function startTaskListeners(){
  ["exam","perf","home"].forEach(cat=>{
    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ê°€ í•„ìš”í•˜ë©´ ì €ì¥/í•´ì œ ë¡œì§ ì¶”ê°€
    db.collection("users").doc(getOwnerUid())
      .collection("tasks").doc(cat).collection("items")
      .orderBy("due","asc")
      .onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
        renderList(cat, arr);
      });
  });
}

// ë¹„ë¡œê·¸ì¸ ë•Œë„ ê³µê°œ UIDë¡œ ì½ê²Œ (OWNER_UIDë¥¼ ë³¸ì¸ ê·œì¹™ëŒ€ë¡œ ì‚¬ìš© ì¤‘ì´ë¼ë©´, ê·¸ëŒ€ë¡œ ìœ ì§€)
const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // ì˜ˆì‹œ
function getOwnerUid(){
  return currentUser?.uid || OWNER_UID;
}

function renderList(cat, items){
  const ul = lists[cat];
  ul.innerHTML = "";
  for (const it of items){
    const li = document.createElement("li");
    li.className = "task";
    const ddayBadge = makeDDayBadge(it.due);
    const period = makePeriodText(it.startPeriod, it.endPeriod);
    const range  = makeDateRange(it.from, it.due);
    li.innerHTML = `
      <label class="chk"><input type="checkbox" ${it.done?"checked":""} data-act="toggle" data-cat="${cat}" data-id="${it.id}"><span></span></label>
      <div class="task-main">
        <div class="task-title"><b>${esc(it.subj||"")}</b>${ddayBadge}</div>
        <div class="task-text">${esc(it.text||"")}</div>
        ${it.desc ? `<div class="task-desc">${esc(it.desc).replace(/\n/g,"<br/>")}</div>`:""}
        <div class="task-meta">ğŸ“… ${range}${period?`  Â·  ${period}`:""}</div>
      </div>
      ${isAdmin?`<div class="task-ops">
         <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
         <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
       </div>`:""}
    `;
    ul.appendChild(li);
  }

  ul.onclick = async (e)=>{
    const t = e.target;
    const act = t.getAttribute("data-act");
    if (!act) return;

    const cat2 = t.getAttribute("data-cat");
    const id   = t.getAttribute("data-id");

    if (act === "toggle"){
      if (!currentUser){ t.checked = !t.checked; return; }
      try{ await col(cat2).doc(id).update({ done:t.checked }); }catch(err){ alert(err.message); }
    } else if (act === "del"){
      if (!isAdmin) return;
      if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      await col(cat2).doc(id).delete();
    } else if (act === "edit"){
      if (!isAdmin) return;
      openEdit(cat2, id);
    }
  };
}

function col(cat){
  return db.collection("users").doc(getOwnerUid())
           .collection("tasks").doc(cat).collection("items");
}

function makeDDayBadge(due){
  if (!due) return "";
  const d = new Date(due+"T00:00:00");
  const today = new Date();
  const diff = Math.floor((d - toMidnight(today))/86400000);
  let label = "";
  let cls   = "";
  if (diff > 0) { label = `D-${diff}`; cls = "p-future"; }
  else if (diff === 0) { label = "D-DAY"; cls="p-today"; }
  else { label = `D+${Math.abs(diff)}`; cls="p-past"; }
  return `<span class="dday ${cls}">${label}</span>`;
}
function toMidnight(dt){ return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }

function makeDateRange(from, to){
  const a = from ? toDisplayDate(from) : null;
  const b = to ? toDisplayDate(to) : null;
  if (a && b && a!==b) return `${a} ~ ${b}`;
  return b || a || "";
}
function toDisplayDate(iso){
  const d = new Date(iso+"T00:00:00");
  const w = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
  const y = d.getFullYear();
  const m = ("0"+(d.getMonth()+1)).slice(-2);
  const day = ("0"+d.getDate()).slice(-2);
  return `${y}-${m}-${day} (${w})`;
}
function makePeriodText(s,e){
  if (!s && !e) return "";
  if (s && e) return `${s}êµì‹œ ~ ${e}êµì‹œ`;
  if (s) return `${s}êµì‹œ`;
  return `${e}êµì‹œ`;
}

/* ====== 5) ì¶”ê°€ í¼(ê´€ë¦¬ìë§Œ) ====== */
function fillPeriodSelects(){
  $$(".add-row .start").forEach(sel=>{
    sel.innerHTML = ["","1","2","3","4","5","6","7"].map(v=>
      `<option value="${v}">${v? v+"êµì‹œ":"êµì‹œ ì—†ìŒ"}</option>`).join("");
  });
  $$(".add-row .end").forEach(sel=>{
    sel.innerHTML = ["","1","2","3","4","5","6","7"].map(v=>
      `<option value="${v}">${v? v+"êµì‹œ":"êµì‹œ ì—†ìŒ"}</option>`).join("");
  });
}
fillPeriodSelects();

$$(".add-row .add").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    if (!isAdmin) return;
    const row  = btn.closest(".add-row");
    const cat  = btn.dataset.cat;
    const subj = $(".subj", row).value.trim();
    const text = $(".text", row).value.trim();
    const from = $(".date:nth-of-type(1)", row).value || "";
    const due  = $(".date:nth-of-type(2)", row).value || "";
    const start= $(".start",row).value || "";
    const end  = $(".end",row).value || "";
    const desc = $(".desc", row).value.trim();

    if (!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
    await col(cat).add({
      subj, text,
      from, due,
      startPeriod: start || null,
      endPeriod: end || null,
      desc: desc || "",
      done: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $(".subj", row).value="";
    $(".text", row).value="";
    $(".date:nth-of-type(1)", row).value="";
    $(".date:nth-of-type(2)", row).value="";
    $(".start", row).value="";
    $(".end", row).value="";
    $(".desc", row).value="";
  });
});

/* ====== 6) ìˆ˜ì • ëª¨ë‹¬(ê°„ë‹¨ ë²„ì „) ====== */
function openEdit(cat, id){
  // ê°„ë‹¨: í˜„ì¬ í•­ëª© ê°’ë§Œ ì½ì–´ì„œ promptë¡œ ìˆ˜ì • (í•„ìš” ì‹œ UI ëª¨ë‹¬ë¡œ êµì²´)
  col(cat).doc(id).get().then(doc=>{
    const d = doc.data();
    const subj = prompt("ê³¼ëª©", d.subj||""); if (subj===null) return;
    const text = prompt("ë‚´ìš©", d.text||""); if (text===null) return;
    const from = prompt("ì‹œì‘ì¼(YYYY-MM-DD, ì„ íƒ)", d.from||""); if (from===null) return;
    const due  = prompt("ë§ˆê°ì¼(YYYY-MM-DD)", d.due||""); if (due===null) return;
    const start= prompt("ì‹œì‘êµì‹œ(ìˆ«ì, ì„ íƒ)", d.startPeriod||""); if (start===null) return;
    const end  = prompt("ëêµì‹œ(ìˆ«ì, ì„ íƒ)", d.endPeriod||""); if (end===null) return;
    const desc = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", d.desc||""); if (desc===null) return;

    col(cat).doc(id).update({
      subj, text,
      from: from || "",
      due:  due  || "",
      startPeriod: start || null,
      endPeriod:   end   || null,
      desc: desc || ""
    });
  });
}

/* ====== 7) ìœ í‹¸ ====== */
function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* ====== 8) 1ë¶„ ìë™ ìƒˆë¡œê³ ì¹¨ (ì¡°ìš©íˆ) ====== */
setInterval(()=>{ location.reload(); }, 60*1000);

</script>
</body>
</html>
