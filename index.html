<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="admin-bar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="spacer"></div>
    <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <main class="container">
    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">ğŸ“„ ìˆ˜í–‰í‰ê°€ â–¾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>

        <div class="add-row" data-cat="perf" style="display:none">
          <div class="row-top">
            <input class="subj" type="text" placeholder="ê³¼ëª©" />
            <input class="dateStart" type="date" />
            <span class="tilde">~</span>
            <input class="dateEnd" type="date" />
            <select class="periodFrom">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
              <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
              <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
              <option value="7">7êµì‹œ</option>
            </select>
            <select class="periodTo">
              <option value="">ë êµì‹œ</option>
              <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
              <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
              <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
              <option value="7">7êµì‹œ</option>
            </select>
            <button class="add btn">+ ì¶”ê°€</button>
          </div>

          <textarea class="text" rows="3" placeholder="ìƒì„¸ ë‚´ìš©(ì„ íƒ)"></textarea>
        </div>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">ğŸ§ª ì‹œí—˜ â–¾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>

        <div class="add-row" data-cat="exam" style="display:none">
          <div class="row-top">
            <input class="subj" type="text" placeholder="ê³¼ëª©" />
            <input class="dateStart" type="date" />
            <span class="tilde">~</span>
            <input class="dateEnd" type="date" />
            <select class="periodFrom">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
              <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
              <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
              <option value="7">7êµì‹œ</option>
            </select>
            <select class="periodTo">
              <option value="">ë êµì‹œ</option>
              <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
              <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
              <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
              <option value="7">7êµì‹œ</option>
            </select>
            <button class="add btn">+ ì¶”ê°€</button>
          </div>

          <textarea class="text" rows="3" placeholder="ìƒì„¸ ë‚´ìš©(ì„ íƒ)"></textarea>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>

        <div class="add-row" data-cat="home" style="display:none">
          <div class="row-top">
            <input class="subj" type="text" placeholder="ê³¼ëª©" />
            <input class="dateStart" type="date" />
            <span class="tilde">~</span>
            <input class="dateEnd" type="date" />
            <select class="periodFrom">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
              <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
              <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
              <option value="7">7êµì‹œ</option>
            </select>
            <select class="periodTo">
              <option value="">ë êµì‹œ</option>
              <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
              <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
              <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
              <option value="7">7êµì‹œ</option>
            </select>
            <button class="add btn">+ ì¶”ê°€</button>
          </div>

          <textarea class="text" rows="3" placeholder="ìƒì„¸ ë‚´ìš©(ì„ íƒ)"></textarea>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™”: ë„¤ í”„ë¡œì íŠ¸ ê°’ -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.appspot.com",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ì•± ì½”ë“œ -->
  <script>
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, r=document) => r.querySelector(q);
    const $$ = (q, r=document) => Array.from(r.querySelectorAll(q));
    const el = {
      loginBtn:  $("#loginBtn"),
      logoutBtn: $("#logoutBtn"),
      lists:     { perf: $("#list_perf"), exam: $("#list_exam"), home: $("#list_home") }
    };

    let currentUser = null;
    let unsubscribers = [];

    function toggleSection(id){
      const box = document.getElementById(id);
      if(!box) return;
      box.classList.toggle("open");
    }
    function setEditVisible(v){
      $$(".add-row").forEach(r => r.style.display = v ? "" : "none");
      $$(".btn-ghost").forEach(b => b.style.display = v ? "" : "none");
      $$(".task__actions").forEach(a => a.style.display = v ? "flex" : "none");
    }

    const col = (cat) => {
      const uid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;
      return db.collection("users").doc(uid)
               .collection("tasks").doc(cat).collection("items");
    };

    // ë ˆê±°ì‹œ(due) í˜¸í™˜
    const getStartISO = it => it.startDate || it.due || "";
    const getEndISO   = it => it.endDate   || it.startDate || it.due || "";

    // ë‚ ì§œ/ìš”ì¼/êµì‹œ + D-day
    function formatMeta(it){
      let meta = "", ddayHtml = "";
      const sISO = getStartISO(it);
      if(sISO){
        const s = new Date(sISO);
        const eISO = getEndISO(it);
        const e = new Date(eISO);
        const wd = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

        const sStr = `${s.getFullYear()}/${String(s.getMonth()+1).padStart(2,"0")}/${String(s.getDate()).padStart(2,"0")} (${wd[s.getDay()]})`;
        if(eISO && eISO !== sISO){
          const eStr = `${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")} (${wd[e.getDay()]})`;
          meta = `${sStr} ~ ${eStr}`;
        } else {
          meta = sStr;
        }

        const pf = Number(it.periodFrom), pt = Number(it.periodTo);
        if(Number.isFinite(pf) && Number.isFinite(pt)){
          meta += ` ${pf===pt ? `${pf}êµì‹œ` : `${pf}~${pt}êµì‹œ`}`;
        } else if (Number.isFinite(pf)) {
          meta += ` ${pf}êµì‹œ`;
        }

        const today = new Date(); today.setHours(0,0,0,0);
        const dueDay = new Date(s); dueDay.setHours(0,0,0,0);
        const diff = Math.floor((dueDay - today) / (1000*60*60*24));
        if (diff === 0) ddayHtml = `<span class="dday red">D-day</span>`;
        else if (diff === 1) ddayHtml = `<span class="dday red">D-1</span>`;
        else if (diff >= 2 && diff <= 3) ddayHtml = `<span class="dday orange">D-${diff}</span>`;
        else if (diff >= 4 && diff <= 5) ddayHtml = `<span class="dday yellow">D-${diff}</span>`;
        else if (diff >= 6) ddayHtml = `<span class="dday green">D-${diff}</span>`;
        else ddayHtml = `<span class="dday past">D+${Math.abs(diff)}</span>`;
      }
      return (meta || ddayHtml) ? `ğŸ“… ${meta} ${ddayHtml}`.trim() : "";
    }

    // ë Œë”ë§ (+ìˆ˜ì • íŒ¨ë„ í¬í•¨)
    function renderList(cat, items){
      const ul = el.lists[cat];
      ul.innerHTML = "";
      for(const it of items){
        const li = document.createElement("li");
        li.className = "task" + (it.done ? " done" : "");
        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""}
                   data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>

          <div class="task__main">
            <div class="task__line">
              <b>${esc(it.subj||"")}</b><br>
              <span>${esc(it.text||"")}</span>
            </div>
            <div class="task__meta">${formatMeta(it)}</div>
          </div>

          <div class="task__actions" style="display:${currentUser?'flex':'none'}; gap:6px;">
            <button class="btn-ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
            <button class="btn-ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
          </div>

          <div class="edit-panel" data-panel="${it.id}">
            <div class="edit-grid">
              <input  class="e-subj" type="text" placeholder="ê³¼ëª©" value="${esc(it.subj||"")}" />
              <textarea class="e-text" rows="1" placeholder="ìƒì„¸ ë‚´ìš©(ì„ íƒ)">${esc(it.text||"")}</textarea>

              <input class="e-start" type="date" value="${getStartISO(it) ? new Date(getStartISO(it)).toISOString().slice(0,10) : ""}" />
              <span class="tilde">~</span>
              <input class="e-end"   type="date" value="${getEndISO(it) ? new Date(getEndISO(it)).toISOString().slice(0,10) : ""}" />

              <select class="e-pf">
                <option value="">ì‹œì‘ êµì‹œ</option>
                ${[1,2,3,4,5,6,7].map(n=>`<option value="${n}" ${Number(it.periodFrom)===n?'selected':''}>${n}êµì‹œ</option>`).join("")}
              </select>

              <select class="e-pt">
                <option value="">ë êµì‹œ</option>
                ${[1,2,3,4,5,6,7].map(n=>`<option value="${n}" ${Number(it.periodTo)===n?'selected':''}>${n}êµì‹œ</option>`).join("")}
              </select>
            </div>

            <div class="edit-actions">
              <button class="btn"         data-act="save"   data-cat="${cat}" data-id="${it.id}">ì €ì¥</button>
              <button class="btn-outline" data-act="cancel" data-cat="${cat}" data-id="${it.id}">ì·¨ì†Œ</button>
            </div>
          </div>
        `;
        ul.appendChild(li);
      }

      // ë¸ë¦¬ê²Œì´íŠ¸ í•¸ë“¤ëŸ¬ (ì²´í¬/ì‚­ì œ/ìˆ˜ì •/ì €ì¥/ì·¨ì†Œ)
      ul.onclick = async (e)=>{
        const t = e.target;
        const act = t.getAttribute("data-act");
        if(!act) return;

        const cat2 = t.getAttribute("data-cat");
        const id   = t.getAttribute("data-id");

        if(["toggle","del","edit","save","cancel"].includes(act) && !currentUser){
          alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.");
          if(act === "toggle") t.checked = !t.checked;
          return;
        }

        try{
          if(act === "toggle"){
            await col(cat2).doc(id).update({ done: t.checked });

          }else if(act === "del"){
            await col(cat2).doc(id).delete();

          }else if(act === "edit"){
            const panel = ul.querySelector(`.edit-panel[data-panel="${id}"]`);
            if(panel) panel.classList.toggle("open");

          }else if(act === "cancel"){
            const panel = ul.querySelector(`.edit-panel[data-panel="${id}"]`);
            if(panel) panel.classList.remove("open");

          }else if(act === "save"){
            const panel = ul.querySelector(`.edit-panel[data-panel="${id}"]`);
            if(!panel) return;

            const subj = panel.querySelector(".e-subj").value.trim();
            const text = panel.querySelector(".e-text").value.trim();
            const start = panel.querySelector(".e-start").value || "";
            const end   = panel.querySelector(".e-end").value   || start;
            const pfVal = panel.querySelector(".e-pf").value;
            const ptVal = panel.querySelector(".e-pt").value;

            if(!subj){ alert("ê³¼ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

            const payload = {
              subj, text,
              startDate: start || "",
              endDate: end || start || "",
              due: start || "", // ë ˆê±°ì‹œ í˜¸í™˜
              periodFrom: pfVal ? Number(pfVal) : null,
              periodTo:   ptVal ? Number(ptVal) : null,
            };

            await col(cat2).doc(id).update(payload);
            panel.classList.remove("open");
          }
        }catch(err){
          console.error(err);
          alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + err.message);
        }
      };
    }

    // ì¶”ê°€ ë°”ì¸ë”©
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        $(".add", row).onclick = async ()=>{
          if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }
          const subj = $(".subj", row).value.trim();
          const text = $(".text", row).value.trim();
          const start= $(".dateStart", row).value || "";
          const end  = $(".dateEnd", row).value || start;
          const pf   = $(".periodFrom", row).value;
          const pt   = $(".periodTo", row).value;

          if(!subj){ alert("ê³¼ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

          try{
            await col(row.dataset.cat).add({
              subj, text,
              startDate: start || "",
              endDate: end || start || "",
              due: start || "",  // ë ˆê±°ì‹œ í˜¸í™˜
              periodFrom: pf ? Number(pf) : null,
              periodTo:   pt ? Number(pt) : null,
              done: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            $(".subj", row).value = "";
            $(".text", row).value = "";
            $(".dateStart", row).value = "";
            $(".dateEnd", row).value = "";
            $(".periodFrom", row).value = "";
            $(".periodTo", row).value = "";
          }catch(e){
            alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            console.error(e);
          }
        };
      });
    }

    // ì‹¤ì‹œê°„ êµ¬ë…(ì •ë ¬: ì‹œì‘ì¼/ë ˆê±°ì‹œ)
    function startListeners(){
      unsubscribers.forEach(u => u && u());
      unsubscribers = [];

      ["perf","exam","home"].forEach(cat => {
        const u = col(cat).onSnapshot(
          snap => {
            const arr = [];
            snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
            arr.sort((a,b) => (getStartISO(a)||"").localeCompare((getStartISO(b)||"")));
            renderList(cat, arr);
          },
          err => {
            console.error("listener error:", err);
            alert("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + err.message);
          }
        );
        unsubscribers.push(u);
      });
    }

    const esc = s => (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
    const provider = new firebase.auth.GoogleAuthProvider();
    $("#loginBtn").onclick  = () => auth.signInWithPopup(provider).catch(e=>alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message));
    $("#logoutBtn").onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      currentUser = user;
      el.loginBtn.style.display  = user ? "none" : "";
      el.logoutBtn.style.display = user ? "" : "none";
      setEditVisible(!!user);
      bindAddRows();
      startListeners();
    });
  </script>
</body>
</html>
