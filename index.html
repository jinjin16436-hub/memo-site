<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="auth">
      <button id="adminBadge" class="chip" style="display:none">ê´€ë¦¬ì</button>
      <button id="loginBtn"  class="btn">ğŸ”‘ ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <main class="container">

    <!-- ì‹œí—˜ -->
    <section class="card">
      <div class="section-head">
        <h2>ğŸ§ª ì‹œí—˜</h2>
      </div>

      <ul id="list_exam" class="task-list"></ul>

      <!-- ê´€ë¦¬ìë§Œ ë³´ì´ê²Œ ë¨ -->
      <div class="add-row" data-cat="exam" style="display:none">
        <input class="subj"  placeholder="ê³¼ëª©" />
        <input class="text"  placeholder="ë‚´ìš©" />
        <input class="date-start" type="date" />
        <input class="date-end"   type="date" />
        <select class="period-start">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <select class="period-end">
          <option value="">ë êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section class="card">
      <div class="section-head">
        <h2>ğŸ“„ ìˆ˜í–‰í‰ê°€</h2>
      </div>

      <ul id="list_perf" class="task-list"></ul>

      <div class="add-row" data-cat="perf" style="display:none">
        <input class="subj"  placeholder="ê³¼ëª©" />
        <input class="text"  placeholder="ë‚´ìš©" />
        <input class="date-start" type="date" />
        <select class="period-start">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <select class="period-end">
          <option value="">ë êµì‹œ</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section class="card">
      <div class="section-head">
        <h2>ğŸ“Œ ìˆ™ì œ</h2>
      </div>

      <ul id="list_home" class="task-list"></ul>

      <div class="add-row" data-cat="home" style="display:none">
        <input class="subj"  placeholder="ê³¼ëª©" />
        <input class="text"  placeholder="ë‚´ìš©" />
        <input class="date-start" type="date" />
        <select class="period-start">
          <option value="">êµì‹œ(ì„ íƒ)</option>
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option><option>8êµì‹œ</option>
        </select>
        <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  /***** 0) Firebase ì´ˆê¸°í™” (ë°˜ë“œì‹œ ë„¤ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´) *****/
  const firebaseConfig = {
    apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
    authDomain: "my-memo-site.firebaseapp.com",
    projectId: "my-memo-site",
    storageBucket: "my-memo-site.firebasestorage.app",
    messagingSenderId: "196036694705",
    appId: "1:196036694705:web:8988d12919420130464890"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  /***** 1) UID ì„¤ì • *****/
  const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";      // ê³µê°œë¡œ ë³´ì—¬ì¤„ ì‚¬ìš©ì (ë¡œê·¸ì•„ì›ƒ/ë¹„ë¡œê·¸ì¸ í¬í•¨)
  const ADMIN_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";           // ì“°ê¸°/ìˆ˜ì •/ì‚­ì œ ê¶Œí•œ

  /***** 2) ìœ í‹¸ *****/
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const el = {
    loginBtn:  $("#loginBtn"),
    logoutBtn: $("#logoutBtn"),
    adminBadge: $("#adminBadge"),
    lists: { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") }
  };

  let currentUser = null;
  let isAdmin     = false;
  let unsubscribers = [];

  // Firestore ê²½ë¡œ (ì½ê¸°ëŠ” ê³µê°œ/ì“°ê¸°Â·ìˆ˜ì •ì€ ê´€ë¦¬ì)
  const col = (cat) => {
    const uid = currentUser?.uid || OWNER_UID;
    return db.collection("users").doc(uid)
             .collection("tasks").doc(cat).collection("items");
  };

  // D-day ë±ƒì§€
  function ddayBadge(dateStr){
    if(!dateStr) return "";
    const today = new Date(); today.setHours(0,0,0,0);
    const due   = new Date(dateStr); due.setHours(0,0,0,0);
    const diff = Math.round((due - today) / (1000*60*60*24));
    let label = "";
    let cls   = "";

    if(diff > 0){       // ë¯¸ë˜
      label = `D-${diff}`;
      if(diff <= 1) cls = "d-red";
      else if(diff <= 3) cls = "d-orange";
      else if(diff <= 5) cls = "d-yellow";
      else cls = "d-green";
    }else if(diff === 0){
      label = "D-DAY";
      cls   = "d-red";
    }else{              // ê³¼ê±°
      label = `A+${Math.abs(diff)}`;
      cls   = "d-past";
    }
    return `<span class="dday ${cls}">${label}</span>`;
  }

  // ë Œë”
  function renderList(cat, items){
    const ul = el.lists[cat];
    ul.innerHTML = "";
    items.forEach(it=>{
      const li = document.createElement("li");
      li.className = "task";

      const dateLine = it.startDate
        ? (it.endDate ? `${it.startDate} ~ ${it.endDate}` : it.startDate)
        : (it.due || "");

      const periodLine = (it.startPeriod || it.endPeriod)
        ? `${it.startPeriod || ""}${it.endPeriod ? " ~ " + it.endPeriod : ""}`
        : "";

      li.innerHTML = `
        <div class="task__left">
          <label class="chk-wrap">
            <input type="checkbox" ${it.done ? "checked": ""} data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>
          <div class="task__main">
            <div class="task__top">
              <b class="task__subj">${escapeHtml(it.subj || "")}</b>
              <span class="sep"></span>
              <span class="task__text">${escapeHtml(it.text || "")}</span>
              ${ddayBadge(it.due || it.startDate || it.endDate)}
            </div>
            <div class="task__meta">
              ${dateLine ? `ğŸ“… ${dateLine}` : ""} ${periodLine ? ` ãƒ» ${periodLine}` : ""}
            </div>
            ${it.detail ? `<div class="task__detail">${escapeHtml(it.detail)}</div>` : ""}
          </div>
        </div>
        <div class="task__actions" style="display:${isAdmin ? "" : "none"}">
          <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
          <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
        </div>
      `;
      ul.appendChild(li);
    });

    // ì•¡ì…˜
    ul.onclick = async (e) => {
      const act = e.target.getAttribute("data-act");
      if(!act) return;

      const cat2 = e.target.getAttribute("data-cat");
      const id   = e.target.getAttribute("data-id");

      if(act === "toggle"){
        if(!isAdmin){ alert("ì™„ë£Œ ì²´í¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); e.target.checked = !e.target.checked; return; }
        await col(cat2).doc(id).update({ done: e.target.checked });
      }
      if(act === "del"){
        if(!isAdmin){ alert("ì‚­ì œëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
        if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) await col(cat2).doc(id).delete();
      }
      if(act === "edit"){
        if(!isAdmin){ alert("ìˆ˜ì •ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
        openEditor(cat2, id);
      }
    }
  }

  // ìˆ˜ì • ë‹¤ì´ì–¼ë¡œê·¸(ê°„ë‹¨)
  async function openEditor(cat, id){
    const snap = await col(cat).doc(id).get();
    if(!snap.exists) return alert("í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    const it = { id: snap.id, ...snap.data() };

    const subj   = prompt("ê³¼ëª©", it.subj || "");
    if(subj === null) return;
    const text   = prompt("ë‚´ìš©", it.text || "");
    if(text === null) return;
    const detail = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ)", it.detail || "");
    if(detail === null) return;

    await col(cat).doc(id).update({ subj, text, detail });
  }

  function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  /***** 3) ì‹¤ì‹œê°„ êµ¬ë… *****/
  function startListeners(){
    unsubscribers.forEach(u=>u&&u());
    unsubscribers = [];

    ["exam","perf","home"].forEach(cat=>{
      const u = col(cat).orderBy("due","asc").onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>arr.push({ id: d.id, ...d.data() }));
        renderList(cat, arr);
      }, err=>{
        console.error("listener error:", err);
        alert("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + err.message);
      });
      unsubscribers.push(u);
    });

    restoreDraft(); // í¼ ì„ì‹œì €ì¥ ë³µì›
  }

  /***** 4) í¼ ì„ì‹œì €ì¥ *****/
  const DRAFT_KEY = "memo:addrow-draft-v1";
  function gatherDraft(){
    const data = {};
    $$(".add-row").forEach(row=>{
      const cat = row.dataset.cat;
      data[cat] = {
        subj: $(".subj", row)?.value || "",
        text: $(".text", row)?.value || "",
        detail: $(".detail", row)?.value || "",
        d1: $(".date-start", row)?.value || "",
        d2: $(".date-end", row)?.value || "",
        p1: $(".period-start", row)?.value || "",
        p2: $(".period-end", row)?.value || "",
      };
    });
    return data;
  }
  function restoreDraft(){
    try{
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      $$(".add-row").forEach(row=>{
        const d = data[row.dataset.cat] || {};
        if($(".subj", row))  $(".subj", row).value  = d.subj || "";
        if($(".text", row))  $(".text", row).value  = d.text || "";
        if($(".detail", row))$(".detail", row).value= d.detail || "";
        if($(".date-start", row)) $(".date-start", row).value = d.d1 || "";
        if($(".date-end", row))   $(".date-end", row).value   = d.d2 || "";
        if($(".period-start", row)) $(".period-start", row).value = d.p1 || "";
        if($(".period-end", row))   $(".period-end", row).value   = d.p2 || "";
      });
    }catch{}
  }
  function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft())); }
  document.addEventListener("input", e=>{
    if(e.target.closest(".add-row")) saveDraft();
  });

  /***** 5) ì¶”ê°€ ë²„íŠ¼(í•¸ë“¤ëŸ¬) â€” í–‰ ê¸°ì¤€ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ *****/
  function bindAddRows(){
    $$(".add-row .add").forEach(btn=>{
      btn.onclick = async (e)=>{
        const row = e.currentTarget.closest(".add-row");
        const cat = row.dataset.cat;

        const subj   = $(".subj", row)?.value.trim()   || "";
        const text   = $(".text", row)?.value.trim()   || "";
        const detail = $(".detail", row)?.value.trim() || "";
        const d1     = $(".date-start", row)?.value    || "";
        const d2     = $(".date-end", row)?.value      || "";
        const p1     = $(".period-start", row)?.value  || "";
        const p2     = $(".period-end", row)?.value    || "";

        if(!isAdmin){ alert("ì¶”ê°€ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
        if(!subj || !text){ alert("ê³¼ëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

        const payload = {
          subj, text, detail,
          startDate: d1 || "", endDate: d2 || "",
          startPeriod: p1 || "", endPeriod: p2 || "",
          due: d1 || d2 || "",
          done: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try{
          await col(cat).add(payload);

          // ì…ë ¥ ì´ˆê¸°í™” + ì„ì‹œì €ì¥ ê°±ì‹ 
          [".subj",".text",".detail",".date-start",".date-end"].forEach(s=>{
            const el = $(s, row); if(el) el.value = "";
          });
          if($(".period-start", row)) $(".period-start", row).value = "";
          if($(".period-end", row))   $(".period-end", row).value   = "";
          saveDraft();
        }catch(err){
          console.error(err);
          alert("ì €ì¥ ì‹¤íŒ¨: " + (err.message || err));
        }
      };
    });
  }

  /***** 6) ë¡œê·¸ì¸/ê¶Œí•œ í‘œì‹œ *****/
  const provider = new firebase.auth.GoogleAuthProvider();

  el.loginBtn.onclick = async ()=>{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithPopup(provider);
  };
  el.logoutBtn.onclick = ()=> auth.signOut();

  auth.onAuthStateChanged(user=>{
    currentUser = user;
    isAdmin     = !!(user && user.uid === ADMIN_UID);
    el.loginBtn.style.display  = user ? "none" : "";
    el.logoutBtn.style.display = user ? "" : "none";
    el.adminBadge.style.display = isAdmin ? "" : "none";

    // ê´€ë¦¬ìë§Œ ì¶”ê°€ í¼ ë…¸ì¶œ
    $$(".add-row").forEach(r => r.style.display = isAdmin ? "" : "none");

    bindAddRows();
    startListeners();
  });

  </script>
</body>
</html>
