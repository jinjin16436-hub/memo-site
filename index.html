<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="topbar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="spacer"></div>
    <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <!-- ì»¨í…Œì´ë„ˆ -->
  <main class="container">

    <!-- ======= ì‹œí—˜ ======= -->
    <section class="sec">
      <div class="sec__head"><h2>ğŸ§ª ì‹œí—˜</h2></div>
      <ul id="list_exam" class="task-list"></ul>

      <!-- ê´€ë¦¬ìë§Œ ë³´ì„ -->
      <div class="add-row owner-only" data-cat="exam">
        <input class="subj" type="text" placeholder="ê³¼ëª©" />
        <input class="text" type="text" placeholder="ë‚´ìš©" />
        <input class="date" type="date" />
        <select class="start">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option value="0">0êµì‹œ</option>
          <option value="1">1êµì‹œ</option>
          <option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option>
          <option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option>
          <option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <select class="end">
          <option value="">ë êµì‹œ</option>
          <option value="0">0êµì‹œ</option>
          <option value="1">1êµì‹œ</option>
          <option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option>
          <option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option>
          <option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ======= ìˆ˜í–‰í‰ê°€ ======= -->
    <section class="sec">
      <div class="sec__head"><h2>ğŸ“„ ìˆ˜í–‰í‰ê°€</h2></div>
      <ul id="list_perf" class="task-list"></ul>

      <!-- ê´€ë¦¬ìë§Œ ë³´ì„ -->
      <div class="add-row owner-only" data-cat="perf">
        <input class="subj" type="text" placeholder="ê³¼ëª©" />
        <input class="text" type="text" placeholder="ë‚´ìš©" />
        <input class="date" type="date" />
        <select class="start">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option value="0">0êµì‹œ</option>
          <option value="1">1êµì‹œ</option>
          <option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option>
          <option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option>
          <option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <select class="end">
          <option value="">ë êµì‹œ</option>
          <option value="0">0êµì‹œ</option>
          <option value="1">1êµì‹œ</option>
          <option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option>
          <option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option>
          <option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ======= ìˆ™ì œ ======= -->
    <section class="sec">
      <div class="sec__head"><h2>ğŸ“Œ ìˆ™ì œ</h2></div>
      <ul id="list_home" class="task-list"></ul>

      <!-- ê´€ë¦¬ìë§Œ ë³´ì„ -->
      <div class="add-row owner-only" data-cat="home">
        <input class="subj" type="text" placeholder="ê³¼ëª©" />
        <input class="text" type="text" placeholder="ë‚´ìš©" />
        <input class="date" type="date" />
        <select class="start">
          <option value="">ì‹œì‘ êµì‹œ</option>
          <option value="0">0êµì‹œ</option>
          <option value="1">1êµì‹œ</option>
          <option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option>
          <option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option>
          <option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <select class="end">
          <option value="">ë êµì‹œ</option>
          <option value="0">0êµì‹œ</option>
          <option value="1">1êµì‹œ</option>
          <option value="2">2êµì‹œ</option>
          <option value="3">3êµì‹œ</option>
          <option value="4">4êµì‹œ</option>
          <option value="5">5êµì‹œ</option>
          <option value="6">6êµì‹œ</option>
          <option value="7">7êµì‹œ</option>
        </select>
        <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
        <button class="add btn">+ ì¶”ê°€</button>
      </div>
    </section>

  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ì•± ì½”ë“œ -->
  <script>
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";

    let currentUser = null;
    const $  = (q, r=document)=>r.querySelector(q);
    const $$ = (q, r=document)=>Array.from(r.querySelectorAll(q));

    const el = {
      loginBtn:  $("#loginBtn"),
      logoutBtn: $("#logoutBtn"),
      lists: { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") }
    };

    const isAdmin = ()=> currentUser && currentUser.uid === OWNER_UID;
    const col = (cat)=> db.collection("users").doc(OWNER_UID).collection("tasks").doc(cat).collection("items");

    /* ---------- D-Day ---------- */
    function toDate(x){ if(!x) return null; const d=new Date(x); return isNaN(+d)?null:d; }
    function renderDdayLabel(endDate, dueDate, startDate){
      const t = toDate(endDate) || toDate(dueDate) || toDate(startDate);
      if(!t) return "";
      const today = new Date(); today.setHours(0,0,0,0);
      t.setHours(0,0,0,0);
      const diff = Math.floor((t - today)/86400000);
      let text="", cls="";
      if(diff === 0){ text="D-Day"; cls="red"; }
      else if(diff > 0){
        text = `D-${diff}`;
        if(diff === 1) cls="red";
        else if(diff <= 3) cls="orange";
        else if(diff <= 5) cls="yellow";
        else cls="green";
      }else{
        text = `D+${Math.abs(diff)}`; cls="past";
      }
      return `<span class="dday ${cls}">${text}</span>`;
    }

    function renderPeriod(it){
      const s = it.startPeriod || it.startClass || "";
      const e = it.endPeriod   || it.endClass   || "";
      if(s && e){
        if(s === e) return `${s}êµì‹œ`;
        return `${s}~${e}êµì‹œ`;
      }else if(s){ return `${s}êµì‹œ`; }
      else if(e){ return `${e}êµì‹œ`; }
      return "";
    }

    function renderDateMeta(it){
      const d = toDate(it.due) || toDate(it.endDate) || toDate(it.startDate);
      if(!d) return "";
      const yo=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      const p = renderPeriod(it);
      return `ğŸ“… ${y}-${m}-${dd} (${yo})${p ? " "+p : ""}`;
    }
    const esc = (s)=> (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    /* ---------- ì‹¤ì‹œê°„ êµ¬ë… & ë Œë” ---------- */
    let unsub=[];
    function startListeners(){
      unsub.forEach(u=>u&&u()); unsub = [];
      ["exam","perf","home"].forEach(cat=>{
        const u = col(cat).orderBy("due","asc").onSnapshot(snap=>{
          const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
          renderList(cat, arr);
        });
        unsub.push(u);
      });
    }

    function renderList(cat, items){
      const ul = el.lists[cat];
      ul.innerHTML = "";
      const admin = isAdmin();

      for(const it of items){
        const li=document.createElement("li");
        li.className = "task" + (it.done?" done":"");
        li.innerHTML = `
          <label class="chk-wrap">
            <input type="checkbox" ${it.done?"checked":""} ${admin?"":"disabled"}
              data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>

          <div class="task__main">
            <div class="task__line">
              <div class="task__title">
                <b>${esc(it.subj||"")}</b>
                <span class="title-side">${renderDdayLabel(it.endDate, it.due, it.startDate)}</span>
              </div>
              <div class="task__desc">${esc(it.text||"")}</div>
              ${it.detail ? `<div class="task__detail">${esc(it.detail)}</div>` : ``}
              <div class="task__meta">${renderDateMeta(it)}</div>
            </div>
          </div>

          <div class="task__actions owner-only">
            <button class="btn btn-ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
            <button class="btn btn-ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
          </div>
        `;
        ul.appendChild(li);
      }

      ul.onclick = async (e)=>{
        const t=e.target, act=t.getAttribute("data-act");
        if(!act) return;

        if(!isAdmin()){
          if(act==="toggle" && t.tagName==="INPUT"){ t.checked=!t.checked; }
          alert("í¸ì§‘ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return;
        }

        const cat2=t.getAttribute("data-cat"), id=t.getAttribute("data-id");
        try{
          if(act==="toggle"){
            await col(cat2).doc(id).update({done:t.checked});
          }else if(act==="del"){
            if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) await col(cat2).doc(id).delete();
          }else if(act==="edit"){
            openEditPrompt(cat2,id);
          }
        }catch(err){ console.error(err); alert("ì‹¤íŒ¨: "+err.message); }
      };
    }

    /* ---------- ì¶”ê°€/ìˆ˜ì • ---------- */
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        const btn=$(".add",row), cat=row.dataset.cat;
        btn.onclick = async ()=>{
          if(!isAdmin()){ alert("ì¶”ê°€ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
          const subj=$(".subj",row).value.trim();
          const text=$(".text",row).value.trim();
          const due =$(".date",row).value || "";
          const sp  =$(".start",row).value || "";
          const ep  =$(".end",row).value   || "";
          const detail = $(".detail",row).value.trim();

          if(!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

          try{
            await col(cat).add({
              subj, text, due,
              startPeriod: sp, endPeriod: ep,
              detail: detail || "",
              done:false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            $(".subj",row).value=""; $(".text",row).value="";
            $(".date",row).value=""; $(".start",row).value="";
            $(".end",row).value="";  $(".detail",row).value="";
          }catch(e){ console.error(e); alert("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
        };
      });
    }

    async function openEditPrompt(cat,id){
      try{
        const ref=col(cat).doc(id), snap=await ref.get(); if(!snap.exists) return;
        const it=snap.data();
        const subj  = prompt("ê³¼ëª©", it.subj || "");   if(subj===null) return;
        const text  = prompt("ë‚´ìš©", it.text || "");   if(text===null) return;
        const due   = prompt("ë‚ ì§œ(YYYY-MM-DD)", (it.due||"").slice(0,10)); if(due===null) return;
        const sp    = prompt("ì‹œì‘ êµì‹œ(ìˆ«ì, ê³µë°±=ì—†ìŒ)", it.startPeriod||""); if(sp===null) return;
        const ep    = prompt("ë êµì‹œ(ìˆ«ì, ê³µë°±=ì—†ìŒ)", it.endPeriod||"");     if(ep===null) return;
        const detail= prompt("ìƒì„¸ ë‚´ìš©(ê³µë°± ê°€ëŠ¥)", it.detail||"");          if(detail===null) return;

        await ref.update({subj,text,due,startPeriod:sp,endPeriod:ep,detail});
      }catch(e){ console.error(e); alert("ìˆ˜ì • ì‹¤íŒ¨: "+e.message); }
    }

    /* ---------- ë¡œê·¸ì¸ ---------- */
    const provider=new firebase.auth.GoogleAuthProvider();
    $("#loginBtn").addEventListener("click", async ()=>{
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithPopup(provider);
      }catch(e){ alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message); }
    });
    $("#logoutBtn").addEventListener("click", ()=>auth.signOut());

    auth.onAuthStateChanged(user=>{
      currentUser=user;
      $("#loginBtn").style.display = user?"none":"";
      $("#logoutBtn").style.display= user?"":"none";
      document.body.classList.toggle("admin", isAdmin());
      bindAddRows();
      startListeners();
    });
  </script>
</body>
</html>
