<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <h1>📒 숙제 & 수행평가</h1>
    <div class="auth">
      <button id="adminBadge" class="chip" style="display:none">관리자</button>
      <button id="loginBtn"  class="btn">🔑 로그인</button>
      <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
    </div>
  </header>

  <main class="container">

    <!-- 시험 -->
    <section class="card">
      <div class="section-head">
        <h2>🧪 시험</h2>
      </div>

      <ul id="list_exam" class="task-list"></ul>

      <!-- 관리자만 보이게 됨 -->
      <div class="add-row" data-cat="exam" style="display:none">
        <input class="subj"  placeholder="과목" />
        <input class="text"  placeholder="내용" />
        <input class="date-start" type="date" />
        <input class="date-end"   type="date" />
        <select class="period-start">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="period-end">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
        <button class="add btn">+ 추가</button>
      </div>
    </section>

    <!-- 수행평가 -->
    <section class="card">
      <div class="section-head">
        <h2>📄 수행평가</h2>
      </div>

      <ul id="list_perf" class="task-list"></ul>

      <div class="add-row" data-cat="perf" style="display:none">
        <input class="subj"  placeholder="과목" />
        <input class="text"  placeholder="내용" />
        <input class="date-start" type="date" />
        <select class="period-start">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="period-end">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
        <button class="add btn">+ 추가</button>
      </div>
    </section>

    <!-- 숙제 -->
    <section class="card">
      <div class="section-head">
        <h2>📌 숙제</h2>
      </div>

      <ul id="list_home" class="task-list"></ul>

      <div class="add-row" data-cat="home" style="display:none">
        <input class="subj"  placeholder="과목" />
        <input class="text"  placeholder="내용" />
        <input class="date-start" type="date" />
        <select class="period-start">
          <option value="">교시(선택)</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <textarea class="detail" placeholder="상세 내용 (선택)"></textarea>
        <button class="add btn">+ 추가</button>
      </div>
    </section>

  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  /***** 0) Firebase 초기화 (반드시 네 프로젝트 값으로 교체) *****/
  const firebaseConfig = {
    apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
    authDomain: "my-memo-site.firebaseapp.com",
    projectId: "my-memo-site",
    storageBucket: "my-memo-site.firebasestorage.app",
    messagingSenderId: "196036694705",
    appId: "1:196036694705:web:8988d12919420130464890"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  /***** 1) UID 설정 *****/
  const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";      // 공개로 보여줄 사용자 (로그아웃/비로그인 포함)
  const ADMIN_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";           // 쓰기/수정/삭제 권한

  /***** 2) 유틸 *****/
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const el = {
    loginBtn:  $("#loginBtn"),
    logoutBtn: $("#logoutBtn"),
    adminBadge: $("#adminBadge"),
    lists: { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") }
  };

  let currentUser = null;
  let isAdmin     = false;
  let unsubscribers = [];

  // Firestore 경로 (읽기는 공개/쓰기·수정은 관리자)
  const col = (cat) => {
    const uid = currentUser?.uid || OWNER_UID;
    return db.collection("users").doc(uid)
             .collection("tasks").doc(cat).collection("items");
  };

  // D-day 뱃지
  function ddayBadge(dateStr){
    if(!dateStr) return "";
    const today = new Date(); today.setHours(0,0,0,0);
    const due   = new Date(dateStr); due.setHours(0,0,0,0);
    const diff = Math.round((due - today) / (1000*60*60*24));
    let label = "";
    let cls   = "";

    if(diff > 0){       // 미래
      label = `D-${diff}`;
      if(diff <= 1) cls = "d-red";
      else if(diff <= 3) cls = "d-orange";
      else if(diff <= 5) cls = "d-yellow";
      else cls = "d-green";
    }else if(diff === 0){
      label = "D-DAY";
      cls   = "d-red";
    }else{              // 과거
      label = `A+${Math.abs(diff)}`;
      cls   = "d-past";
    }
    return `<span class="dday ${cls}">${label}</span>`;
  }

  // 렌더
  function renderList(cat, items){
    const ul = el.lists[cat];
    ul.innerHTML = "";
    items.forEach(it=>{
      const li = document.createElement("li");
      li.className = "task";

      const dateLine = it.startDate
        ? (it.endDate ? `${it.startDate} ~ ${it.endDate}` : it.startDate)
        : (it.due || "");

      const periodLine = (it.startPeriod || it.endPeriod)
        ? `${it.startPeriod || ""}${it.endPeriod ? " ~ " + it.endPeriod : ""}`
        : "";

      li.innerHTML = `
        <div class="task__left">
          <label class="chk-wrap">
            <input type="checkbox" ${it.done ? "checked": ""} data-act="toggle" data-cat="${cat}" data-id="${it.id}">
            <span></span>
          </label>
          <div class="task__main">
            <div class="task__top">
              <b class="task__subj">${escapeHtml(it.subj || "")}</b>
              <span class="sep"></span>
              <span class="task__text">${escapeHtml(it.text || "")}</span>
              ${ddayBadge(it.due || it.startDate || it.endDate)}
            </div>
            <div class="task__meta">
              ${dateLine ? `📅 ${dateLine}` : ""} ${periodLine ? ` ・ ${periodLine}` : ""}
            </div>
            ${it.detail ? `<div class="task__detail">${escapeHtml(it.detail)}</div>` : ""}
          </div>
        </div>
        <div class="task__actions" style="display:${isAdmin ? "" : "none"}">
          <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">수정</button>
          <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">삭제</button>
        </div>
      `;
      ul.appendChild(li);
    });

    // 액션
    ul.onclick = async (e) => {
      const act = e.target.getAttribute("data-act");
      if(!act) return;

      const cat2 = e.target.getAttribute("data-cat");
      const id   = e.target.getAttribute("data-id");

      if(act === "toggle"){
        if(!isAdmin){ alert("완료 체크는 관리자만 가능합니다."); e.target.checked = !e.target.checked; return; }
        await col(cat2).doc(id).update({ done: e.target.checked });
      }
      if(act === "del"){
        if(!isAdmin){ alert("삭제는 관리자만 가능합니다."); return; }
        if(confirm("정말 삭제할까요?")) await col(cat2).doc(id).delete();
      }
      if(act === "edit"){
        if(!isAdmin){ alert("수정은 관리자만 가능합니다."); return; }
        openEditor(cat2, id);
      }
    }
  }

  // 수정 다이얼로그(간단)
  async function openEditor(cat, id){
    const snap = await col(cat).doc(id).get();
    if(!snap.exists) return alert("항목을 찾을 수 없습니다.");
    const it = { id: snap.id, ...snap.data() };

    const subj   = prompt("과목", it.subj || "");
    if(subj === null) return;
    const text   = prompt("내용", it.text || "");
    if(text === null) return;
    const detail = prompt("상세 내용(선택)", it.detail || "");
    if(detail === null) return;

    await col(cat).doc(id).update({ subj, text, detail });
  }

  function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  /***** 3) 실시간 구독 *****/
  function startListeners(){
    unsubscribers.forEach(u=>u&&u());
    unsubscribers = [];

    ["exam","perf","home"].forEach(cat=>{
      const u = col(cat).orderBy("due","asc").onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>arr.push({ id: d.id, ...d.data() }));
        renderList(cat, arr);
      }, err=>{
        console.error("listener error:", err);
        alert("목록을 불러오지 못했습니다: " + err.message);
      });
      unsubscribers.push(u);
    });

    restoreDraft(); // 폼 임시저장 복원
  }

  /***** 4) 폼 임시저장 *****/
  const DRAFT_KEY = "memo:addrow-draft-v1";
  function gatherDraft(){
    const data = {};
    $$(".add-row").forEach(row=>{
      const cat = row.dataset.cat;
      data[cat] = {
        subj: $(".subj", row)?.value || "",
        text: $(".text", row)?.value || "",
        detail: $(".detail", row)?.value || "",
        d1: $(".date-start", row)?.value || "",
        d2: $(".date-end", row)?.value || "",
        p1: $(".period-start", row)?.value || "",
        p2: $(".period-end", row)?.value || "",
      };
    });
    return data;
  }
  function restoreDraft(){
    try{
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      $$(".add-row").forEach(row=>{
        const d = data[row.dataset.cat] || {};
        if($(".subj", row))  $(".subj", row).value  = d.subj || "";
        if($(".text", row))  $(".text", row).value  = d.text || "";
        if($(".detail", row))$(".detail", row).value= d.detail || "";
        if($(".date-start", row)) $(".date-start", row).value = d.d1 || "";
        if($(".date-end", row))   $(".date-end", row).value   = d.d2 || "";
        if($(".period-start", row)) $(".period-start", row).value = d.p1 || "";
        if($(".period-end", row))   $(".period-end", row).value   = d.p2 || "";
      });
    }catch{}
  }
  function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft())); }
  document.addEventListener("input", e=>{
    if(e.target.closest(".add-row")) saveDraft();
  });

  /***** 5) 추가 버튼(핸들러) — 행 기준으로 안전하게 *****/
  function bindAddRows(){
    $$(".add-row .add").forEach(btn=>{
      btn.onclick = async (e)=>{
        const row = e.currentTarget.closest(".add-row");
        const cat = row.dataset.cat;

        const subj   = $(".subj", row)?.value.trim()   || "";
        const text   = $(".text", row)?.value.trim()   || "";
        const detail = $(".detail", row)?.value.trim() || "";
        const d1     = $(".date-start", row)?.value    || "";
        const d2     = $(".date-end", row)?.value      || "";
        const p1     = $(".period-start", row)?.value  || "";
        const p2     = $(".period-end", row)?.value    || "";

        if(!isAdmin){ alert("추가는 관리자만 가능합니다."); return; }
        if(!subj || !text){ alert("과목과 내용을 입력해 주세요."); return; }

        const payload = {
          subj, text, detail,
          startDate: d1 || "", endDate: d2 || "",
          startPeriod: p1 || "", endPeriod: p2 || "",
          due: d1 || d2 || "",
          done: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try{
          await col(cat).add(payload);

          // 입력 초기화 + 임시저장 갱신
          [".subj",".text",".detail",".date-start",".date-end"].forEach(s=>{
            const el = $(s, row); if(el) el.value = "";
          });
          if($(".period-start", row)) $(".period-start", row).value = "";
          if($(".period-end", row))   $(".period-end", row).value   = "";
          saveDraft();
        }catch(err){
          console.error(err);
          alert("저장 실패: " + (err.message || err));
        }
      };
    });
  }

  /***** 6) 로그인/권한 표시 *****/
  const provider = new firebase.auth.GoogleAuthProvider();

  el.loginBtn.onclick = async ()=>{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithPopup(provider);
  };
  el.logoutBtn.onclick = ()=> auth.signOut();

  auth.onAuthStateChanged(user=>{
    currentUser = user;
    isAdmin     = !!(user && user.uid === ADMIN_UID);
    el.loginBtn.style.display  = user ? "none" : "";
    el.logoutBtn.style.display = user ? "" : "none";
    el.adminBadge.style.display = isAdmin ? "" : "none";

    // 관리자만 추가 폼 노출
    $$(".add-row").forEach(r => r.style.display = isAdmin ? "" : "none");

    bindAddRows();
    startListeners();
  });

  </script>
</body>
</html>
