<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>

<style>
:root{
  --bg:#0f1620;
  --card:#121b27;
  --muted:#8aa0b2;
  --text:#dbe8f5;
  --accent:#86b7ff;
  --line:#1f2a3a;
  --btn:#7da2ff;
  --btnText:#101418;

  --dd-red:#f25f5c;
  --dd-orange:#f7a540;
  --dd-yellow:#ffd166;
  --dd-green:#57cc99;

  --notice-red:#ffe2e5;
  --notice-yellow:#fff3cd;
  --notice-green:#d1f3e6;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR","Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
}
a{color:var(--accent); text-decoration:none}

.container{
  max-width:1200px; margin:24px auto; padding:0 16px;
}

header{
  display:flex; align-items:center; gap:12px;
  margin-bottom:24px;
}
h1{
  margin:0; font-size:28px; font-weight:800;
}
.header-actions{margin-left:auto; display:flex; gap:10px;}
.btn{
  background:var(--btn); color:#fff; border:none; border-radius:10px;
  padding:10px 14px; font-weight:700; cursor:pointer;
}
.btn:disabled{opacity:.6; cursor:default}
.btn-ghost{
  background:#1a2331; color:#bcd1e3; border:1px solid var(--line);
  border-radius:10px; padding:8px 12px; cursor:pointer;
}
.section{margin-bottom:26px}
.section-head{
  font-size:20px; font-weight:800; display:flex; align-items:center; gap:8px;
  margin:0 0 12px 0;
}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:18px;
}

.notice-wrap{margin-bottom:26px}
.notice-header{
  display:flex; align-items:center; gap:10px; margin-bottom:12px;
}
.switch{
  margin-left:auto; display:inline-flex; align-items:center; gap:8px;
}
.switch input{display:none}
.switch label{
  width:56px; height:30px; background:#1f2d3a; border-radius:30px;
  position:relative; cursor:pointer;
}
.switch label::after{
  content:""; width:24px; height:24px; background:#fff; border-radius:50%;
  position:absolute; left:3px; top:3px; transition:.2s;
}
.switch input:checked + label{
  background:#63c27d;
}
.switch input:checked + label::after{
  transform:translateX(26px);
}

.notice-form{
  display:grid; grid-template-columns: 1fr 180px 120px; gap:10px; margin-bottom:12px;
}
.notice-form .wide{grid-column:1/-1}
.select, .input, .textarea{
  width:100%; background:#0f1520; border:1px solid var(--line);
  border-radius:12px; color:var(--text); padding:12px;
}
.textarea{min-height:88px; resize:vertical}

.notice-list{display:flex; flex-direction:column; gap:10px}

/* ê³µì§€ ì¹´ë“œ ë°°ê²½ìƒ‰(ë°ì€ í†¤) */
.notice-card{
  border-radius:12px; padding:16px;
  border:1px solid var(--line);
}
.notice-red{background:var(--notice-red); color:#3b181a}
.notice-yellow{background:var(--notice-yellow); color:#3a2f10}
.notice-green{background:var(--notice-green); color:#0e3c2b}
.notice-title{font-weight:800; margin:0 0 8px 0; font-size:18px}
.notice-body{white-space:normal; line-height:1.6}

.notice-actions{margin-top:10px; display:flex; gap:8px}

.group{margin-top:26px}
.list{display:flex; flex-direction:column; gap:14px}

.item{
  padding:18px; border-radius:14px; border:1px solid var(--line);
  background:var(--card);
}
.item-head{
  display:flex; align-items:center; gap:10px; margin-bottom:6px;
}
.item-title{
  margin:0; font-size:20px; font-weight:800;
}
.badge{
  display:inline-flex; align-items:center; justify-content:center;
  border-radius:999px; padding:2px 8px; font-weight:800; font-size:13px;
}
.dd-red{background:var(--dd-red); color:#151414}
.dd-orange{background:var(--dd-orange); color:#151414}
.dd-yellow{background:var(--dd-yellow); color:#151414}
.dd-green{background:var(--dd-green); color:#07311f}
.dd-gray{background:#556070; color:#fff}

.item-text{margin:2px 0 10px 0; color:#cfe3f3}
.item-meta{color:#9db2c2; display:flex; align-items:center; gap:8px}
.item-actions{margin-left:auto; display:flex; gap:8px}

/* ì…ë ¥ì¤„(ê´€ë¦¬ìë§Œ ë³´ì„) - 2ì¤„ êµ¬ì¡° */
.add-row{
  margin-top:10px; padding:12px; border:1px dashed var(--line); border-radius:12px;
}
.add-grid{
  display:grid;
  grid-template-columns: 180px 1fr 180px 180px 140px 140px 120px;
  gap:10px;
}
.add-grid .textarea{grid-column:1/-2} /* ë‹¤ìŒì¤„ë¡œ í¬ê²Œ */
.add-grid .btn{grid-column:-2/-1}

/* ì‘ì€ ë±ƒì§€ ë‹¬ë ¥ ì•„ì´ì½˜ ëŠë‚Œ */
.meta-icon{font-size:18px}

/* ====== ëª¨ë‹¬(íŒì—…) ====== */
.modal{
  position:fixed; inset:0; background:rgba(4,10,18,.65);
  display:none; align-items:center; justify-content:center; z-index:99;
}
.modal.open{display:flex}
.dialog{
  width:min(720px, calc(100% - 40px)); border-radius:16px;
  background:#0e1520; border:1px solid var(--line);
}
.dialog-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px; border-bottom:1px solid var(--line);
}
.dialog-title{font-size:18px; font-weight:800; margin:0}
.dialog-body{padding:16px; display:grid; gap:10px}
.grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.dialog-actions{
  padding:12px 16px; display:flex; gap:8px; justify-content:flex-end;
  border-top:1px solid var(--line);
}
.label{font-size:13px; color:#9fb2c0}
.input, .select, .textarea{outline:none}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
      <div class="header-actions">
        <button id="loginBtn" class="btn">ğŸ”‘ ë¡œê·¸ì¸</button>
        <button id="logoutBtn" class="btn-ghost" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <!-- ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ -->
    <section class="notice-wrap card">
      <div class="notice-header">
        <h2 class="section-head">ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</h2>
        <div class="switch" title="ê´€ë¦¬ìë§Œ ë³€ê²½">
          <input id="toggleNotices" type="checkbox">
          <label for="toggleNotices"></label>
        </div>
      </div>

      <!-- ì¶”ê°€ í¼(ê´€ë¦¬ì ì „ìš©) -->
      <div id="noticeForm" class="notice-form" style="display:none">
        <input id="nfTitle" class="input" placeholder="ì œëª©" />
        <select id="nfType" class="select">
          <option value="notice">ê³µì§€</option>
          <option value="guide">ì•ˆë‚´</option>
          <option value="alert">ì•Œë¦¼</option>
        </select>
        <button id="nfAdd" class="btn">+ ì¶”ê°€</button>
        <textarea id="nfBody" class="textarea wide" placeholder="ìƒì„¸ ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
      </div>

      <div id="noticeList" class="notice-list"></div>
    </section>

    <!-- ì‹œí—˜ -->
    <section class="section">
      <h2 class="section-head">ğŸ§ª ì‹œí—˜</h2>
      <div class="list" id="list_exam"></div>

      <!-- ì¶”ê°€ (ê´€ë¦¬ì) -->
      <div class="add-row" id="add_exam" style="display:none">
        <div class="add-grid">
          <input class="input subj" placeholder="ê³¼ëª©" />
          <input class="input text" placeholder="ë‚´ìš©" />
          <input class="input start" type="date" />
          <input class="input end" type="date" />
          <select class="select startp">
            <option value="0">êµì‹œ ì—†ìŒ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option><option>8êµì‹œ</option>
          </select>
          <select class="select endp">
            <option value="0">êµì‹œ ì—†ìŒ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option><option>8êµì‹œ</option>
          </select>
          <textarea class="textarea detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ) - ì¤„ë°”ê¿ˆ ê°€ëŠ¥"></textarea>
          <button class="btn add">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section class="section">
      <h2 class="section-head">ğŸ§ª ìˆ˜í–‰í‰ê°€</h2>
      <div class="list" id="list_perf"></div>

      <div class="add-row" id="add_perf" style="display:none">
        <div class="add-grid">
          <input class="input subj" placeholder="ê³¼ëª©" />
          <input class="input text" placeholder="ë‚´ìš©" />
          <input class="input start" type="date" />
          <input class="input end" type="date" />
          <select class="select startp">
            <option value="0">êµì‹œ ì—†ìŒ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option><option>8êµì‹œ</option>
          </select>
          <select class="select endp">
            <option value="0">êµì‹œ ì—†ìŒ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option><option>8êµì‹œ</option>
          </select>
          <textarea class="textarea detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ) - ì¤„ë°”ê¿ˆ ê°€ëŠ¥"></textarea>
          <button class="btn add">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section class="section">
      <h2 class="section-head">ğŸ“Œ ìˆ™ì œ</h2>
      <div class="list" id="list_home"></div>

      <div class="add-row" id="add_home" style="display:none">
        <div class="add-grid">
          <input class="input subj" placeholder="ê³¼ëª©" />
          <input class="input text" placeholder="ë‚´ìš©" />
          <input class="input start" type="date" />
          <input class="input end" type="date" />
          <select class="select startp">
            <option value="0">êµì‹œ ì—†ìŒ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option><option>8êµì‹œ</option>
          </select>
          <select class="select endp">
            <option value="0">êµì‹œ ì—†ìŒ</option>
            <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
            <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
            <option>7êµì‹œ</option><option>8êµì‹œ</option>
          </select>
          <textarea class="textarea detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ) - ì¤„ë°”ê¿ˆ ê°€ëŠ¥"></textarea>
          <button class="btn add">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== ëª¨ë‹¬(í•­ëª© ìˆ˜ì •) ===== -->
  <div id="itemModal" class="modal">
    <div class="dialog">
      <div class="dialog-head">
        <h3 class="dialog-title">í•­ëª© ìˆ˜ì •</h3>
        <button class="btn-ghost" onclick="closeItemModal()">ë‹«ê¸°</button>
      </div>
      <div class="dialog-body">
        <div class="grid-2">
          <div>
            <div class="label">ê³¼ëª©</div>
            <input id="imSubj" class="input" />
          </div>
          <div>
            <div class="label">ë‚´ìš©</div>
            <input id="imText" class="input" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <div class="label">ì‹œì‘ì¼</div>
            <input id="imStart" type="date" class="input" />
          </div>
          <div>
            <div class="label">ì¢…ë£Œì¼</div>
            <input id="imEnd" type="date" class="input" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <div class="label">ì‹œì‘ êµì‹œ</div>
            <select id="imStartP" class="select">
              <option value="0">êµì‹œ ì—†ìŒ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>8êµì‹œ</option>
            </select>
          </div>
          <div>
            <div class="label">ì¢…ë£Œ êµì‹œ</div>
            <select id="imEndP" class="select">
              <option value="0">êµì‹œ ì—†ìŒ</option>
              <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
              <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
              <option>7êµì‹œ</option><option>8êµì‹œ</option>
            </select>
          </div>
        </div>
        <div>
          <div class="label">ìƒì„¸ ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)</div>
          <textarea id="imDetail" class="textarea" rows="6"></textarea>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn-ghost" onclick="closeItemModal()">ì·¨ì†Œ</button>
        <button class="btn" onclick="saveItemModal()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ===== ëª¨ë‹¬(ì „ë‹¬ ì‚¬í•­ ìˆ˜ì •) ===== -->
  <div id="noticeModal" class="modal">
    <div class="dialog">
      <div class="dialog-head">
        <h3 class="dialog-title">ì „ë‹¬ ì‚¬í•­ ìˆ˜ì •</h3>
        <button class="btn-ghost" onclick="closeNoticeModal()">ë‹«ê¸°</button>
      </div>
      <div class="dialog-body">
        <div class="grid-2">
          <div>
            <div class="label">ì œëª©</div>
            <input id="nmTitle" class="input" />
          </div>
          <div>
            <div class="label">ì¢…ë¥˜</div>
            <select id="nmType" class="select">
              <option value="notice">ê³µì§€</option>
              <option value="guide">ì•ˆë‚´</option>
              <option value="alert">ì•Œë¦¼</option>
            </select>
          </div>
        </div>
        <div>
          <div class="label">ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)</div>
          <textarea id="nmBody" class="textarea" rows="8"></textarea>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn-ghost" onclick="closeNoticeModal()">ì·¨ì†Œ</button>
        <button class="btn" onclick="saveNoticeModal()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ====== 1) Firebase ì„¤ì • (ë°˜ë“œì‹œ ë³¸ì¸ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´) ======
  const firebaseConfig = {
    apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
    authDomain: "my-memo-site.firebaseapp.com",
    projectId: "my-memo-site",
    storageBucket: "my-memo-site.firebasestorage.app",
    messagingSenderId: "196036694705",
    appId: "1:196036694705:web:8988d12919420130464890"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ====== 2) ê´€ë¦¬ì UID / ê³µê°œì†ŒìŠ¤ UID (ì½ê¸° ì „ìš© í‘œì‹œìš©) ======
  const ADMIN_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";     // ê´€ë¦¬ì Google ë¡œê·¸ì¸ UID
  const OWNER_UID = ADMIN_UID;                 // ê³µê°œë¡œ ë³´ì—¬ì¤„ ì†ŒìŠ¤ UID (ê´€ë¦¬ í•­ëª©ì˜ ì£¼ì¸)

  // ====== 3) ìƒíƒœ ë° DOM ì°¸ì¡° ======
  let currentUser = null;
  let unsubTasks = []; // ì¹´í…Œê³ ë¦¬ë³„ ë¦¬ìŠ¤ë„ˆ í•´ì œ
  let unsubNotices = null;
  let unsubSettings = null;

  const $  = (q, r=document)=>r.querySelector(q);
  const $$ = (q, r=document)=>Array.from(r.querySelectorAll(q));

  const el = {
    loginBtn:   $("#loginBtn"),
    logoutBtn:  $("#logoutBtn"),

    // ê³µì§€
    toggleNotices: $("#toggleNotices"),
    noticeForm: $("#noticeForm"),
    nfTitle:  $("#nfTitle"),
    nfType:   $("#nfType"),
    nfBody:   $("#nfBody"),
    nfAdd:    $("#nfAdd"),
    noticeList: $("#noticeList"),

    // ë¦¬ìŠ¤íŠ¸
    lists: {
      exam: $("#list_exam"),
      perf: $("#list_perf"),
      home: $("#list_home"),
    },
    adds: {
      exam: $("#add_exam"),
      perf: $("#add_perf"),
      home: $("#add_home"),
    }
  };

  // ëª¨ë‹¬ìš© ì „ì—­
  let editTarget = { cat:"", id:"", data:null };  // í•­ëª©
  let editNotice = { id:"", data:null };

  // ====== 4) Util ======
  const esc = s=>(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  const escWithBr = s => esc(s).replaceAll("\n","<br>");

  const isAdmin = ()=> currentUser && currentUser.uid === ADMIN_UID;
  const readUID = ()=> OWNER_UID; // í•­ìƒ ê³µê°œ ì†ŒìŠ¤ UIDì—ì„œ ì½ìŒ

  // D-day ê³„ì‚° (ì‹œì‘ì¼ ê¸°ì¤€ / between start-end â†’ "D-day")
  function ddBadge(start,end){
    if(!start) return "";
    const today = new Date(); today.setHours(0,0,0,0);
    const s = new Date(start); s.setHours(0,0,0,0);
    let e = end ? new Date(end) : null;
    if(e) e.setHours(0,0,0,0);

    // ê¸°ê°„ ë‚´ë©´ D-day
    if( e && today.getTime() >= s.getTime() && today.getTime() <= e.getTime()){
      return `<span class="badge dd-red">D-day</span>`;
    }

    // ê¸°ê°„ ì „/í›„
    const diff = Math.floor((s.getTime() - today.getTime())/86400000);
    let txt = "", cls = "dd-green";
    if(diff > 0){
      txt = `D-${diff}`;
      if(diff <= 1) cls = "dd-red";
      else if(diff <= 3) cls = "dd-orange";
      else if(diff <= 5) cls = "dd-yellow";
      else cls = "dd-green";
    }else if(diff === 0){
      txt = "D-day"; cls = "dd-red";
    }else{
      // ì§€ë‚œ ì¼ì •ì€ íšŒìƒ‰
      txt = `D+${Math.abs(diff)}`; cls = "dd-gray";
    }
    return `<span class="badge ${cls}">${txt}</span>`;
  }

  function periodLabel(sp,ep){
    sp = sp||"0"; ep = ep||"0";
    if(sp==="0" && ep==="0") return "";
    if(sp==="0" && ep!=="0") return `${ep} (ì¢…ì¼ or ë§ˆê°)`;
    if(sp!=="0" && ep==="0") return `${sp}`;
    if(sp===ep) return `${sp}`;
    // ex: 5~6êµì‹œ
    return `${sp.replace("êµì‹œ","")}~${ep}`;
  }

  // ====== 5) ë Œë”ë§ ======
  function renderItem(cat, id, it){
    const ul = el.lists[cat];

    const badge = ddBadge(it.start, it.end);
    const period = periodLabel(it.startp, it.endp);
    const dateText = it.end && it.end!==it.start
      ? `${it.start} ~ ${it.end}`
      : `${it.start || it.end || ""}`;

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="item-head">
        <h3 class="item-title">${esc(it.subj||"")}</h3>
        ${badge}
        <div class="item-actions" style="${isAdmin()?"":"display:none"}">
          <button class="btn-ghost" data-act="edit">ìˆ˜ì •</button>
          <button class="btn-ghost" data-act="del">ì‚­ì œ</button>
        </div>
      </div>
      <div class="item-text">${esc(it.text||"")}</div>
      <div class="item-meta"><span class="meta-icon">ğŸ“…</span>${esc(dateText)}
        ${period ? `<span style="margin-left:8px">${esc(period)}</span>`:""}
      </div>
      ${it.detail? `<div class="item-meta" style="margin-top:8px">${escWithBr(it.detail||"")}</div>`:``}
    `;

    // ë²„íŠ¼
    const actions = div.querySelector(".item-actions");
    if(actions){
      actions.querySelector('[data-act="edit"]').onclick = ()=> openItemModal(cat,id,it);
      actions.querySelector('[data-act="del"]').onclick = ()=> delItem(cat,id);
    }
    ul.appendChild(div);
  }

  function renderList(cat, arr){
    const ul = el.lists[cat];
    ul.innerHTML = "";
    arr.forEach(d=> renderItem(cat, d.id, d) );
  }

  function renderNoticeCard(doc){
    const it = doc.data();
    const id = doc.id;

    let cls = "notice-green";
    if(it.type==="notice") cls = "notice-red";
    else if(it.type==="guide") cls = "notice-yellow";

    const wrap = document.createElement("div");
    wrap.className = `notice-card ${cls}`;
    wrap.innerHTML = `
      <div class="notice-title">[${it.type==="notice"?"ê³µì§€":it.type==="guide"?"ì•ˆë‚´":"ì•Œë¦¼"}] ${esc(it.title||"")}</div>
      <div class="notice-body">${escWithBr(it.body||"")}</div>
      <div class="notice-actions" style="${isAdmin()?"":"display:none"}">
        <button class="btn-ghost" data-act="edit">ìˆ˜ì •</button>
        <button class="btn-ghost" data-act="del">ì‚­ì œ</button>
      </div>
    `;
    const act = wrap.querySelector(".notice-actions");
    if(act){
      act.querySelector('[data-act="edit"]').onclick = ()=> openNoticeModal(id, it);
      act.querySelector('[data-act="del"]').onclick = ()=> delNotice(id);
    }
    el.noticeList.appendChild(wrap);
  }

  // ====== 6) Firestore ë¦¬ìŠ¤ë„ˆ ======
  function col(cat){
    // í•­ìƒ ê³µê°œ ì†ŒìŠ¤(OWNER_UID) ê¸°ì¤€ìœ¼ë¡œ ì½ê¸°
    const uid = readUID();
    return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
  }

  function startTaskListeners(){
    unsubTasks.forEach(u=>u&&u());
    unsubTasks = [];
    ["exam","perf","home"].forEach(cat=>{
      const u = col(cat).orderBy("start","asc").onSnapshot(snap=>{
        const arr = [];
        snap.forEach(doc=> arr.push({id:doc.id, ...doc.data()}) );
        renderList(cat, arr);
      }, e=>console.error(e));
      unsubTasks.push(u);
    });
  }

  function startNoticeListener(){
    if(unsubNotices) unsubNotices();
    const ref = db.collection("notices").orderBy("createdAt","desc");
    unsubNotices = ref.onSnapshot(snap=>{
      el.noticeList.innerHTML = "";
      snap.forEach(doc=> renderNoticeCard(doc) );
    }, e=>console.error(e));
  }

  function startSettingsListener(){
    if(unsubSettings) unsubSettings();
    const sref = db.collection("settings").doc("general");
    unsubSettings = sref.onSnapshot(doc=>{
      const d = doc.data() || {};
      const on = !!d.noticesOn;
      el.toggleNotices.checked = on;
      // í‘œì‹œ ì œì–´ëŠ” ë‹¨ìˆœíˆ ìˆ¨ê¹€/ë…¸ì¶œ (ë°ì´í„°ëŠ” í•­ìƒ ë Œë”ë¨)
      el.noticeList.style.display = on ? "" : "none";
    });
  }

  // ====== 7) CRUD ======
  async function addRow(cat, row){
    if(!isAdmin()) return alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.");
    const subj = $(".subj",row).value.trim();
    const text = $(".text",row).value.trim();
    const start= $(".start",row).value || "";
    const end  = $(".end",row).value || "";
    const startp = $(".startp",row).value||"0";
    const endp   = $(".endp",row).value||"0";
    const detail = $(".detail",row).value||"";

    if(!subj || !text){ return alert("ê³¼ëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); }

    await col(cat).add({
      subj, text, start, end, startp, endp, detail,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // ì´ˆê¸°í™”
    $(".subj",row).value=""; $(".text",row).value="";
    $(".start",row).value=""; $(".end",row).value="";
    $(".startp",row).value="0"; $(".endp",row).value="0";
    $(".detail",row).value="";
  }

  async function delItem(cat,id){
    if(!isAdmin()) return;
    if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    await col(cat).doc(id).delete();
  }

  // ====== 8) ê³µì§€ CRUD ======
  async function addNotice(){
    if(!isAdmin()) return alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.");
    const title = el.nfTitle.value.trim();
    const type  = el.nfType.value;
    const body  = el.nfBody.value.trim();
    if(!title || !body) return alert("ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    await db.collection("notices").add({
      title, type, body,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    el.nfTitle.value=""; el.nfBody.value="";
  }
  async function delNotice(id){
    if(!isAdmin()) return;
    if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    await db.collection("notices").doc(id).delete();
  }

  // ====== 9) ê³µì§€ í‘œì‹œ ON/OFF ======
  el.toggleNotices.addEventListener("change", async (e)=>{
    if(!isAdmin()){
      // ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥ â†’ UI ë˜ëŒë¦¬ê¸°
      startSettingsListener(); // ìŠ¤ëƒ…ìƒ·ì´ ë‹¤ì‹œ ë®ì–´ì”€
      return alert("ê´€ë¦¬ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.");
    }
    const on = e.target.checked;
    await db.collection("settings").doc("general").set({noticesOn:on},{merge:true});
  });

  // ====== 10) ë¡œê·¸ì¸ / ìƒíƒœ ======
  el.loginBtn.onclick = async ()=>{
    try{
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    }catch(e){
      console.error(e); alert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
    }
  };
  el.logoutBtn.onclick = ()=> auth.signOut();

  auth.onAuthStateChanged(u=>{
    currentUser = u;
    el.loginBtn.style.display = u ? "none":"";
    el.logoutBtn.style.display= u ? "":"none";

    // ê´€ë¦¬ìë§Œ ì…ë ¥ì¤„/í¼ í‘œì‹œ
    const show = isAdmin();
    ["exam","perf","home"].forEach(cat=>{
      el.adds[cat].style.display = show ? "" : "none";
    });
    el.noticeForm.style.display = show ? "" : "none";

    // ë¦¬ìŠ¤ë„ˆ
    startTaskListeners();
    startNoticeListener();
    startSettingsListener();
  });

  // ====== 11) ì¶”ê°€ ë²„íŠ¼ ë°”ì¸ë”© ======
  // (ê° add-row ì˜ +ì¶”ê°€ ë²„íŠ¼)
  $$("#add_exam .add")[0].onclick = ()=> addRow("exam", el.adds.exam);
  $$("#add_perf .add")[0].onclick = ()=> addRow("perf", el.adds.perf);
  $$("#add_home .add")[0].onclick = ()=> addRow("home", el.adds.home);
  el.nfAdd.onclick = addNotice;

  // ====== 12) ëª¨ë‹¬ (í•­ëª©) ======
  const itemModal = $("#itemModal");
  const im = {
    subj: $("#imSubj"),
    text: $("#imText"),
    start: $("#imStart"),
    end: $("#imEnd"),
    startp: $("#imStartP"),
    endp: $("#imEndP"),
    detail: $("#imDetail"),
  };

  function openItemModal(cat, id, data){
    if(!isAdmin()) return;
    editTarget = { cat, id, data };
    im.subj.value  = data.subj||"";
    im.text.value  = data.text||"";
    im.start.value = data.start||"";
    im.end.value   = data.end||"";
    im.startp.value= data.startp||"0";
    im.endp.value  = data.endp||"0";
    im.detail.value= data.detail||"";
    itemModal.classList.add("open");
  }
  function closeItemModal(){ itemModal.classList.remove("open"); }

  async function saveItemModal(){
    if(!isAdmin()) return;
    const {cat,id} = editTarget;
    const up = {
      subj: im.subj.value.trim(),
      text: im.text.value.trim(),
      start: im.start.value || "",
      end:   im.end.value   || "",
      startp: im.startp.value||"0",
      endp:   im.endp.value||"0",
      detail: im.detail.value||""
    };
    await col(cat).doc(id).set(up,{merge:true});
    closeItemModal();
  }

  // ====== 13) ëª¨ë‹¬ (ê³µì§€) ======
  const noticeModal = $("#noticeModal");
  const nm = {
    title: $("#nmTitle"),
    type:  $("#nmType"),
    body:  $("#nmBody"),
  };
  function openNoticeModal(id, data){
    if(!isAdmin()) return;
    editNotice = {id, data};
    nm.title.value = data.title||"";
    nm.type.value  = data.type||"notice";
    nm.body.value  = data.body||"";
    noticeModal.classList.add("open");
  }
  function closeNoticeModal(){ noticeModal.classList.remove("open"); }
  async function saveNoticeModal(){
    if(!isAdmin()) return;
    const up = {
      title: nm.title.value.trim(),
      type:  nm.type.value,
      body:  nm.body.value
    };
    await db.collection("notices").doc(editNotice.id).set(up,{merge:true});
    closeNoticeModal();
  }
  </script>
</body>
</html>

