<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>숙제 & 수행평가</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<header class="topbar">
  <div class="brand">📒 숙제 & 수행평가</div>
  <div class="actions">
    <button id="adminBadge" class="chip" style="display:none">관리자</button>
    <button id="loginBtn"  class="btn">🔑 로그인</button>
    <button id="logoutBtn" class="btn" style="display:none">📜 로그아웃</button>
  </div>
</header>

<main class="container">

  <!-- 중요 전달 사항 -->
  <section class="card notice">
    <div class="card-head">
      <div class="title">📢 중요 전달 사항</div>
      <label class="switch">
        <input type="checkbox" id="noticeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <!-- 관리자만 보이는 입력 폼 -->
    <div id="noticeFormWrap" class="notice-form">
      <input id="noticeTitle" class="input" placeholder="제목" />
      <select id="noticeLevel" class="select">
        <option value="info">전달 사항</option>
        <option value="warn">주의</option>
        <option value="danger">중요</option>
      </select>
      <button id="noticeAddBtn" class="btn primary">+ 추가</button>
      <textarea id="noticeBody" class="textarea" placeholder="내용 (줄바꿈 가능)"></textarea>
    </div>

    <div id="noticeListWrap" class="notice-list"></div>
    <div id="noticeEmpty" class="empty">등록된 전달 사항이 없습니다.</div>
  </section>

  <!-- 시험 -->
  <section class="card">
    <div class="card-head">
      <div class="title">🧪 시험</div>
    </div>
    <ul id="list_exam" class="task-list"></ul>

    <!-- 관리자만 보이는 추가 폼 -->
    <div class="add-row admin-only">
      <input class="subj input" placeholder="과목" />
      <input class="text input" placeholder="내용" />
      <input class="date input" type="date" />
      <input class="date input" type="date" />
      <select class="start select"></select>
      <select class="end select"></select>
      <button class="add btn primary" data-cat="exam">+ 추가</button>
      <textarea class="desc textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 수행평가 -->
  <section class="card">
    <div class="card-head">
      <div class="title">🧾 수행평가</div>
    </div>
    <ul id="list_perf" class="task-list"></ul>

    <div class="add-row admin-only">
      <input class="subj input" placeholder="과목" />
      <input class="text input" placeholder="내용" />
      <input class="date input" type="date" />
      <input class="date input" type="date" />
      <select class="start select"></select>
      <select class="end select"></select>
      <button class="add btn primary" data-cat="perf">+ 추가</button>
      <textarea class="desc textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 숙제 -->
  <section class="card">
    <div class="card-head">
      <div class="title">📌 숙제</div>
    </div>
    <ul id="list_home" class="task-list"></ul>

    <div class="add-row admin-only">
      <input class="subj input" placeholder="과목" />
      <input class="text input" placeholder="내용" />
      <input class="date input" type="date" />
      <input class="date input" type="date" />
      <select class="start select"></select>
      <select class="end select"></select>
      <button class="add btn primary" data-cat="home">+ 추가</button>
      <textarea class="desc textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>
</main>

<script>
/* ====== 0) 설정 ====== */
const ADMIN_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // ← 관리자 UID로 교체
const firebaseConfig = {
  // ← 내 Firebase config 값으로 교체
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "1:196036694705:web:8988d12919420130464890"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ====== 1) 상태 ====== */
let currentUser = null;
let isAdmin = false;
const $  = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

function applyAdminUIFlag(){
  document.body.classList.toggle('is-admin', isAdmin);
  $("#adminBadge").style.display = isAdmin ? "" : "none";
  // admin-only 폼
  $$(".admin-only").forEach(el => el.style.display = isAdmin ? "" : "none");
  // 전달사항 입력폼
  const wrap = $("#noticeFormWrap");
  if (wrap) wrap.style.display = isAdmin ? "" : "none";
}

/* ====== 2) 로그인 / 로그아웃 ====== */
$("#loginBtn").addEventListener("click", async ()=>{
  try {
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  } catch {}
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
});
$("#logoutBtn").addEventListener("click", ()=> auth.signOut());

auth.onAuthStateChanged(async (user)=>{
  currentUser = user;
  isAdmin = !!user && user.uid === ADMIN_UID;
  $("#loginBtn").style.display  = user ? "none" : "";
  $("#logoutBtn").style.display = user ? "" : "none";
  applyAdminUIFlag();
  await loadNoticeSettings();
  await renderNoticeList();
  startTaskListeners(); // 시험/수행/숙제 실시간
});

/* ====== 3) 전달 사항 ====== */

// 표시 on/off 불러오기
async function loadNoticeSettings(){
  try{
    const snap = await db.doc("settings/global").get();
    const showNotice = snap.exists ? (snap.data().showNotice !== false) : true;
    const toggle = $("#noticeToggle");
    toggle.checked = showNotice;
    $("#noticeListWrap").classList.toggle("hidden", !showNotice);
  }catch(e){ console.error(e); }
}

// 표시 on/off 저장 (관리자만)
$("#noticeToggle").addEventListener("change", async (e)=>{
  if (!isAdmin){
    e.preventDefault();
    e.target.checked = !e.target.checked;
    return;
  }
  try{
    await db.doc("settings/global").set({ showNotice: e.target.checked }, { merge: true });
    $("#noticeListWrap").classList.toggle("hidden", !e.target.checked);
  }catch(err){
    alert("설정 저장 실패: " + err.message);
  }
});

// 전달사항 추가 (관리자만)
$("#noticeAddBtn").addEventListener("click", async ()=>{
  if (!isAdmin) return;
  const title = $("#noticeTitle").value.trim();
  const level = $("#noticeLevel").value;
  const body  = $("#noticeBody").value.trim();
  if (!title){ alert("제목을 입력해 주세요."); return; }
  try{
    await db.collection("notice").add({
      title, level, body,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $("#noticeTitle").value = "";
    $("#noticeBody").value  = "";
  }catch(e){ alert("추가 실패: "+e.message); }
});

// 전달사항 목록 렌더
async function renderNoticeList(){
  const list = $("#noticeListWrap");
  list.innerHTML = "";
  const snap = await db.collection("notice").orderBy("createdAt","desc").get();
  if (snap.empty){ $("#noticeEmpty").style.display = ""; return; }
  $("#noticeEmpty").style.display = "none";
  snap.forEach(doc=>{
    const d = doc.data();
    const wrap = document.createElement("div");
    wrap.className = `notice-item ${d.level||"info"}`;
    wrap.innerHTML = `
      <div class="notice-title">${esc(d.title)}</div>
      ${d.body ? `<div class="notice-body">${esc(d.body).replace(/\n/g,"<br/>")}</div>`:""}
    `;
    list.appendChild(wrap);
  });
}

/* ====== 4) 과제(시험/수행/숙제) ====== */

const lists = { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") };

function startTaskListeners(){
  ["exam","perf","home"].forEach(cat=>{
    // 기존 리스너 제거가 필요하면 저장/해제 로직 추가
    db.collection("users").doc(getOwnerUid())
      .collection("tasks").doc(cat).collection("items")
      .orderBy("due","asc")
      .onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
        renderList(cat, arr);
      });
  });
}

// 비로그인 때도 공개 UID로 읽게 (OWNER_UID를 본인 규칙대로 사용 중이라면, 그대로 유지)
const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // 예시
function getOwnerUid(){
  return currentUser?.uid || OWNER_UID;
}

function renderList(cat, items){
  const ul = lists[cat];
  ul.innerHTML = "";
  for (const it of items){
    const li = document.createElement("li");
    li.className = "task";
    const ddayBadge = makeDDayBadge(it.due);
    const period = makePeriodText(it.startPeriod, it.endPeriod);
    const range  = makeDateRange(it.from, it.due);
    li.innerHTML = `
      <label class="chk"><input type="checkbox" ${it.done?"checked":""} data-act="toggle" data-cat="${cat}" data-id="${it.id}"><span></span></label>
      <div class="task-main">
        <div class="task-title"><b>${esc(it.subj||"")}</b>${ddayBadge}</div>
        <div class="task-text">${esc(it.text||"")}</div>
        ${it.desc ? `<div class="task-desc">${esc(it.desc).replace(/\n/g,"<br/>")}</div>`:""}
        <div class="task-meta">📅 ${range}${period?`  ·  ${period}`:""}</div>
      </div>
      ${isAdmin?`<div class="task-ops">
         <button class="btn ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}">수정</button>
         <button class="btn ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}">삭제</button>
       </div>`:""}
    `;
    ul.appendChild(li);
  }

  ul.onclick = async (e)=>{
    const t = e.target;
    const act = t.getAttribute("data-act");
    if (!act) return;

    const cat2 = t.getAttribute("data-cat");
    const id   = t.getAttribute("data-id");

    if (act === "toggle"){
      if (!currentUser){ t.checked = !t.checked; return; }
      try{ await col(cat2).doc(id).update({ done:t.checked }); }catch(err){ alert(err.message); }
    } else if (act === "del"){
      if (!isAdmin) return;
      if (!confirm("삭제할까요?")) return;
      await col(cat2).doc(id).delete();
    } else if (act === "edit"){
      if (!isAdmin) return;
      openEdit(cat2, id);
    }
  };
}

function col(cat){
  return db.collection("users").doc(getOwnerUid())
           .collection("tasks").doc(cat).collection("items");
}

function makeDDayBadge(due){
  if (!due) return "";
  const d = new Date(due+"T00:00:00");
  const today = new Date();
  const diff = Math.floor((d - toMidnight(today))/86400000);
  let label = "";
  let cls   = "";
  if (diff > 0) { label = `D-${diff}`; cls = "p-future"; }
  else if (diff === 0) { label = "D-DAY"; cls="p-today"; }
  else { label = `D+${Math.abs(diff)}`; cls="p-past"; }
  return `<span class="dday ${cls}">${label}</span>`;
}
function toMidnight(dt){ return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }

function makeDateRange(from, to){
  const a = from ? toDisplayDate(from) : null;
  const b = to ? toDisplayDate(to) : null;
  if (a && b && a!==b) return `${a} ~ ${b}`;
  return b || a || "";
}
function toDisplayDate(iso){
  const d = new Date(iso+"T00:00:00");
  const w = ["일","월","화","수","목","금","토"][d.getDay()];
  const y = d.getFullYear();
  const m = ("0"+(d.getMonth()+1)).slice(-2);
  const day = ("0"+d.getDate()).slice(-2);
  return `${y}-${m}-${day} (${w})`;
}
function makePeriodText(s,e){
  if (!s && !e) return "";
  if (s && e) return `${s}교시 ~ ${e}교시`;
  if (s) return `${s}교시`;
  return `${e}교시`;
}

/* ====== 5) 추가 폼(관리자만) ====== */
function fillPeriodSelects(){
  $$(".add-row .start").forEach(sel=>{
    sel.innerHTML = ["","1","2","3","4","5","6","7"].map(v=>
      `<option value="${v}">${v? v+"교시":"교시 없음"}</option>`).join("");
  });
  $$(".add-row .end").forEach(sel=>{
    sel.innerHTML = ["","1","2","3","4","5","6","7"].map(v=>
      `<option value="${v}">${v? v+"교시":"교시 없음"}</option>`).join("");
  });
}
fillPeriodSelects();

$$(".add-row .add").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    if (!isAdmin) return;
    const row  = btn.closest(".add-row");
    const cat  = btn.dataset.cat;
    const subj = $(".subj", row).value.trim();
    const text = $(".text", row).value.trim();
    const from = $(".date:nth-of-type(1)", row).value || "";
    const due  = $(".date:nth-of-type(2)", row).value || "";
    const start= $(".start",row).value || "";
    const end  = $(".end",row).value || "";
    const desc = $(".desc", row).value.trim();

    if (!subj || !text){ alert("과목/내용을 입력해 주세요."); return; }
    await col(cat).add({
      subj, text,
      from, due,
      startPeriod: start || null,
      endPeriod: end || null,
      desc: desc || "",
      done: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $(".subj", row).value="";
    $(".text", row).value="";
    $(".date:nth-of-type(1)", row).value="";
    $(".date:nth-of-type(2)", row).value="";
    $(".start", row).value="";
    $(".end", row).value="";
    $(".desc", row).value="";
  });
});

/* ====== 6) 수정 모달(간단 버전) ====== */
function openEdit(cat, id){
  // 간단: 현재 항목 값만 읽어서 prompt로 수정 (필요 시 UI 모달로 교체)
  col(cat).doc(id).get().then(doc=>{
    const d = doc.data();
    const subj = prompt("과목", d.subj||""); if (subj===null) return;
    const text = prompt("내용", d.text||""); if (text===null) return;
    const from = prompt("시작일(YYYY-MM-DD, 선택)", d.from||""); if (from===null) return;
    const due  = prompt("마감일(YYYY-MM-DD)", d.due||""); if (due===null) return;
    const start= prompt("시작교시(숫자, 선택)", d.startPeriod||""); if (start===null) return;
    const end  = prompt("끝교시(숫자, 선택)", d.endPeriod||""); if (end===null) return;
    const desc = prompt("상세 내용(선택)", d.desc||""); if (desc===null) return;

    col(cat).doc(id).update({
      subj, text,
      from: from || "",
      due:  due  || "",
      startPeriod: start || null,
      endPeriod:   end   || null,
      desc: desc || ""
    });
  });
}

/* ====== 7) 유틸 ====== */
function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* ====== 8) 1분 자동 새로고침 (조용히) ====== */
setInterval(()=>{ location.reload(); }, 60*1000);

</script>
</body>
</html>
