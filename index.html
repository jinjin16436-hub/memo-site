<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="topbar">
  <h1>📒 숙제 & 수행평가</h1>
  <div class="auth">
    <button id="loginBtn"  class="btn">🔑 Google 로그인</button>
    <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
  </div>
</header>

<main class="container">

  <!-- 중요 전달 사항 (관리자 ON/OFF) -->
  <section id="noticeWrap" class="notice card">
    <div class="card-head">
      <div class="title">📢 중요 전달 사항</div>
      <div class="actions">
        <label id="noticeToggleWrap" class="toggle" style="display:none">
          <input type="checkbox" id="noticeToggle">
          <span>표시</span>
        </label>
      </div>
    </div>
    <div class="notice-body">
      <ul id="noticeList" class="notice-list"></ul>
      <div id="noticeForm" class="add-area" style="display:none">
        <div class="row">
          <input id="noticeTitle" class="input" placeholder="제목" />
          <select id="noticeTag" class="select">
            <option value="blue">전달 사항</option>
            <option value="yellow">공지</option>
            <option value="red">긴급 공지</option>
          </select>
          <button id="addNotice" class="btn primary">+ 추가</button>
        </div>
        <textarea id="noticeBody" class="textarea" placeholder="내용 (줄바꿈 가능)"></textarea>
      </div>
    </div>
  </section>

  <!-- 시험 -->
  <section class="card">
    <div class="card-head">
      <div class="title">🧪 시험</div>
    </div>
    <ul id="list_exam" class="task-list"></ul>

    <!-- 관리자 전용 추가 행 -->
    <div id="add_exam" class="add-area" style="display:none">
      <div class="row">
        <input class="subj input" placeholder="과목">
        <input class="text input grow" placeholder="내용">
        <input class="date input" type="date">
        <input class="date input" type="date">
        <select class="sel start select"></select>
        <select class="sel end select"></select>
        <button class="btn primary add">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 수행평가 -->
  <section class="card">
    <div class="card-head">
      <div class="title">📄 수행평가</div>
    </div>
    <ul id="list_perf" class="task-list"></ul>

    <div id="add_perf" class="add-area" style="display:none">
      <div class="row">
        <input class="subj input" placeholder="과목">
        <input class="text input grow" placeholder="내용">
        <input class="date input" type="date">
        <input class="date input" type="date">
        <select class="sel start select"></select>
        <select class="sel end select"></select>
        <button class="btn primary add">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 숙제 -->
  <section class="card">
    <div class="card-head">
      <div class="title">📌 숙제</div>
    </div>
    <ul id="list_home" class="task-list"></ul>

    <div id="add_home" class="add-area" style="display:none">
      <div class="row">
        <input class="subj input" placeholder="과목">
        <input class="text input grow" placeholder="내용">
        <input class="date input" type="date">
        <input class="date input" type="date">
        <select class="sel start select"></select>
        <select class="sel end select"></select>
        <button class="btn primary add">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>
</main>

<!-- 수정 모달 -->
<div id="editModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-head">
      <div class="title">항목 수정</div>
      <button class="icon-btn" id="closeEdit">✕</button>
    </div>

    <div class="row">
      <input id="editSubj" class="input" placeholder="과목">
      <input id="editText" class="input grow" placeholder="내용">
    </div>

    <div class="row">
      <input id="editStart" class="input" type="date">
      <input id="editEnd"   class="input" type="date">
      <select id="editStartPd" class="select"></select>
      <select id="editEndPd"   class="select"></select>
    </div>

    <textarea id="editDetail" class="textarea" placeholder="상세 내용 (선택)"></textarea>

    <div class="modal-foot">
      <button id="saveEdit" class="btn primary">저장</button>
      <button id="cancelEdit" class="btn">취소</button>
    </div>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "196036694705",
  appId: "1:196036694705:web:8988d12919420130464890"
};
firebase.initializeApp(firebaseConfig);

const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";  // 공개 UID
const auth = firebase.auth();
const db   = firebase.firestore();

/* ================= 공통 유틸 ================= */
const PERIODS = [
  { value: "", label: "교시 없음" },
  { value: "0", label: "0교시" },
  { value: "1", label: "1교시" },
  { value: "2", label: "2교시" },
  { value: "3", label: "3교시" },
  { value: "4", label: "4교시" },
  { value: "5", label: "5교시" },
  { value: "6", label: "6교시" },
  { value: "7", label: "7교시" },
  { value: "8", label: "8교시" }
];

function fillPeriodOptions(sel) {
  sel.innerHTML = "";
  PERIODS.forEach(p => {
    const o = document.createElement("option");
    o.value = p.value; o.textContent = p.label;
    sel.appendChild(o);
  });
}

function $ (q, root=document){ return root.querySelector(q); }
function $$ (q, root=document){ return Array.from(root.querySelectorAll(q)); }

const lists = {
  perf: $("#list_perf"),
  exam: $("#list_exam"),
  home: $("#list_home")
};

let currentUser = null;
let unsub = [];

/* D-day 뱃지 */
function ddayLabel(start, end) {
  if(!start) return "";
  const base = new Date();
  base.setHours(0,0,0,0);
  const s = new Date(start);
  s.setHours(0,0,0,0);
  let diff = Math.round((s - base) / 86400000);
  // 지남: A+n
  if (diff < 0) {
    const a = Math.abs(diff);
    return `<span class="dday past">A+${a}</span>`;
  }
  // 오늘
  if (diff === 0) return `<span class="dday warn">D-DAY</span>`;
  // 미래: 색 단계
  let cls = "far";
  if (diff <= 2) cls = "urgent";
  else if (diff <= 3) cls = "soon";
  else if (diff <= 5) cls = "near";
  return `<span class="dday ${cls}">D-${diff}</span>`;
}

function weekdayStr(dateStr){
  if(!dateStr) return "";
  const d = new Date(dateStr + "T00:00:00");
  const w = "일월화수목금토"[d.getDay()];
  return `(${w})`;
}

/* ================= 렌더 ================= */
function renderOne(cat, it){
  const li = document.createElement("li");
  li.className = "task";
  const pd = (it.startPd || it.endPd) ? `${it.startPd || ""}${it.endPd ? " ~ " + it.endPd : ""}교시` : "";
  const dateLine = it.start ? `📅 ${it.start} ${weekdayStr(it.start)}${it.end ? " ~ " + it.end + " " + weekdayStr(it.end) : ""} ${pd}` : "";
  li.innerHTML = `
    <label class="chk"><input type="checkbox" data-cat="${cat}" data-id="${it.id}"><span></span></label>
    <div class="main">
      <div class="line1">
        <b class="subject">${it.subj || ""}</b>
        ${ddayLabel(it.start, it.end)}
      </div>
      <div class="line2">${(it.text || "").replace(/\n/g,"<br>")}</div>
      ${it.detail ? `<div class="line3">${it.detail.replace(/\n/g,"<br>")}</div>`: ""}
      ${dateLine ? `<div class="meta">${dateLine}</div>` : ""}
    </div>
    <div class="ops" style="${currentUser && currentUser.uid===OWNER_UID?'':'display:none'}">
      <button class="btn ghost edit" data-cat="${cat}" data-id="${it.id}">수정</button>
      <button class="btn ghost del"  data-cat="${cat}" data-id="${it.id}">삭제</button>
    </div>
  `;

  // 체크박스: 완료 토글(X) 대신, 로그인 안내만(원 요청에 따라 완료 기능 제외/보류)
  $(".chk input", li).addEventListener("change", e=>{
    if(!currentUser || currentUser.uid!==OWNER_UID){
      alert("수정/삭제/완료 체크는 관리자만 가능합니다.");
      e.target.checked = false;
    }
  });

  // 수정
  $(".edit", li)?.addEventListener("click", ()=> openEdit(cat, it));
  // 삭제
  $(".del", li)?.addEventListener("click", async ()=>{
    if(!confirm("삭제할까요?")) return;
    try{
      await col(cat).doc(it.id).delete();
    }catch(err){ alert("삭제 실패: "+err.message); }
  });

  return li;
}

function renderList(cat, arr){
  const ul = lists[cat];
  ul.innerHTML = "";
  arr.forEach(it => ul.appendChild(renderOne(cat, it)));
}

/* ================= Firestore 경로 ================= */
function userForRead(){
  return (currentUser && currentUser.uid===OWNER_UID) ? OWNER_UID : OWNER_UID; // 공개용: 항상 OWNER 읽기
}
function userForWrite(){
  return (currentUser && currentUser.uid===OWNER_UID) ? OWNER_UID : null;
}

function col(cat){
  const uid = userForRead();
  return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
}

/* ================= 실시간 구독 ================= */
function startListen(){
  unsub.forEach(u=>u&&u()); unsub=[];
  ["exam","perf","home"].forEach(cat=>{
    const u = col(cat).orderBy("start","asc").onSnapshot(snap=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      renderList(cat, arr);
    }, err=>console.error(err));
    unsub.push(u);
  });

  // 공지 + 설정
  const ncol = db.collection("users").doc(OWNER_UID).collection("notice");
  const u1 = ncol.orderBy("createdAt","desc").onSnapshot(s=>{
    const arr=[]; s.forEach(d=>arr.push({id:d.id, ...d.data()}));
    renderNotice(arr);
  });
  unsub.push(u1);

  const setdoc = db.collection("users").doc(OWNER_UID).collection("settings").doc("ui");
  const u2 = setdoc.onSnapshot(d=>{
    const on = !!(d.exists && d.data().noticeOn);
    $("#noticeToggle").checked = on;
    $("#noticeWrap").style.display = on ? "" : "none";
  });
  unsub.push(u2);
}

/* ================= Notice ================= */
function renderNotice(items){
  const ul = $("#noticeList");
  ul.innerHTML = "";
  items.forEach(it=>{
    const li = document.createElement("li");
    li.className = `note ${it.tag||"blue"}`;
    li.innerHTML = `
      <div class="note-title">${(it.title||"").replace(/\n/g,"<br>")}</div>
      ${it.body ? `<div class="note-body">${it.body.replace(/\n/g,"<br>")}</div>`:""}
      <div class="note-ops" style="${currentUser && currentUser.uid===OWNER_UID?'':'display:none'}">
        <button class="btn ghost" data-id="${it.id}" data-act="edit">수정</button>
        <button class="btn ghost" data-id="${it.id}" data-act="del">삭제</button>
      </div>
    `;
    ul.appendChild(li);

    $(".note-ops [data-act='del']", li)?.addEventListener("click", async ()=>{
      if(!confirm("삭제할까요?")) return;
      await db.collection("users").doc(OWNER_UID).collection("notice").doc(it.id).delete();
    });
    $(".note-ops [data-act='edit']", li)?.addEventListener("click", async ()=>{
      $("#noticeTitle").value = it.title || "";
      $("#noticeBody").value  = it.body  || "";
      $("#noticeTag").value   = it.tag   || "blue";
      $("#addNotice").dataset.edit = it.id;
      $("#noticeForm").scrollIntoView({behavior:"smooth", block:"center"});
    });
  });
}

/* ================= 추가 행 바인딩 ================= */
function fillAllAddRows(){
  ["add_exam","add_perf","add_home"].forEach(id=>{
    const wrap = $("#"+id);
    // 교시 select 채우기
    $$(".sel.start", wrap).forEach(fillPeriodOptions);
    $$(".sel.end", wrap).forEach(fillPeriodOptions);

    // 추가
    $(".add", wrap).onclick = async ()=>{
      if(!currentUser || currentUser.uid!==OWNER_UID){ alert("관리자만 추가할 수 있어요."); return; }
      const subj = $(".subj", wrap).value.trim();
      const text = $(".text", wrap).value.trim();
      const start= $(".date", wrap)?.value || "";
      const end  = $$(".date", wrap)?.[1]?.value || "";
      const startPd = $(".sel.start", wrap).value;
      const endPd   = $(".sel.end", wrap).value;
      const detail  = $(".detail", wrap).value.trim();
      if(!subj || !text || !start){ alert("과목/내용/시작일은 필수입니다."); return; }
      const cat = id.split("_")[1];
      try{
        await col(cat).add({
          subj, text, detail,
          start, end,
          startPd, endPd,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        $(".subj", wrap).value = "";
        $(".text", wrap).value = "";
        $(".date", wrap).value = "";
        $$(".date", wrap)[1].value = "";
        $(".sel.start", wrap).value = "";
        $(".sel.end", wrap).value = "";
        $(".detail", wrap).value = "";
      }catch(e){ alert("추가 실패: "+e.message); }
    };
  });
}

/* ================= 수정 모달 ================= */
let editCtx = null;
function openEdit(cat, it){
  editCtx = {cat, id: it.id};
  $("#editSubj").value = it.subj || "";
  $("#editText").value = it.text || "";
  $("#editStart").value = it.start || "";
  $("#editEnd").value   = it.end   || "";
  fillPeriodOptions($("#editStartPd"));
  fillPeriodOptions($("#editEndPd"));
  $("#editStartPd").value = it.startPd || "";
  $("#editEndPd").value   = it.endPd   || "";
  $("#editDetail").value  = it.detail  || "";
  $("#editModal").setAttribute("aria-hidden","false");
}
function closeEdit(){
  $("#editModal").setAttribute("aria-hidden","true");
  editCtx = null;
}
$("#closeEdit").onclick = closeEdit;
$("#cancelEdit").onclick = closeEdit;

$("#saveEdit").onclick = async ()=>{
  if(!editCtx) return;
  if(!currentUser || currentUser.uid!==OWNER_UID){ alert("관리자만 수정할 수 있어요."); return; }
  const data = {
    subj: $("#editSubj").value.trim(),
    text: $("#editText").value.trim(),
    start: $("#editStart").value,
    end: $("#editEnd").value,
    startPd: $("#editStartPd").value,
    endPd: $("#editEndPd").value,
    detail: $("#editDetail").value.trim(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    await col(editCtx.cat).doc(editCtx.id).update(data);
    closeEdit();
  }catch(e){ alert("저장 실패: "+e.message); }
};

document.addEventListener("keydown", e=>{
  if(e.key==="Escape") closeEdit();
});

/* ================= 로그인/설정 ================= */
$("#loginBtn").onclick = async ()=>{
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  }catch(e){ alert("로그인 실패: "+e.message); }
};
$("#logoutBtn").onclick = ()=> auth.signOut();

auth.onAuthStateChanged(user=>{
  currentUser = user;
  $("#loginBtn").style.display  = user ? "none" : "";
  $("#logoutBtn").style.display = user ? "" : "none";

  // 관리자 전용 UI
  const isAdmin = !!(user && user.uid===OWNER_UID);
  ["add_exam","add_perf","add_home"].forEach(id=>{
    $("#"+id).style.display = isAdmin ? "" : "none";
  });
  $("#noticeForm").style.display = isAdmin ? "" : "none";
  $("#noticeToggleWrap").style.display = isAdmin ? "" : "none";
  $$(".ops").forEach(op=>op.style.display = isAdmin ? "" : "none");

  startListen();
  fillAllAddRows();
});

/* ================= Notice 저장/ONOFF ================= */
$("#addNotice").onclick = async ()=>{
  if(!currentUser || currentUser.uid!==OWNER_UID){ alert("관리자만 가능"); return; }
  const title = $("#noticeTitle").value.trim();
  const body  = $("#noticeBody").value.trim();
  const tag   = $("#noticeTag").value;
  if(!title){ alert("제목은 필수"); return; }
  const ref = db.collection("users").doc(OWNER_UID).collection("notice");
  try{
    const editId = $("#addNotice").dataset.edit;
    if(editId){
      await ref.doc(editId).update({ title, body, tag, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      delete $("#addNotice").dataset.edit;
    }else{
      await ref.add({ title, body, tag, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
    $("#noticeTitle").value=""; $("#noticeBody").value="";
  }catch(e){ alert("저장 실패: "+e.message); }
};

$("#noticeToggle").onchange = async e=>{
  if(!currentUser || currentUser.uid!==OWNER_UID){ e.target.checked=!e.target.checked; return alert("관리자만 가능"); }
  try{
    await db.collection("users").doc(OWNER_UID).collection("settings").doc("ui")
      .set({ noticeOn: e.target.checked }, { merge:true });
  }catch(err){ alert("설정 저장 실패: "+err.message); }
};

/* ================= 1분 조용 갱신 ================= */
setInterval(()=> startListen(), 60*1000);
</script>
</body>
</html>
