<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="admin-bar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="auth">
      <button id="loginBtn" class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
      <span id="adminBadge" class="admin-badge" style="display:none;">ê´€ë¦¬ì</span>
    </div>
  </header>

  <main class="container">

    <!-- ========== ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ ========== -->
    <section class="block">
      <div class="block-head">
        <h2>ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</h2>
        <label class="switch" title="ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥">
          <input type="checkbox" id="noticeToggle" />
          <span class="slider"></span>
        </label>
      </div>

      <!-- ê´€ë¦¬ì ì „ìš© ì…ë ¥ í¼ (ë‘ ì¤„ ë ˆì´ì•„ì›ƒ) -->
      <div id="noticeForm" class="notice-form" style="display:none">
        <div class="row row-1">
          <input id="noticeTitle" class="input" placeholder="ì œëª©" />
          <select id="noticeLevel" class="input">
            <option value="ì•Œë¦¼">ì•Œë¦¼</option>
            <option value="ì£¼ì˜">ì£¼ì˜</option>
            <option value="ê¸´ê¸‰">ê¸´ê¸‰</option>
          </select>
          <button id="noticeAddBtn" class="btn primary">+ ì¶”ê°€</button>
        </div>
        <div class="row row-2">
          <textarea id="noticeBody" class="input" rows="3" placeholder="ìƒì„¸ ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
        </div>
      </div>

      <!-- ëª©ë¡ -->
      <ul id="noticeList" class="list"></ul>
      <div id="noticeEmpty" class="empty">ë“±ë¡ëœ ì „ë‹¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </section>

    <!-- ====== ì•„ë˜ëŠ” ì˜ˆì‹œì˜ ì¼ë°˜ ì„¹ì…˜(ì‹œí—˜/ìˆ˜í–‰/ìˆ™ì œ) ìë¦¬ ====== -->
    <!-- í•„ìš” ì‹œ ì‚¬ìš©í•˜ë˜ ì„¹ì…˜ ì½”ë“œë¥¼ ì´ì–´ ë¶™ì—¬ ì‚¬ìš©í•˜ì„¸ìš” -->

  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ---------- Firebase ì´ˆê¸°í™” ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ---------- ê³ ì • ìƒìˆ˜ ----------
    // (ë°˜ë“œì‹œ ë„¤ ê³„ì •ì— ë§ê²Œ ë°”ê¿”ì£¼ì„¸ìš”!)
    const ADMIN_UID  = "vv0bADtWdqQUnqFMy8k01dhO13t2";     // ê´€ë¦¬ì UID
    const PUBLIC_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // ê³µê°œ ì¡°íšŒìš© UID (ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ì½ê¸°ìš©ìœ¼ë¡œ ì“°ëŠ” UID)

    // ---------- DOM ----------
    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const loginBtn   = $("#loginBtn");
    const logoutBtn  = $("#logoutBtn");
    const adminBadge = $("#adminBadge");

    const noticeToggle = $("#noticeToggle");
    const noticeForm   = $("#noticeForm");
    const noticeList   = $("#noticeList");
    const noticeEmpty  = $("#noticeEmpty");

    const noticeTitle  = $("#noticeTitle");
    const noticeLevel  = $("#noticeLevel");
    const noticeBody   = $("#noticeBody");
    const noticeAddBtn = $("#noticeAddBtn");

    // ---------- ìƒíƒœ ----------
    let currentUser = null;
    let isAdmin = false;
    let noticeUnsub = null;       // ê³µì§€ ëª©ë¡ ë¦¬ìŠ¤ë„ˆ
    let settingUnsub = null;      // í‘œì‹œ ì„¤ì • ë¦¬ìŠ¤ë„ˆ

    // ---------- ìœ í‹¸ ----------
    function toast(msg){ alert(msg); }
    function byCreatedDesc(a,b){ return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0); }

    // ---------- ì¸ì¦ UI ----------
    loginBtn.onclick = async () => {
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      } catch(e){ toast(e.message); }
    };
    logoutBtn.onclick = () => auth.signOut();

    // ---------- ê´€ë¦¬ì ì—¬ë¶€ì— ë”°ë¥¸ UI ----------
    function syncAdminUI() {
      isAdmin = !!(currentUser && currentUser.uid === ADMIN_UID);
      adminBadge.style.display = isAdmin ? "" : "none";
      loginBtn.style.display   = currentUser ? "none" : "";
      logoutBtn.style.display  = currentUser ? "" : "none";

      // í¼/í† ê¸€ ê¶Œí•œ
      noticeForm.style.display = isAdmin ? "" : "none";
      noticeToggle.disabled    = !isAdmin;

      // ë²„íŠ¼ ë¹„í™œì„±í™” ë°©ì§€
      noticeAddBtn.disabled = !isAdmin ? true : false;
      noticeAddBtn.style.pointerEvents = isAdmin ? "auto" : "none";
    }

    // ---------- ê³µì§€ ì„¤ì •(í‘œì‹œ ì—¬ë¶€) ë¦¬ìŠ¤ë„ˆ ----------
    function listenNoticeSetting(){
      if(settingUnsub) settingUnsub();
      settingUnsub = db.collection("settings").doc("notice").onSnapshot(snap=>{
        const data = snap.exists ? snap.data() : { enabled: true };
        noticeToggle.checked = !!data.enabled;
      }, err=>console.error(err));
    }

    // í† ê¸€ ë³€ê²½ (ê´€ë¦¬ìë§Œ)
    noticeToggle.addEventListener("change", async (e)=>{
      if(!isAdmin){
        // ë¹„ê´€ë¦¬ìëŠ” í† ê¸€ë§Œ ì›ë³µ
        const snap = await db.collection("settings").doc("notice").get();
        noticeToggle.checked = snap.exists ? !!snap.data().enabled : false;
        toast("í‘œì‹œ ì—¬ë¶€ëŠ” ê´€ë¦¬ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.");
        return;
      }
      try {
        await db.collection("settings").doc("notice").set({
          enabled: !!e.target.checked,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      } catch(err){
        console.error(err);
        toast("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: " + err.message);
      }
    });

    // ---------- ê³µì§€ ëª©ë¡ ë¦¬ìŠ¤ë„ˆ ----------
    function listenNotices(){
      if(noticeUnsub) noticeUnsub();
      noticeUnsub = db.collection("notices").orderBy("createdAt","desc").onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        renderNotices(arr);
      }, err=>console.error(err));
    }

    // ---------- ê³µì§€ ë Œë” ----------
    function renderNotices(items){
      noticeList.innerHTML = "";
      if(items.length === 0){
        noticeEmpty.style.display = "";
        return;
      }
      noticeEmpty.style.display = "none";

      for(const it of items){
        const li = document.createElement("li");
        li.className = "notice-item";
        li.innerHTML = `
          <div class="line">
            <b class="title">${escapeHtml(it.title || "")}</b>
            <span class="pill pill-${levelToClass(it.level)}">${it.level||"ì•Œë¦¼"}</span>
          </div>
          <div class="body">${escapeHtml(it.body||"").replace(/\n/g,"<br>")}</div>
          <div class="actions" style="display:${isAdmin?'flex':'none'}">
            <button class="btn ghost" data-act="edit">ìˆ˜ì •</button>
            <button class="btn ghost danger" data-act="del">ì‚­ì œ</button>
          </div>
        `;
        // í¸ì§‘/ì‚­ì œ
        li.addEventListener("click", async (e)=>{
          const act = e.target?.getAttribute?.("data-act");
          if(!act) return;
          if(!isAdmin){ toast("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }

          if(act === "del"){
            if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
            try{ await db.collection("notices").doc(it.id).delete(); }
            catch(err){ toast("ì‚­ì œ ì‹¤íŒ¨: "+err.message); }
          }else if(act === "edit"){
            // ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸ ê¸°ë°˜ ìˆ˜ì • (í•„ìš”ì‹œ ëª¨ë‹¬ë¡œ ë°”ê¿”ë„ ë¨)
            const t = prompt("ì œëª©", it.title || "");
            if(t === null) return;
            const b = prompt("ìƒì„¸ ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)", it.body || "");
            if(b === null) return;
            const lvl = prompt("ë ˆë²¨(ì•Œë¦¼/ì£¼ì˜/ê¸´ê¸‰)", it.level || "ì•Œë¦¼") || "ì•Œë¦¼";
            try{
              await db.collection("notices").doc(it.id).set({
                title: t.trim(),
                body: b,
                level: lvl.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
            }catch(err){ toast("ìˆ˜ì • ì‹¤íŒ¨: "+err.message); }
          }
        });
        noticeList.appendChild(li);
      }
    }

    // ---------- ê³µì§€ ì¶”ê°€ ----------
    noticeAddBtn.addEventListener("click", async ()=>{
      if(!isAdmin){ toast("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }

      const title = (noticeTitle.value||"").trim();
      const level = (noticeLevel.value||"ì•Œë¦¼").trim();
      const body  = (noticeBody.value||"").trim();

      if(!title){ noticeTitle.focus(); return; }

      try{
        await db.collection("notices").add({
          title, level, body,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser?.uid || ADMIN_UID
        });
        // ì…ë ¥ ìœ ì§€ ì›í•˜ë©´ ì£¼ì„ ì²˜ë¦¬
        noticeTitle.value = "";
        noticeBody.value = "";
      }catch(err){
        console.error(err); toast("ì¶”ê°€ ì‹¤íŒ¨: "+err.message);
      }
    });

    // ---------- HTML escape ----------
    function escapeHtml(s){
      return (s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }
    function levelToClass(lv){
      if(lv==="ê¸´ê¸‰") return "red";
      if(lv==="ì£¼ì˜") return "orange";
      return "blue"; // ì•Œë¦¼
    }

    // ---------- ì¸ì¦ ìƒíƒœ ----------
    auth.onAuthStateChanged(user=>{
      currentUser = user || null;
      syncAdminUI();
      // ë¦¬ìŠ¤ë„ˆë“¤ ì‹œì‘
      listenNoticeSetting();
      listenNotices();
    });

    // ---------- 1ë¶„ë§ˆë‹¤ ì¡°ìš©íˆ ìƒˆë¡œê³ ì¹¨ ----------
    setInterval(()=>{
      // ìºì‹œ ê¹¨ì§€ì§€ ì•Šê²Œ re-fetch ëª©ì ì˜ ì–•ì€ í˜¸ì¶œ
      // ì‹¤ì œ ì „ì²´ ë¦¬ë¡œë“œê°€ í•„ìš”í•˜ë©´: location.reload()
      if(document.hidden) return; // ë°±ê·¸ë¼ìš´ë“œì¼ ë• ìƒëµ
      // noop: ì‹¤ì‹œê°„ onSnapshotìœ¼ë¡œ ì¶©ë¶„í•˜ë¯€ë¡œ êµ³ì´ ì¬í˜¸ì¶œ ë¶ˆí•„ìš”
    }, 60000);
  </script>
</body>
</html>
