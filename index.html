<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>

  <!-- ====== STYLE (CSS) ====== -->
  <style>
    :root{
      --bg:#0f1622;
      --panel:#131c2a;
      --panel-2:#0f1928;
      --line:#22314a;
      --text:#dfe7f5;
      --text-dim:#a7b2c6;
      --accent:#7aa2ff;
      --btn:#6c8dff;
      --btn-ghost:#2c3d5f;
      --badge-green:#45a541;
      --badge-yellow:#d6a23f;
      --badge-orange:#d9822f;
      --badge-red:#e04848;
      --notice:#fff3cd;
      --notice-text:#312500;
      --switch-on:#54d98c;
      --switch-off:#607086;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.45 system-ui,Segoe UI,Roboto,Pretendard,'Apple SD Gothic Neo',sans-serif;
    }

    /* header */
    .topbar{
      position:sticky;top:0;z-index:20;
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      padding:14px 20px;border-bottom:1px solid var(--line);
      background:linear-gradient(0deg,var(--panel),var(--panel-2));
    }
    .title{display:flex;gap:10px;align-items:center;font-weight:700;font-size:20px}
    .title i{filter:grayscale(.1)}
    .right{display:flex;gap:10px;align-items:center}
    .btn{background:var(--btn);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{background:var(--btn-ghost);color:#cfe0ff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .chip{padding:3px 9px;border-radius:999px;background:#22314a;color:#bcd2ff;font-size:12px}

    /* page container */
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}

    /* ì¹´ë“œ(íŒ¨ë„) */
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px; padding:14px 16px;
      margin-bottom:18px;
    }
    .card-head{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
    }
    .card-title{display:flex;gap:10px;align-items:center;font-weight:700}
    .muted{color:var(--text-dim)}

    /* ===== ê³µì§€(ì „ë‹¬ ì‚¬í•­) ===== */
    .notice-body{
      background:#0f1d2c; /* ì „ë‹¬ë°•ìŠ¤ ë°”íƒ• */
      border:1px dashed #39507a;
      border-radius:10px;padding:12px;
      color:#dfe9ff;
    }
    .notice-row{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      border-bottom:1px dashed #324a71;padding:10px 0;
    }
    .notice-row:last-child{border-bottom:none}
    .notice-main{display:flex;gap:12px;align-items:flex-start}
    .notice-dot{width:10px;height:10px;border-radius:50%;margin-top:7px}
    .dot-info{background:#6ab7ff}
    .dot-warn{background:#f0c56a}
    .dot-danger{background:#ff7171}
    .notice-title{font-weight:700}
    .notice-desc{color:#c6d6f3;margin-top:2px}
    .notice-actions{display:flex;gap:8px}

    /* ê³µì§€ ì¶”ê°€ í¼ (2ì¤„) */
    .add-notice{margin-top:12px}
    .row-top{display:flex;gap:8px;flex-wrap:wrap}
    .row-bottom{margin-top:8px}
    .row-top input,.row-top select{flex:1;min-width:160px}
    .row-bottom textarea{width:100%;min-height:80px;resize:vertical}

    input,select,textarea{
      background:#0f1928;border:1px solid #2a3d5f;color:var(--text);
      padding:10px;border-radius:10px;outline:none;
    }
    input::placeholder,textarea::placeholder{color:#7382a2}
    .add-right{display:flex;align-items:flex-start;gap:8px}

    /* ===== ì„¹ì…˜ ì¹´ë“œ ===== */
    .section{margin-top:22px}
    .section-head{display:flex;gap:10px;align-items:center;font-size:18px;font-weight:700;margin-bottom:10px}
    .section-body{display:block}
    .task-list{list-style:none;margin:0;padding:0}
    .task{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;border:1px solid var(--line);background:#0e1928;border-radius:12px;padding:12px;margin-bottom:10px}
    .task__left{display:flex;gap:12px;align-items:flex-start}
    .check{appearance:none;width:18px;height:18px;border-radius:4px;border:1px solid #51678f;background:#0d1726;margin-top:2px;cursor:pointer}
    .check:checked{background:#7aa2ff;border-color:#7aa2ff}
    .task__text b{display:block;font-size:17px}
    .sep{margin:0 6px;color:#6f85aa}
    .task__meta{margin-top:2px;color:#a8bad5}

    .dday{display:inline-block;font-weight:700;padding:4px 9px;border-radius:999px;font-size:12px;margin-left:6px;vertical-align:1px}
    .d-red{background:var(--badge-red);color:#fff}
    .d-orange{background:var(--badge-orange);color:#fff}
    .d-yellow{background:var(--badge-yellow);color:#211800}
    .d-green{background:var(--badge-green);color:#fff}
    .d-past{background:#44546a;color:#dfe9ff}

    .task-actions{display:flex;gap:8px}

    /* ì¶”ê°€ í¼: 2ì¤„ ë ˆì´ì•„ì›ƒ */
    .add-row{margin-top:10px;border:1px dashed #39507a;border-radius:10px;padding:10px}
    .add-row .row-top{display:flex;gap:8px;flex-wrap:wrap}
    .add-row .row-bottom{margin-top:8px}
    .add-row input,.add-row select{flex:1;min-width:140px}
    .add-row textarea{width:100%;min-height:72px;resize:vertical}

    .no-data{color:#93a7c7}

    /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
    .switch {position: relative;display:inline-block;width:56px;height:30px}
    .switch input {opacity: 0;width: 0;height: 0}
    .slider{
      position:absolute;cursor:pointer;inset:0;background:#384559;border-radius:999px;transition:.2s;
    }
    .slider:before{
      content:"";position:absolute;height:22px;width:22px;left:5px;top:4px;background:white;border-radius:50%;transition:.2s;
    }
    input:checked + .slider{background:var(--switch-on)}
    input:checked + .slider:before{transform:translateX(26px)}

    .hidden{display:none !important}
  </style>
</head>
<body>

  <!-- ===== Topbar ===== -->
  <header class="topbar">
    <div class="title"><i>ğŸ“’</i> ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</div>
    <div class="right">
      <span id="adminChip" class="chip hidden">ê´€ë¦¬ì</span>
      <button id="loginBtn" class="btn-ghost">ğŸ”‘ ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn hidden">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <main class="wrap">

    <!-- ===== ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ ===== -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</div>
        <label class="switch hidden" id="noticeSwitchWrap" title="í‘œì‹œ/ìˆ¨ê¹€(ê´€ë¦¬ì)">
          <input type="checkbox" id="noticeSwitch">
          <span class="slider"></span>
        </label>
      </div>

      <div class="notice-body" id="noticeList">
        <div class="no-data">ë“±ë¡ëœ ì „ë‹¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>

      <!-- ê³µì§€ ì¶”ê°€ (ê´€ë¦¬ìë§Œ ë³´ì„) -->
      <div class="add-notice hidden" id="noticeAddBox">
        <div class="row-top">
          <input type="text" id="nTitle" placeholder="ì œëª©" />
          <select id="nLevel">
            <option value="info">ì „ë‹¬</option>
            <option value="warn">ì£¼ì˜</option>
            <option value="danger">ê¸´ê¸‰</option>
          </select>
          <button id="addNotice" class="btn">+ ì¶”ê°€</button>
        </div>
        <div class="row-bottom">
          <textarea id="nDesc" placeholder="ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
        </div>
      </div>
    </section>

    <!-- ===== ì„¹ì…˜ë“¤ ===== -->
    <section class="section">
      <div class="section-head">ğŸ§ª ì‹œí—˜</div>
      <div class="section-body">
        <ul id="list_exam" class="task-list"></ul>

        <!-- ì‹œí—˜ ì¶”ê°€(2ì¤„) -->
        <div class="add-row hidden" data-cat="exam" id="row_exam">
          <div class="row-top">
            <input class="subj" type="text" placeholder="ê³¼ëª©" />
            <input class="text" type="text" placeholder="ë‚´ìš©" />
            <input class="date-start" type="date" />
            <input class="date-end" type="date" />
            <select class="period-start">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
            <select class="period-end">
              <option value="">ë êµì‹œ</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
            <button class="add btn">+ ì¶”ê°€</button>
          </div>
          <div class="row-bottom">
            <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-head">ğŸ“„ ìˆ˜í–‰í‰ê°€</div>
      <div class="section-body">
        <ul id="list_perf" class="task-list"></ul>

        <div class="add-row hidden" data-cat="perf" id="row_perf">
          <div class="row-top">
            <input class="subj" type="text" placeholder="ê³¼ëª©" />
            <input class="text" type="text" placeholder="ë‚´ìš©" />
            <input class="date-start" type="date" />
            <input class="date-end" type="date" />
            <select class="period-start">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
            <select class="period-end">
              <option value="">ë êµì‹œ</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
            <button class="add btn">+ ì¶”ê°€</button>
          </div>
          <div class="row-bottom">
            <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-head">ğŸ“Œ ìˆ™ì œ</div>
      <div class="section-body">
        <ul id="list_home" class="task-list"></ul>

        <div class="add-row hidden" data-cat="home" id="row_home">
          <div class="row-top">
            <input class="subj" type="text" placeholder="ê³¼ëª©" />
            <input class="text" type="text" placeholder="ë‚´ìš©" />
            <input class="date-start" type="date" />
            <input class="date-end" type="date" />
            <select class="period-start">
              <option value="">ì‹œì‘ êµì‹œ</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
            <select class="period-end">
              <option value="">ë êµì‹œ</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
            <button class="add btn">+ ì¶”ê°€</button>
          </div>
          <div class="row-bottom">
            <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- ===== Firebase SDK (compat) ===== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ===== App JS ===== -->
  <script>
  /* ========= í™˜ê²½ê°’ (ê¼­ êµì²´!) ========= */
  const ADMIN_UID  = "vv0bADtWdqQUnqFMy8k01dhO13t2";               // ê´€ë¦¬ì UID
  const PUBLIC_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";                 // ê³µê°œë¡œ ë³´ì—¬ì¤„ UID (ê´€ë¦¬ìì™€ ê°™ì•„ë„ OK)
  const firebaseConfig = {
    apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
    authDomain: "my-memo-site.firebaseapp.com",
    projectId: "my-memo-site",
    storageBucket: "my-memo-site.firebasestorage.app",
    messagingSenderId: "196036694705",
    appId: "1:196036694705:web:8988d12919420130464890"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // DOM
  const $ = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
  const el = {
    loginBtn:  $("#loginBtn"),
    logoutBtn: $("#logoutBtn"),
    adminChip: $("#adminChip"),

    // notices
    noticeList: $("#noticeList"),
    noticeAddBox: $("#noticeAddBox"),
    noticeSwitchWrap: $("#noticeSwitchWrap"),
    noticeSwitch: $("#noticeSwitch"),
    nTitle: $("#nTitle"),
    nLevel: $("#nLevel"),
    nDesc:  $("#nDesc"),
    addNoticeBtn: $("#addNotice"),

    // lists
    lists: { exam: $("#list_exam"), perf: $("#list_perf"), home: $("#list_home") },
    rows:  { exam: $("#row_exam"),  perf: $("#row_perf"),  home: $("#row_home")  },
  };

  let currentUser = null;
  const draftKey = (cat)=>`memo:draft:${cat}`;
  const noticeDraftKey = "memo:draft:notice";

  /* ========= ë¡œê·¸ì¸/ê¶Œí•œ ========= */
  function isAdmin(){ return currentUser && currentUser.uid === ADMIN_UID; }
  function viewingUid(){ return isAdmin() ? ADMIN_UID : PUBLIC_UID; }

  function updateAuthUI(){
    el.loginBtn.classList.toggle("hidden", !!currentUser);
    el.logoutBtn.classList.toggle("hidden", !currentUser);
    el.adminChip.classList.toggle("hidden", !isAdmin());

    // ê´€ë¦¬ìë©´ ì¶”ê°€/í† ê¸€ ë³´ì´ê¸°
    const adminMode = isAdmin();
    Object.values(el.rows).forEach(r => r.classList.toggle("hidden", !adminMode));
    el.noticeAddBox.classList.toggle("hidden", !adminMode);
    el.noticeSwitchWrap.classList.toggle("hidden", !adminMode);
  }

  el.loginBtn.onclick = async ()=>{
    try{
      await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }catch(e){ alert(e.message); }
  };
  el.logoutBtn.onclick = ()=>auth.signOut();

  auth.onAuthStateChanged(u=>{
    currentUser = u;
    updateAuthUI();
    attachAllListeners();          // ë¡œê·¸ì¸ ìƒíƒœê°€ ë°”ë€Œë©´ ë‹¤ì‹œ êµ¬ë…
    restoreDrafts();               // ì…ë ¥ê°’ ë³µì›
  });

  /* ========= D-day/í‘œì‹œ ========= */
  const W = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  function fmtDateYMD(d){ if(!d) return ""; const z=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
  function parseDate(s){ if(!s) return null; const [y,m,d] = s.split("-").map(Number); return new Date(y,(m-1),d); }
  function ddayBadge(dateEnd){
    if(!dateEnd) return "";
    const now = new Date(); now.setHours(0,0,0,0);
    const end = parseDate(dateEnd); if(!end) return "";
    const diff = Math.round((end-now)/(24*3600*1000));
    let cls='',label='';
    if(diff<0){ cls='d-past'; label=`A+${Math.abs(diff)}`; }
    else if(diff===0){ cls='d-red'; label='D-DAY'; }
    else if(diff<=1){ cls='d-red'; label=`D-${diff}`; }
    else if(diff<=3){ cls='d-orange'; label=`D-${diff}`; }
    else if(diff<=5){ cls='d-yellow'; label=`D-${diff}`; }
    else { cls='d-green'; label=`D-${diff}`; }
    return `<span class="dday ${cls}">${label}</span>`;
  }
  function dayLine(dateStart,dateEnd,pStart,pEnd){
    if(!dateStart) return "";
    const s = parseDate(dateStart);
    const e = dateEnd ? parseDate(dateEnd) : null;
    const toStr = d=>`${fmtDateYMD(d)} (${W[d.getDay()]})`;
    let t = toStr(s);
    if(e && fmtDateYMD(e)!==fmtDateYMD(s)) t += ` ~ ${toStr(e)}`;
    const ps = pStart? `${pStart}êµì‹œ`:"";
    const pe = pEnd? `${pEnd}êµì‹œ`:"";
    const p  = (ps||pe) ? ` ${ps}${(ps&&pe)?" ~ ":""}${pe}` : "";
    return `ğŸ“… ${t}${p}`;
  }

  /* ========= Firestore ê²½ë¡œ ========= */
  function taskCol(cat, uid=viewingUid()){
    return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
  }

  /* ========= ëª©ë¡ êµ¬ë… ========= */
  let unsubTasks = [];
  let unsubNotice = null, unsubSettings = null;

  function attachAllListeners(){
    // ê¸°ì¡´ êµ¬ë… í•´ì œ
    unsubTasks.forEach(f=>f && f());
    unsubTasks = [];
    if(unsubNotice) {unsubNotice();unsubNotice=null}
    if(unsubSettings){unsubSettings();unsubSettings=null}

    // notices í‘œì‹œ ì„¤ì • (settings/showNotices)
    unsubSettings = db.collection("settings").doc("flags").onSnapshot(snap=>{
      const flag = snap.exists ? !!snap.data().showNotices : true;
      el.noticeSwitch.checked = !!flag;
      // ê´€ë¦¬ì ì•„ë‹Œ ê²½ìš°ë„ ë°˜ì˜
      renderNoticeVisibility(flag);
    });

    // notices ì»¬ë ‰ì…˜
    unsubNotice = db.collection("notices").orderBy("createdAt","desc").onSnapshot(snap=>{
      const arr = []; snap.forEach(doc=>arr.push({id:doc.id,...doc.data()}));
      renderNotices(arr);
    }, err=>{
      console.error("notices listener:", err.message);
    });

    // tasks
    ["exam","perf","home"].forEach(cat=>{
      const u = taskCol(cat).orderBy("dueStart","asc").onSnapshot(snap=>{
        const data=[]; snap.forEach(d=>data.push({id:d.id,...d.data()}));
        renderList(cat,data);
      }, err=>{
        console.error("task listener:", err.message);
      });
      unsubTasks.push(u);
    });
  }

  function renderNoticeVisibility(flag){
    // flagê°€ falseë©´ ë³¸ë¬¸ì„ í¬ë¯¸í•˜ê²Œ
    el.noticeList.style.opacity = flag ? '1' : '.35';
  }

  function renderNotices(items){
    const box = el.noticeList;
    box.innerHTML = "";
    if(!items.length){
      box.innerHTML = `<div class="no-data">ë“±ë¡ëœ ì „ë‹¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }
    items.forEach(it=>{
      const row = document.createElement("div");
      row.className = "notice-row";

      const dotCls = it.level==="warn" ? "dot-warn" : (it.level==="danger" ? "dot-danger":"dot-info");

      row.innerHTML = `
        <div class="notice-main">
          <span class="notice-dot ${dotCls}"></span>
          <div>
            <div class="notice-title">${esc(it.title||"")}</div>
            ${it.desc ? `<div class="notice-desc">${br(esc(it.desc))}</div>` : ""}
          </div>
        </div>
        <div class="notice-actions ${isAdmin()?"":"hidden"}">
          <button class="btn-ghost" data-act="edit">ìˆ˜ì •</button>
          <button class="btn-ghost" data-act="del">ì‚­ì œ</button>
        </div>
      `;

      const btnArea = row.querySelector(".notice-actions");
      if(btnArea){
        btnArea.onclick = async (e)=>{
          const act = e.target.dataset.act;
          if(!act) return;
          if(act==="del"){
            if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
            await db.collection("notices").doc(it.id).delete();
          }else if(act==="edit"){
            const t = prompt("ì œëª©", it.title||""); if(t==null) return;
            const d = prompt("ë‚´ìš©(ì¤„ë°”ê¿ˆ ê°€ëŠ¥)", it.desc||""); if(d==null) return;
            const lv= prompt("ë ˆë²¨ (info|warn|danger)", it.level||"info") || "info";
            await db.collection("notices").doc(it.id).update({title:t,desc:d,level:lv});
          }
        }
      }

      box.appendChild(row);
    });
  }

  // ê³µì§€ ON/OFF ì €ì¥(ê´€ë¦¬ìë§Œ)
  el.noticeSwitch.onchange = async ()=>{
    if(!isAdmin()) return;
    try{
      await db.collection("settings").doc("flags").set({showNotices: el.noticeSwitch.checked},{merge:true});
    }catch(e){ alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: "+e.message); }
  };

  // ê³µì§€ ì¶”ê°€
  el.addNoticeBtn.onclick = async ()=>{
    if(!isAdmin()) return;
    const title = el.nTitle.value.trim();
    const desc  = el.nDesc.value.trim();
    const level = el.nLevel.value;
    if(!title){ alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
    try{
      await db.collection("notices").add({
        title, desc, level,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      // ì…ë ¥ê°’ ìœ ì§€ ì•ˆí• ê±°ë©´ ì´ê³³ì—ì„œ ë¹„ìš°ê¸°
      el.nTitle.value=""; el.nDesc.value=""; saveNoticeDraft();
    }catch(e){ alert("ì¶”ê°€ ì‹¤íŒ¨: "+e.message); }
  };

  /* ========= ëª©ë¡ ë Œë” ========= */
  function renderList(cat, items){
    const ul = el.lists[cat];
    ul.innerHTML = "";
    if(!items.length){
      ul.innerHTML = `<li class="no-data">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
      return;
    }
    for(const it of items){
      const li = document.createElement("li");
      li.className="task";
      li.innerHTML = `
        <div class="task__left">
          <input type="checkbox" class="check" data-id="${it.id}" ${it.done?'checked':''}>
          <div class="task__text">
            <b>${esc(it.subj||"")} ${ddayBadge(it.dueEnd)}</b>
            <div>${esc(it.text||"")}</div>
            <div class="task__meta">${dayLine(it.dueStart,it.dueEnd,it.pStart,it.pEnd)}</div>
            ${it.detail? `<div class="task__meta">${br(esc(it.detail))}</div>`:""}
          </div>
        </div>
        <div class="task-actions ${isAdmin()?'':'hidden'}">
          <button class="btn-ghost" data-act="edit">ìˆ˜ì •</button>
          <button class="btn-ghost" data-act="del">ì‚­ì œ</button>
        </div>
      `;
      // ì²´í¬/ì‚­ì œ/ìˆ˜ì •
      li.onclick = async (e)=>{
        const t = e.target;
        if(t.classList.contains("check")){
          if(!isAdmin()){ t.checked = !!it.done; return; }
          await taskCol(cat, ADMIN_UID).doc(it.id).update({done:t.checked});
          return;
        }
        const act = t.dataset.act;
        if(!act) return;
        if(!isAdmin()) return;

        if(act==="del"){
          if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
          await taskCol(cat, ADMIN_UID).doc(it.id).delete();
        }else if(act==="edit"){
          // ê°„í¸ ìˆ˜ì •
          const subj = prompt("ê³¼ëª©", it.subj||""); if(subj==null) return;
          const text = prompt("ë‚´ìš©", it.text||""); if(text==null) return;
          const dS   = prompt("ì‹œì‘ì¼(yyyy-mm-dd)", it.dueStart||""); if(dS==null) return;
          const dE   = prompt("ëì¼(yyyy-mm-dd)", it.dueEnd||""); if(dE==null) return;
          await taskCol(cat, ADMIN_UID).doc(it.id).update({subj,text,dueStart:dS,dueEnd:dE});
        }
      };

      ul.appendChild(li);
    }
  }

  /* ========= ì…ë ¥ í¼ (ì¶”ê°€) ========= */
  // ì…ë ¥ê°’ ìë™ì €ì¥/ë³µì›
  function saveDraft(cat){
    const row = el.rows[cat];
    const data = {
      subj: $(".subj",row).value,
      text: $(".text",row).value,
      dS:   $(".date-start",row).value,
      dE:   $(".date-end",row).value,
      pS:   $(".period-start",row).value,
      pE:   $(".period-end",row).value,
      det:  $(".detail",row).value,
    };
    localStorage.setItem(draftKey(cat), JSON.stringify(data));
  }
  function loadDraft(cat){
    try{
      const row = el.rows[cat];
      const raw = localStorage.getItem(draftKey(cat)); if(!raw) return;
      const d = JSON.parse(raw);
      $(".subj",row).value = d.subj||"";
      $(".text",row).value = d.text||"";
      $(".date-start",row).value = d.dS||"";
      $(".date-end",row).value = d.dE||"";
      $(".period-start",row).value = d.pS||"";
      $(".period-end",row).value = d.pE||"";
      $(".detail",row).value = d.det||"";
    }catch{}
  }
  function restoreDrafts(){
    ["exam","perf","home"].forEach(loadDraft);
    loadNoticeDraft();
  }
  function saveNoticeDraft(){
    const d = {title:el.nTitle.value, level:el.nLevel.value, desc:el.nDesc.value};
    localStorage.setItem(noticeDraftKey, JSON.stringify(d));
  }
  function loadNoticeDraft(){
    try{
      const d = JSON.parse(localStorage.getItem(noticeDraftKey)||"{}");
      el.nTitle.value = d.title||"";
      el.nLevel.value = d.level||"info";
      el.nDesc.value  = d.desc||"";
    }catch{}
  }

  // ì…ë ¥ ì´ë²¤íŠ¸ë¡œ ìë™ ì €ì¥
  ["exam","perf","home"].forEach(cat=>{
    el.rows[cat].addEventListener("input", ()=>saveDraft(cat));
    // ì¶”ê°€ ë²„íŠ¼
    $(".add", el.rows[cat]).onclick = async ()=>{
      if(!isAdmin()) { alert("ê´€ë¦¬ìë§Œ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”."); return; }
      const row = el.rows[cat];
      const subj = $(".subj",row).value.trim();
      const text = $(".text",row).value.trim();
      const dS   = $(".date-start",row).value||"";
      const dE   = $(".date-end",row).value||"";
      const pS   = $(".period-start",row).value||"";
      const pE   = $(".period-end",row).value||"";
      const det  = $(".detail",row).value||"";
      if(!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
      try{
        await taskCol(cat, ADMIN_UID).add({
          subj,text,detail:det, dueStart:dS,dueEnd:dE, pStart:pS,pEnd:pE,
          done:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // ë¹„ìš°ê³  ë‹¤ì‹œ ì €ì¥
        $(".subj",row).value=""; $(".text",row).value="";
        $(".date-start",row).value=""; $(".date-end",row).value="";
        $(".period-start",row).value=""; $(".period-end",row).value="";
        $(".detail",row).value="";
        saveDraft(cat);
      }catch(e){ alert("ì¶”ê°€ ì‹¤íŒ¨: "+e.message); }
    };
  });
  el.noticeAddBox.addEventListener("input", saveNoticeDraft);

  /* ========= ìœ í‹¸ ========= */
  function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function br(s){ return (s||"").replaceAll("\n","<br>"); }

  // ìµœì´ˆ êµ¬ë…/ì´ˆê¸°í™”
  attachAllListeners();
  restoreDrafts();
  </script>

</body>
</html>
