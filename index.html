<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="topbar">
  <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
  <div class="auth">
    <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<main class="container">

  <!-- ì¤‘ìš” ì „ë‹¬ ì‚¬í•­ (ê´€ë¦¬ì ON/OFF) -->
  <section id="noticeWrap" class="notice card">
    <div class="card-head">
      <div class="title">ğŸ“¢ ì¤‘ìš” ì „ë‹¬ ì‚¬í•­</div>
      <div class="actions">
        <label id="noticeToggleWrap" class="toggle" style="display:none">
          <input type="checkbox" id="noticeToggle">
          <span>í‘œì‹œ</span>
        </label>
      </div>
    </div>
    <div class="notice-body">
      <ul id="noticeList" class="notice-list"></ul>
      <div id="noticeForm" class="add-area" style="display:none">
        <div class="row">
          <input id="noticeTitle" class="input" placeholder="ì œëª©" />
          <select id="noticeTag" class="select">
            <option value="blue">ì „ë‹¬ ì‚¬í•­</option>
            <option value="yellow">ê³µì§€</option>
            <option value="red">ê¸´ê¸‰ ê³µì§€</option>
          </select>
          <button id="addNotice" class="btn primary">+ ì¶”ê°€</button>
        </div>
        <textarea id="noticeBody" class="textarea" placeholder="ë‚´ìš© (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
      </div>
    </div>
  </section>

  <!-- ì‹œí—˜ -->
  <section class="card">
    <div class="card-head">
      <div class="title">ğŸ§ª ì‹œí—˜</div>
    </div>
    <ul id="list_exam" class="task-list"></ul>

    <!-- ê´€ë¦¬ì ì „ìš© ì¶”ê°€ í–‰ -->
    <div id="add_exam" class="add-area" style="display:none">
      <div class="row">
        <input class="subj input" placeholder="ê³¼ëª©">
        <input class="text input grow" placeholder="ë‚´ìš©">
        <input class="date input" type="date">
        <input class="date input" type="date">
        <select class="sel start select"></select>
        <select class="sel end select"></select>
        <button class="btn primary add">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ˜í–‰í‰ê°€ -->
  <section class="card">
    <div class="card-head">
      <div class="title">ğŸ“„ ìˆ˜í–‰í‰ê°€</div>
    </div>
    <ul id="list_perf" class="task-list"></ul>

    <div id="add_perf" class="add-area" style="display:none">
      <div class="row">
        <input class="subj input" placeholder="ê³¼ëª©">
        <input class="text input grow" placeholder="ë‚´ìš©">
        <input class="date input" type="date">
        <input class="date input" type="date">
        <select class="sel start select"></select>
        <select class="sel end select"></select>
        <button class="btn primary add">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>

  <!-- ìˆ™ì œ -->
  <section class="card">
    <div class="card-head">
      <div class="title">ğŸ“Œ ìˆ™ì œ</div>
    </div>
    <ul id="list_home" class="task-list"></ul>

    <div id="add_home" class="add-area" style="display:none">
      <div class="row">
        <input class="subj input" placeholder="ê³¼ëª©">
        <input class="text input grow" placeholder="ë‚´ìš©">
        <input class="date input" type="date">
        <input class="date input" type="date">
        <select class="sel start select"></select>
        <select class="sel end select"></select>
        <button class="btn primary add">+ ì¶”ê°€</button>
      </div>
      <textarea class="detail textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
    </div>
  </section>
</main>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-head">
      <div class="title">í•­ëª© ìˆ˜ì •</div>
      <button class="icon-btn" id="closeEdit">âœ•</button>
    </div>

    <div class="row">
      <input id="editSubj" class="input" placeholder="ê³¼ëª©">
      <input id="editText" class="input grow" placeholder="ë‚´ìš©">
    </div>

    <div class="row">
      <input id="editStart" class="input" type="date">
      <input id="editEnd"   class="input" type="date">
      <select id="editStartPd" class="select"></select>
      <select id="editEndPd"   class="select"></select>
    </div>

    <textarea id="editDetail" class="textarea" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>

    <div class="modal-foot">
      <button id="saveEdit" class="btn primary">ì €ì¥</button>
      <button id="cancelEdit" class="btn">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "196036694705",
  appId: "1:196036694705:web:8988d12919420130464890"
};
firebase.initializeApp(firebaseConfig);

const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";  // ê³µê°œ UID
const auth = firebase.auth();
const db   = firebase.firestore();

/* ================= ê³µí†µ ìœ í‹¸ ================= */
const PERIODS = [
  { value: "", label: "êµì‹œ ì—†ìŒ" },
  { value: "0", label: "0êµì‹œ" },
  { value: "1", label: "1êµì‹œ" },
  { value: "2", label: "2êµì‹œ" },
  { value: "3", label: "3êµì‹œ" },
  { value: "4", label: "4êµì‹œ" },
  { value: "5", label: "5êµì‹œ" },
  { value: "6", label: "6êµì‹œ" },
  { value: "7", label: "7êµì‹œ" },
  { value: "8", label: "8êµì‹œ" }
];

function fillPeriodOptions(sel) {
  sel.innerHTML = "";
  PERIODS.forEach(p => {
    const o = document.createElement("option");
    o.value = p.value; o.textContent = p.label;
    sel.appendChild(o);
  });
}

function $ (q, root=document){ return root.querySelector(q); }
function $$ (q, root=document){ return Array.from(root.querySelectorAll(q)); }

const lists = {
  perf: $("#list_perf"),
  exam: $("#list_exam"),
  home: $("#list_home")
};

let currentUser = null;
let unsub = [];

/* D-day ë±ƒì§€ */
function ddayLabel(start, end) {
  if(!start) return "";
  const base = new Date();
  base.setHours(0,0,0,0);
  const s = new Date(start);
  s.setHours(0,0,0,0);
  let diff = Math.round((s - base) / 86400000);
  // ì§€ë‚¨: A+n
  if (diff < 0) {
    const a = Math.abs(diff);
    return `<span class="dday past">A+${a}</span>`;
  }
  // ì˜¤ëŠ˜
  if (diff === 0) return `<span class="dday warn">D-DAY</span>`;
  // ë¯¸ë˜: ìƒ‰ ë‹¨ê³„
  let cls = "far";
  if (diff <= 2) cls = "urgent";
  else if (diff <= 3) cls = "soon";
  else if (diff <= 5) cls = "near";
  return `<span class="dday ${cls}">D-${diff}</span>`;
}

function weekdayStr(dateStr){
  if(!dateStr) return "";
  const d = new Date(dateStr + "T00:00:00");
  const w = "ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† "[d.getDay()];
  return `(${w})`;
}

/* ================= ë Œë” ================= */
function renderOne(cat, it){
  const li = document.createElement("li");
  li.className = "task";
  const pd = (it.startPd || it.endPd) ? `${it.startPd || ""}${it.endPd ? " ~ " + it.endPd : ""}êµì‹œ` : "";
  const dateLine = it.start ? `ğŸ“… ${it.start} ${weekdayStr(it.start)}${it.end ? " ~ " + it.end + " " + weekdayStr(it.end) : ""} ${pd}` : "";
  li.innerHTML = `
    <label class="chk"><input type="checkbox" data-cat="${cat}" data-id="${it.id}"><span></span></label>
    <div class="main">
      <div class="line1">
        <b class="subject">${it.subj || ""}</b>
        ${ddayLabel(it.start, it.end)}
      </div>
      <div class="line2">${(it.text || "").replace(/\n/g,"<br>")}</div>
      ${it.detail ? `<div class="line3">${it.detail.replace(/\n/g,"<br>")}</div>`: ""}
      ${dateLine ? `<div class="meta">${dateLine}</div>` : ""}
    </div>
    <div class="ops" style="${currentUser && currentUser.uid===OWNER_UID?'':'display:none'}">
      <button class="btn ghost edit" data-cat="${cat}" data-id="${it.id}">ìˆ˜ì •</button>
      <button class="btn ghost del"  data-cat="${cat}" data-id="${it.id}">ì‚­ì œ</button>
    </div>
  `;

  // ì²´í¬ë°•ìŠ¤: ì™„ë£Œ í† ê¸€(X) ëŒ€ì‹ , ë¡œê·¸ì¸ ì•ˆë‚´ë§Œ(ì› ìš”ì²­ì— ë”°ë¼ ì™„ë£Œ ê¸°ëŠ¥ ì œì™¸/ë³´ë¥˜)
  $(".chk input", li).addEventListener("change", e=>{
    if(!currentUser || currentUser.uid!==OWNER_UID){
      alert("ìˆ˜ì •/ì‚­ì œ/ì™„ë£Œ ì²´í¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      e.target.checked = false;
    }
  });

  // ìˆ˜ì •
  $(".edit", li)?.addEventListener("click", ()=> openEdit(cat, it));
  // ì‚­ì œ
  $(".del", li)?.addEventListener("click", async ()=>{
    if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    try{
      await col(cat).doc(it.id).delete();
    }catch(err){ alert("ì‚­ì œ ì‹¤íŒ¨: "+err.message); }
  });

  return li;
}

function renderList(cat, arr){
  const ul = lists[cat];
  ul.innerHTML = "";
  arr.forEach(it => ul.appendChild(renderOne(cat, it)));
}

/* ================= Firestore ê²½ë¡œ ================= */
function userForRead(){
  return (currentUser && currentUser.uid===OWNER_UID) ? OWNER_UID : OWNER_UID; // ê³µê°œìš©: í•­ìƒ OWNER ì½ê¸°
}
function userForWrite(){
  return (currentUser && currentUser.uid===OWNER_UID) ? OWNER_UID : null;
}

function col(cat){
  const uid = userForRead();
  return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
}

/* ================= ì‹¤ì‹œê°„ êµ¬ë… ================= */
function startListen(){
  unsub.forEach(u=>u&&u()); unsub=[];
  ["exam","perf","home"].forEach(cat=>{
    const u = col(cat).orderBy("start","asc").onSnapshot(snap=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      renderList(cat, arr);
    }, err=>console.error(err));
    unsub.push(u);
  });

  // ê³µì§€ + ì„¤ì •
  const ncol = db.collection("users").doc(OWNER_UID).collection("notice");
  const u1 = ncol.orderBy("createdAt","desc").onSnapshot(s=>{
    const arr=[]; s.forEach(d=>arr.push({id:d.id, ...d.data()}));
    renderNotice(arr);
  });
  unsub.push(u1);

  const setdoc = db.collection("users").doc(OWNER_UID).collection("settings").doc("ui");
  const u2 = setdoc.onSnapshot(d=>{
    const on = !!(d.exists && d.data().noticeOn);
    $("#noticeToggle").checked = on;
    $("#noticeWrap").style.display = on ? "" : "none";
  });
  unsub.push(u2);
}

/* ================= Notice ================= */
function renderNotice(items){
  const ul = $("#noticeList");
  ul.innerHTML = "";
  items.forEach(it=>{
    const li = document.createElement("li");
    li.className = `note ${it.tag||"blue"}`;
    li.innerHTML = `
      <div class="note-title">${(it.title||"").replace(/\n/g,"<br>")}</div>
      ${it.body ? `<div class="note-body">${it.body.replace(/\n/g,"<br>")}</div>`:""}
      <div class="note-ops" style="${currentUser && currentUser.uid===OWNER_UID?'':'display:none'}">
        <button class="btn ghost" data-id="${it.id}" data-act="edit">ìˆ˜ì •</button>
        <button class="btn ghost" data-id="${it.id}" data-act="del">ì‚­ì œ</button>
      </div>
    `;
    ul.appendChild(li);

    $(".note-ops [data-act='del']", li)?.addEventListener("click", async ()=>{
      if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      await db.collection("users").doc(OWNER_UID).collection("notice").doc(it.id).delete();
    });
    $(".note-ops [data-act='edit']", li)?.addEventListener("click", async ()=>{
      $("#noticeTitle").value = it.title || "";
      $("#noticeBody").value  = it.body  || "";
      $("#noticeTag").value   = it.tag   || "blue";
      $("#addNotice").dataset.edit = it.id;
      $("#noticeForm").scrollIntoView({behavior:"smooth", block:"center"});
    });
  });
}

/* ================= ì¶”ê°€ í–‰ ë°”ì¸ë”© ================= */
function fillAllAddRows(){
  ["add_exam","add_perf","add_home"].forEach(id=>{
    const wrap = $("#"+id);
    // êµì‹œ select ì±„ìš°ê¸°
    $$(".sel.start", wrap).forEach(fillPeriodOptions);
    $$(".sel.end", wrap).forEach(fillPeriodOptions);

    // ì¶”ê°€
    $(".add", wrap).onclick = async ()=>{
      if(!currentUser || currentUser.uid!==OWNER_UID){ alert("ê´€ë¦¬ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }
      const subj = $(".subj", wrap).value.trim();
      const text = $(".text", wrap).value.trim();
      const start= $(".date", wrap)?.value || "";
      const end  = $$(".date", wrap)?.[1]?.value || "";
      const startPd = $(".sel.start", wrap).value;
      const endPd   = $(".sel.end", wrap).value;
      const detail  = $(".detail", wrap).value.trim();
      if(!subj || !text || !start){ alert("ê³¼ëª©/ë‚´ìš©/ì‹œì‘ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
      const cat = id.split("_")[1];
      try{
        await col(cat).add({
          subj, text, detail,
          start, end,
          startPd, endPd,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        $(".subj", wrap).value = "";
        $(".text", wrap).value = "";
        $(".date", wrap).value = "";
        $$(".date", wrap)[1].value = "";
        $(".sel.start", wrap).value = "";
        $(".sel.end", wrap).value = "";
        $(".detail", wrap).value = "";
      }catch(e){ alert("ì¶”ê°€ ì‹¤íŒ¨: "+e.message); }
    };
  });
}

/* ================= ìˆ˜ì • ëª¨ë‹¬ ================= */
let editCtx = null;
function openEdit(cat, it){
  editCtx = {cat, id: it.id};
  $("#editSubj").value = it.subj || "";
  $("#editText").value = it.text || "";
  $("#editStart").value = it.start || "";
  $("#editEnd").value   = it.end   || "";
  fillPeriodOptions($("#editStartPd"));
  fillPeriodOptions($("#editEndPd"));
  $("#editStartPd").value = it.startPd || "";
  $("#editEndPd").value   = it.endPd   || "";
  $("#editDetail").value  = it.detail  || "";
  $("#editModal").setAttribute("aria-hidden","false");
}
function closeEdit(){
  $("#editModal").setAttribute("aria-hidden","true");
  editCtx = null;
}
$("#closeEdit").onclick = closeEdit;
$("#cancelEdit").onclick = closeEdit;

$("#saveEdit").onclick = async ()=>{
  if(!editCtx) return;
  if(!currentUser || currentUser.uid!==OWNER_UID){ alert("ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”."); return; }
  const data = {
    subj: $("#editSubj").value.trim(),
    text: $("#editText").value.trim(),
    start: $("#editStart").value,
    end: $("#editEnd").value,
    startPd: $("#editStartPd").value,
    endPd: $("#editEndPd").value,
    detail: $("#editDetail").value.trim(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    await col(editCtx.cat).doc(editCtx.id).update(data);
    closeEdit();
  }catch(e){ alert("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
};

document.addEventListener("keydown", e=>{
  if(e.key==="Escape") closeEdit();
});

/* ================= ë¡œê·¸ì¸/ì„¤ì • ================= */
$("#loginBtn").onclick = async ()=>{
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  }catch(e){ alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message); }
};
$("#logoutBtn").onclick = ()=> auth.signOut();

auth.onAuthStateChanged(user=>{
  currentUser = user;
  $("#loginBtn").style.display  = user ? "none" : "";
  $("#logoutBtn").style.display = user ? "" : "none";

  // ê´€ë¦¬ì ì „ìš© UI
  const isAdmin = !!(user && user.uid===OWNER_UID);
  ["add_exam","add_perf","add_home"].forEach(id=>{
    $("#"+id).style.display = isAdmin ? "" : "none";
  });
  $("#noticeForm").style.display = isAdmin ? "" : "none";
  $("#noticeToggleWrap").style.display = isAdmin ? "" : "none";
  $$(".ops").forEach(op=>op.style.display = isAdmin ? "" : "none");

  startListen();
  fillAllAddRows();
});

/* ================= Notice ì €ì¥/ONOFF ================= */
$("#addNotice").onclick = async ()=>{
  if(!currentUser || currentUser.uid!==OWNER_UID){ alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥"); return; }
  const title = $("#noticeTitle").value.trim();
  const body  = $("#noticeBody").value.trim();
  const tag   = $("#noticeTag").value;
  if(!title){ alert("ì œëª©ì€ í•„ìˆ˜"); return; }
  const ref = db.collection("users").doc(OWNER_UID).collection("notice");
  try{
    const editId = $("#addNotice").dataset.edit;
    if(editId){
      await ref.doc(editId).update({ title, body, tag, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      delete $("#addNotice").dataset.edit;
    }else{
      await ref.add({ title, body, tag, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
    $("#noticeTitle").value=""; $("#noticeBody").value="";
  }catch(e){ alert("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
};

$("#noticeToggle").onchange = async e=>{
  if(!currentUser || currentUser.uid!==OWNER_UID){ e.target.checked=!e.target.checked; return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥"); }
  try{
    await db.collection("users").doc(OWNER_UID).collection("settings").doc("ui")
      .set({ noticeOn: e.target.checked }, { merge:true });
  }catch(err){ alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: "+err.message); }
};

/* ================= 1ë¶„ ì¡°ìš© ê°±ì‹  ================= */
setInterval(()=> startListen(), 60*1000);
</script>
</body>
</html>
