<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="admin-bar">
    <h1>📒 숙제 & 수행평가</h1>
    <div class="auth">
      <button id="loginBtn" class="btn">🔑 Google 로그인</button>
      <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
      <span id="adminBadge" class="admin-badge" style="display:none;">관리자</span>
    </div>
  </header>

  <main class="container">

    <!-- ========== 중요 전달 사항 ========== -->
    <section class="block">
      <div class="block-head">
        <h2>📢 중요 전달 사항</h2>
        <label class="switch" title="관리자만 변경 가능">
          <input type="checkbox" id="noticeToggle" />
          <span class="slider"></span>
        </label>
      </div>

      <!-- 관리자 전용 입력 폼 (두 줄 레이아웃) -->
      <div id="noticeForm" class="notice-form" style="display:none">
        <div class="row row-1">
          <input id="noticeTitle" class="input" placeholder="제목" />
          <select id="noticeLevel" class="input">
            <option value="알림">알림</option>
            <option value="주의">주의</option>
            <option value="긴급">긴급</option>
          </select>
          <button id="noticeAddBtn" class="btn primary">+ 추가</button>
        </div>
        <div class="row row-2">
          <textarea id="noticeBody" class="input" rows="3" placeholder="상세 내용 (줄바꿈 가능)"></textarea>
        </div>
      </div>

      <!-- 목록 -->
      <ul id="noticeList" class="list"></ul>
      <div id="noticeEmpty" class="empty">등록된 전달 사항이 없습니다.</div>
    </section>

    <!-- ====== 아래는 예시의 일반 섹션(시험/수행/숙제) 자리 ====== -->
    <!-- 필요 시 사용하던 섹션 코드를 이어 붙여 사용하세요 -->

  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ---------- Firebase 초기화 ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ---------- 고정 상수 ----------
    // (반드시 네 계정에 맞게 바꿔주세요!)
    const ADMIN_UID  = "vv0bADtWdqQUnqFMy8k01dhO13t2";     // 관리자 UID
    const PUBLIC_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // 공개 조회용 UID (로그아웃 상태 읽기용으로 쓰는 UID)

    // ---------- DOM ----------
    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const loginBtn   = $("#loginBtn");
    const logoutBtn  = $("#logoutBtn");
    const adminBadge = $("#adminBadge");

    const noticeToggle = $("#noticeToggle");
    const noticeForm   = $("#noticeForm");
    const noticeList   = $("#noticeList");
    const noticeEmpty  = $("#noticeEmpty");

    const noticeTitle  = $("#noticeTitle");
    const noticeLevel  = $("#noticeLevel");
    const noticeBody   = $("#noticeBody");
    const noticeAddBtn = $("#noticeAddBtn");

    // ---------- 상태 ----------
    let currentUser = null;
    let isAdmin = false;
    let noticeUnsub = null;       // 공지 목록 리스너
    let settingUnsub = null;      // 표시 설정 리스너

    // ---------- 유틸 ----------
    function toast(msg){ alert(msg); }
    function byCreatedDesc(a,b){ return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0); }

    // ---------- 인증 UI ----------
    loginBtn.onclick = async () => {
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      } catch(e){ toast(e.message); }
    };
    logoutBtn.onclick = () => auth.signOut();

    // ---------- 관리자 여부에 따른 UI ----------
    function syncAdminUI() {
      isAdmin = !!(currentUser && currentUser.uid === ADMIN_UID);
      adminBadge.style.display = isAdmin ? "" : "none";
      loginBtn.style.display   = currentUser ? "none" : "";
      logoutBtn.style.display  = currentUser ? "" : "none";

      // 폼/토글 권한
      noticeForm.style.display = isAdmin ? "" : "none";
      noticeToggle.disabled    = !isAdmin;

      // 버튼 비활성화 방지
      noticeAddBtn.disabled = !isAdmin ? true : false;
      noticeAddBtn.style.pointerEvents = isAdmin ? "auto" : "none";
    }

    // ---------- 공지 설정(표시 여부) 리스너 ----------
    function listenNoticeSetting(){
      if(settingUnsub) settingUnsub();
      settingUnsub = db.collection("settings").doc("notice").onSnapshot(snap=>{
        const data = snap.exists ? snap.data() : { enabled: true };
        noticeToggle.checked = !!data.enabled;
      }, err=>console.error(err));
    }

    // 토글 변경 (관리자만)
    noticeToggle.addEventListener("change", async (e)=>{
      if(!isAdmin){
        // 비관리자는 토글만 원복
        const snap = await db.collection("settings").doc("notice").get();
        noticeToggle.checked = snap.exists ? !!snap.data().enabled : false;
        toast("표시 여부는 관리자만 변경할 수 있어요.");
        return;
      }
      try {
        await db.collection("settings").doc("notice").set({
          enabled: !!e.target.checked,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      } catch(err){
        console.error(err);
        toast("설정 저장 실패: " + err.message);
      }
    });

    // ---------- 공지 목록 리스너 ----------
    function listenNotices(){
      if(noticeUnsub) noticeUnsub();
      noticeUnsub = db.collection("notices").orderBy("createdAt","desc").onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        renderNotices(arr);
      }, err=>console.error(err));
    }

    // ---------- 공지 렌더 ----------
    function renderNotices(items){
      noticeList.innerHTML = "";
      if(items.length === 0){
        noticeEmpty.style.display = "";
        return;
      }
      noticeEmpty.style.display = "none";

      for(const it of items){
        const li = document.createElement("li");
        li.className = "notice-item";
        li.innerHTML = `
          <div class="line">
            <b class="title">${escapeHtml(it.title || "")}</b>
            <span class="pill pill-${levelToClass(it.level)}">${it.level||"알림"}</span>
          </div>
          <div class="body">${escapeHtml(it.body||"").replace(/\n/g,"<br>")}</div>
          <div class="actions" style="display:${isAdmin?'flex':'none'}">
            <button class="btn ghost" data-act="edit">수정</button>
            <button class="btn ghost danger" data-act="del">삭제</button>
          </div>
        `;
        // 편집/삭제
        li.addEventListener("click", async (e)=>{
          const act = e.target?.getAttribute?.("data-act");
          if(!act) return;
          if(!isAdmin){ toast("관리자만 가능합니다."); return; }

          if(act === "del"){
            if(!confirm("삭제할까요?")) return;
            try{ await db.collection("notices").doc(it.id).delete(); }
            catch(err){ toast("삭제 실패: "+err.message); }
          }else if(act === "edit"){
            // 간단한 프롬프트 기반 수정 (필요시 모달로 바꿔도 됨)
            const t = prompt("제목", it.title || "");
            if(t === null) return;
            const b = prompt("상세 내용 (줄바꿈 가능)", it.body || "");
            if(b === null) return;
            const lvl = prompt("레벨(알림/주의/긴급)", it.level || "알림") || "알림";
            try{
              await db.collection("notices").doc(it.id).set({
                title: t.trim(),
                body: b,
                level: lvl.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
            }catch(err){ toast("수정 실패: "+err.message); }
          }
        });
        noticeList.appendChild(li);
      }
    }

    // ---------- 공지 추가 ----------
    noticeAddBtn.addEventListener("click", async ()=>{
      if(!isAdmin){ toast("관리자만 추가할 수 있어요."); return; }

      const title = (noticeTitle.value||"").trim();
      const level = (noticeLevel.value||"알림").trim();
      const body  = (noticeBody.value||"").trim();

      if(!title){ noticeTitle.focus(); return; }

      try{
        await db.collection("notices").add({
          title, level, body,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser?.uid || ADMIN_UID
        });
        // 입력 유지 원하면 주석 처리
        noticeTitle.value = "";
        noticeBody.value = "";
      }catch(err){
        console.error(err); toast("추가 실패: "+err.message);
      }
    });

    // ---------- HTML escape ----------
    function escapeHtml(s){
      return (s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }
    function levelToClass(lv){
      if(lv==="긴급") return "red";
      if(lv==="주의") return "orange";
      return "blue"; // 알림
    }

    // ---------- 인증 상태 ----------
    auth.onAuthStateChanged(user=>{
      currentUser = user || null;
      syncAdminUI();
      // 리스너들 시작
      listenNoticeSetting();
      listenNotices();
    });

    // ---------- 1분마다 조용히 새로고침 ----------
    setInterval(()=>{
      // 캐시 깨지지 않게 re-fetch 목적의 얕은 호출
      // 실제 전체 리로드가 필요하면: location.reload()
      if(document.hidden) return; // 백그라운드일 땐 생략
      // noop: 실시간 onSnapshot으로 충분하므로 굳이 재호출 불필요
    }, 60000);
  </script>
</body>
</html>
