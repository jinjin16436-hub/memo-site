<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€ </title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ë°” -->
  <header class="admin-bar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <button id="loginBtn" class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <!-- ë³¸ë¬¸ -->
  <main class="container">
    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_perf')">ğŸ“„ ìˆ˜í–‰í‰ê°€ â–¾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>
        <div class="add-row" data-cat="perf" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">
            <option value="">ì‹œì‘ êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <select class="endPeriod">
            <option value="">ë êµì‹œ</option>
            <option value="1">1êµì‹œ</option><option value="2">2êµì‹œ</option>
            <option value="3">3êµì‹œ</option><option value="4">4êµì‹œ</option>
            <option value="5">5êµì‹œ</option><option value="6">6êµì‹œ</option>
            <option value="7">7êµì‹œ</option>
          </select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_exam')">ğŸ§ª ì‹œí—˜ â–¾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>
        <div class="add-row" data-cat="exam" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">â€¦(ê°™ìŒ)â€¦</select>
          <select class="endPeriod">â€¦(ê°™ìŒ)â€¦</select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section>
      <button class="section-head" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>
        <div class="add-row" data-cat="home" style="display:none">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©" />
          <input class="date" type="date" />
          <input class="date2" type="date" />
          <select class="startPeriod">â€¦</select>
          <select class="endPeriod">â€¦</select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.appspot.com",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);

    const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2";
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    let currentUser = null;

    function toggleSection(id){ $("#"+id).classList.toggle("open"); }

    const col = (cat) => {
      const uid = (currentUser && currentUser.uid) ? currentUser.uid : OWNER_UID;
      return db.collection("users").doc(uid)
               .collection("tasks").doc(cat).collection("items");
    };

    function renderList(cat, items){
      const ul = $("#list_"+cat); ul.innerHTML="";
      items.forEach(it=>{
        const d1 = it.due||"", d2 = it.due2||"", dayStr = d1?(d2?`${d1} ~ ${d2}`:d1):"";
        const week = d1?`(${["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date(d1).getDay()]})`:"";
        const period = it.startP? `${it.startP}${it.endP?`~${it.endP}`:""}êµì‹œ` : "";
        const detail = it.detail? `<div class="detail">${esc(it.detail)}</div>`:"";
        const dday = getDday(d1);

        const li = document.createElement("li");
        li.className="task"+(it.done?" done":"");
        li.innerHTML=`
          <label class="chk-wrap"><input type="checkbox" ${it.done?"checked":""} data-act="toggle" data-id="${it.id}" data-cat="${cat}"><span></span></label>
          <div class="task__main">
            <div class="task__line"><b>${esc(it.subj)}</b></div>
            <div>${esc(it.text)}</div>
            <div class="task__meta">ğŸ“… ${dayStr} ${week} ${period} ${dday}</div>
            ${detail}
          </div>
          <button class="btn-ghost" data-act="edit" data-id="${it.id}" data-cat="${cat}">ìˆ˜ì •</button>
          <button class="btn-ghost" data-act="del" data-id="${it.id}" data-cat="${cat}">ì‚­ì œ</button>
        `;
        ul.appendChild(li);
      });
    }

    function getDday(dateStr){
      if(!dateStr) return "";
      const diff = Math.floor((new Date(dateStr)-new Date())/86400000);
      let color="green";
      if(diff<=1) color="red"; else if(diff<=3) color="orange"; else if(diff<=5) color="gold"; else color="limegreen";
      return `<span style="background:${color};padding:2px 6px;border-radius:6px;font-weight:bold">D-${diff}</span>`;
    }

    function esc(s){return (s||"").replaceAll("<","&lt;").replaceAll(">","&gt;");}

    // Firestore ë¦¬ìŠ¤ë„ˆ
    function startListeners(){
      ["perf","exam","home"].forEach(cat=>{
        col(cat).orderBy("due","asc").onSnapshot(snap=>{
          const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
          renderList(cat,arr);
        });
      });
    }

    // ì¶”ê°€
    function bindAddRows(){
      $$(".add-row").forEach(row=>{
        $(".add",row).onclick=async()=>{
          if(!currentUser) return alert("ë¡œê·¸ì¸ í›„ ì¶”ê°€ ê°€ëŠ¥");
          const subj=$(".subj",row).value.trim(),
                text=$(".text",row).value.trim(),
                due=$(".date",row).value,
                due2=$(".date2",row).value,
                startP=$(".startPeriod",row).value,
                endP=$(".endPeriod",row).value,
                detail=$(".detail",row).value;
          if(!subj||!text) return alert("ê³¼ëª©/ë‚´ìš© ì…ë ¥");
          await col(row.dataset.cat).add({subj,text,due,due2,startP,endP,detail,done:false,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
        };
      });
    }

    // ì²´í¬/ì‚­ì œ/ìˆ˜ì •
    document.body.addEventListener("click",async e=>{
      const t=e.target, act=t.dataset.act;
      if(!act) return;
      const cat=t.dataset.cat, id=t.dataset.id;
      if(act==="toggle"){
        if(!currentUser){alert("ë¡œê·¸ì¸ í•„ìš”"); t.checked=!t.checked; return;}
        await col(cat).doc(id).update({done:t.checked});
      }else if(act==="del"){
        if(!currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”");
        await col(cat).doc(id).delete();
      }else if(act==="edit"){
        alert("âœ ìˆ˜ì • ê¸°ëŠ¥ì€ ì—¬ê¸°ì„œ ì´ì–´ì„œ êµ¬í˜„í•  ìˆ˜ ìˆì–´ìš” (í¼ ì±„ìš°ê¸°/ì €ì¥).");
      }
    });

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    $("#loginBtn").onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    $("#logoutBtn").onclick=()=>auth.signOut();
    auth.onAuthStateChanged(u=>{
      currentUser=u;
      $("#loginBtn").style.display=u?"none":"";
      $("#logoutBtn").style.display=u?"":"none";
    });

    bindAddRows();
    startListeners();
  </script>
</body>
</html>
