<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>부광고 1-1 숙제 & 수행평가</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="topbar">
  <h1>📒 숙제 & 수행평가</h1>
  <div class="auth-area">
    <button id="adminBadge" class="badge admin" style="display:none">관리자</button>
    <button id="loginBtn"  class="btn">🔑 로그인</button>
    <button id="logoutBtn" class="btn" style="display:none">🚪 로그아웃</button>
  </div>
</header>

<main class="container">

  <!-- 중요 전달 사항 -->
  <section class="panel">
    <div class="panel-head">
      <h2>📣 중요 전달 사항</h2>
      <label class="switch" title="표시/숨김(관리자만)">
        <input type="checkbox" id="noticeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <div id="noticeWrap" class="notice-wrap">
      <p class="muted">등록된 전달 사항이 없습니다.</p>
    </div>

    <div id="noticeEditor" class="notice-editor" style="display:none">
      <div class="row">
        <input id="noticeTitle" class="input" placeholder="제목" />
        <select id="noticeTone" class="select">
          <option value="yellow">전달 사항</option>
          <option value="orange">주의</option>
          <option value="red">긴급</option>
          <option value="green">안내</option>
          <option value="blue">정보</option>
        </select>
        <button id="noticeAdd" class="btn add">+ 추가</button>
      </div>
      <textarea id="noticeBody" class="textarea" placeholder="내용 (줄바꿈 가능)"></textarea>
    </div>
  </section>

  <!-- 시험 -->
  <section class="panel">
    <div class="panel-head"><h2>🧪 시험</h2></div>
    <ul id="list_exam" class="task-list"></ul>
    <div class="add-row" data-cat="exam">
      <div class="grid">
        <input class="subj input" placeholder="과목" />
        <input class="text input" placeholder="내용" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="endPeriod select">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <button class="add btn">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 수행평가 -->
  <section class="panel">
    <div class="panel-head"><h2>🧾 수행평가</h2></div>
    <ul id="list_perf" class="task-list"></ul>
    <div class="add-row" data-cat="perf">
      <div class="grid">
        <input class="subj input" placeholder="과목" />
        <input class="text input" placeholder="내용" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="endPeriod select">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <button class="add btn">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

  <!-- 숙제 -->
  <section class="panel">
    <div class="panel-head"><h2>📌 숙제</h2></div>
    <ul id="list_home" class="task-list"></ul>
    <div class="add-row" data-cat="home">
      <div class="grid">
        <input class="subj input" placeholder="과목" />
        <input class="text input" placeholder="내용" />
        <input class="dateStart input" type="date" />
        <input class="dateEnd input" type="date" />
        <select class="startPeriod select">
          <option value="">시작 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <select class="endPeriod select">
          <option value="">끝 교시</option>
          <option>1교시</option><option>2교시</option><option>3교시</option>
          <option>4교시</option><option>5교시</option><option>6교시</option>
          <option>7교시</option><option>8교시</option>
        </select>
        <button class="add btn">+ 추가</button>
      </div>
      <textarea class="detail textarea" placeholder="상세 내용 (선택)"></textarea>
    </div>
  </section>

</main>

<!-- 수정 모달 -->
<div id="editModal" class="modal" style="display:none">
  <div class="modal-body">
    <h3>항목 수정</h3>
    <div class="grid">
      <input id="editSubj"  class="input" />
      <input id="editText"  class="input" />
      <input id="editStart" class="input" type="date" />
      <input id="editEnd"   class="input" type="date" />
      <select id="editStartPeriod" class="select">
        <option value="">시작 교시</option>
        <option>1교시</option><option>2교시</option><option>3교시</option>
        <option>4교시</option><option>5교시</option><option>6교시</option>
        <option>7교시</option><option>8교시</option>
      </select>
      <select id="editEndPeriod" class="select">
        <option value="">끝 교시</option>
        <option>1교시</option><option>2교시</option><option>3교시</option>
        <option>4교시</option><option>5교시</option><option>6교시</option>
        <option>7교시</option><option>8교시</option>
      </select>
    </div>
    <textarea id="editDetail" class="textarea" placeholder="상세 내용 (선택)"></textarea>

    <div class="right">
      <button id="editCancel" class="btn light">취소</button>
      <button id="editSave"   class="btn">저장</button>
    </div>
  </div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ========= 1) Firebase 설정 ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
  authDomain: "my-memo-site.firebaseapp.com",
  projectId: "my-memo-site",
  storageBucket: "my-memo-site.firebasestorage.app",
  messagingSenderId: "196036694705",
  appId: "1:196036694705:web:8988d12919420130464890"
};
// 반드시 본인 값으로 교체
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db   = firebase.firestore();

/* ========= 2) 고정 UID ========= */
// 관리자 UID와 공개 읽기용 UID
const ADMIN_UID  = "vv0bADtWdqQUnqFMy8k01dhO13t2";      // 관리자 계정 uid
const PUBLIC_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // 비로그인/일반 사용자에게 보여줄 데이터의 uid

/* ========= 3) 전역 상태 ========= */
let currentUser = null;
let isAdmin     = false;
const lists = { exam: document.getElementById('list_exam'),
                perf: document.getElementById('list_perf'),
                home: document.getElementById('list_home') };

let unsub = []; // snapshot 해제

/* ========= 4) 로그인/로그아웃 ========= */
document.getElementById('loginBtn').onclick = async () => {
  try {
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  } catch(e) { alert("로그인 실패: " + e.message); }
};
document.getElementById('logoutBtn').onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
  currentUser = user;
  isAdmin     = !!(user && user.uid === ADMIN_UID);

  document.getElementById('loginBtn').style.display  = user ? "none" : "";
  document.getElementById('logoutBtn').style.display = user ? "" : "none";
  document.getElementById('adminBadge').style.display = isAdmin ? "" : "none";

  // 관리자만 추가/수정/삭제 UI 노출
  document.querySelectorAll('.add-row').forEach(r => r.style.display = isAdmin ? "" : "none");
  document.getElementById('noticeEditor').style.display = isAdmin ? "" : "none";
  document.querySelectorAll('.task-list .op').forEach(btn => btn.style.display = isAdmin ? "" : "none");

  bindDraft(); // 폼 자동저장
  startListeners(); // 목록 스냅샷

  // 중요 전달 사항 토글 관리
  loadNoticeToggle();
});

/* ========= 5) 경로 유틸 ========= */
function ownerUidForRead() {
  return (currentUser && isAdmin) ? ADMIN_UID : PUBLIC_UID;
}
function ownerUidForWrite() {
  if (!currentUser || !isAdmin) throw new Error("권한 없음");
  return ADMIN_UID;
}
function col(cat, write=false) {
  const uid = write ? ownerUidForWrite() : ownerUidForRead();
  return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
}

/* ========= 6) D-day 계산 ========= */
function renderDday(startStr, endStr) {
  if (!startStr) return '';
  const msDay = 86400000;
  const today = new Date(); today.setHours(0,0,0,0);

  const start = new Date(startStr); start.setHours(0,0,0,0);
  const end   = endStr ? new Date(endStr) : new Date(startStr);
  end.setHours(0,0,0,0);

  if (today < start) {
    const diff = Math.ceil((start - today)/msDay);
    return `<span class="dday pill warn">D-${diff}</span>`;
  } else if (today >= start && today <= end) {
    return `<span class="dday pill hot">D-DAY</span>`;
  } else {
    const diff = Math.ceil((today - end)/msDay);
    return `<span class="dday pill thin">D+${diff}</span>`;
  }
}

/* ========= 7) 렌더 ========= */
function periodRange(s,e){
  if(!s && !e) return "";
  if(s && !e) return ` ${s}`;
  if(!s && e) return ` ${e}`;
  return ` ${s} ~ ${e}`;
}

function renderOne(cat, it) {
  const dday = renderDday(it.startDate, it.endDate);
  const pr   = periodRange(it.startPeriod || "", it.endPeriod || "");

  return `
  <li class="task" data-cat="${cat}" data-id="${it.id}">
    <label class="chk-wrap">
      <input type="checkbox" ${it.done?"checked":""} disabled />
      <span></span>
    </label>
    <div class="task__main">
      <div class="task__line">
        <div class="topline">
          <b class="subject">${escapeHtml(it.subj||"")}</b>
          ${dday}
        </div>
        <div class="content">${escapeHtml(it.text||"")}</div>
      </div>
      <div class="task__meta">
        <span>📅 ${it.startDate || ""}${it.endDate? ` ~ ${it.endDate}`:""}${pr? ` ·${pr}`:""}</span>
      </div>
      ${it.detail? `<pre class="detail">${escapeHtml(it.detail)}</pre>` : ""}
    </div>
    <div class="task__ops">
      <button class="op btn light" data-act="edit"  style="display:${isAdmin?'':'none'}">수정</button>
      <button class="op btn light" data-act="del"   style="display:${isAdmin?'':'none'}">삭제</button>
    </div>
  </li>`;
}

function renderList(cat, items) {
  const ul = lists[cat];
  ul.innerHTML = items.map(it => renderOne(cat,it)).join("");

  // 수정/삭제 바인딩
  ul.querySelectorAll("[data-act]").forEach(btn=>{
    btn.onclick = async (e)=>{
      const li = e.target.closest("li.task");
      const id = li.dataset.id;
      const act = e.target.dataset.act;

      if(act==="del"){
        if(!confirm("삭제할까요?")) return;
        try{
          await col(cat,true).doc(id).delete();
        }catch(err){ alert("삭제 실패: " + err.message); }
      }else if(act==="edit"){
        openEdit(cat,id);
      }
    };
  });
}

/* ========= 8) 스냅샷 ========= */
function startListeners(){
  unsub.forEach(u=>u&&u()); unsub = [];
  ["exam","perf","home"].forEach(cat=>{
    const u = col(cat).orderBy("startDate","asc").onSnapshot(snap=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      renderList(cat,arr);
    }, err=>{
      console.error("listener error:",err);
    });
    unsub.push(u);
  });

  // 전달 사항 로드
  loadNotices();
}

// 60초마다 조용한 갱신(단, onSnapshot가 있어 사실상 불필요하지만 요청이 있어 둡니다)
setInterval(()=>startListeners(), 60000);

/* ========= 9) 추가 폼(+ 자동 임시 저장) ========= */
const DRAFT_KEY = "memo:draft-v2";

function gatherDraft(){
  const data={};
  document.querySelectorAll(".add-row").forEach(row=>{
    const cat=row.dataset.cat;
    data[cat] = {
      subj:  row.querySelector(".subj").value,
      text:  row.querySelector(".text").value,
      start: row.querySelector(".dateStart").value,
      end:   row.querySelector(".dateEnd").value,
      sp:    row.querySelector(".startPeriod").value,
      ep:    row.querySelector(".endPeriod").value,
      detail:row.querySelector(".detail").value
    };
  });
  return data;
}
function applyDraft(data){
  if(!data) return;
  document.querySelectorAll(".add-row").forEach(row=>{
    const d = data[row.dataset.cat]; if(!d) return;
    row.querySelector(".subj").value  = d.subj || "";
    row.querySelector(".text").value  = d.text || "";
    row.querySelector(".dateStart").value = d.start || "";
    row.querySelector(".dateEnd").value   = d.end   || "";
    row.querySelector(".startPeriod").value = d.sp || "";
    row.querySelector(".endPeriod").value   = d.ep || "";
    row.querySelector(".detail").value = d.detail || "";
  });
}
function bindDraft(){
  try{ applyDraft(JSON.parse(localStorage.getItem(DRAFT_KEY))); }catch{}
  document.addEventListener("input", e=>{
    if(e.target.closest(".add-row")){
      localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft()));
    }
  });
}
function clearRow(row){
  row.querySelector(".subj").value="";
  row.querySelector(".text").value="";
  row.querySelector(".dateStart").value="";
  row.querySelector(".dateEnd").value="";
  row.querySelector(".startPeriod").value="";
  row.querySelector(".endPeriod").value="";
  row.querySelector(".detail").value="";
  localStorage.setItem(DRAFT_KEY, JSON.stringify(gatherDraft()));
}

// 추가 버튼 바인딩
document.querySelectorAll(".add-row .add").forEach(btn=>{
  btn.onclick = async ()=>{
    if(!isAdmin){ alert("관리자만 추가할 수 있습니다."); return; }
    const row = btn.closest(".add-row");
    const cat = row.dataset.cat;

    const subj  = row.querySelector(".subj").value.trim();
    const text  = row.querySelector(".text").value.trim();
    const start = row.querySelector(".dateStart").value;
    const end   = row.querySelector(".dateEnd").value;
    const sp    = row.querySelector(".startPeriod").value;
    const ep    = row.querySelector(".endPeriod").value;
    const detail= row.querySelector(".detail").value;

    if(!subj || !text || !start){ alert("과목/내용/시작일은 필수입니다."); return; }

    try{
      await col(cat,true).add({
        subj, text, startDate:start, endDate:end || start,
        startPeriod: sp || "", endPeriod: ep || "",
        detail: detail || "",
        done:false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      clearRow(row);
    }catch(err){ alert("저장 실패: " + err.message); }
  };
});

/* ========= 10) 수정 모달 ========= */
const modal = document.getElementById("editModal");
const editSubj = document.getElementById("editSubj");
const editText = document.getElementById("editText");
const editStart= document.getElementById("editStart");
const editEnd  = document.getElementById("editEnd");
const editStartPeriod = document.getElementById("editStartPeriod");
const editEndPeriod   = document.getElementById("editEndPeriod");
const editDetail = document.getElementById("editDetail");

let editing = { cat:null, id:null };

function openEdit(cat,id){
  editing = {cat,id};
  col(cat).doc(id).get().then(doc=>{
    const d=doc.data();
    editSubj.value  = d.subj||"";
    editText.value  = d.text||"";
    editStart.value = d.startDate||"";
    editEnd.value   = d.endDate||"";
    editStartPeriod.value = d.startPeriod||"";
    editEndPeriod.value   = d.endPeriod||"";
    editDetail.value = d.detail||"";
    modal.style.display="block";
  });
}
document.getElementById("editCancel").onclick = ()=> modal.style.display="none";
document.getElementById("editSave").onclick = async ()=>{
  if(!isAdmin){ alert("관리자만 수정할 수 있습니다."); return; }
  try{
    await col(editing.cat,true).doc(editing.id).update({
      subj: editSubj.value.trim(),
      text: editText.value.trim(),
      startDate: editStart.value,
      endDate:   editEnd.value || editStart.value,
      startPeriod: editStartPeriod.value || "",
      endPeriod:   editEndPeriod.value   || "",
      detail: editDetail.value || ""
    });
    modal.style.display="none";
  }catch(err){ alert("수정 실패: " + err.message); }
};

/* ========= 11) 중요 전달 사항 ========= */
// 구조: settings/{ADMIN_UID}/doc("ui")-> { showNotices: boolean }
// 공지 컬렉션: users/{ADMIN_UID}/notices/{autoId} -> { title, body, tone, createdAt }

const uiDoc = db.collection("settings").doc(ADMIN_UID).collection("ui").doc("global");

async function loadNoticeToggle(){
  const tgl = document.getElementById("noticeToggle");
  try{
    const s = await uiDoc.get();
    const show = !!(s.exists && s.data().showNotices);
    tgl.checked = show;
  }catch{}
  // 관리자만 토글 가능
  tgl.disabled = !isAdmin;
  tgl.onchange = async ()=>{
    if(!isAdmin) return;
    try{
      await uiDoc.set({ showNotices: tgl.checked }, { merge:true });
    }catch(e){ alert("표시 설정 실패: "+e.message); }
  };
}

function loadNotices(){
  // 표시 설정에 따라 숨김 처리
  uiDoc.get().then(s=>{
    const show = !!(s.exists && s.data().showNotices);
    document.querySelector(".panel .notice-wrap").style.opacity = show? "1" : "0.45";
  });
  // 목록
  db.collection("users").doc(ownerUidForRead()).collection("notices")
    .orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      const wrap = document.getElementById("noticeWrap");
      if(snap.empty){ wrap.innerHTML = '<p class="muted">등록된 전달 사항이 없습니다.</p>'; return; }
      const html = [];
      snap.forEach(d=>{
        const n=d.data();
        const color = n.tone||"yellow";
        html.push(`
          <article class="notice ${color}">
            <div class="notice-title">${escapeHtml(n.title||"")}</div>
            <pre class="notice-body">${escapeHtml(n.body||"")}</pre>
          </article>
        `);
      });
      wrap.innerHTML = html.join("");
    }, err=>console.error(err));
}

document.getElementById("noticeAdd").onclick = async ()=>{
  if(!isAdmin){ alert("관리자만 추가할 수 있습니다."); return; }
  const title = document.getElementById("noticeTitle").value.trim();
  const body  = document.getElementById("noticeBody").value.trim();
  const tone  = document.getElementById("noticeTone").value;
  if(!title){ alert("제목을 입력하세요."); return; }
  try{
    await db.collection("users").doc(ownerUidForWrite()).collection("notices").add({
      title, body, tone, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("noticeTitle").value="";
    document.getElementById("noticeBody").value="";
  }catch(e){ alert("추가 실패: " + e.message); }
};

/* ========= 12) 도우미 ========= */
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

</script>
</body>
</html>
