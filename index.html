<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ê´‘ê³  1-1 ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <header class="admin-bar">
    <h1>ğŸ“’ ìˆ™ì œ & ìˆ˜í–‰í‰ê°€</h1>
    <div class="spacer"></div>
    <button id="loginBtn"  class="btn">ğŸ”‘ Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" class="btn" style="display:none">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <main class="container">
    <!-- ìˆ˜í–‰í‰ê°€ -->
    <section class="section">
      <button class="section-head" onclick="toggleSection('sec_perf')">ğŸ§ª ìˆ˜í–‰í‰ê°€ â–¾</button>
      <div id="sec_perf" class="section-body open">
        <ul id="list_perf" class="task-list"></ul>

        <!-- ì¶”ê°€ í¼ -->
        <div class="add-row" data-cat="perf">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©(í•œ ì¤„)" />
          <input class="date start" type="date" />
          <span class="til">~</span>
          <input class="date end"   type="date" />
          <select class="startPeriod"></select>
          <select class="endPeriod"></select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn-primary">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ì‹œí—˜ -->
    <section class="section">
      <button class="section-head" onclick="toggleSection('sec_exam')">ğŸ“ ì‹œí—˜ â–¾</button>
      <div id="sec_exam" class="section-body open">
        <ul id="list_exam" class="task-list"></ul>

        <!-- ì¶”ê°€ í¼ -->
        <div class="add-row" data-cat="exam">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©(í•œ ì¤„)" />
          <input class="date start" type="date" />
          <span class="til">~</span>
          <input class="date end"   type="date" />
          <select class="startPeriod"></select>
          <select class="endPeriod"></select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn-primary">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <!-- ìˆ™ì œ -->
    <section class="section">
      <button class="section-head" onclick="toggleSection('sec_home')">ğŸ“Œ ìˆ™ì œ â–¾</button>
      <div id="sec_home" class="section-body open">
        <ul id="list_home" class="task-list"></ul>

        <!-- ì¶”ê°€ í¼ -->
        <div class="add-row" data-cat="home">
          <input class="subj" type="text" placeholder="ê³¼ëª©" />
          <input class="text" type="text" placeholder="ë‚´ìš©(í•œ ì¤„)" />
          <input class="date start" type="date" />
          <span class="til">~</span>
          <input class="date end"   type="date" />
          <select class="startPeriod"></select>
          <select class="endPeriod"></select>
          <textarea class="detail" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
          <button class="add btn-primary">+ ì¶”ê°€</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase ì´ˆê¸°í™” : âš ï¸ ë„¤ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´ -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbThwhLWHJz8mBHGvhpWOL88cP9C7Nxio",
      authDomain: "my-memo-site.firebaseapp.com",
      projectId: "my-memo-site",
      storageBucket: "my-memo-site.firebasestorage.app",
      messagingSenderId: "196036694705",
      appId: "1:196036694705:web:8988d12919420130464890"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ì•± ì½”ë“œ -->
  <script>
  /* ------------------- ê³µí†µ DOM/ìœ í‹¸ ------------------- */
  const $  = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
  const el = {
    loginBtn:  $("#loginBtn"),
    logoutBtn: $("#logoutBtn"),
    lists: { perf: $("#list_perf"), exam: $("#list_exam"), home: $("#list_home") }
  };

  const OWNER_UID = "vv0bADtWdqQUnqFMy8k01dhO13t2"; // ë¹„ë¡œê·¸ì¸ ì—´ëŒìš©
  const auth = firebase.auth();
  const db   = firebase.firestore();
  let currentUser = null;
  let unsub = [];

  function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function toggleSection(id){ $("#"+id)?.classList.toggle("open"); }

  // ê¸°ê°„/ìš”ì¼/êµì‹œ í‘œì‹œ í—¬í¼
  const wday = (d) => ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
  function toDate(s){ if(!s) return null; const d=new Date(s); return Number.isNaN(d.getTime())?null:d; }

  function formatRange(startStr, endStr, dueStr){
    const s = toDate(startStr) || toDate(dueStr);
    const e = toDate(endStr)   || toDate(dueStr);
    if(!s && !e) return "";
    const f = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} (${wday(d)})`;
    if(s && e) return (s.getTime()===e.getTime()) ? f(s) : `${f(s)} ~ ${f(e)}`;
    return f(s || e);
  }
  function formatPeriods(sp, ep){
    if(!sp && !ep) return "";
    if(sp && ep){
      if(sp===ep) return sp;
      const a = Number((sp||"").replace("êµì‹œ",""));
      const b = Number((ep||"").replace("êµì‹œ",""));
      if(!Number.isNaN(a) && !Number.isNaN(b)) return `${a}~${b}êµì‹œ`;
      return `${sp} ~ ${ep}`;
    }
    return sp || ep;
  }
  // D-Day ë¼ë²¨ (ì§€ë‚¬ìœ¼ë©´ A+N)
  function renderDdayLabel(endDate, dueDate, startDate){
    const target = toDate(endDate) || toDate(dueDate) || toDate(startDate);
    if(!target) return "";
    const today = new Date(); today.setHours(0,0,0,0);
    target.setHours(0,0,0,0);
    const diff = Math.floor((target - today)/(1000*60*60*24));
    let label="", cls="";
    if(diff===0){ label="D-Day"; cls="red"; }
    else if(diff>0){
      label=`D-${diff}`;
      if(diff===1) cls="red";
      else if(diff<=3) cls="orange";
      else if(diff<=5) cls="yellow";
      else cls="green";
    }else{
      label=`A+${Math.abs(diff)}`;
      cls="past";
    }
    return `<span class="dday ${cls}">${label}</span>`;
  }

  // Firestore ê²½ë¡œ: ë¡œê·¸ì¸ ì‹œ ë‚´ ë¬¸ì„œ, ë¹„ë¡œê·¸ì¸ ì‹œ OWNER_UID
  const col = (cat)=>{
    const uid = (currentUser?.uid) || OWNER_UID;
    return db.collection("users").doc(uid).collection("tasks").doc(cat).collection("items");
  };

  // êµì‹œ ì…€ë ‰íŠ¸ ì˜µì…˜ ì„¸íŒ…
  const PERIODS = ["","0êµì‹œ","1êµì‹œ","2êµì‹œ","3êµì‹œ","4êµì‹œ","5êµì‹œ","6êµì‹œ","7êµì‹œ","8êµì‹œ","ì¢…ì¼"];
  function fillPeriodSelects(){
    $$(".add-row").forEach(row=>{
      const a = $(".startPeriod",row), b = $(".endPeriod",row);
      [a,b].forEach(sel=>{
        sel.innerHTML = PERIODS.map(v=>`<option value="${v}">${v||"ì‹œì‘ êµì‹œ"}</option>`).join("");
      });
      b.querySelector("option[value='']").textContent = "ë êµì‹œ";
    });
  }
  fillPeriodSelects();

  /* ------------------- ë Œë”ë§ ------------------- */
  function renderList(cat, arr){
    const ul = el.lists[cat];
    ul.innerHTML = "";

    arr.forEach(it=>{
      const range   = formatRange(it.startDate, it.endDate, it.due);
      const periods = formatPeriods(it.startPeriod, it.endPeriod);
      const meta    = [
        range ? `ğŸ“… ${range}` : "",
        periods ? ` ${periods}` : ""
      ].join("");

      const li = document.createElement("li");
      li.className = "task"+(it.done?" done":"");
      li.innerHTML = `
        <label class="chk-wrap">
          <input type="checkbox" ${it.done?"checked":""}
                 data-act="toggle" data-cat="${cat}" data-id="${it.id}"/>
          <span></span>
        </label>
        <div class="task__main">
          <div class="task__line">
            <b>${esc(it.subj||"")}</b>
            ${renderDdayLabel(it.endDate, it.due, it.startDate)}
            <div class="task__text">${esc(it.text||"")}</div>
          </div>
          <div class="task__meta">${meta}</div>
          ${it.detail ? `<div class="task__meta" style="white-space:pre-wrap;margin-top:6px;">${esc(it.detail)}</div>` : ""}
        </div>
        <div class="task__ops">
          <button class="btn-ghost" data-act="edit" data-cat="${cat}" data-id="${it.id}" style="${currentUser?'':'display:none'}">ìˆ˜ì •</button>
          <button class="btn-ghost" data-act="del"  data-cat="${cat}" data-id="${it.id}" style="${currentUser?'':'display:none'}">ì‚­ì œ</button>
        </div>
      `;
      ul.appendChild(li);
    });

    // ì²´í¬/ì‚­ì œ/ìˆ˜ì •
    ul.onclick = async (e)=>{
      const t = e.target;
      const act = t.getAttribute("data-act");
      if(!act) return;

      const cat2 = t.getAttribute("data-cat");
      const id   = t.getAttribute("data-id");
      if(!currentUser){
        alert("ìˆ˜ì •/ì‚­ì œëŠ” ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        if(act==="toggle") t.checked = !t.checked;
        return;
      }
      try{
        if(act==="toggle"){
          await col(cat2).doc(id).update({ done: t.closest("label").querySelector("input").checked });
        }else if(act==="del"){
          if(confirm("ì‚­ì œí• ê¹Œìš”?")) await col(cat2).doc(id).delete();
        }else if(act==="edit"){
          // ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸ í¸ì§‘ (í•„ìš”í•˜ë©´ ëª¨ë‹¬ë¡œ í™•ì¥ ê°€ëŠ¥)
          const snap = await col(cat2).doc(id).get();
          const it = snap.data();
          if(!it) return;

          const subj  = prompt("ê³¼ëª©", it.subj||"");            if(subj===null) return;
          const text  = prompt("ë‚´ìš©(í•œ ì¤„)", it.text||"");    if(text===null) return;
          const sdate = prompt("ì‹œì‘ì¼(YYYY-MM-DD)", it.startDate||it.due||""); if(sdate===null) return;
          const edate = prompt("ëì¼(YYYY-MM-DD)",   it.endDate||it.due||"");   if(edate===null) return;
          const sp    = prompt("ì‹œì‘ êµì‹œ (ex. 1êµì‹œ, ë¹ˆì¹¸ ê°€ëŠ¥)", it.startPeriod||"");
          const ep    = prompt("ë êµì‹œ (ex. 2êµì‹œ, ë¹ˆì¹¸ ê°€ëŠ¥)",   it.endPeriod||"");
          const det   = prompt("ìƒì„¸ ë‚´ìš©(ì„ íƒ, ì¤„ë°”ê¿ˆ ê°€ëŠ¥)", it.detail||"");

          await col(cat2).doc(id).update({
            subj, text,
            startDate: sdate || null,
            endDate:   edate || null,
            startPeriod: sp || "",
            endPeriod:   ep || "",
            detail: (det||"")
          });
        }
      }catch(err){
        console.error(err);
        alert("ì‘ì—… ì‹¤íŒ¨: "+err.message);
      }
    };
  }

  /* --------------- ì‹¤ì‹œê°„ êµ¬ë… + ì •ë ¬ + ë°±í•„ --------------- */
  function startListeners(){
    unsub.forEach(u=>u && u());
    unsub = [];

    ["perf","exam","home"].forEach(cat=>{
      const u = col(cat).onSnapshot(snap=>{
        const rows = [];
        snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));

        // ê³¼ê±°(due-only) ë¬¸ì„œë„ ë³´ì´ë„ë¡ ì •ë ¬í‚¤ë¥¼ ìœ ì—°í•˜ê²Œ
        const keyDate = (it)=> (toDate(it.endDate) || toDate(it.due) || toDate(it.startDate))?.getTime() ?? Infinity;
        rows.sort((a,b)=> keyDate(a) - keyDate(b));

        renderList(cat, rows);

        // (ì„ íƒ) ë¡œê·¸ì¸ ì‹œ êµ¬ ìŠ¤í‚¤ë§ˆë¥¼ ìƒˆ ìŠ¤í‚¤ë§ˆë¡œ ë°±í•„
        if(currentUser) maybeBackfillOldDocs(cat, rows);
      }, err=>{
        console.error(err);
        alert("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      });
      unsub.push(u);
    });
  }

  // dueë§Œ ìˆëŠ” ì˜ˆì „ ë¬¸ì„œ â†’ startDate/endDate ë¡œ ë°±í•„
  async function maybeBackfillOldDocs(cat, rows){
    const batch = db.batch();
    let cnt = 0;
    rows.forEach(it=>{
      if(!it.startDate && !it.endDate && it.due){
        batch.update(col(cat).doc(it.id), { startDate: it.due, endDate: it.due });
        cnt++;
      }
    });
    if(cnt>0){
      try{ await batch.commit(); console.log(`[ë°±í•„] ${cat}: ${cnt}ê±´`); }catch(e){ console.warn("ë°±í•„ ì‹¤íŒ¨:", e); }
    }
  }

  /* ------------------- ì¶”ê°€ í¼ ë°”ì¸ë”© ------------------- */
  function bindAddRows(){
    $$(".add-row").forEach(row=>{
      const cat = row.dataset.cat;
      $(".add", row).onclick = async ()=>{
        if(!currentUser){ alert("ë¡œê·¸ì¸ í›„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”."); return; }
        const subj = $(".subj",row).value.trim();
        const text = $(".text",row).value.trim();
        const sdt  = $(".date.start",row).value;
        const edt  = $(".date.end",row).value;
        const sp   = $(".startPeriod",row).value || "";
        const ep   = $(".endPeriod",row).value || "";
        const det  = $(".detail",row).value;

        if(!subj || !text){ alert("ê³¼ëª©/ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

        try{
          await col(cat).add({
            subj, text,
            startDate: sdt || null,
            endDate:   (edt || sdt || null),
            startPeriod: sp, endPeriod: ep,
            detail: det || "",
            done: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          // í¼ ì´ˆê¸°í™”
          $(".subj",row).value = "";
          $(".text",row).value = "";
          $(".date.start",row).value = "";
          $(".date.end",row).value   = "";
          $(".startPeriod",row).value = "";
          $(".endPeriod",row).value   = "";
          $(".detail",row).value = "";
        }catch(e){
          console.error(e);
          alert("ì €ì¥ ì‹¤íŒ¨: "+e.message);
        }
      };
    });
  }
  bindAddRows();

  /* ------------------- ë¡œê·¸ì¸ ------------------- */
  el.loginBtn.onclick = async ()=>{
    try{
      await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }catch(e){
      alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨\n${e.code}\n${e.message}`);
      console.error(e);
    }
  };
  el.logoutBtn.onclick = ()=>auth.signOut();

  auth.onAuthStateChanged(user=>{
    currentUser = user || null;
    el.loginBtn.style.display  = user ? "none" : "";
    el.logoutBtn.style.display = user ? "" : "none";
    startListeners();
  });
  </script>
</body>
</html>
